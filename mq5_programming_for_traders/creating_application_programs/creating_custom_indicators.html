<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>创建自定义指标 | 专业投机策略</title>
    <meta name="description" content="迎接新的时代">
    <meta name="generator" content="VitePress v1.6.3">
    <link rel="preload stylesheet" href="/assets/style.CBnFUBTF.css" as="style">
    <link rel="preload stylesheet" href="/vp-icons.css" as="style">
    
    <script type="module" src="/assets/app.D8cMKHSL.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/theme.CSTfEtnf.js">
    <link rel="modulepreload" href="/assets/chunks/framework.CCnnzLsu.js">
    <link rel="modulepreload" href="/assets/mq5_programming_for_traders_creating_application_programs_creating_custom_indicators.md.D89rvx8i.lean.js">
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <link rel="alternate" type="application/rss+xml" href="/blog.rss">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="true">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&amp;family=Manrope:wght@600&amp;family=IBM+Plex+Mono:wght@400&amp;display=swap" as="style">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&amp;family=Manrope:wght@600&amp;family=IBM+Plex+Mono:wght@400&amp;display=swap">
    <link rel="me" href="https://m.webtoo.ls/@vite">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://vite.dev/og-image.jpg">
    <meta property="og:url" content="https://vite.dev">
    <meta property="og:description" content="Next Generation Frontend Tooling">
    <meta property="og:site_name" content="vitejs">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@vite_js">
    <meta name="theme-color" content="#646cff">
    <script src="https://cdn.usefathom.com/script.js" data-site="TPLGJZGR" data-spa="auto" defer></script>
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
    <link rel="canonical" href="https://vite.dev/mq5_programming_for_traders/creating_application_programs/creating_custom_indicators">
    <meta property="og:title" content="创建自定义指标">
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-e8cbffd7><!--[--><!--]--><!--[--><span tabindex="-1" data-v-4e586869></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-4e586869>Skip to content</a><!--]--><!----><header class="VPNav" data-v-e8cbffd7 data-v-7a0b7e8a><div class="VPNavBar" data-v-7a0b7e8a data-v-357046c4><div class="wrapper" data-v-357046c4><div class="container" data-v-357046c4><div class="title" data-v-357046c4><div class="VPNavBarTitle has-sidebar" data-v-357046c4 data-v-c0b09a5e><a class="title" href="/" data-v-c0b09a5e><!--[--><!--]--><!--[--><img class="VPImage logo" src="/logo.svg" alt data-v-7d39a773><!--]--><span data-v-c0b09a5e>专业投机策略</span><!--[--><!--]--></a></div></div><div class="content" data-v-357046c4><div class="content-body" data-v-357046c4><!--[--><!--]--><div class="VPNavBarSearch search" data-v-357046c4><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-357046c4 data-v-a8ff5a32><span id="main-nav-aria-label" class="visually-hidden" data-v-a8ff5a32> Main Navigation </span><!--[--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-a8ff5a32 data-v-00041c6c><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-00041c6c><span class="text" data-v-00041c6c><!----><span data-v-00041c6c>外盘策略</span><span class="vpi-chevron-down text-icon" data-v-00041c6c></span></span></button><div class="menu" data-v-00041c6c><div class="VPMenu" data-v-00041c6c data-v-64b59e26><div class="items" data-v-64b59e26><!--[--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_strategy/trend_follow/" data-v-06756f99><!--[--><span data-v-06756f99>趋势跟踪</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_strategy/martingale/" data-v-06756f99><!--[--><span data-v-06756f99>马丁格尔</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_strategy/frequency_trading/" data-v-06756f99><!--[--><span data-v-06756f99>高频交易</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/future_strategy/" tabindex="0" data-v-a8ff5a32 data-v-25d839e6><!--[--><span data-v-25d839e6>期货策略</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-a8ff5a32 data-v-00041c6c><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-00041c6c><span class="text" data-v-00041c6c><!----><span data-v-00041c6c>MT5编辑器</span><span class="vpi-chevron-down text-icon" data-v-00041c6c></span></span></button><div class="menu" data-v-00041c6c><div class="VPMenu" data-v-00041c6c data-v-64b59e26><div class="items" data-v-64b59e26><!--[--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/metaeditor/welcome/" data-v-06756f99><!--[--><span data-v-06756f99>欢迎来到算法交易</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/metaeditor/main_menu/" data-v-06756f99><!--[--><span data-v-06756f99>主菜单</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/metaeditor/toolbar/" data-v-06756f99><!--[--><span data-v-06756f99>工具栏</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/metaeditor/workspace/" data-v-06756f99><!--[--><span data-v-06756f99>工作区</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/metaeditor/mql5storage/" data-v-06756f99><!--[--><span data-v-06756f99>MQL5存储</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/metaeditor/mql5_wizard/" data-v-06756f99><!--[--><span data-v-06756f99>MQL4/MQL5 向导</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/metaeditor/development/" data-v-06756f99><!--[--><span data-v-06756f99>开发程序</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/metaeditor/other/" data-v-06756f99><!--[--><span data-v-06756f99>其它</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-a8ff5a32 data-v-00041c6c><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-00041c6c><span class="text" data-v-00041c6c><!----><span data-v-00041c6c>MQL5快速入门</span><span class="vpi-chevron-down text-icon" data-v-00041c6c></span></span></button><div class="menu" data-v-00041c6c><div class="VPMenu" data-v-00041c6c data-v-64b59e26><div class="items" data-v-64b59e26><!--[--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_quick_start/welcome/" data-v-06756f99><!--[--><span data-v-06756f99>初步认识</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_quick_start/basic_grammar/" data-v-06756f99><!--[--><span data-v-06756f99>基础语法</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_quick_start/first_real_ea/" data-v-06756f99><!--[--><span data-v-06756f99>第一个EA</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_quick_start/advance_konwledge/" data-v-06756f99><!--[--><span data-v-06756f99>进阶知识</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_quick_start/classic_strategy/" data-v-06756f99><!--[--><span data-v-06756f99>经典策略</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_quick_start/indicator_tools/" data-v-06756f99><!--[--><span data-v-06756f99>指标工具</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-a8ff5a32 data-v-00041c6c><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-00041c6c><span class="text" data-v-00041c6c><!----><span data-v-00041c6c>MQL5官方教程</span><span class="vpi-chevron-down text-icon" data-v-00041c6c></span></span></button><div class="menu" data-v-00041c6c><div class="VPMenu" data-v-00041c6c data-v-64b59e26><div class="items" data-v-64b59e26><!--[--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mq5_programming_for_traders/welcome/" data-v-06756f99><!--[--><span data-v-06756f99>开始</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/" data-v-06756f99><!--[--><span data-v-06756f99>MQL5编程基础</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mq5_programming_for_traders/object_oriented_programming/" data-v-06756f99><!--[--><span data-v-06756f99>面向对象</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mq5_programming_for_traders/common_mql5_apis/" data-v-06756f99><!--[--><span data-v-06756f99>常用API</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mq5_programming_for_traders/creating_application_programs/" data-v-06756f99><!--[--><span data-v-06756f99>在 MQL5 中创建应用程序</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mq5_programming_for_traders/trading_automation/" data-v-06756f99><!--[--><span data-v-06756f99>交易自动化</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mq5_programming_for_traders/advanced_language_tools/" data-v-06756f99><!--[--><span data-v-06756f99>MQL5高级工具</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/article/" tabindex="0" data-v-a8ff5a32 data-v-25d839e6><!--[--><span data-v-25d839e6>经典文章</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-357046c4 data-v-17c83068><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-17c83068 data-v-c8344e84 data-v-5dac9e91><span class="check" data-v-5dac9e91><span class="icon" data-v-5dac9e91><!--[--><span class="vpi-sun sun" data-v-c8344e84></span><span class="vpi-moon moon" data-v-c8344e84></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-357046c4 data-v-a318d133 data-v-43df44de><!--[--><a class="VPSocialLink no-icon" href="https://www.douyin.com/user/MS4wLjABAAAAVb-2dWdStZkPrNrzAGkHhhquMun5zaNAUsNPN166PCA" aria-label="tiktok" target="_blank" rel="noopener" data-v-43df44de data-v-b3f2150c><span class="vpi-social-tiktok"></span></a><a class="VPSocialLink no-icon" href="https://space.bilibili.com/485926738" aria-label="bilibili" target="_blank" rel="noopener" data-v-43df44de data-v-b3f2150c><span class="vpi-social-bilibili"></span></a><a class="VPSocialLink no-icon" href="https://mp.weixin.qq.com/s/Q_d8EUdnWIh4uzjg9DGQqg" aria-label="wechat" target="_blank" rel="noopener" data-v-43df44de data-v-b3f2150c><span class="vpi-social-wechat"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-357046c4 data-v-72eb2fc7 data-v-00041c6c><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-00041c6c><span class="vpi-more-horizontal icon" data-v-00041c6c></span></button><div class="menu" data-v-00041c6c><div class="VPMenu" data-v-00041c6c data-v-64b59e26><!----><!--[--><!--[--><!----><div class="group" data-v-72eb2fc7><div class="item appearance" data-v-72eb2fc7><p class="label" data-v-72eb2fc7>Appearance</p><div class="appearance-action" data-v-72eb2fc7><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-72eb2fc7 data-v-c8344e84 data-v-5dac9e91><span class="check" data-v-5dac9e91><span class="icon" data-v-5dac9e91><!--[--><span class="vpi-sun sun" data-v-c8344e84></span><span class="vpi-moon moon" data-v-c8344e84></span><!--]--></span></span></button></div></div></div><div class="group" data-v-72eb2fc7><div class="item social-links" data-v-72eb2fc7><div class="VPSocialLinks social-links-list" data-v-72eb2fc7 data-v-43df44de><!--[--><a class="VPSocialLink no-icon" href="https://www.douyin.com/user/MS4wLjABAAAAVb-2dWdStZkPrNrzAGkHhhquMun5zaNAUsNPN166PCA" aria-label="tiktok" target="_blank" rel="noopener" data-v-43df44de data-v-b3f2150c><span class="vpi-social-tiktok"></span></a><a class="VPSocialLink no-icon" href="https://space.bilibili.com/485926738" aria-label="bilibili" target="_blank" rel="noopener" data-v-43df44de data-v-b3f2150c><span class="vpi-social-bilibili"></span></a><a class="VPSocialLink no-icon" href="https://mp.weixin.qq.com/s/Q_d8EUdnWIh4uzjg9DGQqg" aria-label="wechat" target="_blank" rel="noopener" data-v-43df44de data-v-b3f2150c><span class="vpi-social-wechat"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-357046c4 data-v-5440f226><span class="container" data-v-5440f226><span class="top" data-v-5440f226></span><span class="middle" data-v-5440f226></span><span class="bottom" data-v-5440f226></span></span></button></div></div></div></div><div class="divider" data-v-357046c4><div class="divider-line" data-v-357046c4></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-e8cbffd7 data-v-315e22c6><div class="container" data-v-315e22c6><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-315e22c6><span class="vpi-align-left menu-icon" data-v-315e22c6></span><span class="menu-text" data-v-315e22c6>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-315e22c6 data-v-41946b35><button data-v-41946b35>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-e8cbffd7 data-v-2381695a><div class="curtain" data-v-2381695a></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-2381695a><span class="visually-hidden" id="sidebar-aria-label" data-v-2381695a> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-54ab8e9b><section class="VPSidebarItem level-0" data-v-54ab8e9b data-v-0221ad41><div class="item" role="button" tabindex="0" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><h2 class="text" data-v-0221ad41>开始</h2><!----></div><div class="items" data-v-0221ad41><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>大纲</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/introduction_to_mql5" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>简介</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/editing_compiling_running" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>编辑编译运行</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/mql_wizard" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>MQL向导</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/statements" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>语句代码块函数</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/first_program" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>第一个程序</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/data_types_and_values" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>数据类型和值</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/variables_and_identifiers" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>变量和标识符</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/assignment_and_initialization" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>赋值和初始化</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/data_input" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>数据输入</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/error_fixing_and_debugging" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>修复错误和调试</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/data_output" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>数据输出</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/formatting" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>格式化</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/mini_summary" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>迷你小结</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-54ab8e9b><section class="VPSidebarItem level-0 collapsible collapsed" data-v-54ab8e9b data-v-0221ad41><div class="item" role="button" tabindex="0" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><h2 class="text" data-v-0221ad41>MQL5编程基础</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-0221ad41><span class="vpi-chevron-right caret-icon" data-v-0221ad41></span></div></div><div class="items" data-v-0221ad41><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>简介</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/identifiers/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>标识符</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/built-in_data_types/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>内置数据类型</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/variables/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>变量</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/arrays/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>数组</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/expresssions/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>表达式</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/type_conversion/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>类型转换</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/statements/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>语句</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/function/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>函数</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/preprocessor/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>预处理</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-54ab8e9b><section class="VPSidebarItem level-0 collapsible collapsed" data-v-54ab8e9b data-v-0221ad41><div class="item" role="button" tabindex="0" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><h2 class="text" data-v-0221ad41>面向对象</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-0221ad41><span class="vpi-chevron-right caret-icon" data-v-0221ad41></span></div></div><div class="items" data-v-0221ad41><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/object_oriented_programming/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>简介</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/object_oriented_programming/structures_and_unions" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>结构体和联合体</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/object_oriented_programming/classes_and_interfaces" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>类和接口</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/object_oriented_programming/templates" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>模板</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-54ab8e9b><section class="VPSidebarItem level-0 collapsible collapsed" data-v-54ab8e9b data-v-0221ad41><div class="item" role="button" tabindex="0" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><h2 class="text" data-v-0221ad41>常用API</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-0221ad41><span class="vpi-chevron-right caret-icon" data-v-0221ad41></span></div></div><div class="items" data-v-0221ad41><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>简介</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/built-in_type_conversions" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>内置类型转换</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/working_with_strings_and_symbols" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>字符串和符号处理</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/working_with_arrays" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>数组操作</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/mathematical_functions" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>数学函数</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/working_with_files" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>文件操作</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/client_terminal_global_variables" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>客户端全局变量</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/functions_for_working_with_time" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>时间相关函数</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/user_interaction" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>用户交互</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/mql_program_execution_environment" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>MQL 程序执行环境</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/matrices_and_vectors" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>矩阵和向量</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-54ab8e9b><section class="VPSidebarItem level-0 collapsible collapsed has-active" data-v-54ab8e9b data-v-0221ad41><div class="item" role="button" tabindex="0" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><h2 class="text" data-v-0221ad41>在 MQL5 中创建应用程序</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-0221ad41><span class="vpi-chevron-right caret-icon" data-v-0221ad41></span></div></div><div class="items" data-v-0221ad41><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>简介</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/general_principles" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>一般原则</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/script_and_services" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>脚本和服务</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/timeseries" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>时间序列</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/creating_custom_indicators" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>自定义指标</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/ready-made-indicators" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>自带指标</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/working_with_timer" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>定时器的使用</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/working_with_charts" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>图表操作</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/graphical_objects" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>图表对象</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/interactive_events_on_charts" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>图表上的交互式事件</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-54ab8e9b><section class="VPSidebarItem level-0 collapsible collapsed" data-v-54ab8e9b data-v-0221ad41><div class="item" role="button" tabindex="0" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><h2 class="text" data-v-0221ad41>交易自动化</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-0221ad41><span class="vpi-chevron-right caret-icon" data-v-0221ad41></span></div></div><div class="items" data-v-0221ad41><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/trading_automation/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>简介</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/trading_automation/financial_instruments_and_market_watch" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>金融工具与市场报价</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/trading_automation/depth_of_market" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>市场深度</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/trading_automation/trading_account_information" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>交易账户信息</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/trading_automation/createing_expert_advisors" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>创建智能交易顾问</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/trading_automation/testing_and_optimization_of_expert_advisors" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>专家顾问的测试和优化</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-54ab8e9b><section class="VPSidebarItem level-0 collapsible collapsed" data-v-54ab8e9b data-v-0221ad41><div class="item" role="button" tabindex="0" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><h2 class="text" data-v-0221ad41>MQL5高级工具</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-0221ad41><span class="vpi-chevron-right caret-icon" data-v-0221ad41></span></div></div><div class="items" data-v-0221ad41><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>简介</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/resources" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>资源</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/custom_symbol" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>自定义交易品种</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/economic_calendar" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>经济日历</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/cryptography" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>密码学</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/network_functions" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>网络函数</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/sqlite_database" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>SQLite 数据库</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/connection_of_binary_format_libraries" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>二进制格式库的开发与连接</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/projects" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>项目</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/native_python_support" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>原生python支持</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/opencl" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>opencl</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/conclusion" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>总结</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-e8cbffd7 data-v-41fb371c><div class="VPDoc has-sidebar has-aside" data-v-41fb371c data-v-c23ecb28><!--[--><!--]--><div class="container" data-v-c23ecb28><div class="aside" data-v-c23ecb28><div class="aside-curtain" data-v-c23ecb28></div><div class="aside-container" data-v-c23ecb28><div class="aside-content" data-v-c23ecb28><div class="VPDocAside" data-v-c23ecb28 data-v-296f4c62><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-296f4c62 data-v-e8bc4af3><div class="content" data-v-e8bc4af3><div class="outline-marker" data-v-e8bc4af3></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-e8bc4af3>本页目录</div><ul class="VPDocOutlineItem root" data-v-e8bc4af3 data-v-4326957b><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-296f4c62></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-c23ecb28><div class="content-container" data-v-c23ecb28><!--[--><!--]--><main class="main" data-v-c23ecb28><div style="position:relative;" class="vp-doc _mq5_programming_for_traders_creating_application_programs_creating_custom_indicators" data-v-c23ecb28><div><h1 id="创建自定义指标" tabindex="-1">创建自定义指标 <a class="header-anchor" href="#创建自定义指标" aria-label="Permalink to &quot;创建自定义指标&quot;">​</a></h1><p>指标是最受欢迎的MQL程序类型之一。它们是进行技术分析的一种简单而强大的工具。其主要使用机制是运用公式对初始价格数据进行处理，以创建衍生时间序列。这使得对市场过程的特定特征进行评估和可视化成为可能。任何时间序列，包括通过指标计算得到的时间序列，都可以作为输入传递给另一个指标，依此类推。许多知名指标（例如，MACD指标）的公式实际上由对几个相互关联的指标的调用组成。</p><p>终端用户无疑熟悉许多内置指标，并且他们也知道可以使用MQL5语言来扩展可用指标的列表。从用户的角度来看，内置指标和用MQL5实现的自定义指标的工作方式完全相同。</p><p>通常情况下，指标以线条、柱状图和其他图形结构的形式在价格图表窗口中显示其运算结果。每个这样的图表都是基于计算出的时间序列进行可视化的，这些时间序列存储在指标内部的特殊数组中，这些数组被称为指标缓冲区：它们与开盘价（Open）、最高价（High）、最低价（Low）和收盘价（Close）（OHLC）价格一起可在终端的数据窗口中查看。然而，除了缓冲区之外，指标还可以提供额外的功能，或者可能根本没有缓冲区。例如，指标经常用于解决需要创建图形对象、管理图表及其属性以及与用户进行交互的问题（请参阅<code>OnChartEvent</code>）。</p><p>在本章中，我们将学习在MQL5中创建指标的基本原理。这样的指标通常被称为“自定义”指标，因为用户可以从头开始编写它们，或者从现成的源代码编译它们。在下一章中，我们将探讨自定义指标和内置指标的编程管理问题，这将使我们能够构建更复杂的指标，并为基于指标的交易信号和智能交易系统的过滤器铺平道路。</p><p>稍后，我们将掌握以资源形式将指标引入可执行MQL程序的技术。</p><h2 id="指标的主要特征" tabindex="-1">指标的主要特征 <a class="header-anchor" href="#指标的主要特征" aria-label="Permalink to &quot;指标的主要特征&quot;">​</a></h2><p>指标实现了一种特定的计算算法，该算法按K线应用于给定的初始时间序列或多个时间序列。所有这些时间序列都是终端自身的数组（请参阅函数<code>ArrayIsSeries</code>）：终端为它们分配内存，并在新K线形成时添加新元素。自然地，在这些数组中，不同时间框架下包含交易品种报价的数组起着基础性作用，因为它们是由终端填充的。然而，已启动的指标可以显著扩展可供分析的时间序列集合。</p><p>指标通常将其运算结果保存在动态数组中，这些数组通过特殊函数（<code>SetIndexBuffer</code>）注册为指标缓冲区，并且也成为终端自身的数组。除了为它们分配内存之外，终端还提供对这些数组的公共访问，将其视为新的时间序列，其他指标可以基于这些时间序列进行计算。</p><p>指标计算部分的入口点是<code>OnCalculate</code>函数——一个同名的事件处理程序。在“事件处理函数概述”中，我们已经提到过这个函数：仅其在源代码中的存在就足以让终端将MQL程序视为一个指标。<code>OnCalculate</code>函数将在下一节中详细描述。特别是，<code>OnCalculate</code>函数的主要特点是存在两种不同的形式。程序员应该在指标设计的最开始就选择其中一种形式，因为这决定了指标的用途和可能的使用场景。</p><p><code>OnCalculate</code>函数并不是指标的唯一显著特征。除了它之外，还有一组专门为指标设计的特殊预处理器指令<code>#property</code>——我们将在本章的几个相关部分逐步探讨它们。之前我们已经了解了一些通用的程序属性，当然，这些指令也同样适用于指标。</p><p>正如MetaTrader 5的用户所知道的，每个指标都有一种显示其图形结构（时间序列）的方式：要么在显示交易品种价格的主窗口中，要么在一个单独的子窗口中。当将特定指标（或一组指标）添加到图表中时，如果该指标设计为在子窗口中工作，就会在窗口的下部创建这样一个子窗口。例如，标准的移动平均线（MA）指标绘制在价格图表上，而威廉指标（WPR）则绘制在一个单独的子窗口中。</p><p>从开发者的角度来看，这意味着最初就应该确定指标是在主窗口中显示还是在子窗口中显示，因为这两种模式不能同时使用。此外，这一特征以及指标缓冲区的数量只能使用<code>#property</code>指令设置一次（请参阅“两种类型的指标”和“设置缓冲区数量和图形绘图”），然后就无法通过调用MQL5 API函数来更改它们，因为根本就没有提供这样的函数。与这些不可变的属性不同，大多数其他指标属性可以通过特殊函数进行动态调整。因此，在我们研究指标编程的技术方面时，我们将能够在<code>#property</code>属性和MQL5函数之间建立对应关系。</p><p>此外，指标通常会实现<code>OnInit</code>和<code>OnDeinit</code>处理程序（请参阅“指标和智能交易系统的参考事件”）。<code>OnInit</code>对于分配将用作指标缓冲区的数组尤为重要，也就是说，用于积累中间和最终计算的结果，这些结果对用户可见并且可供其他程序（如智能交易系统）使用。</p><p>指标是交互式MQL程序的一种，如果有必要，它可以处理由用户或其他程序产生的定时器事件（<code>OnTimer</code>）和图表变化（<code>OnChartEvent</code>）。这些技术特性对于指标来说是可选的，并且基于图表事件队列。我们将在关于图表的章节中单独讨论它们。</p><h2 id="指标的主要事件-oncalculate" tabindex="-1">指标的主要事件：OnCalculate <a class="header-anchor" href="#指标的主要事件-oncalculate" aria-label="Permalink to &quot;指标的主要事件：OnCalculate&quot;">​</a></h2><p><code>OnCalculate</code>函数是MQL5指标代码的主要入口点。每当<code>OnCalculate</code>事件发生时，该函数就会被调用，而<code>OnCalculate</code>事件是在价格数据发生变化时生成的。例如，当一个交易品种的新报价点到达时，或者当旧价格发生变化（填补历史数据中的缺口或从服务器下载缺失数据）时，就会触发该事件。</p><p>该函数有两种变体，它们在计算的源数据方面有所不同：</p><ol><li><strong>完整形式</strong>：在参数中提供一组标准的价格时间序列（开盘价、最高价、最低价、收盘价（OHLC）价格、成交量、点差）。</li><li><strong>简化形式</strong>：针对一个任意的时间序列（不一定是标准的）。</li></ol><p>一个指标只能使用这两种形式中的一种，并且不可能在一个指标中同时结合使用它们。</p><p>在使用<code>OnCalculate</code>的简化形式时，当将指标放置在图表上时，其属性对话框中会出现一个额外的选项卡。该选项卡提供一个下拉列表“应用于”（Apply to），你应该在其中选择作为指标计算基础的初始时间序列。默认情况下，如果未选择任何时间序列，则计算基于收盘价（Close）价格值。</p><h2 id="使用简化形式的oncalculate为指标选择初始时间序列" tabindex="-1">使用简化形式的OnCalculate为指标选择初始时间序列 <a class="header-anchor" href="#使用简化形式的oncalculate为指标选择初始时间序列" aria-label="Permalink to &quot;使用简化形式的OnCalculate为指标选择初始时间序列&quot;">​</a></h2><p>下拉列表中总是会提供标准类型的价格，但如果图表上还有其他指标，此设置允许你选择其中一个作为另一个指标的数据源，从而构建一个由指标组成的处理链。我们将在“跳过初始K线的绘制”部分尝试从一个指标构建另一个指标。当使用完整形式时，此选项不可用。</p><p>禁止将指标应用于以下内置指标：分形指标（Fractals）、鳄鱼指标（Gator）、一目均衡表指标（Ichimoku）和抛物线转向指标（Parabolic SAR）。</p><p><code>OnCalculate</code>的简化形式具有以下原型：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> rates_total</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> prev_calculated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> begin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p><code>data</code>数组包含用于计算的初始数据。这可以是价格时间序列之一，或者是另一个指标的计算缓冲区。<code>rates_total</code>参数指定<code>data</code>数组的大小。调用<code>ArraySize(data)</code>或<code>iBars(NULL, 0)</code>应该得到与<code>rates_total</code>相同的值。</p><p><code>prev_calculated</code>参数旨在有效地在少量新K线（通常是一根，即最后一根）上重新计算指标，而不是对所有K线进行完整计算。<code>prev_calculated</code>的值等于上一次函数调用时从<code>OnCalculate</code>函数返回给运行时的结果。例如，如果在接收到下一个报价点时，指标已经为所有K线计算了公式，它应该从<code>OnCalculate</code>返回<code>rates_total A</code>的值（这里的索引<code>A</code>表示初始时刻）。然后，在下一个报价点时，在接收到<code>OnCalculate</code>事件后，终端会将<code>prev_calculated</code>设置为先前的值<code>rates_totalA</code>。然而，在此期间K线的数量可能已经发生了变化，新的值<code>rates_total</code>将会增加；我们将其称为<code>rates_totalB</code>。因此，只会计算从<code>prev_calculated</code>（也就是<code>rates_totalA</code>）到<code>rates_totalB</code>的K线。</p><p>然而，最常见的情况是新的报价点适合当前的零号K线，也就是说，<code>rates_total</code>不会改变，因此在大多数<code>OnCalculate</code>调用中，我们有<code>prev_calculated == rates_total</code>。在这种情况下我们是否需要重新计算呢？这取决于计算的性质。例如，如果指标是基于不会改变的K线开盘价进行计算的，那么重新计算任何内容都没有意义。但是，如果指标使用收盘价（实际上是最后一个已知报价点的价格）或任何其他依赖于收盘价的汇总价格，那么最后一根K线应该始终重新计算。</p><p><code>OnCalculate</code>函数第一次被调用时，<code>prev_calculated</code>的值等于0。</p><p>如果自上一次调用<code>OnCalculate</code>函数以来，价格数据发生了变化（例如，上传了更深的历史数据或填补了缺口），那么终端也会将<code>prev_calculated</code>参数的值设置为0。因此，指标将收到一个信号，要求对整个可用历史数据进行完整的重新计算。</p><p>如果<code>OnCalculate</code>函数返回一个空值，指标将不会绘制，并且其在数据窗口中的缓冲区的名称和值将被隐藏。</p><p>请注意，返回完整的K线数量<code>rates_total</code>是告知终端和其他将使用该指标的MQL程序其数据已准备好的唯一标准方式。即使一个指标被设计为仅计算和显示有限数量的数据，它也应该返回<code>rates_total</code>。</p><p><code>data</code>数组的索引方向可以通过调用<code>ArraySetAsSeries</code>来选择（默认值为<code>false</code>，可以通过调用<code>ArrayGetAsSeries</code>来验证）。同时，如果我们对该数组应用<code>ArrayIsSeries</code>函数，它将返回<code>true</code>。这意味着这个数组是一个由终端管理的内部数组。指标无法以任何方式更改它，而只能读取它，特别是因为参数描述中有一个<code>const</code>修饰符。</p><p><code>begin</code>参数报告应该从计算中排除的<code>data</code>数组的初始值的数量。当用户以从另一个指标接收数据的方式配置我们的指标时，系统会设置该参数（见上文图片）。例如，如果所选的数据源指标计算一个周期为<code>N</code>的移动平均线，那么根据定义，前<code>N - 1</code>根K线不包含源数据，因为在那里不可能对<code>N</code>根K线进行平均。如果开发者在这个源指标中设置了一个特殊属性，它将在<code>begin</code>参数中正确地传递给我们。我们很快将在实践中检验这一方面（见“跳过初始K线的绘制”部分）。</p><p>让我们尝试创建一个使用简化形式<code>OnCalculate</code>的空指标。它目前还无法执行任何操作，但将为进一步的实验做准备。原始文件<code>IndStub.mq5</code>可以在文件夹<code>MQL5/Indicators/MQL5Book/p5/</code>中找到。为了确保指标正常工作，我们在<code>OnCalculate</code>中添加以下内容：将<code>prev_calculated</code>和<code>rates_total</code>的值输出到日志的功能，以及计算函数调用次数的功能。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> rates_total</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> prev_calculated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> begin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   ++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">count;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 比较上一次调用和当前调用的K线数量</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 仅在有差异时发出信号</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PrintFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;calculated=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rates=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ticks&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         prev_calculated, rates_total, count);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 返回处理的K线数量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><code>prev_calculated</code>和<code>rates_total</code>不相等的条件确保了该消息只会在指标第一次放置在图表上时以及有新K线出现时出现。在当前K线形成过程中到来的所有报价点都不会改变K线的数量，因此<code>prev_calculated</code>和<code>rates_total</code>将相等。然而，我们将在<code>count</code>变量中计算报价点的总数。</p><p>其余参数目前尚未使用，但我们将逐步利用所有这些可能性。</p><p>此源代码可以成功编译，但会生成两个警告：</p><ol><li><code>no indicator window property is defined, indicator_chart_window is applied</code>：没有定义指标窗口属性，应用了<code>indicator_chart_window</code>。</li><li><code>no indicator plot defined for indicator</code>：没有为指标定义绘图。</li></ol><p>这些警告表明缺少一些<code>#property</code>指令，尽管这些指令不是必需的，但它们设置了指标的基本属性。特别是，第一个警告表示没有为指标选择绑定方法：主窗口还是子窗口，因此默认将使用主图表窗口。第二个警告与我们尚未设置要显示的图表数量这一事实有关。如前所述，一些指标是特意设计为没有缓冲区的，因为它们旨在执行其他操作，但在我们的情况下，这是一个提醒，以便稍后添加可视化部分。</p><p>我们将在接下来的几段中处理消除这些警告的问题，但现在，我们将在欧元兑美元（EURUSD）、1分钟（M1）图表上启动该指标。我们使用M1时间框架，因为这样我们可以快速看到新K线的形成以及日志中消息的出现。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>calculated=0 rates=10002; 1 ticks</span></span>
<span class="line"><span>calculated=10002 rates=10003; 30 ticks</span></span>
<span class="line"><span>calculated=10003 rates=10004; 90 ticks</span></span>
<span class="line"><span>calculated=10004 rates=10005; 167 ticks</span></span>
<span class="line"><span>calculated=10005 rates=10006; 240 ticks</span></span></code></pre></div><p>因此，我们看到<code>OnCalculate</code>处理程序按预期被调用，并且你可以在其中对每个报价点和K线进行计算。可以通过从图表上下文菜单中调用“指标列表”对话框来从图表中删除该指标：选择所需的指标并按“删除”（Delete）键。</p><p>现在让我们回到<code>OnCalculate</code>函数的另一个原型。我们已经在实践中尝试了简化版本，但我们也可以为完整形式实现完全相同的空白指标。</p><p>完整形式是为基于标准价格时间序列的计算而设计的，具有以下原型：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> rates_total</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> prev_calculated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">time</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">open</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">high</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">low</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">close</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tick_volume</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">volume</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">spread</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p><code>rates_total</code>和<code>prev_calculated</code>参数的含义与<code>OnCalculate</code>的简单形式中的相同：<code>rates_total</code>设置传输的时间序列的大小（所有数组具有相同的长度，因为这是图表上K线的总数），而<code>prev_calculated</code>包含上一次调用时处理的K线数量（即<code>OnCalculate</code>函数之前使用<code>return</code>语句返回给终端的值）。</p><p><code>open</code>、<code>high</code>、<code>low</code>和<code>close</code>数组包含当前图表K线的相关价格：工作交易品种和时间框架的时间序列。<code>time</code>数组包含每根K线的开盘时间，而<code>tick_volume</code>和<code>volume</code>包含每根K线的交易成交量（报价成交量和实际成交量）。</p><p>在上一章中，我们研究了终端通过一组函数为MQL程序提供的具有标准价格和成交量类型的时间序列。因此，为了方便计算指标，这些时间序列作为数组直接通过引用传递给<code>OnCalculate</code>处理程序。这消除了调用这些函数并将报价复制（重复）到内部数组的需要。当然，这种技术仅适用于那些在与当前图表匹配的工作交易品种和时间框架的一种组合上进行计算的指标。然而，MQL5允许创建多货币、多时间框架的指标，以及针对当前图表之外的交易品种和时间框架的指标。在所有这些情况下，不使用访问时间序列的函数就已经不可能了。稍后我们将看到这是如何实现的。</p><p>如果我们使用<code>ArrayIsSeries</code>检查所有传递的数组是否属于终端，该函数将返回<code>true</code>。所有数组都是只读的。参数描述中的<code>const</code>修饰符也强调了这一点。</p><p>根据计算算法需要的数据在完整形式和简化形式之间进行选择。例如，要使用移动平均算法平滑一个数组，只需要一个输入数组，因此可以为用户选择的任何价格类型构建指标。然而，知名指标抛物线转向指标（ParabolicSAR）或之字形指标（ZigZag）需要最高价和最低价，因此必须使用<code>OnCalculate</code>的完整版本。在接下来的部分中，我们将看到使用<code>OnCalculate</code>简单版本和完整版本的指标示例。</p><h2 id="两种类型的指标-主窗口指标和子窗口指标" tabindex="-1">两种类型的指标：主窗口指标和子窗口指标 <a class="header-anchor" href="#两种类型的指标-主窗口指标和子窗口指标" aria-label="Permalink to &quot;两种类型的指标：主窗口指标和子窗口指标&quot;">​</a></h2><p>如你所知，MetaTrader 5中的指标可以在两个位置显示其线条：在显示报价的主图表窗口中，位于报价之上；或者在价格图表下方创建的单独窗口中。这两种模式是相互排斥的：每个指标要么是为在主窗口中显示而设计，要么是为在子窗口中显示而设计，不能同时结合这两种方式。</p><p>对于那些需要在两个窗口中可视化数据的情况，有几种替代解决方案。例如，可以以两个相互交互的指标的形式来实现一个项目（交互的技术方面有多种可能：可以是资源、文件、数据库管理系统，或者通过动态链接库（DLL）访问的共享内存）。另一种方法是在其中一个窗口（例如在底部面板）中使用指标缓冲区，并在主图表上使用图形对象进行可视化。</p><p>多个指标既可以应用于主窗口，也可以应用于子窗口。如果一个指标是为在单独的窗口中工作而设计的，那么用鼠标将其从“导航器”拖到主窗口时，将自动为该指标创建一个新窗口。然而，如果该窗口已经有一个包含另一个指标的子窗口，那么新的指标可以被拖到相同的位置，从而使两个或更多指标对齐。在这种情况下，在一个窗口中对指标进行各种缩放模式是可行的。默认情况下，每个指标的图形结构会自动且相互独立地缩放到面板的全高，但这是可以更改的（请参阅关于键盘事件部分的示例<code>SubScaler.mq5</code>）。</p><p>指标的显示窗口是通过两个编译指令之一来选择的：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_chart_window</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     // 在图表窗口（主窗口）中显示指标</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_separate_window</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 在单独的窗口（子窗口）中显示指标</span></span></code></pre></div><p>指标开发者应该在源代码的开头插入其中一个指令。如果这两个指令都不存在，默认选项会将指标输出到主窗口，但编译器会生成一个警告。我们在上一节中已经看到了这种情况。在接下来的示例中，我们一定会指定<code>#property indicator_chart_window</code>或<code>#property indicator_separate_window</code>。</p><p>上一节中<code>IndStub.mq5</code>的第二个编译警告涉及缺少缓冲区和图表设置。我们将在下一节中处理这些问题。</p><p>指标设置中“应用于”（Apply to）下拉列表的作用取决于该指标所设计的窗口。</p><ul><li>为单独窗口（子窗口）设计的指标可以应用于子窗口中的指标，但不能应用于主窗口中的指标。</li><li>然而，为主窗口设计的指标可以应用于任何指标，无论是主窗口中的指标还是子窗口中的指标。</li></ul><h2 id="设置缓冲区和图形绘图的数量" tabindex="-1">设置缓冲区和图形绘图的数量 <a class="header-anchor" href="#设置缓冲区和图形绘图的数量" aria-label="Permalink to &quot;设置缓冲区和图形绘图的数量&quot;">​</a></h2><p>为了让指标在图表上显示其计算结果，它必须定义一个或多个数组，并将它们声明为指标缓冲区。缓冲区的数量通过以下指令设置：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_buffers N</span></span></code></pre></div><p>这里的<code>N</code>是一个介于1到512之间的整数。该指令设置了在代码中可用于指标计算的缓冲区数量。</p><p><code>N</code>必须是一个整数常量（字面量）或等效的宏定义。由于这是一个预处理器指令，在源代码预处理阶段还不存在变量（即使带有<code>const</code>修饰符）。</p><p>然而，仅有缓冲区还不足以可视化计算数据。在MQL5中，可视化系统是两级的。第一级由指标缓冲区构成，它们是存储用于显示数据的动态数组。第二级用于管理这些数据的显示方式。它基于被称为图形结构（或图表，或绘图）的新实体构建。关键在于，不同的数据显示方式可能需要不同数量的指标缓冲区。例如，移动平均线每个K线只有一个值，因此对于这样的折线图，一个指标缓冲区就足够了。但是，要显示蜡烛图，每个K线需要4个值（开盘价、最高价、最低价、收盘价）。因此，一个这样的图形绘图需要4个指标缓冲区。</p><p>图表的数量（<code>P</code>）也必须在源代码中使用特殊指令进行定义：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_plots   P</span></span></code></pre></div><p>在最简单的情况下，缓冲区和图表的数量是相同的。但我们很快会分析需要比图形结构更多缓冲区的示例。除了特定类型的图形结构需要预定数量的缓冲区这种情况外，我们有时还需要为中间计算分配一个或多个数组。这样的数组并不直接参与渲染，但包含用于构建渲染缓冲区的数据。当然，你可以为此目的使用简单的动态数组而不将它们声明为缓冲区。但那样的话，我们就必须自己控制和调整它们的大小。将它们设为缓冲区会方便得多，这样就可以指示终端分配内存。</p><p>缓冲区和图形绘图的数量只能使用预处理器指令设置；这些属性不能使用MQL5函数动态更改。</p><p>在确定了缓冲区和图表的数量之后，应该在源代码中描述那些将成为指标缓冲区的数组本身。</p><p>让我们开始开发一个新的指标示例<code>IndReplica1.mq5</code>，以展示源代码中必要的部分。该指标的本质很简单：在它唯一的缓冲区中，我们将显示接收到的<code>data</code>参数数组的值。正如我们之前所说，在将指标应用到图表时，用户会选择要传递给<code>data</code>数组的特定时间序列；默认情况下会提供包含K线收盘价的时间序列。</p><p>让我们添加描述一个缓冲区和一个图表的指令：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_chart_window</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_buffers </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_plots </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span></code></pre></div><p>这些指令并不会分配缓冲区本身，而只是设置指标的属性，并让运行时系统为程序进一步确定和配置指定数量的数组做好准备。接下来，我们将看看如何将一个数组注册为缓冲区。</p><h2 id="将数组指定为缓冲区-setindexbuffer" tabindex="-1">将数组指定为缓冲区：SetIndexBuffer <a class="header-anchor" href="#将数组指定为缓冲区-setindexbuffer" aria-label="Permalink to &quot;将数组指定为缓冲区：SetIndexBuffer&quot;">​</a></h2><p>从程序启动到停止的整个生命周期内，任何<code>double</code>类型的动态数组都能充当指标缓冲区。最常见的定义此类数组的方式是在全局层面进行。不过，在某些情形下，把数组设为类的成员，然后创建带有数组的全局对象会更便利。在实现多货币指标（请参阅“多货币和多时间框架指标”部分的示例<code>IndUnityPercent.mq5</code>）和Delta交易量指标（请参阅“等待数据和管理可见性”部分的<code>IndDeltaVolume.mq5</code>）时，我们会探讨这种方法的实例。</p><p>那么，让我们在全局层面描述一个动态数组缓冲区（不指定大小）：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> buffer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>可以使用终端中的特殊<code>SetIndexBuffer</code>函数将其注册为缓冲区。通常，它会在<code>OnInit</code>处理程序中被调用，就像许多其他用于设置指标的函数一样，我们稍后会讨论这些函数。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> buffer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ENUM_INDEXBUFFER_TYPE mode </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INDICATOR_DATA)</span></span></code></pre></div><p>该函数将由<code>index</code>指定的指标缓冲区与<code>buffer</code>动态数组关联起来。<code>index</code>的值必须介于0到<code>N - 1</code>之间，其中<code>N</code>是由<code>#property indicator_buffers</code>指令指定的缓冲区数量。</p><p>绑定操作完成后，数组还不能立即处理数据，甚至其大小也不会改变，所以初始化和所有计算都应在<code>OnCalculate</code>函数中进行。将动态数组指定为指标缓冲区后，就不能再更改其大小了。对于指标缓冲区，所有调整大小的操作都由终端自行完成。</p><p>数组与指标缓冲区绑定后，索引方向默认与普通数组相同。如有需要，可以使用<code>ArraySetAsSeries</code>函数更改索引方向。</p><p><code>SetIndexBuffer</code>函数在成功时返回<code>true</code>，出错时返回<code>false</code>。</p><p>可选的<code>mode</code>参数告知系统缓冲区将如何使用。可能的值在<code>ENUM_INDEXBUFFER_TYPE</code>枚举中提供：</p><table tabindex="0"><thead><tr><th>标识符</th><th>描述</th></tr></thead><tbody><tr><td>INDICATOR_DATA</td><td>用于渲染的数据</td></tr><tr><td>INDICATOR_COLOR_INDEX</td><td>渲染颜色</td></tr><tr><td>INDICATOR_CALCULATIONS</td><td>中间计算的内部结果</td></tr></tbody></table><p>默认情况下，指标缓冲区用于绘制数据（<code>INDICATOR_DATA</code>）。这个值除了能在图表上显示数组外，还有另一个作用：鼠标指针下K线对应的每个缓冲区的值会显示在数据窗口中。不过，这种行为可以通过一些指标设置来改变（请参阅“图形绘图设置”部分的<code>PLOT_SHOW_DATA</code>属性）。本章的大多数示例都使用<code>INDICATOR_DATA</code>模式。</p><p>如果指标计算需要为每个K线存储中间结果，可以为它们分配一个辅助的、不显示的缓冲区（<code>INDICATOR_CALCULATIONS</code>）。这比使用普通数组实现相同目的更方便，因为这样程序员就无需自行控制其大小。本章将给出两个使用<code>INDICATOR_CALCULATIONS</code>的示例：<code>IndTripleEMA.mq5</code>（请参阅“跳过初始K线的绘制”）和<code>IndSubChartSimple.mq5</code>（请参阅“多货币和多时间框架指标”）。</p><p>某些图形结构允许为每个K线设置显示颜色。颜色缓冲区（<code>INDICATOR_COLOR_INDEX</code>）用于存储颜色信息。颜色由整数类型<code>color</code>表示，但所有指标缓冲区都必须是<code>double</code>类型，在这种情况下，它们存储的是开发者设置的特殊调色板中的颜色编号（请参阅“图表逐元素着色”部分及其示例指标<code>IndColorWPR.mq5</code>）。</p><p>颜色和辅助缓冲区的值不会显示在数据窗口中，也不能使用<code>CopyBuffer</code>函数获取，我们将在“从MQL5使用内置和自定义指标”一章中探讨该函数。</p><p>指标缓冲区不会用任何值进行初始化。如果由于某种原因，其某些元素未被计算（例如，指标设置中对最大K线数量有限制，或者图形结构本身意味着重要元素之间应该有间隔，就像之字形指标的顶点之间那样），那么应该用一个特殊的“空”值显式填充它们。这个空值不会在图表上显示，也不会在数据窗口中显示。默认情况下，有一个<code>EMPTY_VALUE</code>（<code>DBL_MAX</code>）常量用于此目的，但如有需要，可以用任何其他值替换，例如0。这可以使用<code>PlotIndexSetDouble</code>函数来完成。</p><p>基于对<code>SetIndexBuffer</code>函数的新认识，让我们完成上一节开始的示例<code>IndReplica1.mq5</code>。特别是，我们需要<code>OnInit</code>处理程序：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_chart_window</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_buffers </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_plots </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;MQL5Book/PRTF.mqh&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> buffer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // global dynamic array</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // register an array as an indicator buffer</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, buffer));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // true / ok</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // the second incorrect call is made here intentionally to show an error</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, buffer));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // false / BUFFERS_WRONG_INDEX(4602)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // check size: still 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArraySize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buffer));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INIT_SUCCEEDED;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>缓冲区的数量由指令定义为1，所以为单个缓冲区分配数组时使用索引0（<code>SetIndexBuffer</code>的第一个参数）。第二次函数调用是错误的，添加它只是为了演示问题：由于索引1意味着声明了两个缓冲区，它会生成一个<code>BUFFERS_WRONG_INDEX</code>（4602）错误。</p><p>在<code>OnCalculate</code>函数的开头，让我们再次打印数组的大小。此时，它已经根据K线数量进行了分配：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> rates_total</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> prev_calculated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> begin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // after starting, check that the platform automatically manages the size of the array</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArraySize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buffer));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 10189 - actual number of bars</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span></code></pre></div><p>现在让我们来看看我们的指标将进行什么计算。如前所述，我们暂时不会使用复杂的公式，只是尝试将<code>data</code>参数中传递的时间序列复制到缓冲区中。这反映在指标的名称中：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // on each new bar or set of bars (including the first calculation)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // fill in all new bars</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArrayCopy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buffer, data, prev_calculated, prev_calculated);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   else</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // ticks on the current bar</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // update the last bar</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">      buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // we report the number of processed bars to ourselves in the future</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>现在，指标编译时没有任何警告。我们可以在图表上运行它，在默认设置下，它应该在缓冲区中复制K线的收盘价。这是由于<code>OnCalculate</code>的简化形式，我们在“指标的主要事件：OnCalculate”部分讨论过这个方面。</p><p>然而，有一个奇怪的现象：我们的缓冲区显示在数据窗口中，并且包含正确的值，但图表上没有线条。这是因为负责显示的是图形结构，而不是缓冲区。在当前版本的指标中，我们只配置了缓冲区。在下一节中，我们将创建一个新的版本<code>IndReplica2.mq5</code>，并补充必要的指令。</p><p>同时，上述效果对于创建“隐藏”指标很有用，这些指标不会在图表上显示其线条，但可以被其他MQL程序以编程方式读取。如果需要，开发者甚至可以在数据窗口中隐藏对指标缓冲区的提及（请参阅下一节的<code>PLOT_SHOW_DATA</code>）。</p><p>如何从MQL5代码管理指标将在下一章讨论。</p><h3 id="绘图设置-plotindexsetinteger" tabindex="-1">绘图设置：PlotIndexSetInteger <a class="header-anchor" href="#绘图设置-plotindexsetinteger" aria-label="Permalink to &quot;绘图设置：PlotIndexSetInteger&quot;">​</a></h3><p>MQL5 API提供了以下用于配置绘图的函数：<code>PlotIndexSetInteger</code>、<code>PlotIndexSetDouble</code> 和 <code>PlotIndexSetString</code>。整型属性也可以通过 <code>PlotIndexGetInteger</code> 来读取。我们主要关注整型属性。</p><p><code>PlotIndexSetInteger</code> 函数有两种形式。稍后我们会看到它们的区别。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ENUM_PLOT_PROPERTY_INTEGER</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> property</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ENUM_PLOT_PROPERTY_INTEGER</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> property</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> modifier</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数用于设置指定索引处图形绘图的属性值。<code>index</code> 的值必须在 0 到 <code>P - 1</code> 之间，其中 <code>P</code> 是由 <code>#property indicator_plots</code> 指令指定的绘图数量。属性本身由 <code>property</code> 参数标识：允许的值应从 <code>ENUM_PLOT_PROPERTY_INTEGER</code> 枚举中选取（见下文）。属性值通过 <code>value</code> 参数传递。</p><p>函数的第二种形式用于适用于多个组件的属性（尽管它们属于同一属性）。特别是对于某些类型的图表，可以分配一组颜色而不是一种颜色。在这种情况下，你可以使用 <code>modifier</code> 参数来更改此集合中的任何颜色。</p><p>如果成功，函数返回 <code>true</code>；否则返回 <code>false</code>。</p><p>以下表格提供了可用的 <code>ENUM_PLOT_PROPERTY_INTEGER</code> 属性。</p><table tabindex="0"><thead><tr><th>标识符</th><th>描述</th><th>属性类型</th></tr></thead><tbody><tr><td>PLOT_ARROW</td><td>用于 <code>DRAW_ARROW</code> 图表的 Wingdings 字体箭头代码</td><td>uchar</td></tr><tr><td>PLOT_ARROW_SHIFT</td><td><code>DRAW_ARROW</code> 图表的箭头垂直偏移量</td><td>int</td></tr><tr><td>PLOT_DRAW_BEGIN</td><td>数据开始的第一个柱线（从左到右）的索引</td><td>int</td></tr><tr><td>PLOT_DRAW_TYPE</td><td>绘图（图表）类型</td><td>ENUM_DRAW_TYPE</td></tr><tr><td>PLOT_SHOW_DATA</td><td>在数据窗口中显示绘图值的标志（<code>true</code> — 可见，<code>false</code> — 不可见）</td><td>bool</td></tr><tr><td>PLOT_SHIFT</td><td>指标图形沿时间轴的柱线偏移量（正值向右偏移，负值向左偏移）</td><td>int</td></tr><tr><td>PLOT_LINE_STYLE</td><td>线条绘制样式</td><td>ENUM_LINE_STYLE</td></tr><tr><td>PLOT_LINE_WIDTH</td><td>线条粗细（以像素为单位，范围 1 - 5）</td><td>int</td></tr><tr><td>PLOT_COLOR_INDEXES</td><td>颜色数量（1 - 64）</td><td>int</td></tr><tr><td>PLOT_LINE_COLOR</td><td>渲染颜色（<code>modifier</code> — 颜色编号）</td><td>color</td></tr></tbody></table><p>我们会逐步了解所有属性，但目前我们将重点关注三个主要属性：<code>PLOT_DRAW_TYPE</code>、<code>PLOT_LINE_STYLE</code> 和 <code>PLOT_LINE_COLOR</code>。</p><p>MetaTrader 5 中的指标支持几种预定义的绘图类型。它们决定了视觉表示形式以及用于显示的初始数据缓冲区的所需结构。</p><p>总共有 10 种这样的基本绘图，在 MQL5 级别，它们由 <code>ENUM_DRAW_TYPE</code> 枚举中的标识符描述。应该将 <code>ENUM_DRAW_TYPE</code> 的值之一赋给 <code>PLOT_DRAW_TYPE</code> 属性。</p><table tabindex="0"><thead><tr><th>可视化类型，示例</th><th>描述</th><th>缓冲区数量</th></tr></thead><tbody><tr><td>DRAW_NONE <br> IndDeltaVolume.mq5</td><td>图表上不显示任何内容，但相应缓冲区的值在数据窗口中可用</td><td>1</td></tr><tr><td>DRAW_LINE <br> IndLabelHighLowClose.mq5, IndWPR.mq5, IndUnityPercent.mq5</td><td>根据缓冲区值绘制曲线（“空”元素会在曲线上形成间隙）</td><td>1</td></tr><tr><td>DRAW_SECTION</td><td>在“非空”缓冲区元素之间形成折线的直线段（如果没有间隙，与 <code>DRAW_LINE</code> 类似）</td><td>1</td></tr><tr><td>DRAW_ARROW <br> IndReplica3.mq5, IndFractals.mq5</td><td>字符（标签）</td><td>1</td></tr><tr><td>DRAW_HISTOGRAM <br> IndDeltaVolume.mq5</td><td>从零线到缓冲区值的直方图</td><td>1</td></tr><tr><td>DRAW_HISTOGRAM2 <br> IndLabelHighLowClose.mq5</td><td>两个指标缓冲区的配对元素值之间的直方图</td><td>2</td></tr><tr><td>DRAW_ZIGZAG <br> IndFractalsZigZag.mq5</td><td>在两个缓冲区中连续出现的“非空”元素之间形成折线的直线段（类似于 <code>DRAW_SECTION</code>，但与它不同的是，允许在一个柱线上有垂直段）</td><td>2</td></tr><tr><td>DRAW_FILLING</td><td>通过两个缓冲区中的配对值对两条线之间的通道进行颜色填充</td><td>2</td></tr><tr><td>DRAW_BARS <br> IndSubChartSimple.mq5</td><td>以柱状图形式显示：每个柱线的四个价格按 OHLC 顺序显示在四个相邻的缓冲区中</td><td>4</td></tr><tr><td>DRAW_CANDLES <br> IndSubChartSimple.mq5</td><td>以蜡烛图形式显示：每个柱线的四个价格按 OHLC 顺序显示在四个相邻的缓冲区中</td><td>4</td></tr></tbody></table><p>此表未列出所有 <code>ENUM_DRAW_TYPE</code> 元素。有一些相同绘图类型的变体支持对单个元素（柱状图）进行着色。我们将在单独的“图表逐元素着色”部分介绍它们。MQL5 文档为所有类型提供了示例，在本书范围内有一些例外情况：在类型名称旁边标明了演示指标的存在。</p><p>在所有情况下，包括 <code>DRAW_NONE</code>，其他程序都可以通过 <code>CopyBuffer</code> 函数访问缓冲区中的数据。</p><p><code>DRAW_NONE</code> 类型的一个额外特性是，此类缓冲区的值不参与自动图表缩放，而默认情况下，显示在子窗口中的指标会启用自动图表缩放。</p><p>线条的样式由 <code>PLOT_LINE_STYLE</code> 属性决定，该属性也有一个包含有效 <code>ENUM_LINE_STYLE</code> 值的枚举。</p><table tabindex="0"><thead><tr><th>标识符</th><th>描述</th></tr></thead><tbody><tr><td>STYLE_SOLID</td><td>实线</td></tr><tr><td>STYLE_DASH</td><td>虚线</td></tr><tr><td>STYLE_DOT</td><td>点线</td></tr><tr><td>STYLE_DASHDOT</td><td>点划线</td></tr><tr><td>STYLE_DASHDOTDOT</td><td>双点划线</td></tr></tbody></table><p>最后，线条的颜色由 <code>PLOT_LINE_COLOR</code> 属性设置。在最简单的情况下，此属性包含整个图表的单一颜色。对于某些图表类型，特别是 <code>DRAW_CANDLES</code>，可以使用 <code>modifier</code> 参数指定多种颜色。我们稍后会讨论这个问题（见“多货币和多时间框架指标”部分的示例 <code>IndSubChartSimple.mq5</code>）。</p><p>上述三个属性足以演示指标 <code>IndReplica2.mq5</code>。让我们分别添加两个 <code>ENUM_DRAW_TYPE</code> 和 <code>ENUM_LINE_STYLE</code> 类型的输入参数 <code>DrawType</code> 和 <code>LineStyle</code>，然后在 <code>OnInit</code> 中多次调用 <code>PlotIndexSetInteger</code> 函数来设置指标的渲染属性。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_chart_window</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_buffers </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_plots </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input ENUM_DRAW_TYPE DrawType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DRAW_LINE;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input ENUM_LINE_STYLE LineStyle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> STYLE_SOLID;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> buffer[];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 将数组注册为指标缓冲区</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, buffer);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 设置编号为 0 的图表的属性</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_DRAW_TYPE, DrawType);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_LINE_STYLE, LineStyle);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_LINE_COLOR, clrBlue);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INIT_SUCCEEDED;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>对于 <code>PLOT_LINE_COLOR</code> 属性，我们没有创建输入变量，因为此属性和其他一些属性可以直接从任何指标的属性对话框的“颜色”选项卡中访问。默认情况下，即指标启动后立即，线条颜色将为蓝色。但是，颜色以及线条粗细和样式可以在对话框（在指定选项卡上）中更改。我们的 <code>LineStyle</code> 参数部分重复了“颜色”表中相应的“样式”单元格。然而，它提供了额外的优势。对话框的标准控件在线条宽度大于 1 时不允许选择样式。当使用输入变量 <code>LineStyle</code> 时，我们可以得到例如宽度为 3 像素的点划线。</p><p>在 <code>OnCalculate</code> 中填充缓冲区数据与 <code>IndReplica1.mq5</code> 相比保持不变。</p><p>在编译并在图表上启动指标后，我们得到了预期的结果：图表上收盘价处有一条蓝色线条，并且数据窗口中显示了相应的柱线收盘价。</p><p>通过更改 <code>DrawType</code> 输入参数，我们可以更改缓冲区中数据的显示方式。在这种情况下，你应该只选择需要单个缓冲区的类型。任何其他图形类型（<code>DRAW_HISTOGRAM2</code>、<code>DRAW_ZIGZAG</code>、<code>DRAW_FILLING</code>、<code>DRAW_BARS</code>、<code>DRAW_CANDLES</code>）在单个缓冲区上根本无法工作，并且不会显示任何内容。选择带有着色的构造类型（以“Color”开头）也没有意义，因为它们需要一个额外的缓冲区，其中包含每个柱线的颜色编号（正如已经提到的，我们将在“图表逐元素着色”部分了解这种可能性）。</p><p>下面展示了 <code>DRAW_LINE</code>、<code>DRAW_SECTION</code>、<code>DRAW_HISTOGRAM</code> 和 <code>DRAW_ARROW</code> 的显示选项。</p><h2 id="单缓冲区图表类型" tabindex="-1">单缓冲区图表类型 <a class="header-anchor" href="#单缓冲区图表类型" aria-label="Permalink to &quot;单缓冲区图表类型&quot;">​</a></h2><p>如果不是特意选择了不同的样式，<code>DRAW_LINE</code> 使用 <code>STYLE_SOLID</code> 而 <code>DRAW_SECTION</code> 使用 <code>STYLE_DOT</code>，这些绘图类型将是相同的，因为我们缓冲区中的所有元素都有“非空”值。默认情况下，“空”值意味着特殊常量 <code>EMPTY_VALUE</code>，我们没有使用它。<code>DRAW_SECTION</code> 中的线段会绕过“空”元素绘制，只有在存在“空”元素时这一点才会变得明显。我们将在“数据间隙可视化”部分讨论“空”元素的设置。</p><p>从零开始的直方图 <code>DRAW_HISTOGRAM</code> 通常用于具有自己窗口的指标，但这里为了演示目的展示了它。我们将在“等待数据和管理可见性”部分创建一个具有这种渲染类型的子窗口指标（见示例 <code>IndDeltaVolume.mq5</code>）。</p><p>对于 <code>DRAW_ARROW</code> 类型，系统默认使用填充圆圈字符（代码 159），但你可以通过调用 <code>PlotIndexSetInteger(index, PLOT_ARROW, code)</code> 将其更改为其他字符。</p><p>Wingdings 字体符号的代码和外观可以在 MQL5 帮助文档中找到。</p><p>在 <code>IndReplica3.mq5</code> 指标的另一个修改版本中，我们添加了输入参数来选择“箭头”符号（<code>ArrowCode</code>），以及在图表上垂直（<code>Arrow padding</code>）和水平（<code>TimeShift</code>）移动这些标签。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input uchar ArrowCode </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 159</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ArrowPadding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TimeShift </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>沿价格刻度的垂直偏移量以像素为单位指定（正值表示向下偏移，负值表示向上偏移）。沿时间刻度的水平偏移量以柱线为单位设置（正值表示向右偏移，即向未来偏移，负值表示向左偏移，即向过去偏移）。新的输入变量在 <code>OnInit</code> 中传递给 <code>PlotIndexSetInteger</code> 调用。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_DRAW_TYPE, DRAW_ARROW);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_ARROW, ArrowCode);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_ARROW_SHIFT, ArrowPadding);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_SHIFT, TimeShift);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>以下截图展示了 <code>IndReplica3.mq5</code> 在图表上的一个示例，设置为 117（菱形）、-50（向上 50 点）、3（向右/向前 3 个柱线）。</p><h3 id="带有垂直和水平标签偏移的散点图" tabindex="-1">带有垂直和水平标签偏移的散点图 <a class="header-anchor" href="#带有垂直和水平标签偏移的散点图" aria-label="Permalink to &quot;带有垂直和水平标签偏移的散点图&quot;">​</a></h3><p>我们的默认指标基于收盘价类型（尽管用户可以在属性对话框的“应用于”下拉列表中更改此设置）。如果需要，你可以使用以下指令分配不同的初始设置：</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_applied_price PRICE_TYPE</span></span></code></pre></div><p>这里，应将 <code>ENUM_APPLIED_PRICE</code> 枚举中的任何常量替换 <code>PRICE_TYPE</code>。其中也包括 <code>PRICE_CLOSE</code>，它对应于默认值。例如，将以下指令添加到源代码中，将使指标默认基于典型价格。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_applied_price PRICE_TYPICAL</span></span></code></pre></div><p>再次强调，此设置仅指定默认值。内置的 <code>_AppliedTo</code> 变量允许你了解指标所基于的实际价格类型。如果指标是根据另一个指标的描述符构建的，那么只能知道这一事实，而无法知道提供数据的具体指标的名称。</p><p>要在源代码中了解 <code>ENUM_PLOT_PROPERTY_INTEGER</code> 枚举中属性的当前状态，请使用 <code>PlotIndexGetInteger</code> 函数。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PlotIndexGetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ENUM_PLOT_PROPERTY_INTEGER</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> property</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PlotIndexGetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ENUM_PLOT_PROPERTY_INTEGER</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> property</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> modifier</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数通常与 <code>PlotIndexSetInteger</code> 一起使用，用于将绘图属性从一条线复制到另一条线，或者从包含在各种指标源代码中的通用 <code>.mqh</code> 文件的代码中读取属性。</p><p>遗憾的是，没有提供类似的 <code>PlotIndexGetDouble</code> 和 <code>PlotIndexGetString</code> 函数。</p><h2 id="缓冲区和图表的映射规则" tabindex="-1">缓冲区和图表的映射规则 <a class="header-anchor" href="#缓冲区和图表的映射规则" aria-label="Permalink to &quot;缓冲区和图表的映射规则&quot;">​</a></h2><p>在使用 <code>PlotIndexSetInteger(i, PLOT_DRAW_TYPE, type)</code> 注册图表时，每次调用都会根据渲染类型所需的数量，依次为第 <code>i</code> 个图表分配一定数量的缓冲区（见上一节的 <code>ENUM_DRAW_TYPE</code> 表格）。因此，在将缓冲区与后续图表关联时（在后续的 <code>PlotIndexSetInteger</code> 调用期间），这些数量的缓冲区将不再被考虑。</p><p>例如，如果第一个绘图（索引为 0）是 <code>DRAW_CANDLES</code> 类型，它需要 4 个指标缓冲区，那么恰好会有 4 个缓冲区与之关联。这样，索引从 0 到 3（包含）的缓冲区将被绑定，下一个可绑定的空闲缓冲区的索引将是 4。</p><p>如果接下来注册一个简单的折线图 <code>DRAW_LINE</code>（它在图表序列中的索引是 1），它只需要 1 个缓冲区，即索引为 4 的缓冲区。</p><p>如果进一步配置一个 <code>DRAW_ZIGZAG</code> 图表（下一个图表索引是 2），由于它使用两个缓冲区，那么索引为 5 和 6 的缓冲区将分配给它。</p><p>当然，缓冲区的数量必须足够满足所有已注册的绘图需求。上述示例在下面的表格中进行了说明。该示例只有 7 个缓冲区和 3 个绘图（图表）。</p><table tabindex="0"><thead><tr><th>在 <code>SetIndexBuffer</code> 中的缓冲区索引</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th></tr></thead><tbody><tr><td>在 <code>PlotIndexSetInteger</code> 中的图表索引</td><td>0</td><td>1</td><td>2</td><td></td><td></td><td></td><td></td></tr><tr><td>渲染类型</td><td><code>DRAW_CANDLES</code></td><td><code>DRAW_LINE</code></td><td><code>DRAW_ZIGZAG</code></td><td></td><td></td><td></td><td></td></tr></tbody></table><p>缓冲区和图表的索引是相互独立的，也就是说，缓冲区索引不必与图表索引相同。同时，随着图表索引的增加，与之绑定的缓冲区索引也会增加，如果使用的渲染类型需要多个缓冲区，那么索引之间的差异可能会越来越大。</p><p>虽然通常习惯在调用 <code>PlotIndexSetInteger</code> 之前调用 <code>SetIndexBuffer</code> 函数，但这并不是强制要求。唯一重要的是缓冲区索引和图表索引的正确对应关系。当使用指令（见下一节）时，这些指令是 <code>PlotIndexSetInteger</code> 的替代方式，无论如何，指令都会在 <code>OnInit</code> 处理程序之前执行。</p><p>为了演示缓冲区索引和图表索引之间的区别，我们来看一个简单的示例 <code>IndHighLowClose.mq5</code>。在这个文件中，我们将以 <code>DRAW_HISTOGRAM2</code> 类型的直方图形式绘制每个蜡烛图的最高价和最低价之间的范围，并使用简单的折线 <code>DRAW_LINE</code> 来标记收盘价。为了访问不同类型价格的时间序列数据，我们还需要将 <code>OnCalculate</code> 函数的形式从简化版改为完整版。</p><p>由于直方图需要 2 个缓冲区，再加上用于绘制收盘价折线的缓冲区，我们应该定义三个缓冲区。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_chart_window</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_buffers </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_plots </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> highs[];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lows[];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> closes[];</span></span></code></pre></div><p>在 <code>OnInit</code> 函数中按优先级对它们进行注册。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 为 3 种价格类型的缓冲区分配数组</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, highs);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, lows);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, closes);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 在索引 0 处绘制最高价和最低价之间的直方图</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_DRAW_TYPE, DRAW_HISTOGRAM2);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_LINE_WIDTH, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_LINE_COLOR, clrBlue);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 在索引 1 处绘制收盘价折线</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_DRAW_TYPE, DRAW_LINE);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_LINE_WIDTH, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_LINE_COLOR, clrRed);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INIT_SUCCEEDED;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>顺便提一下，直方图的宽度被设置为 5 像素，折线的宽度被设置为 2 像素。没有显式指定样式，默认使用 <code>STYLE_SOLID</code>。</p><p>现在让我们来看一下实际的 <code>OnCalculate</code> 函数。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> rates_total</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> prev_calculated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> datetime</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">open</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">high</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">low</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tick_volume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">volume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">spread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 在每个新的柱线或一组柱线（包括首次计算）上</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 填充所有新的柱线</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        ArrayCopy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(highs, high, prev_calculated, prev_calculated);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        ArrayCopy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lows, low, prev_calculated, prev_calculated);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        ArrayCopy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(closes, close, prev_calculated, prev_calculated);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 当前柱线上的报价</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 更新最后一个柱线</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        highs[rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> high[rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        lows[rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> low[rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        closes[rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> close[rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 返回下一次调用时已处理的柱线数量</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>该指标的结果如下图所示：</p><h3 id="高低价直方图和收盘价折线" tabindex="-1">高低价直方图和收盘价折线 <a class="header-anchor" href="#高低价直方图和收盘价折线" aria-label="Permalink to &quot;高低价直方图和收盘价折线&quot;">​</a></h3><p>请注意一个重要的点。图表会按照其索引的顺序绘制在图表上，因此有些图表在视觉上会高于其他图表（覆盖其他图表）。在这种情况下，索引为 0 的直方图会首先绘制，然后索引为 1 的折线会绘制在其上方。有时，更改图表的注册顺序是有意义的，这样可以让较小的图形结构更容易被看到，因为它们可能会被较大（较宽）的绘图所覆盖。</p><p>在假想的 Z 轴上设置这种优先级（Z 轴垂直于屏幕并深入屏幕内部）被称为 Z 顺序。在学习图形对象时，我们还会再次遇到这种技术。</p><p>另外，请记住，默认情况下，指标会显示在价格图表的上方，但可以在设置中更改此行为：在“图表属性”对话框的“常规”选项卡中，有“图表在前景”选项。在软件界面中也有类似的选项（<code>ChartSetInteger(CHART_FOREGROUND)</code>，见“图表显示模式”部分）。</p><h2 id="使用指令自定义绘图" tabindex="-1">使用指令自定义绘图 <a class="header-anchor" href="#使用指令自定义绘图" aria-label="Permalink to &quot;使用指令自定义绘图&quot;">​</a></h2><p>到目前为止，我们一直使用 <code>PlotIndexSetInteger</code> 函数调用来自定义图形绘图。MQL5 允许你使用 <code>#property</code> 预处理器指令来实现相同的功能。这两种方法的主要区别在于，指令在编译时进行处理，使用它们描述的属性在加载可执行文件时就会被读取，甚至在 <code>OnInit</code> 处理程序（如果存在）执行之前。也就是说，指令提供了一些默认值，如果你不需要更改这些值，就可以直接使用。</p><p>另一方面，<code>PlotIndexSetInteger</code> 函数调用允许你在程序执行期间动态更改属性。使用函数动态更改属性可以让你创建更灵活的指标使用场景。下面的表格展示了这些指令以及相关的 <code>PlotIndexSetInteger</code> 函数调用。</p><table tabindex="0"><thead><tr><th>指令</th><th>函数</th><th>描述</th></tr></thead><tbody><tr><td><code>indicator_colorN</code></td><td><code>PlotIndexSetInteger(N - 1, PLOT_LINE_COLOR, color)</code></td><td>绘图的线条颜色</td></tr><tr><td><code>indicator_styleN</code></td><td><code>PlotIndexSetInteger(N - 1, PLOT_LINE_STYLE, type)</code></td><td><code>ENUM_LINE_STYLE</code> 枚举中的绘图样式</td></tr><tr><td><code>indicator_typeN</code></td><td><code>PlotIndexSetInteger(N - 1, PLOT_DRAW_TYPE, type)</code></td><td><code>ENUM_DRAW_TYPE</code> 枚举中的绘图类型</td></tr><tr><td><code>indicator_widthN</code></td><td><code>PlotIndexSetInteger(N - 1, PLOT_LINE_WIDTH, width)</code></td><td>线条粗细（以像素为单位，范围 1 - 5）</td></tr></tbody></table><p>请注意，指令中绘图的编号从 1 开始，而在函数中从 0 开始。例如，指令 <code>#property indicator_type1 DRAW_ZIGZAG</code> 等同于调用 <code>PlotIndexSetInteger(0, PLOT_DRAW_TYPE, DRAW_ZIGZAG)</code>。</p><p>还值得注意的是，通过函数可以设置的属性比通过指令设置的要多得多：<code>ENUM_PLOT_PROPERTY_INTEGER</code> 枚举提供了十个元素。</p><p>即使首次将指标放置在图表上，指令描述的属性在指标设置对话框中也是可用的（用户可以看到并编辑）。特别是，这包括线条的粗细、颜色和样式（“颜色”选项卡），以及水平线条的数量和位置（“水平线条”选项卡）。由函数设置的相同属性（如果指令中没有默认值）只会在第二次及以后出现在对话框中。</p><p>让我们调整 <code>IndHighLowClose.mq5</code> 指标以使用指令。新版本在 <code>IndPropHighLowClose.mq5</code> 文件中。使用指令简化了 <code>OnInit</code> 处理程序；<code>OnCalculate</code> 保持不变。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_chart_window</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_buffers </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_plots </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 高低价直方图渲染设置（在指令中将索引 0 改为 1）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_type1   DRAW_HISTOGRAM2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_style1  STYLE_SOLID</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 默认值，可以省略</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_color1  clrBlue</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_width1  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 收盘价折线绘图设置（在指令中将索引 1 改为 2）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_type2   DRAW_LINE</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_style2  STYLE_SOLID</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 默认值，可以省略</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_color2  clrRed</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_width2  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> highs[];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lows[];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> closes[];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 为 3 种价格类型的缓冲区分配数组</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, highs);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, lows);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, closes);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INIT_SUCCEEDED;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>新指标的外观与旧指标完全相同。</p><h2 id="设置绘图名称" tabindex="-1">设置绘图名称 <a class="header-anchor" href="#设置绘图名称" aria-label="Permalink to &quot;设置绘图名称&quot;">​</a></h2><p>在本章前面的示例中，数据窗口中的指标缓冲区是以指标本身的名称来标识的，这缺乏信息性。MQL5 API 提供了为每个缓冲区设置自定义名称的功能。这可以通过我们已经了解的两种方式来实现：使用 <code>#property</code> 指令和调用特殊的 <code>PlotIndexSetString</code> 函数。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PlotIndexSetString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ENUM_PLOT_PROPERTY_STRING</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> property</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">string</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数原型与 <code>PlotIndexSetInteger</code> 类似，只是属性的类型（<code>value</code> 参数）为字符串。该函数仅支持 <code>PLOT_LABEL</code> 属性（它是 <code>ENUM_PLOT_PROPERTY_STRING</code> 枚举常量）。<code>index</code> 参数中的自定义图表索引必须介于 0 到 <code>N - 1</code> 之间，其中 <code>N</code> 是 <code>#property indicator_plots N</code> 中指定的绘图总数。</p><p>使用指令时，图表索引应加 1，因为指令中绘图的编号从 1 开始，而函数参数中的编号从 0 开始。</p><table tabindex="0"><thead><tr><th>指令</th><th>函数</th><th>描述</th></tr></thead><tbody><tr><td><code>#property indicator_labelN</code></td><td><code>PlotIndexSetString(N - 1, PLOT_LABEL, string)</code></td><td>指定要在数据窗口和工具提示中显示的文本标签</td></tr></tbody></table><p>对于需要多个指标缓冲区的图形序列（例如 <code>DRAW_CANDLES</code>、<code>DRAW_FILLING</code> 等），标签名称使用 <code>;</code> 分隔符指定。</p><p>当鼠标悬停在图表上时，标签也会显示在工具提示中。</p><p>在 <code>IndLabelHighLowClose.mq5</code> 示例中，我们添加了两个指令（与 <code>IndPropHighLowClose.mq5</code> 的区别）。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_label1  </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;High;Low&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_label2  </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Close&quot;</span></span></code></pre></div><p>现在，在数据窗口中显示指标时，理解出现的值变得容易多了。</p><h2 id="可视化数据间隙-空元素" tabindex="-1">可视化数据间隙（空元素） <a class="header-anchor" href="#可视化数据间隙-空元素" aria-label="Permalink to &quot;可视化数据间隙（空元素）&quot;">​</a></h2><p>在许多情况下，指标读数应该仅在某些柱线上显示，而其余柱线保持不变（从视觉上看，没有额外的线条或标签）。例如，许多信号指标会在出现买入或卖出建议的柱线上显示向上或向下的箭头。但信号是很少出现的。</p><p>不显示在图表或数据窗口中的空值是使用 <code>PlotIndexSetDouble</code> 函数来设置的。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PlotIndexSetDouble</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ENUM_PLOT_PROPERTY_DOUBLE</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> property</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数为指定索引处的绘图设置双精度属性。此类属性的集合总结在 <code>ENUM_PLOT_PROPERTY_DOUBLE</code> 枚举中，但目前它只有一个元素：<code>PLOT_EMPTY_VALUE</code>，它也用于设置空值。该值本身通过最后一个参数 <code>value</code> 传递。</p><p>作为一个具有稀少值的指标示例，我们将考虑一个分形检测器。它会在图表上标记出比其两侧 <code>N</code> 个相邻柱线的最高价更高的最高价（<code>High</code>），以及比其两侧 <code>N</code> 个相邻柱线的最低价更低的最低价（<code>Low</code>）。该指标文件名为 <code>IndFractals.mq5</code>。</p><p>该指标将有两个缓冲区和两个 <code>DRAW_ARROW</code> 类型的图形绘图。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_chart_window</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_buffers </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_plots   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 渲染设置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_type1   DRAW_ARROW</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_type2   DRAW_ARROW</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_color1  clrBlue</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_color2  clrRed</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_label1  </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Fractal Up&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_label2  </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Fractal Down&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 指标缓冲区</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UpBuffer[];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DownBuffer[];</span></span></code></pre></div><p><code>FractalOrder</code> 输入变量将允许你设置相邻柱线的数量，通过这个数量来确定最高价或最低价的极值。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FractalOrder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>为了使箭头符号更清晰可见，我们将让箭头符号与极值之间有 10 像素的缩进。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ArrowShift </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>在 <code>OnInit</code> 函数中，声明数组作为缓冲区并将它们绑定到图形绘图上。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 绑定缓冲区</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, UpBuffer, INDICATOR_DATA);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, DownBuffer, INDICATOR_DATA);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 向上和向下箭头的字符代码</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_ARROW, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">217</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_ARROW, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">218</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 箭头的缩进</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_ARROW_SHIFT, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ArrowShift);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_ARROW_SHIFT, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ArrowShift);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 设置空值（可以省略，因为默认空值是 EMPTY_VALUE）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetDouble</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_EMPTY_VALUE, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetDouble</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_EMPTY_VALUE, EMPTY_VALUE);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FractalOrder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INIT_SUCCEEDED </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INIT_PARAMETERS_INCORRECT;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>请注意，默认的空值是特殊常量 <code>EMPTY_VALUE</code>，所以上面的 <code>PlotIndexSetDouble</code> 调用是可选的。</p><p>在 <code>OnCalculate</code> 处理程序中，在第一次调用时，我们用 <code>EMPTY_VALUE</code> 初始化两个数组，然后在柱线形成时将其赋给新的元素。进行初始化是必要的，因为分配给缓冲区的内存可能包含任意数据（无用数据）。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> rates_total</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> prev_calculated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> datetime</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">open</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">high</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">low</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tick_volume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">volume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">spread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 开始时，完全填充数组</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        ArrayInitialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(UpBuffer, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        ArrayInitialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(DownBuffer, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 在新的柱线上，我们也要清空元素</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prev_calculated; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            UpBuffer[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EMPTY_VALUE;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            DownBuffer[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EMPTY_VALUE;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span></code></pre></div><p>在主循环中，逐柱比较最高价和最低价与相邻柱线的同类型价格，并在每侧的 <code>FractalOrder</code> 个柱线中找到极值的位置设置标记。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 查看所有或新的柱线，这些柱线在 FractalOrder 范围内有柱线</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fmax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FractalOrder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, FractalOrder);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FractalOrder; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 检查最高价是否高于相邻柱线</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        UpBuffer[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> high[i];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FractalOrder; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">j)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(high[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> high[i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> j] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> high[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> high[i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> j])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                UpBuffer[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EMPTY_VALUE;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 检查最低价是否低于相邻柱线</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        DownBuffer[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> low[i];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FractalOrder; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">j)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(low[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> low[i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> j] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> low[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> low[i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> j])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                DownBuffer[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EMPTY_VALUE;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>让我们看看这个指标在图表上的样子。</p><h3 id="分形指标" tabindex="-1">分形指标 <a class="header-anchor" href="#分形指标" aria-label="Permalink to &quot;分形指标&quot;">​</a></h3><p>现在让我们将绘图类型从 <code>DRAW_ARROW</code> 更改为 <code>DRAW_ZIGZAG</code>，并比较两种选项下空值的效果。结果应该是在分形上绘制出一个之字形折线。修改后的指标版本在 <code>IndFractalsZigZag.mq5</code> 文件中。</p><p>主要的变化之一涉及图表的数量：现在是一个，因为 <code>DRAW_ZIGZAG</code> “占用” 了两个缓冲区。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_chart_window</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_buffers </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_plots   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 渲染设置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_type1   DRAW_ZIGZAG</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_color1  clrMediumOrchid</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_width1  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_label1  </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ZigZag Up;ZigZag Down&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span></code></pre></div><p>所有与设置箭头相关的函数调用都从 <code>OnInit</code> 中移除了。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, UpBuffer, INDICATOR_DATA);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, DownBuffer, INDICATOR_DATA);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetDouble</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_EMPTY_VALUE, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FractalOrder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INIT_SUCCEEDED </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INIT_PARAMETERS_INCORRECT;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>其余的源代码保持不变。</p><p>下面的图片展示了一个图表，在这个图表上除了分形之外还应用了之字形折线：这样，你可以直观地比较它们的结果。两个指标完全独立工作，但由于算法相同，找到的极值也是相同的。</p><h3 id="基于分形的之字形指标" tabindex="-1">基于分形的之字形指标 <a class="header-anchor" href="#基于分形的之字形指标" aria-label="Permalink to &quot;基于分形的之字形指标&quot;">​</a></h3><p>需要注意的是，如果连续出现相同类型的极值，之字形折线会使用其中的第一个极值。这是因为分形被用作极值的结果。当然，在标准的之字形折线中不会出现这种情况。如果有需要，有兴趣的人可以先对分形序列进行细化，从而改进算法。</p><p>还应该注意的是，对于 <code>DRAW_ZIGZAG</code>（以及 <code>DRAW_SECTION</code>）的渲染，可见的线段连接的是非空元素，因此，严格来说，在每个柱线上都会绘制线段的一部分，包括那些值为 <code>EMPTY_VALUE</code>（或其他指定的空值）的柱线。然而，你可以在数据窗口中看到，空元素确实是空的：它们没有显示任何值。</p><h2 id="独立子窗口中的指标-大小与水平位置" tabindex="-1">独立子窗口中的指标：大小与水平位置 <a class="header-anchor" href="#独立子窗口中的指标-大小与水平位置" aria-label="Permalink to &quot;独立子窗口中的指标：大小与水平位置&quot;">​</a></h2><p>到目前为止，我们仅探讨了在主图表窗口中运行的指标，即带有 <code>#property indicator_chart_window</code> 指令的指标。现在，是时候研究一下放置在价格图表下方独立子窗口中的指标了。请记住，此类指标应使用 <code>#property indicator_separate_window</code> 指令进行声明。</p><p>我们之前所学的一切同样适用于子窗口中的指标，包括描述和固定缓冲区、设置绘图类型和样式，以及可以选择使用完整或简化形式的 <code>OnCalculate</code> 函数。不过，它们也有一些特性和额外的设置。</p><p>由于子窗口有自己的值刻度，MQL5 允许为其设置最大值和最小值（用户可以在指标设置对话框的“刻度”选项卡中设置类似的限制）。这可以通过 <code>IndicatorSetDouble</code> 函数以编程方式实现，该函数有以下两种原型：</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IndicatorSetDouble</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ENUM_CUSTOMIND_PROPERTY_DOUBLE</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> property</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IndicatorSetDouble</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ENUM_CUSTOMIND_PROPERTY_DOUBLE</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> property</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> modifier</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数用于为指标设置双精度属性值。之所以需要两种形式，是因为某些属性可能有多个，特别是水平位置线（稍后会详细讨论）。可用的属性收集在 <code>ENUM_CUSTOMIND_PROPERTY_DOUBLE</code> 枚举中。</p><table tabindex="0"><thead><tr><th>标识符</th><th>描述</th></tr></thead><tbody><tr><td><code>INDICATOR_MINIMUM</code></td><td>垂直轴上的最小值</td></tr><tr><td><code>INDICATOR_MAXIMUM</code></td><td>垂直轴上的最大值</td></tr><tr><td><code>INDICATOR_LEVELVALUE</code></td><td>水平位置线的值（编号在 <code>modifier</code> 参数中设置）</td></tr></tbody></table><p>许多振荡指标（如威廉指标（WPR））会使用固定的刻度范围。我们将通过它来看一个示例，涵盖本节中的所有函数（属性）。</p><p>若函数执行成功则返回 <code>true</code>，否则返回 <code>false</code>。</p><p>除了控制刻度，如我们所知，子窗口中的指标还可以有水平位置线。要设置其数量和属性，需使用另一个函数 <code>IndicatorSetInteger</code>。用户也可以在指标设置对话框的“水平位置线”选项卡中执行类似操作。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IndicatorSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ENUM_CUSTOMIND_PROPERTY_INTEGER</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> property</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IndicatorSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ENUM_CUSTOMIND_PROPERTY_INTEGER</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> property</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> modifier</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数同样有两种形式，可用于为指标设置 <code>int</code> 类型或等效类型（如颜色或枚举）的属性值。可用的属性收集在 <code>ENUM_CUSTOMIND_PROPERTY_INTEGER</code> 枚举中。除了与水平位置线相关的属性外，它还包含 <code>INDICATOR_DIGITS</code> 属性，这是所有类型指标通用的属性，我们将在下一节讨论。</p><table tabindex="0"><thead><tr><th>标识符</th><th>描述</th></tr></thead><tbody><tr><td><code>INDICATOR_DIGITS</code></td><td>指标值的显示精度（小数点后的位数）</td></tr><tr><td><code>INDICATOR_HEIGHT</code></td><td>指标自身窗口的固定高度（以像素为单位，使用预处理器命令 <code>#property indicator_height</code>）</td></tr><tr><td><code>INDICATOR_LEVELS</code></td><td>指标窗口中水平位置线的数量</td></tr><tr><td><code>INDICATOR_LEVELCOLOR</code></td><td>水平位置线的颜色（为 <code>color</code> 类型，<code>modifier</code> 参数设置水平位置线的编号）</td></tr><tr><td><code>INDICATOR_LEVELSTYLE</code></td><td>水平位置线的样式（为 <code>ENUM_LINE_STYLE</code> 类型，<code>modifier</code> 参数设置水平位置线的编号）</td></tr><tr><td><code>INDICATOR_LEVELWIDTH</code></td><td>水平位置线的粗细（1 - 5）（<code>modifier</code> 参数设置水平位置线的编号）</td></tr></tbody></table><p>水平位置线可以有文本标签。要为其分配标签，可使用 <code>IndicatorSetString</code> 函数。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IndicatorSetString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ENUM_CUSTOMIND_PROPERTY_STRING</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> property</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">string</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IndicatorSetString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ENUM_CUSTOMIND_PROPERTY_STRING</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> property</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> modifier</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">string</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p><code>ENUM_CUSTOMIND_PROPERTY_STRING</code> 包含指标的字符串参数列表。请注意，<code>INDICATOR_SHORTNAME</code> 属性与水平位置线无关，它也是所有指标通用的，将在下一节讨论。</p><table tabindex="0"><thead><tr><th>标识符</th><th>描述</th></tr></thead><tbody><tr><td><code>INDICATOR_SHORTNAME</code></td><td>指标的公开标题</td></tr><tr><td><code>INDICATOR_LEVELTEXT</code></td><td>水平位置线的描述（编号在 <code>modifier</code> 中指定）</td></tr></tbody></table><p>所有提到的用于 <code>int</code> 和 <code>double</code> 数值类型的函数都有对应的特殊指令（以下是总结表格）。</p><table tabindex="0"><thead><tr><th>水平位置线属性的指令</th><th>等效函数</th><th>属性类型</th><th>描述</th></tr></thead><tbody><tr><td><code>indicator_levelN</code></td><td><code>IndicatorSetDouble(INDICATOR_LEVELVALUE, N - 1, value)</code></td><td><code>double</code></td><td>垂直轴上第 N 条水平位置线的值</td></tr><tr><td><code>indicator_levelcolor</code></td><td><code>IndicatorSetInteger(INDICATOR_LEVELCOLOR, N - 1, color)</code></td><td><code>color</code></td><td>水平位置线的颜色（不同编号的水平位置线只能使用函数设置不同颜色）</td></tr><tr><td><code>indicator_levelwidth</code></td><td><code>IndicatorSetInteger(INDICATOR_LEVELWIDTH, N - 1, width)</code></td><td><code>int</code></td><td>水平位置线的像素粗细（不同编号的水平位置线只能使用函数设置不同粗细）</td></tr><tr><td><code>indicator_levelstyle</code></td><td><code>IndicatorSetInteger(INDICATOR_LEVELSTYLE, N - 1, style)</code></td><td><code>ENUM_LINE_STYLE</code></td><td>水平位置线的样式（不同编号的水平位置线只能使用函数设置不同样式）</td></tr><tr><td><code>indicator_minimum</code></td><td><code>IndicatorSetDouble(INDICATOR_MINIMUM, minimum)</code></td><td><code>double</code></td><td>固定的最小值，垂直轴上的刻度下限</td></tr><tr><td><code>indicator_maximum</code></td><td><code>IndicatorSetDouble(INDICATOR_MAXIMUM, maximum)</code></td><td><code>double</code></td><td>固定的最大值，垂直轴上的刻度上限</td></tr></tbody></table><p>请注意，使用 <code>#property</code> 指令时，属性实例（修饰符）的编号从 1 开始，而函数使用的编号从 0 开始。</p><p>细心的读者会注意到，有些属性没有对应的指令。这些属性包括 <code>INDICATOR_LEVELTEXT</code>、<code>INDICATOR_SHORTNAME</code> 和 <code>INDICATOR_DIGITS</code>。假定这些属性应根据输入变量和指标所在的图表，从 MQL 代码中动态填充。<code>INDICATOR_LEVELS</code> 可通过指定多个水平位置线的指令间接设置。</p><p>最后，子窗口中指标的一个显著特点是，程序可以“固定”其窗口的垂直大小。</p><table tabindex="0"><thead><tr><th>子窗口大小的指令</th><th>等效函数</th><th>描述</th></tr></thead><tbody><tr><td><code>indicator_height</code></td><td><code>IndicatorSetInteger(INDICATOR_HEIGHT, height)</code></td><td>指标子窗口的固定高度（以像素为单位，用户将无法更改高度）</td></tr></tbody></table><p>固定的子窗口高度通常仅用于使用图形对象实现的控制面板（按钮、标志、输入字段）。</p><p>遗憾的是，属性设置函数没有对应的获取函数（<code>IndicatorGetInteger</code>、<code>IndicatorGetDouble</code>、<code>IndicatorGetString</code>）。这也导致无法确定用户更改后的水平位置线的数量和值。</p><p>作为使用固定刻度和水平位置线的示例，我们来看 <code>IndWPR.mq5</code> 指标。在这个指标中，我们将使用标准的 WPR 算法：在给定数量的过去 K 线（WPR 周期）内，找出价格的最高价 <code>H</code> 和最低价 <code>L</code>（即价格范围）。然后，计算当前价格 <code>C</code> 与最低价 <code>L</code> 的差值 <code>C - L</code>（或差值 <code>-(H - C)</code>，带负号）与整个价格范围的比率，并将结果转换到 0 到 -100 的范围内。以下是计算 WPR 的标准公式：</p><div class="language-plaintext vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">plaintext</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>R% = (-(H - C) / (H - L)) * 100</span></span></code></pre></div><p>让我们在源代码开头添加一些指令。除了将指标放置在独立窗口的属性外，还设置值刻度范围为 0 到 -100。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_separate_window</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_maximum    </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_minimum    </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100.0</span></span></code></pre></div><p>一个缓冲区和一个折线图就足以存储值并显示指标。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_buffers    </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_plots      </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_type1      DRAW_LINE</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_color1     clrDodgerBlue</span></span></code></pre></div><p>在 WPR 指标中，通常会划分出两条水平位置线：-20 和 -80，分别作为超买和超卖区域的边界。让我们为它们创建两条水平位置线。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_level1     </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20.0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_level2     </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">80.0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_levelstyle STYLE_DOT</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_levelcolor clrSilver</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_levelwidth </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span></code></pre></div><p>唯一的输入变量允许设置 WPR 的计算周期。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WPRPeriod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 14</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 周期</span></span></code></pre></div><p>缓冲区数组在全局级别声明，并在 <code>OnInit</code> 函数中注册。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WPRBuffer[];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 检查输入是否正确</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (WPRPeriod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        Alert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;周期值 (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">) 不正确。应大于等于 1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, WPRPeriod));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 将数组绑定为缓冲区</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, WPRBuffer);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><code>OnInit</code> 处理函数声明为 <code>void</code> 类型，这意味着隐式初始化成功。但是，如果周期设置小于 1，则无法进行计算，并会向用户发出警告。</p><p>为了简化 <code>OnCalculate</code> 函数的头文件，为指标准备了 <code>IndCommon.mqh</code> 头文件，其中包含两个宏，用于描述事件处理函数两种形式的标准参数列表。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ON_CALCULATE_STD_FULL_PARAM_LIST</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total,     </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prev_calculated, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">time[],    </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">open[],      </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">high[],      </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">low[],       </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">close[],     </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tick_volume[], </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">volume[],      </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">spread[]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ON_CALCULATE_STD_SHORT_PARAM_LIST</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total,     </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prev_calculated, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> begin,           </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data[]</span></span></code></pre></div><p>现在，我们可以在这个指标和其他指标中使用简洁的 <code>OnCalculate</code> 定义（前提是我们对宏中提议的参数名称满意）。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;MQL5Book/IndCommon.mqh&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ON_CALCULATE_STD_FULL_PARAM_LIST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WPRPeriod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WPRPeriod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>在 <code>OnCalculate</code> 函数开始时，我们检查是否可以使用当前的 <code>WPRPeriod</code> 和 <code>rates_total</code> 值进行计算。如果数据不足或周期过短，则返回 0，这将使指标窗口为空。</p><p>接下来，我们用空值填充前几个无法计算给定周期 WPR 的 K 线。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ON_CALCULATE_STD_FULL_PARAM_LIST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        ArrayFill</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WPRBuffer, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, WPRPeriod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>最后，我们进行 WPR 计算并将结果存储在缓冲区中。请注意，最后一根 K 线会在每个报价更新时更新：这通过从 <code>prev_calculated - 1</code> 开始循环实现。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ON_CALCULATE_STD_FULL_PARAM_LIST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fmax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, WPRPeriod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IsStopped</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> max_high </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> high[</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fmax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArrayMaximum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(high, i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WPRPeriod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, WPRPeriod), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> min_low </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> low[</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fmax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArrayMinimum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(low, i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WPRPeriod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, WPRPeriod), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (max_high </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> min_low)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            WPRBuffer[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(max_high </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> close[i]) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (max_high </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> min_low);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            WPRBuffer[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WPRBuffer[i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><code>ArrayMaximum</code> 和 <code>ArrayMinimum</code> 函数可用于查找最高价和最低价的索引。</p><p>该指标在独立窗口中的显示如下：</p><p>WPR 指标</p><p>WPR 指标</p><p>在接下来的章节中，我们将继续改进这个指标，逐步添加其他常用属性。</p><h2 id="指标的通用属性-标题和数值精度" tabindex="-1">指标的通用属性：标题和数值精度 <a class="header-anchor" href="#指标的通用属性-标题和数值精度" aria-label="Permalink to &quot;指标的通用属性：标题和数值精度&quot;">​</a></h2><p>对于所有指标，都支持一些重要属性，这些属性虽与计算无关，但能提升用户体验。在 <code>OnInit</code> 处理程序中正确设置这些属性，已成为指标开发标准的一部分。</p><p>可以使用之前讨论过的 <code>IndicatorSetInteger</code> 函数来设置整数属性 <code>INDICATOR_DIGITS</code>，该属性会影响图表和数据窗口中实数的显示精度。默认情况下，终端会输出小数点后 6 位数字。若指标读数与当前交易品种的价格相关，那么将此属性设置为价格显示精度是合理的，即 <code>IndicatorSetInteger(INDICATOR_DIGITS, _Digits)</code>。</p><p>以威廉指标（WPR）为例，其数值类似于百分比，因此将显示值限制为小数点后两位是合理的。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IndicatorSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(INDICATOR_DIGITS, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>另一个常用属性是字符串属性 <code>INDICATOR_SHORTNAME</code>，需使用 <code>IndicatorSetString</code> 函数来设置。这是指标的标题，会显示在工具提示中，若指标有独立窗口，还会显示在子窗口的左上角。若未明确指定，将使用指标文件的名称。例如，在上一节的截图中，我们看到的标题是 <code>IndWPR</code>。</p><p>通常会在指标标题中显示主要输入变量和操作模式（若有多种模式）。</p><p>例如，对于 WPR 指标，通常会在标题中包含用户选择的周期。</p><p>此外，标题可以进行简化。这很重要，因为标题长度限制为 63 个字符。</p><p>对于更新后的 WPR 指标，我们将使用以下设置：</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IndicatorSetString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(INDICATOR_SHORTNAME, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;%R&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;(&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (string)WPRPeriod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>在给超买和超卖区域设置不同颜色后（见示例 <code>IndColorWPR.mq5</code>），我们将在下一节中验证这些改进的效果。</p><h2 id="逐点图表着色" tabindex="-1">逐点图表着色 <a class="header-anchor" href="#逐点图表着色" aria-label="Permalink to &quot;逐点图表着色&quot;">​</a></h2><p>除了之前在 <code>ENUM_DRAW_TYPE</code> 中列出的标准绘图类型外，平台还提供了可以为每根 K 线的值单独着色的变体。为此，需要使用一个额外的指标缓冲区来存储颜色编号。这些编号对应于一个特殊数组中的元素，该数组包含程序员定义的一组颜色。颜色的最大数量为 64 种。</p><p>以下表格列出了支持颜色设置的 <code>ENUM_DRAW_TYPE</code> 元素，以及绘制它们所需的缓冲区数量，其中包括一个用于存储颜色索引的缓冲区。</p><table tabindex="0"><thead><tr><th>可视化类型</th><th>描述</th><th>缓冲区数量</th></tr></thead><tbody><tr><td><code>DRAW_COLOR_LINE</code></td><td>多色线条</td><td>1 + 1</td></tr><tr><td><code>DRAW_COLOR_SECTION</code></td><td>多色线段</td><td>1 + 1</td></tr><tr><td><code>DRAW_COLOR_ARROW</code></td><td>多色箭头</td><td>1 + 1</td></tr><tr><td><code>DRAW_COLOR_HISTOGRAM</code></td><td>从零线开始的多色直方图</td><td>1 + 1</td></tr><tr><td><code>DRAW_COLOR_HISTOGRAM2</code></td><td>两个指标缓冲区成对值之间的多色直方图</td><td>2 + 1</td></tr><tr><td><code>DRAW_COLOR_ZIGZAG</code></td><td>多色锯齿线</td><td>2 + 1</td></tr><tr><td><code>DRAW_COLOR_BARS</code></td><td>多色柱状图</td><td>4 + 1</td></tr><tr><td><code>DRAW_COLOR_CANDLES</code></td><td>多色蜡烛图</td><td>4 + 1</td></tr></tbody></table><p>在将缓冲区绑定到图表时，要注意额外的颜色缓冲区必须在 <code>SetIndexBuffer</code> 的第一个参数中指定，其编号应紧跟在数据缓冲区之后。例如，若要使用一个数据缓冲区和一个颜色缓冲区为线条着色，数据缓冲区编号为 0，颜色缓冲区编号为 1：</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ColorLineData[];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ColorLineColors[];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ColorLineData, INDICATOR_DATA);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ColorLineColors, INDICATOR_COLOR_INDEX);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_DRAW_TYPE, DRAW_COLOR_LINE);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>可以通过 <code>#property indicator_colorN</code> 指令为图表 N 指定调色板中的初始颜色集。该指令使用逗号分隔所需的颜色，可以使用命名常量或颜色字面量。例如，在指标中使用以下代码可以为第 0 个图表（指令中的编号从 1 开始）选择 6 种标准颜色进行着色：</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_color1   clrRed,clrBlue,clrGreen,clrYellow,clrMagenta,clrCyan</span></span></code></pre></div><p>在程序中，后续只需指定颜色的索引，而不是实际要显示图形构造的颜色。调色板中的编号与普通数组一样，从 0 开始。因此，如果需要为第 i 根 K 线设置绿色，只需在颜色缓冲区中设置调色板中绿色的索引，在这种情况下是 2。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ColorLineColors[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 引用颜色为 clrGreen 的元素</span></span></code></pre></div><p>用于着色的颜色集并非一成不变，可以使用 <code>PlotIndexSetInteger(index, PLOT_LINE_COLOR, color)</code> 函数动态更改。</p><p>例如，要将上述调色板中的 <code>clrGreen</code> 颜色替换为 <code>clrGray</code>，可使用以下调用：</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_LINE_COLOR, clrGray);</span></span></code></pre></div><p>让我们在 WPR 指标中应用着色功能。新文件为 <code>IndColorWPR.mq5</code>，更改涉及以下几个方面。</p><p>缓冲区数量增加了 1 个，颜色从 1 种变为 3 种。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_buffers    </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_plots      </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_type1      DRAW_COLOR_LINE</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_color1     clrDodgerBlue,clrGreen,clrRed</span></span></code></pre></div><p>添加了一个新数组用于颜色缓冲区，并在 <code>OnInit</code> 函数中进行注册。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WPRColors[];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, WPRColors, INDICATOR_COLOR_INDEX);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>如果不设置 <code>INDICATOR_COLOR_INDEX</code> 缓冲区类型（即使用 <code>SetIndexBuffer(1, WPRColors)</code> 调用，默认会将其视为 <code>INDICATOR_DATA</code>），它将在数据窗口中可见。</p><p>在 <code>OnCalculate</code> 函数的工作循环内，根据第 i 根 K 线的值分析添加着色逻辑。默认情况下，使用索引为 0 的颜色，即之前的 <code>clrDodgerBlue</code>。如果指标读数进入上区域，则用颜色 2（<code>clrRed</code>）突出显示；如果进入下区域，则用颜色 1（<code>clrGreen</code>）着色。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ON_CALCULATE_STD_FULL_PARAM_LIST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fmax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, WPRPeriod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IsStopped</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        WPRColors[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (WPRBuffer[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) WPRColors[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (WPRBuffer[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">80</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) WPRColors[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>在屏幕上的显示效果如下：</p><p>带超买和超卖区域着色的 WPR 指标</p><p>带超买和超卖区域着色的 WPR 指标</p><p>请注意，如果线段的终点（K 线）位于上区域或下区域，该线段将用替代颜色绘制。在这种情况下，前一个读数可能位于中间区域，这可能会让人觉得颜色设置有误。但这是符合当前实现和平台颜色使用方式的正确行为。</p><p><code>DRAW_COLOR_LINE</code> 折线图中相邻两根 K 线之间线段的颜色由右侧（最近）的 K 线颜色决定。</p><p>如果只想对相邻两根 K 线都在同一区域的线段进行颜色突出显示，可以将代码修改为：</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">WPRColors[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (WPRBuffer[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WPRBuffer[i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) WPRColors[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (WPRBuffer[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">80</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WPRBuffer[i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">80</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) WPRColors[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>此外，记得我们在源代码中添加了标题设置和值表示精度（2 位小数）的设置。对比新旧图像，你会注意到这些视觉差异。特别是，标题现在显示为 &quot;%R(14)&quot;，垂直值刻度变得更加紧凑。</p><p>我们在 <code>IndColorWPR.mq5</code> 指标中要更改的最后一个方面是跳过初始 K 线的绘制。</p><h2 id="跳过初始柱线的绘制" tabindex="-1">跳过初始柱线的绘制 <a class="header-anchor" href="#跳过初始柱线的绘制" aria-label="Permalink to &quot;跳过初始柱线的绘制&quot;">​</a></h2><p>在很多情形下，依据算法条件，指标数值的计算无法从第一个（最左侧可用）柱线开始，因为需要确保历史数据中有最少指定数量的前序柱线。例如，许多平滑处理类型都意味着当前值的计算要用到前 <code>N</code> 个柱线的价格数组。</p><p>在这种情况下，可能无法在最开始的柱线上计算指标值，或者这些值不打算显示在图表上，仅用于辅助计算后续的值。</p><p>若要禁止指标在历史数据的前 <code>N - 1</code> 个柱线上显示，可将 <code>PLOT_DRAW_BEGIN</code> 属性为相应的图形绘图索引设置为 <code>N</code>，即 <code>PlotIndexSetInteger(index, PLOT_DRAW_BEGIN, N)</code>。默认情况下，此属性值为 0，这意味着从一开始就显示数据。</p><p>我们可以通过将必要柱线设置为空值（默认是 <code>EMPTY_VALUE</code>）来禁止线条显示。不过，调用 <code>PlotIndexSetInteger</code> 函数并设置 <code>PLOT_DRAW_BEGIN</code> 属性有不同作用。我们借此告知外部程序指标缓冲区中前几个无意义值的数量。特别是，其他可能基于我们指标的时间序列构建的指标，会在其 <code>OnCalculate</code> 处理程序的 <code>begin</code> 参数中获取 <code>PLOT_DRAW_BEGIN</code> 属性的值，从而有机会跳过这些柱线。</p><p>在 <code>IndColorWPR.mq5</code> 指标示例里，我们在 <code>OnInit</code> 函数中添加类似设置：</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WPRPeriod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 14</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 周期</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_DRAW_BEGIN, WPRPeriod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>现在，在 <code>OnCalculate</code> 函数中，可以移除对初始柱线的强制清空操作，因为它们总会被隐藏：</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ArrayFill</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WPRBuffer, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, WPRPeriod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>但这仅在用户手动选择我们的指标作为另一个指标的时间序列源时能正常工作。如果有程序员想在其开发中使用我们的指标，会有不同的数据获取机制（我们将在下一章讨论），这种机制无法获取 <code>PLOT_DRAW_BEGIN</code> 属性。所以，最好使用显式的缓冲区初始化。</p><p>为展示如何在另一个基于我们指标数据计算的指标中使用此属性，我们准备另一个指标，即著名的三重指数移动平均线（Triple Exponential Moving Average）算法，封装在 <code>IndTripleEMA.mq5</code> 指标中。完成后，就可以轻松将其应用于价格时间序列和任意指标，如之前的 <code>IndColorWPR.mq5</code> 指标。</p><p>此外，我们会了解为计算描述辅助缓冲区（<code>INDICATOR_CALCULATIONS</code>）的技术可能性。</p><p>三重 EMA 公式包含多个计算步骤。对初始时间序列 <code>T</code> 进行周期为 <code>P</code> 的简单指数平滑可表示为：</p><div class="language-plaintext vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">plaintext</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>K = 2.0 / (P + 1)</span></span>
<span class="line"><span>A[i] = T[i] * K + A[i - 1] * (1 - K)</span></span></code></pre></div><p>其中，<code>K</code> 是考虑原始序列元素的权重因子，在给定周期 <code>P</code> 后计算得出；<code>(1 - K)</code> 是应用于平滑序列 <code>A</code> 元素的惯性系数。为得到序列 <code>A</code> 的第 <code>i</code> 个元素，我们将原始序列 <code>T[i]</code> 的第 <code>i</code> 个元素的 <code>K</code> 部分与前一个元素 <code>A[i - 1]</code> 的 <code>(1 - K)</code> 部分相加。</p><p>若将上述公式表示的平滑操作记为 <code>E</code> 运算符，那么三重 EMA 正如其名，需应用三次 <code>E</code> 操作，然后以特殊方式组合得到的三个平滑序列：</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">EMA1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> E</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(A, P), 对所有 i</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">EMA2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> E</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(EMA1, P), 对所有 i</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">EMA3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> E</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(EMA2, P), 对所有 i</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TEMA </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EMA1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EMA2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EMA3, 对所有 i</span></span></code></pre></div><p>与相同周期的常规 EMA 相比，三重 EMA 对原始序列的滞后更小。不过，它的响应性更强，这可能导致结果线出现不规则情况并给出错误信号。</p><p>EMA 平滑处理从序列的第二个元素开始就能得到大致的平均值估算，且无需更改算法。这是 EMA 与其他平滑方法的区别，其他方法需要前 <code>P</code> 个元素，或者在可用元素少于 <code>P</code> 时需要修改初始样本的算法。一些开发者即使使用 EMA，也倾向于使平滑序列的前 <code>P - 1</code> 个元素无效。但需注意，在 EMA 公式中，序列过去元素的影响不限于 <code>P</code> 个元素，只有当元素数量趋于无穷大时，这种影响才会变得微不足道（在其他著名的 MA 算法中，恰好是前 <code>P</code> 个元素有影响）。</p><p>为探究跳过初始数据的影响，在本书中我们不会禁止输出初始 EMA 值。</p><p>为计算三个 EMA 级别，我们需要辅助缓冲区，再加上一个用于最终序列的缓冲区，它将以折线图形式显示：</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_chart_window</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_buffers </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_plots   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_type1   DRAW_LINE</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_color1  Orange</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_width1  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_label1  </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;EMA³&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TemaBuffer[];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Ema[];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EmaOfEma[];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EmaOfEmaOfEma[];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, TemaBuffer, INDICATOR_DATA);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Ema, INDICATOR_CALCULATIONS);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, EmaOfEma, INDICATOR_CALCULATIONS);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, EmaOfEmaOfEma, INDICATOR_CALCULATIONS);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>输入变量 <code>InpPeriodEMA</code> 可用于设置平滑周期。第二个变量 <code>InpHandleBegin</code> 是一个模式开关，通过它我们可以探究指标在 <code>OnCalculate</code> 处理程序中考虑或忽略 <code>begin</code> 参数时的反应。可用模式总结在 <code>BEGIN_POLICY</code> 枚举中，含义如下（按排列顺序）：</p><ul><li><code>STRICT</code>：根据 <code>begin</code> 严格偏移。</li><li><code>CUSTOM</code>：自定义验证初始数据，不考虑 <code>begin</code>。</li><li><code>NONE</code>：不处理，即忽略 <code>begin</code> 并直接对所有数据进行计算。</li></ul><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">enum</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BEGIN_POLICY</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    STRICT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 严格</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    CUSTOM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 自定义</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    NONE</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 不处理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> InpPeriodEMA </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 14</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                 // EMA 周期</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input BEGIN_POLICY InpHandleBegin </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> STRICT;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 处理 &#39;begin&#39; 参数</span></span></code></pre></div><p>第二个 <code>CUSTOM</code> 模式基于对每个源元素与 <code>EMPTY_VALUE</code> 的初步比较，并将其替换为适合算法的值。这仅适用于那些诚实地初始化缓冲区未使用部分而不留下无用数据的指标。我们的 <code>IndColorWPR</code> 指标按要求填充了缓冲区，所以可以预期 <code>STRICT</code> 和 <code>CUSTOM</code> 模式的结果几乎相同。</p><p>基于 <code>InpPeriodEMA</code> 为计算 EMA 准备常量 <code>K</code>：</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> K </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (InpPeriodEMA </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>EMA 函数本身很简单（这里省略了 <code>CUSTOM</code> 变体中对 <code>EMPTY_VALUE</code> 检查的保护片段）：</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> EMA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">source</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> pos</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> begin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pos </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> begin)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        result[pos] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> source[pos];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        result[pos] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> source[pos] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> K </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result[pos </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> K);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>以下是 <code>OnCalculate</code> 中完整的三重平滑计算：</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> rates_total</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> prev_calculated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> begin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">price</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _begin </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> InpHandleBegin </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> STRICT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> begin </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 全新启动或历史数据更新</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;begin=&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, begin, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">EnumToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(InpHandleBegin));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 我们可以动态更改图表设置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_DRAW_BEGIN, _begin);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 初始化数组</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        ArrayInitialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Ema, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        ArrayInitialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(EmaOfEma, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        ArrayInitialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(EmaOfEmaOfEma, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        ArrayInitialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TemaBuffer, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Ema[_begin] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EmaOfEma[_begin] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EmaOfEmaOfEma[_begin] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> price[_begin];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 主循环，考虑从 _begin 开始</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fmax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, _begin);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IsStopped</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        EMA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(price, Ema, i, _begin);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        EMA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Ema, EmaOfEma, i, _begin);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        EMA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(EmaOfEma, EmaOfEmaOfEma, i, _begin);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(InpHandleBegin </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CUSTOM)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 防止初始空元素</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Ema[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EMPTY_VALUE</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EmaOfEma[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EMPTY_VALUE</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EmaOfEmaOfEma[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EMPTY_VALUE)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        TemaBuffer[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Ema[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EmaOfEma[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EmaOfEmaOfEma[i];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>在首次启动或历史数据更新时，接收到的 <code>begin</code> 参数值以及用户选择的处理模式会被写入日志。</p><p>成功编译后，就可以进行实验了。</p><p>首先，运行 <code>IndColorWPR</code> 指标（默认其周期为 14，根据源代码，由于索引从 0 开始，所以 <code>PLOT_DRAW_BEGIN</code> 属性会被设置为 13，第 13 个柱线将是第一个有值出现的柱线）。然后将 <code>IndTripleEMA</code> 指标拖到显示 WPR 的子窗口中。在打开的属性设置对话框的“选项”选项卡中，在“应用于”下拉列表中选择“上一个指标数据”。在“输入”选项卡中保留默认值。</p><p>以下图像展示了图表的开头部分。日志中会有如下记录：<code>begin=13 STRICT</code>。</p><h3 id="考虑数据起始点的三重-ema-指标应用于-wpr" tabindex="-1">考虑数据起始点的三重 EMA 指标应用于 WPR <a class="header-anchor" href="#考虑数据起始点的三重-ema-指标应用于-wpr" aria-label="Permalink to &quot;考虑数据起始点的三重 EMA 指标应用于 WPR&quot;">​</a></h3><p>注意，平均线与 WPR 一样，从离起始点有一定距离的位置开始。</p><p><strong>注意</strong>：用于指标计算的可用柱线数量 <code>rates_total</code>（或 <code>iBars(_Symbol, _Period)</code>）可能会超过终端设置中允许的图表上最大柱线数量，如果有更长的本地报价历史。在这种情况下，WPR 线（或任何其他跳过前几个元素的指标，如 MA）开头的空元素将变得不可见，它们会被图表的左边界遮挡。若要重现初始柱线上没有线条的情况，要么需要增加图表上的柱线数量，要么关闭终端并删除特定交易品种的本地历史数据。</p><p>现在，在 <code>IndTripleEMA</code> 指标设置中切换到 <code>CUSTOM</code> 模式（日志将显示 <code>begin=0 CUSTOM</code>）。指标读数应该不会有太大变化。</p><p>最后，激活 <code>NONE</code> 模式。日志将输出：<code>begin=0 NONE</code>。</p><p>此时，图表上的情况会看起来很奇怪，因为线条实际上会消失。在数据窗口中，可以看到元素值非常大。</p><h3 id="不考虑数据起始点的三重-ema-指标应用于-wpr" tabindex="-1">不考虑数据起始点的三重 EMA 指标应用于 WPR <a class="header-anchor" href="#不考虑数据起始点的三重-ema-指标应用于-wpr" aria-label="Permalink to &quot;不考虑数据起始点的三重 EMA 指标应用于 WPR&quot;">​</a></h3><p>这是因为 <code>EMPTY_VALUE</code> 等于最大实数 <code>DBL_MAX</code>。因此，不考虑 <code>begin</code> 参数时，使用这些值进行计算也会生成非常大的数字。根据计算的具体情况，溢出可能会导致我们得到特殊的 <code>NaN</code>（非数字，参见“检查实数的正常性”）。其中一个 <code>-nan(ind)</code> 在图像中被突出显示（数据窗口已经知道如何输出某些类型的 <code>NaN</code>，例如 <code>inf</code> 和 <code>-inf</code>，但目前还不包括 <code>-nan(ind)</code>）。如我们所知，这样的 <code>NaN</code> 值很危险，因为涉及它们的计算会继续产生 <code>NaN</code>。如果没有生成 <code>NaN</code>，那么随着在柱线上向右移动，大数计算中的“过渡过程”会逐渐减弱（由于 EMA 公式中的缩减因子 <code>(1 - K)</code>），结果会稳定下来并变得合理。如果将图表滚动到当前时间，就会看到正常的三重 EMA。</p><p>考虑 <code>begin</code> 参数是一种良好的实践，但这并不能保证数据提供者（如果是第三方指标）正确填充了此属性。因此，最好在代码中提供一些保护措施。在 <code>IndTripleEMA</code> 的这个实现中，保护措施在初始级别实现。</p><p>如果我们在价格图表上运行 <code>IndTripleEMA</code> 指标，总是会得到 <code>begin = 0</code>，因为价格时间序列从最开始的柱线就填充了真实数据。</p><h2 id="等待数据与管理可见性-draw-none" tabindex="-1">等待数据与管理可见性（<code>DRAW_NONE</code>） <a class="header-anchor" href="#等待数据与管理可见性-draw-none" aria-label="Permalink to &quot;等待数据与管理可见性（`DRAW_NONE`）&quot;">​</a></h2><p>在上一章 “使用 <code>MqlTick</code> 结构体中的实时报价数组” 部分，我们使用了脚本 <code>SeriesTicksDeltaVolume.mq5</code>，它用于计算每根 K 线的成交量差（Delta 成交量）。当时，我们将结果显示在日志中，但分析此类技术信息更为方便且合理的方式是使用指标。在本节中，我们将创建这样一个指标 —— <code>IndDeltaVolume.mq5</code>。</p><p>在这里，我们必须处理在开发指标时经常遇到但在之前的示例中未讨论过的两个因素。</p><p>第一个因素是，报价数据不属于终端在 <code>OnCalculate</code> 参数中发送给指标的标准价格时间序列。这意味着指标本身必须请求这些数据，并在能够在窗口中显示内容之前等待。</p><p>第二个因素与这样一个事实有关，即通常情况下，买入和卖出的成交量远大于它们的成交量差，并且当在一个窗口中显示时，很难区分成交量差。然而，成交量差是一个指示性数值，通常会与价格走势一起进行分析。例如，K 线和成交量差配置有 4 种最明显的组合：</p><ul><li>阳线且正成交量差 = 上涨趋势的确认</li><li>阴线且负成交量差 = 下跌趋势的确认</li><li>阳线且负成交量差 = 可能出现下跌反转</li><li>阴线且正成交量差 = 可能出现上涨反转</li></ul><p>为了查看成交量差的直方图，我们需要提供一种禁用 “大” 直方图（买入和卖出成交量）的模式，为此我们将使用 <code>DRAW_NONE</code> 类型。它会禁用特定绘图的绘制，并防止其对自动选择的窗口刻度产生影响（但会在数据窗口中保留缓冲区）。因此，通过不考虑大的绘图，我们将为剩余的成交量差图表实现更大的自动缩放。另一种通过将缓冲区标记为辅助（<code>INDICATOR_CALCULATIONS</code> 模式）来隐藏缓冲区的方法将在下一节讨论。</p><p>成交量差的概念是分别计算报价中的买入和卖出成交量，然后我们可以求出这些成交量之间的差值。相应地，我们得到了三个时间序列，分别是买入成交量、卖出成交量以及它们之间的差值。由于这些信息不适合用价格刻度来表示，所以该指标应显示在其自身的窗口中，并且我们将选择从零线开始的直方图（<code>DRAW_HISTOGRAM</code>）作为显示这三个时间序列的方式。</p><p>根据这一点，让我们用指令描述指标的属性：位置、缓冲区和绘图的数量，以及它们的类型。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_separate_window</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_buffers </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_plots   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_type1   DRAW_HISTOGRAM</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_color1  clrBlue</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_width1  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_label1  </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Buy&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_type2   DRAW_HISTOGRAM</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_color2  clrRed</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_width2  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_label2  </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Sell&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_type3   DRAW_HISTOGRAM</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_color3  clrMagenta</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_width3  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_label3  </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Delta&quot;</span></span></code></pre></div><p>我们将使用之前脚本中的输入变量。由于报价数据量相当大，我们将限制用于计算历史数据的 K 线数量（<code>BarCount</code>）。此外，根据特定金融工具的报价中是否存在实际成交量，我们可以用两种不同的方式计算成交量差，为此我们将使用报价类型参数（<code>COPY_TICKS</code> 枚举在头文件 <code>TickEnum.mqh</code> 中定义，我们在脚本中已经使用过该头文件）。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;MQL5Book/TickEnum.mqh&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BarCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input COPY_TICKS TickType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INFO_TICKS;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ShowBuySell </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>在 <code>OnInit</code> 处理函数中，我们根据用户选择的 <code>ShowBuySell</code> 参数，在 <code>DRAW_HISTOGRAM</code> 和 <code>DRAW_NONE</code> 之间切换前两个直方图的操作模式（默认 <code>true</code> 表示显示所有三个直方图）。请注意，通过 <code>PlotIndexSetInteger</code> 进行的动态配置会覆盖使用 <code>#property</code> 指令嵌入可执行文件中的静态设置（在这种情况下，只是其中一些设置）。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_DRAW_TYPE, ShowBuySell</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DRAW_HISTOGRAM </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DRAW_NONE);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PLOT_DRAW_TYPE, ShowBuySell</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DRAW_HISTOGRAM </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DRAW_NONE);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INIT_SUCCEEDED;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>但是指标缓冲区的注册在哪里呢？我们将在接下来的几段中再回到这个问题。现在让我们开始准备 <code>OnCalculate</code> 函数。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ON_CALCULATE_STD_FULL_PARAM_LIST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // TODO(1): 初始化，用零填充</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 在每次新的 K 线或首次运行时的一组新 K 线</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 处理所有或新的 K 线</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fmax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(prev_calculated, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fmax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BarCount));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">             i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IsStopped</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // TODO(2): 尝试获取数据并计算第 i 根 K 线，</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 如果失败，做些什么！</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 当前 K 线的报价</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // TODO(3): 更新当前 K 线</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>主要的技术问题在于标记为 <code>TODO(2)</code> 的代码块。在脚本中使用的、并将以最小改动移植到指标中的报价请求算法，使用 <code>CopyTicksRange</code> 函数来请求报价数据。这样的调用会返回报价数据库中可用的数据。但是，如果对于给定的历史 K 线，数据尚未可用，该请求会导致报价数据以异步方式（在后台模式下）下载并同步。在这种情况下，调用代码会收到 0 条报价数据。因此，在收到这样的 “空” 响应时，指标应该以失败（但不是错误）的标志中断计算，并在一段时间后重新请求报价数据。在正常的公开市场情况下，我们会定期收到报价数据，所以 <code>OnCalculate</code> 函数可能很快会被调用，并使用更新后的报价数据基础重新计算。但是在周末没有报价数据时该怎么办呢？</p><p>为了正确处理这种情况，MQL5 提供了一个定时器。我们将在后续的某一章中学习它，但目前我们将把它当作一个 “黑匣子” 来使用。特殊的 <code>EventSetTimer</code> 函数 “请求” 内核在指定的秒数后调用我们的 MQL 程序。这样的调用的入口点是一个保留的 <code>OnTimer</code> 处理函数，我们在 “事件处理函数概述” 部分的总表中已经见过它。因此，如果在接收报价数据时出现延迟，应该使用 <code>EventSetTimer</code> 启动定时器（最小周期 1 秒就足够了），并从 <code>OnCalculate</code> 返回 0。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ON_CALCULATE_STD_FULL_PARAM_LIST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fmax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(prev_calculated, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fmax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BarCount));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IsStopped</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // TODO(2): 尝试获取数据并计算第 i 根 K 线，</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/*如果没有数据*/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;K 线 &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, i, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; 上没有数据，时间为 &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TimeToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(time[i]),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                  &quot;. 设置定时器以刷新...&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            EventSetTimer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 请在 1 秒后调用我们</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 目前不在窗口中显示任何内容</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>在 <code>OnTimer</code> 处理函数中，我们使用 <code>EventKillTimer</code> 函数来停止定时器（如果不这样做，系统将继续每秒调用我们的处理函数）。此外，我们需要以某种方式启动指标的重新计算。为此，我们将应用另一个我们尚未在图表章节中学习的函数 —— <code>ChartSetSymbolPeriod</code>（请参阅 “切换交易品种和时间周期” 部分）。它允许为具有给定标识符的图表设置交易品种和时间周期的新组合（0 表示当前图表）。然而，如果通过传递 <code>_Symbol</code> 和 <code>_Period</code>（请参阅预定义变量）不改变它们，那么图表将简单地被更新（指标将被重新计算）。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnTimer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    EventKillTimer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ChartSetSymbolPeriod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, _Symbol, _Period);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 图表自动更新</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>这里需要注意的另一点是，在公开市场中，如果在下一次 <code>OnTimer</code> 调用之前出现了下一条报价数据，定时器事件和图表自动更新可能是多余的。因此，我们将创建一个全局变量（<code>calcDone</code>）来切换计算准备就绪的标志。在 <code>OnCalculate</code> 开始时，我们将其重置为 <code>false</code>；在正常计算完成时，我们将其设置为 <code>true</code>。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> calcDone </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ON_CALCULATE_STD_FULL_PARAM_LIST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    calcDone </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/*如果没有数据*/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">       ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 以 calcDone = false 退出</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    calcDone </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>然后在 <code>OnTimer</code> 中，我们只有在 <code>calcDone</code> 等于 <code>false</code> 时才可以启动图表自动更新。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnTimer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    EventKillTimer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">calcDone)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        ChartSetSymbolPeriod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, _Symbol, _Period);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>现在让我们转到 <code>TODO(1,2,3)</code> 注释部分，我们应该在那里执行计算并填充指标缓冲区。我们将在一个 <code>CalcDeltaVolume</code> 类中组合所有这些操作。因此，每个操作将分配一个单独的方法，同时我们将保持 <code>OnCalculate</code> 处理函数简单（方法调用将代替注释出现）。</p><p>在类中，我们将提供成员变量，这些变量将接受用户对处理的历史 K 线数量和成交量差计算方法的设置，以及用于指标缓冲区的三个数组。我们将在构造函数中初始化它们。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CalcDeltaVolume</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> limit;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COPY_TICKS tickType;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> buy[];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sell[];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> delta[];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    CalcDeltaVolume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> bars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> COPY_TICKS</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">limit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bars), </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tickType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(type), </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lasttime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lastcount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 将内部数组注册为指标缓冲区</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, buy);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, sell);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, delta);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span></code></pre></div><p>我们可以将成员数组指定为缓冲区，因为我们接下来要创建这个类的全局对象。为了正确显示数据，我们只需要确保在绘制时附加到图表的数组存在即可。可以动态更改缓冲区绑定（请参阅下一节中 <code>IndSubChartSimple.mq5</code> 的示例）。</p><p>请注意，指标缓冲区必须是 <code>double</code> 类型，而成交量是 <code>ulong</code> 类型。因此，对于非常大的值（例如，在非常大的时间周期上），理论上可能会有精度损失。</p><p>已经创建了 <code>reset</code> 方法来初始化缓冲区。数组的大多数元素用空值 <code>EMPTY_VALUE</code> 填充，最后 <code>limit</code> 根 K 线用零填充，因为在那里我们将分别累加买入和卖出的成交量。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> reset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 填充买入数组，并从它复制其余部分</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 除了最后 limit 根 K 线为 0 外，所有元素为空值</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ArrayInitialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buy, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ArrayFill</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buy, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArraySize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buy) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> limit, limit, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 将初始状态复制到其他数组</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ArrayCopy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sell, buy);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ArrayCopy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(delta, buy);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>第 <code>i</code> 根历史 K 线的计算由 <code>createDeltaBar</code> 方法执行。它的输入接受 K 线编号以及指向包含 K 线时间戳的数组的引用（我们作为 <code>OnCalculate</code> 参数接收它）。数组的第 <code>i</code> 个元素初始化为 0。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createDeltaBar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> datetime</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    delta[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> buy[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sell[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span></code></pre></div><p>然后我们需要确定第 <code>i</code> 根 K 线的时间限制：<code>prev</code> 和 <code>next</code>，其中 <code>next</code> 通过添加我们新接触的 <code>PeriodSeconds</code> 函数的值来计算，即 <code>prev</code> 右侧的时间。该函数返回当前时间周期的秒数。通过加上这个时间量，我们找到了下一根 K 线的理论起始时间。在历史数据中，当 <code>i</code> 不等于最后一根 K 线的编号时，我们可以用 <code>time[i + 1]</code> 来代替找到 <code>next</code> 时间戳。然而，指标也应该在仍在形成过程中的最后一根 K 线上起作用，而这根 K 线没有下一根 K 线。因此，一般来说，禁止使用 <code>time[i + 1]</code>。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime prev </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> time[i];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime next </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prev </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PeriodSeconds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><p>当我们在脚本中进行类似计算时，我们不必使用 <code>PeriodSeconds</code> 函数，因为我们不计算最后一根当前 K 线，并且可以分别使用 <code>iTime(WorkSymbol, TimeFrame, i)</code> 和 <code>iTime(WorkSymbol, TimeFrame, i + 1)</code> 来找到 <code>next</code> 和 <code>prev</code>。</p><p>此外，在 <code>createDeltaBar</code> 方法中，我们在找到的时间戳范围内请求报价数据（从右侧时间减去 1 毫秒，以免触及下一根 K 线）。报价数据存储在 <code>ticks</code> 数组中，由辅助方法 <code>calc</code> 处理。它包含的脚本算法几乎没有变化。我们不得不将其分离成一个指定的方法，因为计算将在两种不同的情况下进行：使用历史 K 线（记住 <code>TODO(2)</code> 注释）和使用当前 K 线的报价（<code>TODO(3)</code> 注释）。我们将在下面考虑第二种情况。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ResetLastError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MqlTick ticks[];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CopyTicksRange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Symbol, ticks, COPY_TICKS_ALL,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    prev </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, next </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _LastError </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    calc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i, ticks);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_LastError;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n;</span></span></code></pre></div><p>如果请求成功，该方法返回处理的报价数据数量；如果出现错误，则返回带有负号的错误代码。请注意，如果数据库中尚未有该 K 线的报价数据（严格来说，这不是错误，但它不允许指标的可视化操作继续进行），该方法将返回 0（0 的符号不会改变其值）。因此，在 <code>OnCalculate</code> 函数中，我们需要检查该方法的结果是否 “小于或等于” 0。</p><p><code>calc</code> 方法实际上由脚本 <code>SeriesTicksDeltaVolume.mq5</code> 的有效代码行组成，所以我们这里不再展示。如果有人想回顾一下，可以查看 <code>IndDeltaVolume.mq5</code>。</p><p>为了计算不断更新的最后一根 K 线上的成交量差，我们需要以毫秒精度固定最后处理的报价的时间戳。然后，在下一次调用 <code>OnCalculate</code> 时，我们将能够查询此标签之后的所有报价数据。</p><p>请注意，不能保证系统会实时在每一条报价数据到达时都调用我们的 <code>OnCalculate</code> 处理函数。如果我们执行繁重的计算，或者如果某些其他 MQL 程序因计算而使终端负载过重，或者如果报价数据到达非常快（例如，在重要新闻发布之后），事件可能无法进入指标队列（队列中每种类型的事件最多存储一个，包括最多一个报价通知）。因此，如果程序想要获取所有报价数据，它必须使用 <code>CopyTicksRange</code> 或 <code>CopyTicks</code> 请求它们。</p><p>然而，仅靠最后处理的报价的时间戳是不够的。即使考虑到毫秒，报价数据也可能具有相同的时间。因此，我们不能在标签上加上 1 毫秒来排除 “旧” 的报价数据：具有相同标签的 “新” 报价数据可能会在它之后出现。</p><p>因此，我们不仅应该记住标签，还应该记住具有该标签的最后报价数据的数量。然后，下次我们请求报价数据时，我们可以从记住的时间开始请求（即包括 “旧” 的报价数据），但要准确跳过上次已经处理的数量。</p><p>为了实现这个算法，在类中声明了两个变量 <code>lasttime</code> 和 <code>lastcount</code>。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ulong lasttime;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 最后处理的在线报价的毫秒标记</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastcount;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 此时具有此标签的报价数量</span></span></code></pre></div><p>从系统接收的报价数组中，我们使用辅助方法 <code>updateLastTime</code> 找到这些变量的值。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateLastTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> n</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MqlTick</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ticks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    lasttime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ticks[n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].time_msc;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    lastcount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> k </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; k </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">--</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">k)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ticks[k].time_msc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ticks[n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].time_msc) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">lastcount;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>现在我们可以完善 <code>createDeltaBar</code></p><h2 id="多货币和多时间框架指标" tabindex="-1">多货币和多时间框架指标 <a class="header-anchor" href="#多货币和多时间框架指标" aria-label="Permalink to &quot;多货币和多时间框架指标&quot;">​</a></h2><p>到目前为止，我们所讨论的指标都是基于当前图表品种的报价或tick数据进行运算的。但有时，需要对多个金融产品进行分析，或者分析一个与当前品种不同的产品。在这种情况下，正如我们在tick分析中所看到的，通过<code>OnCalculate</code>参数传递给指标的标准时间序列是不够用的。此时，就需要以某种方式请求“外部”报价，等待其构建完成，然后再基于这些报价来计算指标。</p><p>请求并构建与当前图表时间框架不同的报价，其机制与处理其他品种的机制并无差异。所以，在本节中，我们将探讨多货币指标的创建，而多时间框架指标也可以依照类似的原则来构建。</p><p>我们需要解决的问题之一是K线在时间上的同步。特别是对于不同的品种，可能存在不同的交易时间表、周末等情况，总体而言，主图表上的K线编号和“外部”品种报价中的K线编号可能不同。</p><p>首先，我们简化一下任务，仅考虑一个任意的品种，它可能与当前品种不同。交易者常常需要同时查看多个不同品种的图表（例如，相关品种对中的领先品种和跟随品种）。我们来创建<code>IndSubChartSimple.mq5</code>指标，用于在子窗口中显示用户所选品种的报价。</p><h4 id="indsubchartsimple" tabindex="-1">IndSubChartSimple <a class="header-anchor" href="#indsubchartsimple" aria-label="Permalink to &quot;IndSubChartSimple&quot;">​</a></h4><p>为了与主图表的外观保持一致，我们不仅要在输入参数中指定品种，还要指定绘图模式：<code>DRAW_CANDLES</code>、<code>DRAW_BARS</code>、<code>DRAW_LINE</code>。前两种模式需要四个缓冲区，它们会输出全部四个价格：开盘价（Open）、最高价（High）、最低价（Low）和收盘价（Close）（日本蜡烛图或K线），而最后一种模式则使用单个缓冲区来显示收盘价的线条。为了支持所有模式，我们将使用所需的最大缓冲区数量。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_separate_window</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_buffers </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_plots   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_type1   DRAW_CANDLES</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_color1  clrBlue,clrGreen,clrRed</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 边框色、阳线色、阴线色</span></span></code></pre></div><p>用于缓冲区的数组通过价格类型名称来描述。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> open[];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> high[];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> low[];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> close[];</span></span></code></pre></div><p>默认开启日本蜡烛图显示。在这种模式下，MQL5允许指定多个颜色，而不只是一个。在<code>#property indicator_colorN</code>指令中，颜色用逗号分隔。如果有两种颜色，那么第一种颜色决定蜡烛图的轮廓颜色，第二种颜色决定填充颜色。如果有三种颜色，就像我们这里的情况，第一种颜色决定轮廓颜色，第二种和第三种颜色分别决定阳线和阴线的实体颜色。</p><p>在关于图表的章节中，我们会了解<code>ENUM_CHART_MODE</code>枚举，它描述了三种可用的图表绘制模式。</p><table tabindex="0"><thead><tr><th>名称</th><th>元素</th></tr></thead><tbody><tr><td><code>ENUM_CHART_MODE</code> 元素</td><td><code>ENUM_DRAW_TYPE</code> 元素</td></tr><tr><td><code>CHART_CANDLES</code></td><td><code>DRAW_CANDLES</code></td></tr><tr><td><code>CHART_BARS</code></td><td><code>DRAW_BARS</code></td></tr><tr><td><code>CHART_LINE</code></td><td><code>DRAW_LINE</code></td></tr></tbody></table><p>这些元素与我们选择的绘图模式相对应，因为我们有意选择了与标准模式相同的绘图方法。这里使用<code>ENUM_CHART_MODE</code>很方便，因为它只包含我们需要的三个元素，而<code>ENUM_DRAW_TYPE</code>有很多其他的绘图方法。</p><p>因此，输入变量的定义如下。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input string SubSymbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 品种</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input ENUM_CHART_MODE Mode </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CHART_CANDLES;</span></span></code></pre></div><p>实现了一个简单的函数，用于将<code>ENUM_CHART_MODE</code>转换为<code>ENUM_DRAW_TYPE</code>。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ENUM_DRAW_TYPE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Mode2Style</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ENUM_CHART_MODE</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> m</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(m)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CHART_CANDLES: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DRAW_CANDLES;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CHART_BARS: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DRAW_BARS;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CHART_LINE: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DRAW_LINE;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DRAW_NONE;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><code>SubSymbol</code>输入参数中的空字符串表示当前图表的品种。然而，由于MQL5不允许编辑输入变量，我们需要添加一个全局变量来存储实际使用的品种，并在<code>OnInit</code>处理程序中进行赋值。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string symbol;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   symbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SubSymbol;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) symbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _Symbol;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 确保品种存在并在市场报价窗口中被选中</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SymbolSelect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INIT_PARAMETERS_INCORRECT;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>我们还需要检查用户输入的品种是否存在，并将其添加到市场报价窗口中，这可以通过<code>SymbolSelect</code>函数来完成，我们将在关于品种的章节中学习这个函数。</p><p>为了统一缓冲区和图表的设置，源代码中有几个辅助函数：</p><ul><li><code>InitBuffer</code> - 设置一个缓冲区</li><li><code>InitBuffers</code> - 设置整个缓冲区集</li><li><code>InitPlot</code> - 设置一个图表</li></ul><p>单独的函数将注册相同实体时重复的多个操作组合在一起。它们也为在关于图表的章节中进一步开发此指标开辟了道路：我们将支持根据用户对图表的操作交互式更改绘图设置（请参阅章节“图表显示模式”中完整版本的指标<code>IndSubChart.mq5</code>）。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InitBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ENUM_INDEXBUFFER_TYPE</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> style</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INDICATOR_DATA,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> bool</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> asSeries</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(index, buffer, style);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArraySetAsSeries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buffer, asSeries);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">string</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InitBuffers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ENUM_CHART_MODE</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> m</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   string title;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(m </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CHART_LINE)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      InitBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, close, INDICATOR_DATA, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 隐藏折线图未使用的所有缓冲区</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      InitBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, high, INDICATOR_CALCULATIONS, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      InitBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, low, INDICATOR_CALCULATIONS, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      InitBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, open, INDICATOR_CALCULATIONS, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      title </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> symbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot; Close&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      InitBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, open, INDICATOR_DATA, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      InitBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, high, INDICATOR_DATA, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      InitBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, low, INDICATOR_DATA, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      InitBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, close, INDICATOR_DATA, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      title </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;# Open;# High;# Low;# Close&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      StringReplace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(title, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;#&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, symbol);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> title;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>请注意，当开启折线图模式时，仅使用<code>close</code>数组，它被分配索引0。由于<code>INDICATOR_CALCULATIONS</code>属性，其余三个数组对用户完全隐藏。在蜡烛图和K线模式下，使用所有四个数组，并且它们的编号符合OHLC标准，这是<code>DRAW_CANDLES</code>和<code>DRAW_BARS</code>绘图类型所要求的。所有数组都被赋予“串行”属性，即从右到左进行索引。</p><p><code>InitBuffers</code>函数返回数据窗口中缓冲区的标题。</p><p>所有必需的绘图属性都在<code>InitPlot</code>函数中设置。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InitPlot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> string</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> style</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> width</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> colorx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> empty</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EMPTY_VALUE)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(index, PLOT_DRAW_TYPE, style);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  PlotIndexSetString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(index, PLOT_LABEL, name);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  PlotIndexSetDouble</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(index, PLOT_EMPTY_VALUE, empty);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(index, PLOT_LINE_WIDTH, width);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(colorx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(index, PLOT_LINE_COLOR, colorx);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>在<code>OnInit</code>处理程序中，使用新函数完成单个图表（索引为0）的初始设置。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   InitPlot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">InitBuffers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Mode), </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Mode2Style</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Mode));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   IndicatorSetString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(INDICATOR_SHORTNAME, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;SubChart (&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> symbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   IndicatorSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(INDICATOR_DIGITS, (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SymbolInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, SYMBOL_DIGITS));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">     </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INIT_SUCCEEDED;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>虽然在这个指标版本中设置只执行一次，但它是动态进行的，会考虑到<code>mode</code>输入参数，这与<code>#property</code>指令提供的静态设置不同。在未来，在指标的完整版本中，我们可以多次调用<code>InitPlot</code>，“即时”更改指标的外观。</p><p>缓冲区在<code>OnCalculate</code>中填充。在最简单的情况下，当给定的品种与图表相同时，我们可以简单地使用以下实现。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> rates_total</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> prev_calculated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> datetime</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">op</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">hi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">lo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[])</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 未使用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 需要澄清（见下文）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArrayInitialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(open, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArrayInitialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(high, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArrayInitialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(low, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArrayInitialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(close, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Symbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> symbol)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 正在开发</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArraySetAsSeries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(op, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArraySetAsSeries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hi, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArraySetAsSeries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lo, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArraySetAsSeries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cl, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MathMax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prev_calculated, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         open[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> op[i];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         high[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> hi[i];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         low[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lo[i];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         close[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cl[i];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>然而，在处理任意品种时，数组参数不包含所需的报价，并且可用K线的总数可能不同。此外，当首次将指标放置在图表上时，如果没有提前为“外部”品种打开另一个图表，其报价可能根本未准备好。而且，第三方品种的报价将异步加载，因此新的K线批次可能随时“到达”，需要进行完整的重新计算。</p><p>因此，让我们创建一些变量来控制另一个品种的K线数量（<code>lastAvailable</code>）、一个可编辑的常量参数<code>prev_calculated</code>的“副本”，以及一个报价准备就绪的标志。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> initialized;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 品种报价准备就绪标志</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastAvailable;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 品种（和当前时间框架）的K线数量</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prev_calculated;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 可编辑的prev_calculated副本</span></span></code></pre></div><p>在<code>OnCalculate</code>开始时，我们添加一个检查，以查看是否同时出现了多个K线：我们使用<code>lastAvailable</code>变量，该变量在函数上一次正常退出之前（即在成功计算的情况下）根据<code>iBars(symbol, _Period)</code>的值进行填充。如果加载了额外的历史数据，我们应该将<code>_prev_calculated</code>和K线数量重置为0，并移除准备就绪标志，以便重新计算指标。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> rates_total</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> prev_calculated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> datetime</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">op</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">hi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">lo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[])</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 未使用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">iBars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, _Period) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastAvailable </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 加载额外的历史数据或首次启动</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      _prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      initialized </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      lastAvailable </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 然后在各处使用_prev_calculated的副本</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArrayInitialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(open, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArrayInitialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(high, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArrayInitialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(low, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArrayInitialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(close, EMPTY_VALUE);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Symbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> symbol)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 请求报价并“等待”它们准备好</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 主要计算（填充缓冲区）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ...</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 保持原样</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   } </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   lastAvailable </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iBars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, _Period);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>注释中的“等待”一词加引号并非偶然。我们知道，在指标中不能真正地等待（以免减慢终端的界面线程）。相反，如果数据不足，我们应该简单地退出函数。因此，“等待”意味着等待下一个计算事件：在tick到达时或响应图表更新请求时。</p><p>以下代码将检查报价是否准备好。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> rates_total</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> prev_calculated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> datetime</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">op</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">hi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">lo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[])</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 未使用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Symbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> symbol)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">initialized)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Host &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, _Symbol, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, rates_total, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; bars up to &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (string)time[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Updating &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, symbol, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, lastAvailable, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; -&gt; &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">iBars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, _Period), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; / &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">iBars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, _Period) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">               (string)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">iTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, _Period, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">iBars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, _Period) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;n/a&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            &quot;... Please wait&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">QuoteRefresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, _Period, time[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            initialized </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 异步请求更新图表</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            ChartSetSymbolPeriod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, _Symbol, _Period);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 目前没有可显示的内容</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ...</span></span></code></pre></div><p>主要工作由特殊的<code>QuoteRefresh</code>函数完成。它接收所需的品种、时间框架和当前图表上第一个（最旧）K线的时间作为参数——我们对更早的日期不感兴趣，但请求的品种可能没有这么深的历史数据。这就是为什么将所有检查的复杂性隐藏在一个单独的函数中很方便。</p><p>一旦数据下载并同步到可用程度，该函数将返回<code>true</code>。我们稍后将研究其内部结构。</p><p>同步完成后，我们使用<code>iBarShift</code>函数找到同步的K线，并复制它们的OHLC值（<code>iOpen</code>、<code>iHigh</code>、<code>iLow</code>、<code>iClose</code>函数）。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArraySetAsSeries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(time, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 从现在到过去</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MathMax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _prev_calculated, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iBarShift</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, _Period, time[i], </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      open[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, _Period, x);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      high[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iHigh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, _Period, x);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      low[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iLow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, _Period, x);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      close[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, _Period, x);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      open[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> high[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> low[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> close[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EMPTY_VALUE;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>一种看似更高效的替代方法是使用<code>Copy</code>函数复制整个价格数组，但这里并不适用，因为不同品种上具有相同索引的K线可能对应不同的时间戳。因此，复制后，你必须分析日期并在缓冲区内移动元素，使其与当前图表上的时间相匹配。</p><p>由于在<code>iBarShift</code>函数中最后一个参数传递的是<code>true</code>，该函数将查找K线时间的精确匹配。如果另一个品种中没有K线，我们将得到 -1，并在图表上显示空白（<code>EMPTY_VALUE</code>）。</p><p>成功完成完整计算后，新的K线将以经济模式进行计算，即考虑<code>_prev_calculated</code>和<code>rates_total</code>。</p><p>现在让我们来看看<code>QuoteRefresh</code>函数。这是一个通用且有用的函数，因此将其放在头文件<code>QuoteRefresh.mqh</code>中。</p><p>在一开始，我们检查是否从指标类型的MQL程序中请求当前品种和当前时间框架的时间序列。此类请求是被禁止的，因为指标运行所依赖的“原生”时间序列已经由终端构建或准备好：再次请求它可能会导致循环或阻塞。因此，我们只需返回同步标志（<code>SERIES_SYNCHRONIZED</code>），如果尚未准备好，指标应稍后检查数据（在下一个tick、通过定时器或其他方式）。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> QuoteRefresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> string</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> asset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ENUM_TIMEFRAMES</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> period</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> datetime</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MQL5InfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(MQL5_PROGRAM_TYPE) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PROGRAM_INDICATOR</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _Symbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> asset </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _Period </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> period)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SeriesInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(asset, period, SERIES_SYNCHRONIZED);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span></code></pre></div><p>第二个检查涉及K线数量：如果已经达到图表上允许的最大数量，继续下载任何内容就没有意义了。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Bars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(asset, period) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TerminalInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TERMINAL_MAXBARS))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SeriesInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(asset, period, SERIES_SYNCHRONIZED);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span></code></pre></div><p>接下来的代码部分按顺序从终端请求可用报价的起始日期：</p><ul><li>按给定的时间框架（<code>SERIES_FIRSTDATE</code>）</li><li>不关联时间框架（<code>SERIES_TERMINAL_FIRSTDATE</code>），在终端的本地数据库中</li><li>不关联时间框架（<code>SERIES_SERVER_FIRSTDATE</code>），在服务器上</li></ul><p>如果在任何阶段，请求的日期已经在可用数据区域内，我们将得到<code>true</code>作为准备就绪的标志。否则，将从终端的本地数据库或服务器请求数据，然后构建时间序列（所有这些都是异步自动响应我们的<code>CopyTime</code>调用完成的；也可以使用其他<code>Copy</code>函数）。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime times[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime first </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, server </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SeriesInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(asset, period, SERIES_FIRSTDATE, first)))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(first </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> first </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> start)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 应用程序数据存在，它已经准备好或正在准备中</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SeriesInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(asset, period, SERIES_SYNCHRONIZED);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   else</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SeriesInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(asset, period, SERIES_TERMINAL_FIRSTDATE, first)))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(first </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> first </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> start)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // 终端数据库中存在技术数据，</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // 启动时间序列的构建或立即获取所需数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CopyTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(asset, period, first, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, times)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SeriesInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(asset, period, SERIES_SERVER_FIRSTDATE, server)))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 服务器上存在技术数据，我们来请求它</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(first </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> first </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> server)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">               PrintFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                 &quot;Warning: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> first date </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on server is less than on terminal &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                  asset, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TimeToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(server), </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TimeToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(first));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 不能请求超过服务器拥有的数据 - 所以取最大值</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CopyTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(asset, period, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fmax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(start, server), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, times)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>指标已经完成。我们来编译并运行它，例如在EURUSD的H1图表上，指定USDRUB作为额外的品种。日志将显示如下内容：</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Host EURUSD </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20001</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bars up to </span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">2018.08.09</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 13</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Updating USDRUB </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 14123</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;"> 2014.12.22</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 11</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">00...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Please wait</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SeriesInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol,period,SERIES_FIRSTDATE,first)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HISTORY_NOT_FOUND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4401</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Host EURUSD </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20001</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bars up to </span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">2018.08.09</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 13</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Updating USDRUB </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 14123</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;"> 2014.12.22</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 11</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">00...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Please wait</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SeriesInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol,period,SERIES_FIRSTDATE,first)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ok</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Done</span></span></code></pre></div><p>处理完成（显示“Done”消息）后，子窗口将显示另一个图表的蜡烛图。</p><h3 id="indsubchartsimple指标-带有第三方品种报价的draw-candles" tabindex="-1">IndSubChartSimple指标 - 带有第三方品种报价的<code>DRAW_CANDLES</code> <a class="header-anchor" href="#indsubchartsimple指标-带有第三方品种报价的draw-candles" aria-label="Permalink to &quot;IndSubChartSimple指标 - 带有第三方品种报价的`DRAW_CANDLES`&quot;">​</a></h3><p>重要的是要注意，由于交易时段缩短，USDRUB的有效K线仅占据每个日间隔的日间部分。</p><h3 id="indunitypercent" tabindex="-1">IndUnityPercent <a class="header-anchor" href="#indunitypercent" aria-label="Permalink to &quot;IndUnityPercent&quot;">​</a></h3><p>我们在本节中创建的第二个指标是一个真正的多货币（多资产）指标<code>IndUnityPercent.mq5</code>。其理念是显示给定金融产品中所有独立货币（资产）的相对强度。例如，如果我们交易包含两个品种EURUSD和XAUUSD的篮子，那么篮子价值中会考虑美元、欧元和黄金，这些资产中的每一个相对于其他资产都有一个相对价值。</p><p>在每个时间点，都有当前价格，用以下公式描述：</p><div class="language-plaintext vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">plaintext</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>EUR / USD = EURUSD</span></span>
<span class="line"><span>XAU / USD = XAUUSD</span></span></code></pre></div><p>其中，变量<code>EUR</code>、<code>USD</code>、<code>XAU</code>是资产的一些独立“价值”，而<code>EURUSD</code>和<code>XAUUSD</code>是常量（已知报价）。</p><p>为了求解这些变量，我们向方程组中添加另一个方程，将变量的平方和限制为1（因此指标名称中的第一个词是“Unity”）：</p><div class="language-plaintext vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">plaintext</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>EUR * EUR + USD * USD + XAU * XAU = 1</span></span></code></pre></div><p>可能会有更多的变量，我们可以将它们表示为<code>xi</code>。请注意，<code>x0</code>是所有产品共有的主要货币，是必需的。</p><p>那么，一般来说，计算变量的公式如下（我们将省略其推导过程）：</p><div class="language-plaintext vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">plaintext</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>x0 = sqrt(1 / (1 + sum(C(xi, x0)^2))), i = 1..n</span></span>
<span class="line"><span>xi = C(xi, x0) * x0, i = 1..n</span></span></code></pre></div><p>其中，<code>n</code>是变量的数量，<code>C(xi,x0)</code>是第<code>i</code>个品种对的报价。请注意，变量的数量比产品的数量多1。</p><p>由于计算中涉及的报价通常差异很大（例如，EURUSD和XAUUSD的情况），并且仅通过彼此表示（即不参考任何稳定的基准），因此从绝对值转换为百分比变化是有意义的。因此，在根据上述公式编写算法时，我们将采用报价<code>C(xi,x0)[0] / C(xi,x0)[1]</code>的比率，其中方括号中的索引表示当前[0]和前一个[1]K线。此外，为了加快计算速度，可以去掉平方和开方运算。</p><p>为了可视化线条，我们将提供一个最大允许的货币数量和指标缓冲区。当然，如果用户输入的品种较少，计算中可以只使用其中一些缓冲区。但不能动态增加限制，需要更改指令并重新编译指标。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BUF_NUM</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 15</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_separate_window</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_buffers BUF_NUM</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_plots BUF_NUM</span></span></code></pre></div><p>在实现这个指标时，我们将顺便解决一个麻烦的问题。由于会有许多相同类型的缓冲区，标准方法是通过大量“复制粘贴”来进行编码，这是不可取的。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> buffer1[];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> buffer15[];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, buffer1);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">14</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, buffer15);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>这种方式不方便、效率低且容易出错。相反，我们采用面向对象编程（OOP）。我们将创建一个类，该类将存储指标缓冲区的数组，并负责统一设置，因为我们的缓冲区应该是相同的（除了颜色，对于构成当前图表品种的货币，线条可能会加粗，但这是在用户输入参数后进行调整的）。</p><p>有了这样的类，我们可以简单地分配一个其对象的数组，指标缓冲区将自动连接并按所需数量进行配置。示意性地，这种方法由以下伪代码说明。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 支持统一指标缓冲区数组的“引擎”代码</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Buffer</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 全局缓冲区计数器</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> array[];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 此缓冲区的数组</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cursor;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       // 分配元素的指针</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 构造函数设置并连接数组</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      SetIndexBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(count</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, array);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArraySetAsSeries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(array, ...);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 重载以设置感兴趣的元素编号</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Buffer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *operator</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      cursor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> index;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 重载以将值写入所选元素</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> operator</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> x</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      buffer[cursor] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::count;</span></span></code></pre></div><p>通过运算符重载，我们可以使用熟悉的语法为缓冲区对象的元素赋值：<code>buffer[i] = value</code>。</p><p>在指标代码中，只需定义一个“数组的数组”，而不是许多单独数组的描述行。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 指标代码</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 构造15个缓冲区对象，自动注册和配置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Buffer buffers[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">15</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span></code></pre></div><p>实现此机制的类的完整版本可在文件<code>IndBufArray.mqh</code>中找到。请注意，它仅支持缓冲区，不支持图表。理想情况下，应该用新的类扩展类集，允许创建现成的图表对象，这些对象将根据特定图表的类型占用缓冲区数组中所需数量的缓冲区。我们建议你自己研究并补充该文件。特别是，代码中包含一个管理指标缓冲区数组的类<code>BufferArray</code>，用于创建具有相同属性值的“数组的数组”，如<code>ENUM_INDEXBUFFER_TYPE</code>类型、索引方向、空值。我们在新指标中如下使用它：</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">BufferArray</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> buffers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">BUF_NUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>这里，构造函数的第一个参数传递所需的缓冲区数量，第二个参数传递是否按时间序列进行索引的指示（下面会详细说明）。</p><p>定义之后，我们可以在代码的任何地方使用方便的表示法来设置第<code>i</code>个缓冲区的第<code>j</code>个K线的值（它使用缓冲区对象和缓冲区数组中<code>[]</code>运算符的双重重载）：</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buffers[i][j] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> value;</span></span></code></pre></div><p>在指标的输入变量中，我们允许用户指定一个用逗号分隔的品种列表，并限制历史计算的K线数量，以控制潜在大量产品的加载和同步。如果你决定显示整个可用历史，应该识别并应用不同产品可用的最小K线数量，并控制从服务器加载额外的历史数据。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input string Instruments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;EURUSD,GBPUSD,USDCHF,USDJPY,AUDUSD,USDCAD,NZDUSD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BarLimit </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>程序启动时，解析品种列表并形成一个单独的<code>Symbols</code>数组，其大小为<code>SymbolCount</code>。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string Symbols[];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> direction[];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 与通用货币的直接(+1)/反向(-1)汇率</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SymbolCount;</span></span></code></pre></div><p>所有品种必须有相同的通用货币（通常是美元），以便揭示相互关联。根据特定品种中的通用货币是基础货币（在外汇对中排在第一位）还是报价货币（在外汇对中排在第二位），计算中使用其直接或反向报价（1.0 / 汇率）。这个方向将存储在<code>Direction</code>数组中。</p><p>让我们看看执行上述操作的<code>InitSymbols</code>函数。如果列表解析成功，它将返回通用货币的名称。内置的<code>SymbolInfoString</code>函数允许获取任何金融产品的基础货币和报价货币，我们将在关于金融产品的章节中学习它。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">string</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InitSymbols</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   SymbolCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fmin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringSplit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Instruments, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;,&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Symbols), BUF_NUM </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayResize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Symbols, SymbolCount);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayResize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Direction, SymbolCount);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayInitialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Direction, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   string common </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 通用货币</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SymbolCount; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 确保品种在市场报价窗口中存在</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SymbolSelect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Symbols[i], </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Can&#39;t select &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Symbols[i]);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 获取构成品种的货币</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      string first, second;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      first </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SymbolInfoString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Symbols[i], SYMBOL_CURRENCY_BASE);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      second </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SymbolInfoString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Symbols[i], SYMBOL_CURRENCY_PROFIT);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 统计每种货币的出现次数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(first </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> second)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         workCurrencies.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">inc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(first);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         workCurrencies.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">inc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(second);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         workCurrencies.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">inc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Symbols[i]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span></code></pre></div><p>循环使用辅助模板类<code>MapArray</code>跟踪每种货币在所有产品中的出现次数。这样的对象在指标的全局级别进行描述，需要包含头文件<code>MapArray.mqh</code>。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;MQL5Book/MapArray.mqh&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 键值对数组 [名称; 数量]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 用于计算货币使用统计</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MapArray</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> workCurrencies;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">string</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InitSymbols</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>由于这个类起辅助作用，这里不详细描述。你可以查看源代码以获取更多详细信息。其要点是，当为新的货币名称调用其<code>inc</code>方法时，它会将其添加到内部数组中，计数器的初始值为1，如果该名称已经出现过，则计数器加1。</p><p>随后，我们将计数器大于1的货币确定为通用货币。如果设置正确，其余货币应该恰好出现一次。以下是<code>InitSymbols</code>函数的继续部分。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 根据货币使用统计找到通用货币</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> workCurrencies.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(workCurrencies[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 计数器大于1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(common </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         common </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> workCurrencies.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 获取第i种货币的名称</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Collision: multiple common symbols&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(common </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) common </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> workCurrencies.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 知道通用货币后，确定每个品种的“方向”</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SymbolCount; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SymbolInfoString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Symbols[i], SYMBOL_CURRENCY_PROFIT) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> common)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      Direction[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SymbolInfoString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Symbols[i], SYMBOL_CURRENCY_BASE) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> common)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      Direction[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Ambiguous symbol direction &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Symbols[i], </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;, defaults used&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      Direction[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> common;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>有了<code>InitSymbols</code>函数，我们可以编写<code>OnInit</code>（简化版）。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string common </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InitSymbols</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(common </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INIT_PARAMETERS_INCORRECT;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   string base </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SymbolInfoString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Symbol, SYMBOL_CURRENCY_BASE);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   string profit </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SymbolInfoString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Symbol, SYMBOL_CURRENCY_PROFIT);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 根据货币数量（品种数量 + 1）设置线条</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SymbolCount; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      string name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> workCurrencies.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PlotIndexSetString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i, PLOT_LABEL, name);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i, PLOT_DRAW_TYPE, DRAW_LINE);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i, PLOT_SHOW_DATA, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i, PLOT_LINE_WIDTH, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> base </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> profit));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 隐藏数据窗口中多余的缓冲区</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SymbolCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BUF_NUM; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PlotIndexSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i, PLOT_SHOW_DATA, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 在1.0处设置一个水平参考线</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   IndicatorSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(INDICATOR_LEVELS, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   IndicatorSetDouble</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(INDICATOR_LEVELVALUE, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 带有参数的名称</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   IndicatorSetString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(INDICATOR_SHORTNAME,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &quot;Unity [&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (string)workCurrencies.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;]&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 精度</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   IndicatorSetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(INDICATOR_DIGITS, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INIT_SUCCEEDED;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>现在让我们来看看主要的事件处理程序<code>OnCalculate</code>。</p><p>重要的是要注意，主循环中遍历K线的顺序是反向的，就像在时间序列中一样，从现在到过去。这种方法对于多货币指标更方便，因为不同品种的历史深度可能不同，从当前K线往回计算直到任何一个品种没有数据的第一个时刻是有意义的。在这种情况下，提前终止循环不应被视为错误，我们应该返回<code>rates_total</code>以在图表上显示已经计算好的最相关K线的值。</p><p>然而，在这个简化版的<code>IndUnityPercent</code>中，我们不这样做，而是采用一种更简单、更严格的方法：用户必须使用<code>BarLimit</code>参数定义无条件的历史查询深度。换句话说，对于所有品种，必须有数据直到图表品种上编号为<code>BarLimit</code>的K线的时间戳。否则，指标将尝试下载缺失的数据。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> rates_total</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> prev_calculated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> begin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> price</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      buffers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">empty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 将全部清理工作委托给BufferArray类</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 主循环，按照“时间序列”的方向从现在到过去</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> limit </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MathMin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rates_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prev_calculated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, BarLimit);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> limit; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">calculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         EventSetTimer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 再给1秒时间来上传和准备数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 下次调用时再尝试重新计算</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><code>Calculate</code>函数（见下文）计算第<code>i</code>个K线上所有缓冲区的值。如果数据缺失，它将返回<code>false</code>，我们将启动一个定时器，以便有时间为所有所需产品构建时间序列。在定时器处理程序中，我们将以通常的方式向终端发送更新图表的请求。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnTimer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   EventKillTimer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ChartSetSymbolPeriod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, _Symbol, _Period);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>在 <code>Calculate</code> 函数中，我们首先确定当前 K 线和前一根 K 线的日期范围，将根据这个范围来计算变化。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Calculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime time0 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Symbol, _Period, bar);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime time1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Symbol, _Period, bar </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span></code></pre></div><p>需要这两个日期来调用下一个函数 <code>CopyClose</code> 的特定版本，在这个版本中会指定日期区间。在这个指标中，我们不能使用基于 K 线数量的选项，因为任何一个品种都可能存在与其他品种不同的任意 K 线间隔。例如，如果一个品种上有 K 线 <code>t</code>（当前）和 <code>t-1</code>（前一个），那么就可以正确计算变化值 <code>Close[t]/Close[t-1]</code>。然而，在另一个品种上，K 线 <code>t</code> 可能不存在，并且请求两根 K 线将返回左边“最近”的 K 线（在过去），而这个过去可能与“现在”相差很远（例如，如果该品种不是全天候交易，可能对应于前一天的交易时段）。</p><p>为了避免这种情况，指标严格在指定区间内请求报价，如果对于某个特定品种，该区间为空，这意味着没有变化。</p><p>同时，可能会出现这样的情况，即这种查询返回的 K 线数量可能超过两根，在这种情况下，总是取最后两根（右边）的 K 线作为最相关的 K 线。例如，当放置在 USDRUB 的 H1 图表上时，指标会“看到”每个工作日 17:00 的 K 线之后，会有下一个工作日 10:00 的 K 线。然而，对于像 EURUSD 这样的主要外汇货币对，在它们之间会有 16 根晚上、夜间和早上的 H1 K 线。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Calculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> w[];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 接收报价的数组（按 K 线）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v[];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 特征变化值</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayResize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(v, SymbolCount);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 找到每个品种的报价变化</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SymbolCount; j</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 尝试获取第 j 个品种至少 2 根 K 线，</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 对应于当前图表品种的两根 K 线</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CopyClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Symbols[j], _Period, time0, time1, w);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // 如果没有 K 线，尝试从过去获取前一根 K 线</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CopyClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Symbols[j], _Period, time0, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, w) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // 然后将其复制以表示没有变化</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // （原则上，可以两次写入任何常量）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         ArrayResize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(w, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         w[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> w[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 在需要时找到反向汇率</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Direction[j] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         w[x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> w[x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         w[x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> w[x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 计算变化值，即两个值的比率</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      v[j] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> w[x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> w[x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 最后一根 / 前一根</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span></code></pre></div><p>当获取到变化值后，算法按照前面给出的公式进行计算，并将值写入指标缓冲区。</p><div class="language-c++ vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SymbolCount; j</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v[j];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> base_0 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sum);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   buffers[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">][bar] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> base_0 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (SymbolCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SymbolCount; j</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      buffers[j][bar] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> base_0 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v[j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (SymbolCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>让我们看看在默认设置下，该指标在一组基本外汇产品上的运行情况（在首次放置时，如果之前没有为这些产品打开图表，可能需要花费一些时间来接收时间序列）。</p><h4 id="包含主要外汇货币的多货币指标-indunitypercent" tabindex="-1">包含主要外汇货币的多货币指标 IndUnityPercent <a class="header-anchor" href="#包含主要外汇货币的多货币指标-indunitypercent" aria-label="Permalink to &quot;包含主要外汇货币的多货币指标 IndUnityPercent&quot;">​</a></h4><p>指标窗口中两种货币线条之间的距离等于相应报价的百分比变化（在两个连续的收盘价 <code>Close</code> 之间）。这就是指标名称中第二个词“Percent”的由来。</p><p>在下一章关于指标的编程使用中，我们将介绍 <code>IndUnityPercentPro.mq5</code> 的高级版本，在这个版本中，<code>Copy</code> 函数将被调用内置指标 <code>iMA</code> 所取代，这将使我们能够轻松实现对任意价格类型的平滑处理和计算，而无需任何额外的工作。</p><h2 id="跟踪k线形成" tabindex="-1">跟踪K线形成 <a class="header-anchor" href="#跟踪k线形成" aria-label="Permalink to &quot;跟踪K线形成&quot;">​</a></h2><p>上一节讨论的 <code>IndUnityPercent.mq5</code> 指标在每一个报价时都会对最后一根K线进行重新计算，因为它使用了收盘价。一些指标和智能交易系统是以更节省资源的方式专门开发的，即每根K线只进行一次计算。例如，我们可以根据开盘价来计算Unity的公式，这样的话就可以跳过报价数据。有几种方法可以检测新的K线：</p><ol><li>记住当前第0根K线的时间（通过 <code>OnCalculate</code> 函数的 <code>time</code> 参数 —— <code>time[0]</code>，或者一般来说，<code>iTime(symbol, period, 0)</code>），并等待其变化。</li><li>记住K线数量 <code>rates_total</code>（或 <code>iBars(symbol, period)</code>），并对增加1做出反应（向任何一个方向变化为不同的数量都值得怀疑，可能表明历史数据被修改了）。</li><li>等待一根报价成交量等于1的K线（该K线的第一个报价）。</li></ol><p>然而，由于指标的多货币特性，新K线形成的概念变得不那么明确了。</p><p>在每个交易品种上，下一根K线会在其自身的报价到达时出现，而且它们的到达时间通常不同。在这种情况下，指标开发者必须决定如何操作：是等待所有交易品种上出现时间相同的K线，还是在任何一个交易品种上出现新K线后，对最后几根K线多次重新计算指标。</p><p>在本节中，我们将引入一个简单的类 <code>MultiSymbolMonitor</code>（见文件 <code>MultiSymbolMonitor.mqh</code>），用于根据给定的交易品种列表跟踪新K线的形成。</p><p>所需的时间周期可以传递给类的构造函数。默认情况下，它会跟踪程序运行所在的当前图表的时间周期。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MultiSymbolMonitor</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">protected:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ENUM_TIMEFRAMES period;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    MultiSymbolMonitor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(): </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">period</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Period) {}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    MultiSymbolMonitor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ENUM_TIMEFRAMES</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">): </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">period</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(p) {}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span></code></pre></div><p>为了存储跟踪的交易品种列表，我们将使用上一节中的辅助类 <code>MapArray</code>。在这个数组中，我们将写入 [交易品种名称; 最后一根K线的时间戳] 对，即模板类型 <code>&lt;string, datetime&gt;</code>。<code>attach</code> 方法用于填充该数组。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">protected:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    MapArray</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string,datetime</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastTime;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> attach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> string</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        lastTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span></code></pre></div><p>对于给定的数组，该类可以在 <code>check</code> 方法中通过在交易品种循环中调用 <code>iTime</code> 函数来更新和检查时间戳。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ulong</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> bool</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> refresh</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ulong flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string symbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime dt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, period, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastTime[symbol])</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 有变化吗？</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(refresh)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 更新时间戳</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            lastTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, dt);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flags;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>调用代码应该自行决定何时调用 <code>check</code> 方法，通常是在报价到达时或通过定时器调用。严格来说，这两种选择都不能对其他交易品种上报价（和新K线）的出现提供即时反应，因为 <code>OnCalculate</code> 事件只在图表的工作交易品种的报价时出现，如果在这些报价之间有其他交易品种的报价，我们在下次 “自己的” 报价之前都不会知道。</p><p>我们将在关于交互式图表事件的章节中考虑对多个交易品种的报价进行实时监控（请参阅 “自定义事件生成” 部分的间谍指标 <code>EventTickSpy.mq5</code>）。</p><p>目前，我们将以可用的精度检查K线。那么，让我们继续看 <code>check</code> 方法。</p><p>每个时间点都由为数组中所有交易品种设置的时间戳的各自状态来表征。例如，新的K线可能只在流动性最强的交易品种上在12:00形成，而对于其他几个交易品种，报价可能会在几毫秒甚至几秒后出现。在这个时间间隔内，数组中的一个元素将被更新，其余的仍然是旧的。然后，所有交易品种将逐渐都出现12:00的K线。</p><p>对于最后一根K线的开盘时间与保存的时间不相等的所有交易品种，该方法会设置该交易品种编号对应的位，从而形成一个带有变化的位掩码。该列表中包含的交易品种不能超过64个。</p><p>如果返回值为零，则表示没有注册到变化。</p><p><code>refresh</code> 参数指定 <code>check</code> 方法是只注册变化（<code>false</code>），还是根据当前市场情况更新状态（<code>true</code>）。</p><p><code>describe</code> 方法允许通过位掩码获取已变化的交易品种列表。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">string</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> describe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ulong</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> flags</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    string message </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            message </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> message;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>接下来，我们将使用 <code>inSync</code> 方法来确定数组中的所有交易品种是否具有相同的最后一根K线时间。只有对于具有相同交易时段的一组货币，使用这个方法才有意义。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> inSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lastTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime first </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastTime[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(first </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastTime[i]) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>使用上述描述的类，我们实现了一个简单的多货币指标 <code>IndMultiSymbolMonitor.mq5</code>，它唯一的任务是检测给定交易品种列表的新K线。</p><p>由于该指标不提供绘图功能，所以缓冲区和图表的数量为0。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_chart_window</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_buffers </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property indicator_plots   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span></code></pre></div><p>交易品种列表在相应的输入变量中指定，然后转换为在监控对象中注册的数组。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input string Instruments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;EURUSD,GBPUSD,USDCHF,USDJPY,AUDUSD,USDCAD,NZDUSD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;MQL5Book/MultiSymbolMonitor.mqh&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MultiSymbolMonitor monitor;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    string symbols[];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StringSplit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Instruments, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;,&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, symbols);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        monitor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">attach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbols[i]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><code>OnCalculate</code> 处理函数在报价时调用监控器，并将状态变化输出到日志中。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnCalculate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> rates_total</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> prev_calculated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> begin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">price</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ulong changes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> monitor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(changes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;新K线出现在: &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, monitor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">describe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(changes),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">              &quot;, 同步状态:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, monitor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">inSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rates_total;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>要检查这个指标，我们需要在终端上花费大量的在线时间。然而，MetaTrader 5 提供了一种更简单的方法 —— 借助测试器。我们将在下一节中进行介绍。</p><h2 id="测试指标" tabindex="-1">测试指标 <a class="header-anchor" href="#测试指标" aria-label="Permalink to &quot;测试指标&quot;">​</a></h2><p>MetaTrader 5 内置的测试器支持两种类型的 MQL 程序：智能交易系统（Expert Advisors）和指标（Indicators）。指标总是在可视化窗口中进行测试。但这仅适用于对独立指标的测试。如果指标是由智能交易系统以编程方式创建和调用的，那么这个智能交易系统连同指标可以根据用户的意愿在无可视化的情况下进行测试。我们将在下一章学习从 MQL 代码中使用指标的技术。同样的技术也将用于与智能交易系统的集成。</p><p>同时，指标开发者应该注意，在无可视化的情况下，测试器对从智能交易系统调用的指标使用一种加速计算方法。数据并非在每个报价时都进行计算，而是仅在从指标缓冲区请求相关数据时才计算（请参阅 <code>CopyBuffer</code> 函数）。</p><p>如果指标在当前报价时尚未进行计算，那么在首次访问其数据时会计算一次。如果在同一报价期间产生了其他请求，则会以已计算好的形式返回数据。如果在当前报价时未读取指标缓冲区，则不会对指标进行计算。指标的按需计算在测试和优化过程中能显著提高速度。</p><p>如果某个指标需要精确计算且不能跳过报价，MQL5 可以指示测试器在每个报价时都重新计算指标。这可以通过以下指令来实现：</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property tester_everytick_calculate</span></span></code></pre></div><p>该指令中的 “everytick” 专门指的是指标的计算，并且不会影响报价生成模式。换句话说，报价是指测试器生成的价格变化，无论是每个报价、OHLC M1 价格，还是 K 线开盘价格，并且测试器的这个设置仍然有效。</p><p>对于本章中我们所考虑的指标，这个属性并非至关重要。还应注意的是，它仅适用于策略测试器中的操作。在终端中，指标总是在每个传入的报价时接收 <code>OnCalculate</code> 事件（前提是如果 <code>OnCalculate</code> 中的计算耗时过长，无法在新报价到达之前完成计算，那么指标有可能会跳过某些报价）。</p><p>至于测试器，在以下任何一种情况下，指标都会在每个报价时进行计算：</p><ol><li>在可视化模式下。</li><li>如果存在 <code>tester_everytick_calculate</code> 指令。</li><li>如果指标有 <code>EventChartCustom</code> 调用，或者有 <code>OnChartEvent</code> 或 <code>OnTimer</code> 函数。</li></ol><p>让我们尝试测试上一节中的 <code>IndMultiSymbolMonitor.mq5</code> 指标。</p><p>我们选择 EURUSD 货币对，时间周期为 H1 图表的主要交易品种和时间周期。报价生成方法为 “基于真实报价”。</p><p>开始测试后，我们应该在可视化模式窗口的日志中看到以下记录：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>2021.10.20 00:00:00   新K线出现在: EURUSD USDCHF USDJPY , 同步状态:false</span></span>
<span class="line"><span>2021.10.20 00:00:00   新K线出现在: AUDUSD , 同步状态:false</span></span>
<span class="line"><span>2021.10.20 00:00:00   新K线出现在: GBPUSD , 同步状态:false</span></span>
<span class="line"><span>2021.10.20 00:00:02   新K线出现在: USDCAD , 同步状态:false</span></span>
<span class="line"><span>2021.10.20 00:00:11   新K线出现在: NZDUSD , 同步状态:true</span></span>
<span class="line"><span>2021.10.20 01:00:04   新K线出现在: EURUSD GBPUSD USDCHF USDJPY AUDUSD USDCAD NZDUSD , 同步状态:true</span></span>
<span class="line"><span>2021.10.20 02:00:00   新K线出现在: EURUSD USDJPY NZDUSD , 同步状态:false</span></span>
<span class="line"><span>2021.10.20 02:00:00   新K线出现在: USDCHF , 同步状态:false</span></span>
<span class="line"><span>2021.10.20 02:00:01   新K线出现在: AUDUSD , 同步状态:false</span></span>
<span class="line"><span>2021.10.20 02:00:15   新K线出现在: GBPUSD USDCAD , 同步状态:true</span></span>
<span class="line"><span>2021.10.20 03:00:00   新K线出现在: EURUSD AUDUSD NZDUSD , 同步状态:false</span></span>
<span class="line"><span>2021.10.20 03:00:00   新K线出现在: GBPUSD USDJPY USDCAD , 同步状态:false</span></span>
<span class="line"><span>2021.10.20 03:00:12   新K线出现在: USDCHF , 同步状态:true</span></span></code></pre></div><p>如你所见，新的 K 线在不同的交易品种上逐渐出现。通常，在 “同步” 标志设置为 <code>true</code> 之前会发生几个事件。</p><p>你也可以对本章中的其他指标进行测试。请注意，如果一个 MQL 程序查询报价历史记录，请在测试器中选择 “基于真实报价” 的生成方法。</p><p>“按开盘价测试” 仅适用于为支持此模式而开发的指标和智能交易系统，例如，它们仅根据开盘价进行计算，或者从第 1 根 K 线开始分析已完成的 K 线。</p><p>注意！在测试器中测试指标时，<code>OnDeinit</code> 事件不起作用。此外，不会执行其他的清理操作，例如，全局对象的析构函数不会被调用。</p><h2 id="指标的局限性和优势" tabindex="-1">指标的局限性和优势 <a class="header-anchor" href="#指标的局限性和优势" aria-label="Permalink to &quot;指标的局限性和优势&quot;">​</a></h2><p>本章讨论的所有专用函数仅在指标的源代码中可用。在其他类型的 MQL 程序中使用它们是没有意义的，因为这些函数会返回错误。</p><p>还有一些函数在指标中是被禁止使用的：</p><ul><li><code>OrderCalcMargin</code></li><li><code>OrderCalcProfit</code></li><li><code>OrderCheck</code></li><li><code>OrderSend</code></li><li><code>SendFTP</code></li><li><code>WebRequest</code></li><li><code>Socket***</code></li><li><code>Sleep</code></li><li><code>MessageBox</code></li><li><code>ExpertRemove</code></li></ul><p>其中一些函数（带有 <code>Order-</code> 前缀的）涉及交易计算，仅允许在智能交易系统和脚本中使用。其他函数用于执行请求，这些请求会阻塞线程的执行，直到返回结果，而指标不允许这样做，因为指标是在终端的界面线程中执行的。出于类似的原因，<code>Sleep</code> 和 <code>MessageBox</code> 函数也被禁止使用。</p><p>指标主要负责数据的可视化，奇怪的是，它并不适合进行大规模计算。特别是，如果你决定创建一个在过程中训练神经网络或决策树的指标，这很可能会对终端的正常运行产生负面影响。</p><p>长时间计算的影响可以通过指标 <code>IndBarIndex.mq5</code> 来展示，在正常模式下，该指标旨在在其缓冲区元素中显示 K 线编号。然而，使用输入参数 <code>SimulateCalculation</code>（应设置为 <code>true</code>），你可以在定时器上启动一个无限循环。</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 设置为 true 将冻结同一工作交易品种图表上指标的绘制</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 注意！实验结束后不要忘记移除该指标！</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SimulateCalculation </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(SimulateCalculation)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        EventSetTimer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnTimer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    Comment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;计算开始于 &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TimeLocal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IsStopped</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 模拟计算的无限循环</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    Comment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>在这种模式下，正如预期的那样，该指标开始完全占用 1 个处理器核心，但也会出现另一个副作用。放置了 <code>IndBarIndex</code> 指标的同一交易品种上的任何其他指标都会停止更新。例如，我们可以在 EURUSD（任何时间周期）上运行 <code>IndBarIndex</code>，然后在任何其他 EURUSD 图表上尝试应用常规移动平均线：在从第一个图表中移除 <code>IndBarIndex</code> 之前，它将不会显示。</p><p>在这方面，所有耗时较长的计算都应该放在单独的线程中，即脚本或非交易类的智能交易系统中，并且指标中只应使用它们的计算结果。MQL5 API 允许创建新的图表或带有图表的对象，在其中可以应用包含所需智能交易系统或脚本的 <code>tpl</code> 模板。</p><h2 id="在-mql-向导中创建指标初稿" tabindex="-1">在 MQL 向导中创建指标初稿 <a class="header-anchor" href="#在-mql-向导中创建指标初稿" aria-label="Permalink to &quot;在 MQL 向导中创建指标初稿&quot;">​</a></h2><p>至此，我们已经了解了指标的内部结构，并且能够明白源代码中的某些语法结构是如何影响指标的外部呈现和计算的。有了这样的知识基础，你可以开始研究他人的代码，并根据自己的需求对其进行修改。或者，你也可以尝试创建属于自己的指标。为了避免从零开始，你可以使用 MQL 向导。特别是，它还可以用于创建指标初稿。</p><p>要启动该向导，在 MetaEditor 导航器中，针对 “指标” 分支调用上下文菜单，然后运行 “新建文件” 命令（快捷键 Ctrl + N）。在本书的第一部分 “MQL 向导和程序初稿” 章节中，我们使用该向导创建了第一个脚本，并了解了这一步骤的具体操作。</p><p>在这种情况下（从上下文菜单启动时），向导的第一步会自动选择 “自定义指标” 选项。</p><p>点击 “下一步” 进入第二步，此时你需要指定文件名。在这里，你可以添加指标输入参数。这一步骤与创建脚本时的情况并无不同。</p><p>在第三步中，向导会提供选择 <code>OnCalculate</code> 处理函数的一种形式，以及其他可选的事件处理函数。</p><p><strong>MQL5 向导：创建指标时选择事件处理函数</strong></p><p><strong>MQL 向导：创建指标时选择事件处理函数</strong></p><p>最后一步允许你定义将在图表的哪个部分显示线条：可以是主窗口（默认情况），也可以是图表下方的独立子窗口（如果你启用 “指标在独立窗口中” 标志）。</p><p><strong>MQL5 向导：创建指标时的窗口选择和图表列表</strong></p><p><strong>MQL 向导：创建指标时的窗口选择和图表列表</strong></p><p>使用 “添加” 按钮，你可以列出几个图形结构，并设置它们的基本属性。</p><p>所有这些术语我们都已经从 “内部” 有所了解，因此你可以有意识地选择这样或那样的选项。</p><p>尝试生成几个启用了不同选项的指标版本，并评估它们对最终生成的程序文本的影响。</p><p>当然，在获得源代码初稿后，开发者可以自由地进行任意更改，修改在向导中设置的任何方面。这一点尤为重要，因为向导的设置范围非常有限。具体来说，输入参数类型列表仅限于标准的 MQL5 类型，没有水平位置线、调色板等设置。至于其他的事件处理函数，向导仅提供了 <code>OnTimer</code> 和 <code>OnChartEvent</code>，而没有包括 <code>OnBookEvent</code> 和 <code>OnDeinit</code>。但是，基于本章的内容，你可以逐步为初稿补充所需的一切内容。</p></div></div></main><footer class="VPDocFooter" data-v-c23ecb28 data-v-7e27a434><!--[--><!--]--><div class="edit-info" data-v-7e27a434><!----><div class="last-updated" data-v-7e27a434><p class="VPLastUpdated" data-v-7e27a434 data-v-205198a3>最近更新: <time datetime="2025-04-11T15:58:41.000Z" data-v-205198a3></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-7e27a434><span class="visually-hidden" id="doc-footer-aria-label" data-v-7e27a434>Pager</span><div class="pager" data-v-7e27a434><a class="VPLink link pager-link prev" href="/mq5_programming_for_traders/creating_application_programs/timeseries" data-v-7e27a434><!--[--><span class="desc" data-v-7e27a434>上一页</span><span class="title" data-v-7e27a434>时间序列</span><!--]--></a></div><div class="pager" data-v-7e27a434><a class="VPLink link pager-link next" href="/mq5_programming_for_traders/creating_application_programs/ready-made-indicators" data-v-7e27a434><!--[--><span class="desc" data-v-7e27a434>下一页</span><span class="title" data-v-7e27a434>自带指标</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-e8cbffd7 data-v-6afcd22d><div class="container" data-v-6afcd22d><!----><p class="copyright" data-v-6afcd22d>Copyright © 2025-present </p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"article_agile_dev.md\":\"CekoZB6J\",\"article_common_custom.md\":\"5MkjiTf_\",\"article_eastore.md\":\"CeS_EYm7\",\"article_equity_control.md\":\"CV7OiIpk\",\"article_index.md\":\"C21QXJd3\",\"article_insample_outsample.md\":\"CZcU34Jz\",\"article_judge_strategy.md\":\"BB8mhfkQ\",\"article_kaufman.md\":\"C_jgKhbF\",\"article_market_pending.md\":\"Bn74lSQ7\",\"article_market_scan.md\":\"DTycShzK\",\"article_monte_carlo_simulate2.md\":\"DF-AK5gA\",\"article_mt5_ontester.md\":\"CVdJbqGO\",\"article_overfitting_underfitting.md\":\"Bwt3Z2Vd\",\"article_parameter_optimization.md\":\"Cewd_17i\",\"article_portfolio.md\":\"3xffy8DT\",\"article_pre_live.md\":\"CMEYbj4R\",\"article_quant_rank.md\":\"CLHpQ1PG\",\"article_rand_probability.md\":\"CuLRtCjA\",\"article_success_for_quant.md\":\"D20931LK\",\"article_unify_price.md\":\"BSCt3s4F\",\"blog.md\":\"DY2r_8Gy\",\"future_strategy_index copy.md\":\"Bl7NiD8Q\",\"future_strategy_index.md\":\"tOu39xIn\",\"future_strategy_indicator_desc_index.md\":\"CfWWd1UF\",\"future_strategy_macd.md\":\"cRmXRHbN\",\"index.md\":\"C7iEt7cL\",\"metaeditor_development_ai_assistant.md\":\"CqO-OGH-\",\"metaeditor_development_c_dll.md\":\"ySFrrkQ3\",\"metaeditor_development_compile.md\":\"CLcacmC3\",\"metaeditor_development_debug.md\":\"C8yzhAhQ\",\"metaeditor_development_generate_mqh.md\":\"CWh5Skrw\",\"metaeditor_development_index.md\":\"DXD6eABr\",\"metaeditor_development_intelligent_management.md\":\"DBxb1cDr\",\"metaeditor_development_mql5_cloud_protector.md\":\"ZKeRwiiT\",\"metaeditor_development_opencl.md\":\"K_ipDkPN\",\"metaeditor_development_profiling.md\":\"DofvIj8o\",\"metaeditor_development_python.md\":\"_mjzDdFd\",\"metaeditor_development_source_code_find.md\":\"S0Ogzfxe\",\"metaeditor_development_styler.md\":\"BEOI0t7n\",\"metaeditor_main_menu_index.md\":\"CXXPw8OR\",\"metaeditor_main_menu_main_menu_build.md\":\"CK_QoCmC\",\"metaeditor_main_menu_main_menu_debug.md\":\"G68ZpR3W\",\"metaeditor_main_menu_main_menu_edit.md\":\"Bk-KepSh\",\"metaeditor_main_menu_main_menu_file.md\":\"4AeiS2_Z\",\"metaeditor_main_menu_main_menu_help.md\":\"BtxQHJ06\",\"metaeditor_main_menu_main_menu_search.md\":\"CxRRuboD\",\"metaeditor_main_menu_main_menu_tools.md\":\"BcLApDsT\",\"metaeditor_main_menu_main_menu_view.md\":\"DHiCsiJY\",\"metaeditor_main_menu_main_menu_window.md\":\"BBk-qWxB\",\"metaeditor_mql5_wizard_index.md\":\"jEUATVoV\",\"metaeditor_mql5_wizard_wizard_class.md\":\"CnMHpija\",\"metaeditor_mql5_wizard_wizard_ea.md\":\"CfqtPFLa\",\"metaeditor_mql5_wizard_wizard_ea_generate.md\":\"DvGGkuHY\",\"metaeditor_mql5_wizard_wizard_include.md\":\"CsBvOX25\",\"metaeditor_mql5_wizard_wizard_indicator.md\":\"Bx9DMe-v\",\"metaeditor_mql5_wizard_wizard_library.md\":\"DJkz73k7\",\"metaeditor_mql5_wizard_wizard_script.md\":\"DLazBzzU\",\"metaeditor_mql5storage_index.md\":\"D8xIk0dG\",\"metaeditor_mql5storage_mql5storage_connect.md\":\"qkTwMz88\",\"metaeditor_mql5storage_mql5storage_diff.md\":\"BpNtUibG\",\"metaeditor_mql5storage_mql5storage_merging.md\":\"BMw6jECz\",\"metaeditor_mql5storage_mql5storage_svn_client.md\":\"DBkeQe2B\",\"metaeditor_mql5storage_mql5storage_working.md\":\"CscIQLs2\",\"metaeditor_mql5storage_projects.md\":\"C3HWKvUe\",\"metaeditor_other_articles.md\":\"D-cOqq6u\",\"metaeditor_other_index.md\":\"CcYyLhKx\",\"metaeditor_other_machine_learning.md\":\"62vENuYg\",\"metaeditor_other_mql5_help.md\":\"B2a2tqsd\",\"metaeditor_other_mql5community.md\":\"Dy11e8hb\",\"metaeditor_other_project_example.md\":\"l0TLhQky\",\"metaeditor_other_structure.md\":\"CEsj1WDC\",\"metaeditor_other_video_guides.md\":\"BkI9apKH\",\"metaeditor_toolbar_index.md\":\"CFT_1Mzk\",\"metaeditor_toolbar_toolbar_customize.md\":\"R7xWLCaw\",\"metaeditor_toolbar_toolbar_search.md\":\"CHevt1bd\",\"metaeditor_toolbar_toolbar_standard.md\":\"D9jvqk-Y\",\"metaeditor_welcome_index.md\":\"CGk5HTew\",\"metaeditor_welcome_integration_ide.md\":\"C035wAZG\",\"metaeditor_welcome_open.md\":\"DxAIEWzX\",\"metaeditor_welcome_settings.md\":\"CvPD7VnS\",\"metaeditor_workspace_hotkeys.md\":\"Bj_9zXTW\",\"metaeditor_workspace_index.md\":\"Do9WOnRU\",\"metaeditor_workspace_navigator.md\":\"BCvRu1ie\",\"metaeditor_workspace_source_code_windows.md\":\"CtRXf08w\",\"metaeditor_workspace_status_bar.md\":\"CSADWvAE\",\"metaeditor_workspace_toolbox.md\":\"DbWRa0F2\",\"mq5_programming_for_traders_advanced_language_tools_conclusion.md\":\"BqFosGVq\",\"mq5_programming_for_traders_advanced_language_tools_connection_of_binary_format_libraries.md\":\"BLOdUF9q\",\"mq5_programming_for_traders_advanced_language_tools_cryptography.md\":\"dpslRa2w\",\"mq5_programming_for_traders_advanced_language_tools_custom_symbol.md\":\"CrPz6kCN\",\"mq5_programming_for_traders_advanced_language_tools_economic_calendar.md\":\"D3B845sY\",\"mq5_programming_for_traders_advanced_language_tools_index.md\":\"DioZP1qd\",\"mq5_programming_for_traders_advanced_language_tools_native_python_support.md\":\"CGZfS8jh\",\"mq5_programming_for_traders_advanced_language_tools_network_functions.md\":\"CS-cRyGW\",\"mq5_programming_for_traders_advanced_language_tools_opencl.md\":\"DNf39_d9\",\"mq5_programming_for_traders_advanced_language_tools_projects.md\":\"BgiuLuji\",\"mq5_programming_for_traders_advanced_language_tools_resources.md\":\"A3t4zE4C\",\"mq5_programming_for_traders_advanced_language_tools_sqlite_database.md\":\"vKWKdHQk\",\"mq5_programming_for_traders_common_mql5_apis_built-in_type_conversions.md\":\"DIBH5D9g\",\"mq5_programming_for_traders_common_mql5_apis_client_terminal_global_variables.md\":\"BVt6e9Bi\",\"mq5_programming_for_traders_common_mql5_apis_functions_for_working_with_time.md\":\"NmrvYrpo\",\"mq5_programming_for_traders_common_mql5_apis_index.md\":\"_fnRC4po\",\"mq5_programming_for_traders_common_mql5_apis_mathematical_functions.md\":\"pw6wAfHt\",\"mq5_programming_for_traders_common_mql5_apis_matrices_and_vectors.md\":\"D1XXAANW\",\"mq5_programming_for_traders_common_mql5_apis_mql_program_execution_environment.md\":\"C_WvrAq_\",\"mq5_programming_for_traders_common_mql5_apis_user_interaction.md\":\"ChANgtY4\",\"mq5_programming_for_traders_common_mql5_apis_working_with_arrays.md\":\"MrXMnalE\",\"mq5_programming_for_traders_common_mql5_apis_working_with_files.md\":\"BSQ62vW0\",\"mq5_programming_for_traders_common_mql5_apis_working_with_strings_and_symbols.md\":\"BgWUyRVM\",\"mq5_programming_for_traders_creating_application_programs_creating_custom_indicators.md\":\"D89rvx8i\",\"mq5_programming_for_traders_creating_application_programs_general_principles.md\":\"B7oL656R\",\"mq5_programming_for_traders_creating_application_programs_graphical_objects.md\":\"DJGQQBYe\",\"mq5_programming_for_traders_creating_application_programs_index.md\":\"BRkjFXBR\",\"mq5_programming_for_traders_creating_application_programs_interactive_events_on_charts.md\":\"DjQkJjZy\",\"mq5_programming_for_traders_creating_application_programs_ready-made-indicators.md\":\"DqZW3If2\",\"mq5_programming_for_traders_creating_application_programs_script_and_services.md\":\"CtZoueCu\",\"mq5_programming_for_traders_creating_application_programs_timeseries.md\":\"BtoCGRyg\",\"mq5_programming_for_traders_creating_application_programs_working_with_charts.md\":\"BQW7ulcA\",\"mq5_programming_for_traders_creating_application_programs_working_with_timer.md\":\"D8Y2rBH3\",\"mq5_programming_for_traders_mql5_programming_fundamentals_arrays.md\":\"DkA9guq7\",\"mq5_programming_for_traders_mql5_programming_fundamentals_built-in_data_types.md\":\"DmSre79F\",\"mq5_programming_for_traders_mql5_programming_fundamentals_expresssions.md\":\"DMZfWSmE\",\"mq5_programming_for_traders_mql5_programming_fundamentals_function.md\":\"BdgE5fd_\",\"mq5_programming_for_traders_mql5_programming_fundamentals_identifiers.md\":\"DVfDbqmo\",\"mq5_programming_for_traders_mql5_programming_fundamentals_index.md\":\"DgPkDkd0\",\"mq5_programming_for_traders_mql5_programming_fundamentals_preprocessor.md\":\"Da7Vqy0j\",\"mq5_programming_for_traders_mql5_programming_fundamentals_statements.md\":\"Chdks6In\",\"mq5_programming_for_traders_mql5_programming_fundamentals_type_conversion.md\":\"DzZLqDPG\",\"mq5_programming_for_traders_mql5_programming_fundamentals_variables.md\":\"D6w5sCtA\",\"mq5_programming_for_traders_object_oriented_programming_classes_and_interfaces.md\":\"OmWgrExH\",\"mq5_programming_for_traders_object_oriented_programming_common_mql5_apis.md\":\"BP_Vo3Wm\",\"mq5_programming_for_traders_object_oriented_programming_index.md\":\"BVlzbIxn\",\"mq5_programming_for_traders_object_oriented_programming_structures_and_unions.md\":\"Dx5dMKIe\",\"mq5_programming_for_traders_object_oriented_programming_templates.md\":\"BJEhki9r\",\"mq5_programming_for_traders_trading_automation_createing_expert_advisors.md\":\"Dt9e0mG6\",\"mq5_programming_for_traders_trading_automation_depth_of_market.md\":\"BOO1IJkB\",\"mq5_programming_for_traders_trading_automation_financial_instruments_and_market_watch.md\":\"B9vxeHpI\",\"mq5_programming_for_traders_trading_automation_index.md\":\"DTY53Nv6\",\"mq5_programming_for_traders_trading_automation_testing_and_optimization_of_expert_advisors.md\":\"Dy0UHdqu\",\"mq5_programming_for_traders_trading_automation_trading_account_information.md\":\"BshGeCtu\",\"mq5_programming_for_traders_welcome_assignment_and_initialization.md\":\"ChV1uj30\",\"mq5_programming_for_traders_welcome_data_input.md\":\"CK0GP829\",\"mq5_programming_for_traders_welcome_data_output.md\":\"CMIS56Tx\",\"mq5_programming_for_traders_welcome_data_types_and_values.md\":\"CZ_evvC8\",\"mq5_programming_for_traders_welcome_editing_compiling_running.md\":\"DWG9biXN\",\"mq5_programming_for_traders_welcome_error_fixing_and_debugging.md\":\"CoCSAVqN\",\"mq5_programming_for_traders_welcome_first_program.md\":\"Ow3JA9A_\",\"mq5_programming_for_traders_welcome_formatting.md\":\"DQ5IkYuZ\",\"mq5_programming_for_traders_welcome_index.md\":\"Dd4UExBk\",\"mq5_programming_for_traders_welcome_introduction_to_mql5.md\":\"6yvllYrA\",\"mq5_programming_for_traders_welcome_mini_summary.md\":\"Ds7kxAr2\",\"mq5_programming_for_traders_welcome_mql5_programming_fundamentals.md\":\"B1EKEZK6\",\"mq5_programming_for_traders_welcome_mql_wizard.md\":\"CQtZIDOi\",\"mq5_programming_for_traders_welcome_statements.md\":\"DL7aDo42\",\"mq5_programming_for_traders_welcome_variables_and_identifiers.md\":\"BfwdZsQd\",\"mt5_ctp_quick_start_account_info.md\":\"AeH_Ubzz\",\"mt5_ctp_quick_start_close_position.md\":\"_Xvwfyvj\",\"mt5_ctp_quick_start_index.md\":\"BgkAhdQx\",\"mt5_ctp_quick_start_open_position.md\":\"CPimgyFy\",\"mt5_ctp_quick_start_position_info.md\":\"BaXJDf37\",\"mt5_quick_start_advance_konwledge_avoid_overfitting.md\":\"-Ja7o3EZ\",\"mt5_quick_start_advance_konwledge_correlation_factor.md\":\"C1J_ofNT\",\"mt5_quick_start_advance_konwledge_evaluation_function.md\":\"C2jlQGh_\",\"mt5_quick_start_advance_konwledge_high_quality_data.md\":\"C-dHx4rj\",\"mt5_quick_start_advance_konwledge_index.md\":\"DFm8PySY\",\"mt5_quick_start_advance_konwledge_market_scan.md\":\"CCilSTmX\",\"mt5_quick_start_advance_konwledge_monte_carlo_simulate.md\":\"CVgGUnsf\",\"mt5_quick_start_advance_konwledge_multiple_symbol_ea.md\":\"3MU1cdST\",\"mt5_quick_start_advance_konwledge_oop.md\":\"CSI-NA9b\",\"mt5_quick_start_advance_konwledge_optimize.md\":\"DsRqe3D3\",\"mt5_quick_start_advance_konwledge_strategy_portfolio_manage.md\":\"DDugm1y2\",\"mt5_quick_start_advance_konwledge_unify_price.md\":\"BOxInq4O\",\"mt5_quick_start_advance_konwledge_wfa.md\":\"Bu8cpx9E\",\"mt5_quick_start_basic_grammar_control.md\":\"FkNix97X\",\"mt5_quick_start_basic_grammar_data_type.md\":\"CdlLxo9L\",\"mt5_quick_start_basic_grammar_ea_composition.md\":\"BegUswnS\",\"mt5_quick_start_basic_grammar_expression.md\":\"gSPy198p\",\"mt5_quick_start_basic_grammar_function.md\":\"XzrW6d12\",\"mt5_quick_start_basic_grammar_index.md\":\"DelPidf4\",\"mt5_quick_start_basic_grammar_variable.md\":\"DPmPeA6-\",\"mt5_quick_start_classic_strategy_contrarian_rsi_ma.md\":\"BSI0rDtb\",\"mt5_quick_start_classic_strategy_donchian_channel.md\":\"Ddrh0o4H\",\"mt5_quick_start_classic_strategy_ichimoku.md\":\"DHzHhyh8\",\"mt5_quick_start_classic_strategy_index.md\":\"B66J8L8u\",\"mt5_quick_start_classic_strategy_london_break.md\":\"BNpKSpOJ\",\"mt5_quick_start_classic_strategy_td9_trend.md\":\"ohena6Yy\",\"mt5_quick_start_classic_strategy_triple_screen.md\":\"CO5wFyXh\",\"mt5_quick_start_first_real_ea_complete_code.md\":\"DBGw2DmE\",\"mt5_quick_start_first_real_ea_index.md\":\"C7ZszPIu\",\"mt5_quick_start_first_real_ea_indicator_data.md\":\"DOWSCWZB\",\"mt5_quick_start_first_real_ea_open_detail.md\":\"CQJfoMWb\",\"mt5_quick_start_first_real_ea_param_check.md\":\"DCOfELp8\",\"mt5_quick_start_first_real_ea_risk_manage.md\":\"CfIpy5e3\",\"mt5_quick_start_indicator_tools_calendar.md\":\"5xQxMEVc\",\"mt5_quick_start_indicator_tools_donchian_channel.md\":\"oVqUL-6u\",\"mt5_quick_start_indicator_tools_full_period_indicator_monitor.md\":\"BW6bHHx4\",\"mt5_quick_start_indicator_tools_index.md\":\"BR8AbLiz\",\"mt5_quick_start_indicator_tools_oncaclulate.md\":\"MVszxV5Y\",\"mt5_quick_start_indicator_tools_oscillator.md\":\"DqhftR-F\",\"mt5_quick_start_indicator_tools_price_intensive.md\":\"CsP70J5A\",\"mt5_quick_start_indicator_tools_squeeze.md\":\"Db2wdOtM\",\"mt5_quick_start_welcome_cfd_advantage.md\":\"OLkW2RmR\",\"mt5_quick_start_welcome_index.md\":\"D-rThBDz\",\"mt5_quick_start_welcome_mt5_ide.md\":\"BwUiPygq\",\"mt5_quick_start_welcome_mt5_indroduce.md\":\"7m74Bhyn\",\"mt5_quick_start_welcome_outline.md\":\"CO5mXHS0\",\"mt5_strategy_boll.md\":\"EsZ8ZY9u\",\"mt5_strategy_bolla.md\":\"CGTVrXkA\",\"mt5_strategy_contrarian_by_rsi_ma.md\":\"DlS9GeJ7\",\"mt5_strategy_debug.md\":\"DPYxhjZz\",\"mt5_strategy_divergent_oscillation.md\":\"D_Vp9sMI\",\"mt5_strategy_eldtriplescreen.md\":\"CsoMojbI\",\"mt5_strategy_frequency_trading_index.md\":\"CzDGiS_i\",\"mt5_strategy_ichimokutrendflow.md\":\"BpWq0Oa8\",\"mt5_strategy_indicator_donchianchannel.md\":\"D7sDZUa0\",\"mt5_strategy_indicator_oncalculate.md\":\"BK-A-OGY\",\"mt5_strategy_londonbreakout.md\":\"EuYRwshZ\",\"mt5_strategy_macd.md\":\"DX23diwu\",\"mt5_strategy_martingale_index.md\":\"DJXeBrW7\",\"mt5_strategy_martingale_martingale_reverse.md\":\"D4wXM2-D\",\"mt5_strategy_nr4.md\":\"CJuxuhlX\",\"mt5_strategy_panel_calendar.md\":\"BHNvM7Dj\",\"mt5_strategy_permission_verification.md\":\"D8iysydz\",\"mt5_strategy_price_action_index.md\":\"iusk5YDd\",\"mt5_strategy_risk_monitor.md\":\"uOcqy7-b\",\"mt5_strategy_strategy_quant_x.md\":\"DLcvwjHl\",\"mt5_strategy_td9_trend_flow_stop_order.md\":\"B-fvRHV-\",\"mt5_strategy_trend_follow_index.md\":\"CEfPUPrm\",\"mt5_strategy_trend_follow_triple_screen.md\":\"Bu8XjnQV\",\"readme.md\":\"oogmlVDH\",\"team.md\":\"BiGhHkL5\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"专业投机策略\",\"description\":\"迎接新的时代\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"/logo.svg\",\"lastUpdated\":{\"text\":\"最近更新\"},\"outline\":{\"label\":\"本页目录\",\"level\":[2,3]},\"search\":{\"provider\":\"local\",\"options\":{\"translations\":{\"button\":{\"buttonText\":\"搜索\",\"buttonAriaLabel\":\"搜索\"},\"modal\":{\"footer\":{\"selectText\":\"选择\",\"navigateText\":\"切换\",\"closeText\":\"关闭\"}}}}},\"docFooter\":{\"prev\":\"上一页\",\"next\":\"下一页\"},\"footer\":{\"copyright\":\"Copyright © 2025-present \"},\"socialLinks\":[{\"icon\":\"tiktok\",\"link\":\"https://www.douyin.com/user/MS4wLjABAAAAVb-2dWdStZkPrNrzAGkHhhquMun5zaNAUsNPN166PCA\"},{\"icon\":\"bilibili\",\"link\":\"https://space.bilibili.com/485926738\"},{\"icon\":\"wechat\",\"link\":\"https://mp.weixin.qq.com/s/Q_d8EUdnWIh4uzjg9DGQqg\"}],\"nav\":[{\"text\":\"外盘策略\",\"items\":[{\"text\":\"趋势跟踪\",\"link\":\"/mt5_strategy/trend_follow/\"},{\"text\":\"马丁格尔\",\"link\":\"/mt5_strategy/martingale/\"},{\"text\":\"高频交易\",\"link\":\"/mt5_strategy/frequency_trading/\"}]},{\"text\":\"期货策略\",\"link\":\"/future_strategy/\",\"activeMatch\":\"/future_strategy/\"},{\"text\":\"MT5编辑器\",\"items\":[{\"text\":\"欢迎来到算法交易\",\"link\":\"/metaeditor/welcome/\"},{\"text\":\"主菜单\",\"link\":\"/metaeditor/main_menu/\"},{\"text\":\"工具栏\",\"link\":\"/metaeditor/toolbar/\"},{\"text\":\"工作区\",\"link\":\"/metaeditor/workspace/\"},{\"text\":\"MQL5存储\",\"link\":\"/metaeditor/mql5storage/\"},{\"text\":\"MQL4/MQL5 向导\",\"link\":\"/metaeditor/mql5_wizard/\"},{\"text\":\"开发程序\",\"link\":\"/metaeditor/development/\"},{\"text\":\"其它\",\"link\":\"/metaeditor/other/\"}]},{\"text\":\"MQL5快速入门\",\"items\":[{\"text\":\"初步认识\",\"link\":\"/mt5_quick_start/welcome/\"},{\"text\":\"基础语法\",\"link\":\"/mt5_quick_start/basic_grammar/\"},{\"text\":\"第一个EA\",\"link\":\"/mt5_quick_start/first_real_ea/\"},{\"text\":\"进阶知识\",\"link\":\"/mt5_quick_start/advance_konwledge/\"},{\"text\":\"经典策略\",\"link\":\"/mt5_quick_start/classic_strategy/\"},{\"text\":\"指标工具\",\"link\":\"/mt5_quick_start/indicator_tools/\"}]},{\"text\":\"MQL5官方教程\",\"items\":[{\"text\":\"开始\",\"link\":\"/mq5_programming_for_traders/welcome/\"},{\"text\":\"MQL5编程基础\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/\"},{\"text\":\"面向对象\",\"link\":\"/mq5_programming_for_traders/object_oriented_programming/\"},{\"text\":\"常用API\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/\"},{\"text\":\"在 MQL5 中创建应用程序\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/\"},{\"text\":\"交易自动化\",\"link\":\"/mq5_programming_for_traders/trading_automation/\"},{\"text\":\"MQL5高级工具\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/\"}]},{\"text\":\"经典文章\",\"link\":\"/article/\",\"activeMatch\":\"/article/\"}],\"sidebar\":{\"/mt5_strategy/\":[{\"text\":\"趋势跟踪\",\"items\":[{\"text\":\"RSI + MA\",\"link\":\"/mt5_strategy/trend_follow/\"},{\"text\":\"三重滤网\",\"link\":\"/mt5_strategy/trend_follow/triple_screen\"}]},{\"text\":\"马丁格尔\",\"items\":[{\"text\":\"通用马丁\",\"link\":\"/mt5_strategy/martingale/\"},{\"text\":\"顺势反手马丁\",\"link\":\"/mt5_strategy/martingale/martingale_reverse\"}]},{\"text\":\"高频交易\",\"items\":[{\"text\":\"剥头皮\",\"link\":\"/mt5_strategy/frequency_trading/\"}]},{\"text\":\"价格行为\",\"items\":[{\"text\":\"双底双顶\",\"link\":\"/mt5_strategy/price_action/\"}]}],\"/future_strategy/\":[{\"collapsed\":true,\"text\":\"趋势跟踪\",\"items\":[{\"text\":\"布林线\",\"link\":\"/future_strategy/\"},{\"text\":\"MACD\",\"link\":\"/future_strategy/macd\"},{\"text\":\"指标说明\",\"link\":\"/future_strategy/indicator_desc\"}]}],\"/article/\":[{\"collapsed\":true,\"text\":\"量化\",\"items\":[{\"text\":\"梁文锋2019年演讲\",\"link\":\"/article/\"},{\"text\":\"桥水基金雷·达里奥\",\"link\":\"/article/portfolio\"},{\"text\":\"量化交易的段位\",\"link\":\"/article/quant_rank\"},{\"text\":\"解决策略过度拟合\",\"link\":\"/article/insample_outsample\"},{\"text\":\"挂单和市价单区别\",\"link\":\"/article/market_pending\"},{\"text\":\"EA商店\",\"link\":\"/article/eastore\"},{\"text\":\"评估策略是否有盈利能力\",\"link\":\"/article/judge_strategy\"},{\"text\":\"通用策略和定制策略\",\"link\":\"/article/common_custom\"},{\"text\":\"量化成功的要点\",\"link\":\"/article/success_for_quant\"},{\"text\":\"使用走完的K线\",\"link\":\"/article/unify_price\"},{\"text\":\"实盘前的准备\",\"link\":\"/article/pre_live\"},{\"text\":\"佩里·考夫曼\",\"link\":\"/article/kaufman\"},{\"text\":\"自定义统计结果\",\"link\":\"/article/mt5_ontester\"},{\"text\":\"概率优势与随机幸运\",\"link\":\"/article/rand_probability\"},{\"text\":\"量化策略的敏捷开发\",\"link\":\"/article/agile_dev\"},{\"text\":\"净值曲线控制\",\"link\":\"/article/equity_control\"}]}],\"/metaeditor/\":[{\"collapsed\":true,\"text\":\"欢迎来到算法交易\",\"items\":[{\"text\":\"开始\",\"link\":\"/metaeditor/welcome/\"},{\"text\":\"启动\",\"link\":\"/metaeditor/welcome/open\"},{\"text\":\"设置\",\"link\":\"/metaeditor/welcome/settings\"},{\"text\":\"与其它开发环境整合\",\"link\":\"/metaeditor/welcome/integration_ide\"}]},{\"collapsed\":true,\"text\":\"主菜单\",\"items\":[{\"text\":\"摘要\",\"link\":\"/metaeditor/main_menu/\"},{\"text\":\"文件\",\"link\":\"/metaeditor/main_menu/main_menu_file\"},{\"text\":\"编辑\",\"link\":\"/metaeditor/main_menu/main_menu_edit\"},{\"text\":\"搜索\",\"link\":\"/metaeditor/main_menu/main_menu_search\"},{\"text\":\"视图\",\"link\":\"/metaeditor/main_menu/main_menu_view\"},{\"text\":\"调试\",\"link\":\"/metaeditor/main_menu/main_menu_debug\"},{\"text\":\"构建\",\"link\":\"/metaeditor/main_menu/main_menu_build\"},{\"text\":\"工具\",\"link\":\"/metaeditor/main_menu/main_menu_tools\"},{\"text\":\"窗口\",\"link\":\"/metaeditor/main_menu/main_menu_window\"},{\"text\":\"帮助\",\"link\":\"/metaeditor/main_menu/main_menu_help\"}]},{\"collapsed\":true,\"text\":\"工具栏\",\"items\":[{\"text\":\"摘要\",\"link\":\"/metaeditor/toolbar/\"},{\"text\":\"标准\",\"link\":\"/metaeditor/toolbar/toolbar_standard\"},{\"text\":\"搜索\",\"link\":\"/metaeditor/toolbar/toolbar_search\"},{\"text\":\"安装\",\"link\":\"/metaeditor/toolbar/toolbar_customize\"}]},{\"collapsed\":true,\"text\":\"工作区\",\"items\":[{\"text\":\"摘要\",\"link\":\"/metaeditor/workspace/\"},{\"text\":\"导航\",\"link\":\"/metaeditor/workspace/navigator\"},{\"text\":\"工具箱\",\"link\":\"/metaeditor/workspace/toolbox\"},{\"text\":\"状态栏\",\"link\":\"/metaeditor/workspace/status_bar\"},{\"text\":\"操作窗口\",\"link\":\"/metaeditor/workspace/source_code_windows\"},{\"text\":\"热键\",\"link\":\"/metaeditor/workspace/hotkeys\"}]},{\"collapsed\":true,\"text\":\"MQL5存储\",\"items\":[{\"text\":\"摘要\",\"link\":\"/metaeditor/mql5storage/\"},{\"text\":\"启用存储\",\"link\":\"/metaeditor/mql5storage/mql5storage_connect\"},{\"text\":\"创建并操作项目\",\"link\":\"/metaeditor/mql5storage/projects\"},{\"text\":\"操控存储\",\"link\":\"/metaeditor/mql5storage/mql5storage_working\"},{\"text\":\"查看项目历史\",\"link\":\"/metaeditor/mql5storage/mql5storage_diff\"},{\"text\":\"合并修改\",\"link\":\"/metaeditor/mql5storage/mql5storage_merging\"},{\"text\":\"外部 Subversion 客户端\",\"link\":\"/metaeditor/mql5storage/mql5storage_svn_client\"}]},{\"collapsed\":true,\"text\":\"MQL4/MQL5 向导\",\"items\":[{\"text\":\"摘要\",\"link\":\"/metaeditor/mql5_wizard/\"},{\"text\":\"创建 EA 模板\",\"link\":\"/metaeditor/mql5_wizard/wizard_ea\"},{\"text\":\"创建成品智能交易系统\",\"link\":\"/metaeditor/mql5_wizard/wizard_ea_generate\"},{\"text\":\"创建指标\",\"link\":\"/metaeditor/mql5_wizard/wizard_indicator\"},{\"text\":\"创建脚本\",\"link\":\"/metaeditor/mql5_wizard/wizard_script\"},{\"text\":\"创建函数库\",\"link\":\"/metaeditor/mql5_wizard/wizard_library\"},{\"text\":\"创建包含文件\",\"link\":\"/metaeditor/mql5_wizard/wizard_include\"},{\"text\":\"创建类\",\"link\":\"/metaeditor/mql5_wizard/wizard_class\"}]},{\"collapsed\":true,\"text\":\"开发程序\",\"items\":[{\"text\":\"摘要\",\"link\":\"/metaeditor/development/\"},{\"text\":\"智能管理\",\"link\":\"/metaeditor/development/intelligent_management\"},{\"text\":\"查找和替换\",\"link\":\"/metaeditor/development/source_code_find\"},{\"text\":\"格式化\",\"link\":\"/metaeditor/development/styler\"},{\"text\":\"编译\",\"link\":\"/metaeditor/development/compile\"},{\"text\":\"MQL5 云端保护: 为程序提供先进的保护\",\"link\":\"/metaeditor/development/mql5_cloud_protector\"},{\"text\":\"代码调试\",\"link\":\"/metaeditor/development/debug\"},{\"text\":\"代码分析\",\"link\":\"/metaeditor/development/profiling\"},{\"text\":\"AI Assistant编码助手\",\"link\":\"/metaeditor/development/ai_assistant\"},{\"text\":\"生成头文件\",\"link\":\"/metaeditor/development/generate_mqh\"},{\"text\":\"调用 C++ 的 DLL (与 MS Visual Studio 集成)\",\"link\":\"/metaeditor/development/c_dll\"},{\"text\":\"使用Python\",\"link\":\"/metaeditor/development/python\"},{\"text\":\"OpenCL 支持\",\"link\":\"/metaeditor/development/opencl\"}]},{\"collapsed\":true,\"text\":\"其它\",\"items\":[{\"text\":\"SQL数据库操作\",\"link\":\"/metaeditor/other/\"},{\"text\":\"使用机器学习模型\",\"link\":\"/metaeditor/other/machine_learning\"},{\"text\":\"程序开发示例\",\"link\":\"/metaeditor/other/project_example\"},{\"text\":\"MetaEditor 环境文件夹\",\"link\":\"/metaeditor/other/structure\"},{\"text\":\"MQL5 社区: 交易者的社区\",\"link\":\"/metaeditor/other/mql5community\"},{\"text\":\"内置帮助\",\"link\":\"/metaeditor/other/mql5_help\"},{\"text\":\"有关开发交易应用程序的文章\",\"link\":\"/metaeditor/other/article\"},{\"text\":\"交易平台指南视频\",\"link\":\"/metaeditor/other/video_guides\"}]}],\"/mq5_programming_for_traders/\":[{\"text\":\"开始\",\"items\":[{\"text\":\"大纲\",\"link\":\"/mq5_programming_for_traders/welcome/\"},{\"text\":\"简介\",\"link\":\"/mq5_programming_for_traders/welcome/introduction_to_mql5\"},{\"text\":\"编辑编译运行\",\"link\":\"/mq5_programming_for_traders/welcome/editing_compiling_running\"},{\"text\":\"MQL向导\",\"link\":\"/mq5_programming_for_traders/welcome/mql_wizard\"},{\"text\":\"语句代码块函数\",\"link\":\"/mq5_programming_for_traders/welcome/statements\"},{\"text\":\"第一个程序\",\"link\":\"/mq5_programming_for_traders/welcome/first_program\"},{\"text\":\"数据类型和值\",\"link\":\"/mq5_programming_for_traders/welcome/data_types_and_values\"},{\"text\":\"变量和标识符\",\"link\":\"/mq5_programming_for_traders/welcome/variables_and_identifiers\"},{\"text\":\"赋值和初始化\",\"link\":\"/mq5_programming_for_traders/welcome/assignment_and_initialization\"},{\"text\":\"数据输入\",\"link\":\"/mq5_programming_for_traders/welcome/data_input\"},{\"text\":\"修复错误和调试\",\"link\":\"/mq5_programming_for_traders/welcome/error_fixing_and_debugging\"},{\"text\":\"数据输出\",\"link\":\"/mq5_programming_for_traders/welcome/data_output\"},{\"text\":\"格式化\",\"link\":\"/mq5_programming_for_traders/welcome/formatting\"},{\"text\":\"迷你小结\",\"link\":\"/mq5_programming_for_traders/welcome/mini_summary\"}]},{\"text\":\"MQL5编程基础\",\"collapsed\":true,\"items\":[{\"text\":\"简介\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/\"},{\"text\":\"标识符\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/identifiers/\"},{\"text\":\"内置数据类型\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/built-in_data_types/\"},{\"text\":\"变量\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/variables/\"},{\"text\":\"数组\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/arrays/\"},{\"text\":\"表达式\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/expresssions/\"},{\"text\":\"类型转换\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/type_conversion/\"},{\"text\":\"语句\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/statements/\"},{\"text\":\"函数\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/function/\"},{\"text\":\"预处理\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/preprocessor/\"}]},{\"text\":\"面向对象\",\"collapsed\":true,\"items\":[{\"text\":\"简介\",\"link\":\"/mq5_programming_for_traders/object_oriented_programming/\"},{\"text\":\"结构体和联合体\",\"link\":\"/mq5_programming_for_traders/object_oriented_programming/structures_and_unions\"},{\"text\":\"类和接口\",\"link\":\"/mq5_programming_for_traders/object_oriented_programming/classes_and_interfaces\"},{\"text\":\"模板\",\"link\":\"/mq5_programming_for_traders/object_oriented_programming/templates\"}]},{\"text\":\"常用API\",\"collapsed\":true,\"items\":[{\"text\":\"简介\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/\"},{\"text\":\"内置类型转换\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/built-in_type_conversions\"},{\"text\":\"字符串和符号处理\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/working_with_strings_and_symbols\"},{\"text\":\"数组操作\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/working_with_arrays\"},{\"text\":\"数学函数\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/mathematical_functions\"},{\"text\":\"文件操作\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/working_with_files\"},{\"text\":\"客户端全局变量\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/client_terminal_global_variables\"},{\"text\":\"时间相关函数\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/functions_for_working_with_time\"},{\"text\":\"用户交互\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/user_interaction\"},{\"text\":\"MQL 程序执行环境\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/mql_program_execution_environment\"},{\"text\":\"矩阵和向量\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/matrices_and_vectors\"}]},{\"text\":\"在 MQL5 中创建应用程序\",\"collapsed\":true,\"items\":[{\"text\":\"简介\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/\"},{\"text\":\"一般原则\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/general_principles\"},{\"text\":\"脚本和服务\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/script_and_services\"},{\"text\":\"时间序列\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/timeseries\"},{\"text\":\"自定义指标\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/creating_custom_indicators\"},{\"text\":\"自带指标\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/ready-made-indicators\"},{\"text\":\"定时器的使用\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/working_with_timer\"},{\"text\":\"图表操作\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/working_with_charts\"},{\"text\":\"图表对象\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/graphical_objects\"},{\"text\":\"图表上的交互式事件\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/interactive_events_on_charts\"}]},{\"text\":\"交易自动化\",\"collapsed\":true,\"items\":[{\"text\":\"简介\",\"link\":\"/mq5_programming_for_traders/trading_automation/\"},{\"text\":\"金融工具与市场报价\",\"link\":\"/mq5_programming_for_traders/trading_automation/financial_instruments_and_market_watch\"},{\"text\":\"市场深度\",\"link\":\"/mq5_programming_for_traders/trading_automation/depth_of_market\"},{\"text\":\"交易账户信息\",\"link\":\"/mq5_programming_for_traders/trading_automation/trading_account_information\"},{\"text\":\"创建智能交易顾问\",\"link\":\"/mq5_programming_for_traders/trading_automation/createing_expert_advisors\"},{\"text\":\"专家顾问的测试和优化\",\"link\":\"/mq5_programming_for_traders/trading_automation/testing_and_optimization_of_expert_advisors\"}]},{\"text\":\"MQL5高级工具\",\"collapsed\":true,\"items\":[{\"text\":\"简介\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/\"},{\"text\":\"资源\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/resources\"},{\"text\":\"自定义交易品种\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/custom_symbol\"},{\"text\":\"经济日历\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/economic_calendar\"},{\"text\":\"密码学\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/cryptography\"},{\"text\":\"网络函数\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/network_functions\"},{\"text\":\"SQLite 数据库\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/sqlite_database\"},{\"text\":\"二进制格式库的开发与连接\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/connection_of_binary_format_libraries\"},{\"text\":\"项目\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/projects\"},{\"text\":\"原生python支持\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/native_python_support\"},{\"text\":\"opencl\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/opencl\"},{\"text\":\"总结\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/conclusion\"}]}],\"/mt5_quick_start/\":[{\"text\":\"初步认识\",\"items\":[{\"text\":\"介绍\",\"link\":\"/mt5_quick_start/welcome/\"},{\"text\":\"大纲\",\"link\":\"/mt5_quick_start/welcome/outline\"},{\"text\":\"CFD优势\",\"link\":\"/mt5_quick_start/welcome/cfd_advantage\"},{\"text\":\"认识MT5\",\"link\":\"/mt5_quick_start/welcome/mt5_indroduce\"},{\"text\":\"开发环境配置\",\"link\":\"/mt5_quick_start/welcome/mt5_ide\"}]},{\"text\":\"基础语法\",\"items\":[{\"text\":\"注释 标识符 保留字\",\"link\":\"/mt5_quick_start/basic_grammar/\"},{\"text\":\"数据类型\",\"link\":\"/mt5_quick_start/basic_grammar/data_type\"},{\"text\":\"表达式\",\"link\":\"/mt5_quick_start/basic_grammar/expression\"},{\"text\":\"EA的组成\",\"link\":\"/mt5_quick_start/basic_grammar/ea_composition\"},{\"text\":\"变量\",\"link\":\"/mt5_quick_start/basic_grammar/variable\"},{\"text\":\"控制语句\",\"link\":\"/mt5_quick_start/basic_grammar/control\"},{\"text\":\"函数\",\"link\":\"/mt5_quick_start/basic_grammar/function\"}]},{\"text\":\"第一个EA\",\"items\":[{\"text\":\"标准库 外部输入\",\"link\":\"/mt5_quick_start/first_real_ea/\"},{\"text\":\"4种资金管理方式\",\"link\":\"/mt5_quick_start/first_real_ea/risk_manage\"},{\"text\":\"指标数据\",\"link\":\"/mt5_quick_start/first_real_ea/indicator_data\"},{\"text\":\"开仓细节\",\"link\":\"/mt5_quick_start/first_real_ea/open_detail\"},{\"text\":\"完整代码\",\"link\":\"/mt5_quick_start/first_real_ea/complete_code\"}]},{\"text\":\"进阶知识\",\"items\":[{\"text\":\"常见异常\",\"link\":\"/mt5_quick_start/advance_konwledge/\"},{\"text\":\"高质量历史数据\",\"link\":\"/mt5_quick_start/advance_konwledge/high_quality_data\"},{\"text\":\"统一喂价模式\",\"link\":\"/mt5_quick_start/advance_konwledge/unify_price\"},{\"text\":\"策略组合管理\",\"link\":\"/mt5_quick_start/advance_konwledge/strategy_portfolio_manage\"},{\"text\":\"面相对象\",\"link\":\"/mt5_quick_start/advance_konwledge/oop\"},{\"text\":\"多品种EA\",\"link\":\"/mt5_quick_start/advance_konwledge/multiple_symbol_ea\"},{\"text\":\"策略优化\",\"link\":\"/mt5_quick_start/advance_konwledge/optimize\"},{\"text\":\"市场扫描\",\"link\":\"/mt5_quick_start/advance_konwledge/market_scan\"},{\"text\":\"避免过度拟合\",\"link\":\"/mt5_quick_start/advance_konwledge/avoid_overfitting\"},{\"text\":\"WFA推进分析\",\"link\":\"/mt5_quick_start/advance_konwledge/wfa\"},{\"text\":\"蒙特卡洛模拟\",\"link\":\"/mt5_quick_start/advance_konwledge/monte_carlo_simulate\"},{\"text\":\"评价函数\",\"link\":\"/mt5_quick_start/advance_konwledge/evaluation_function\"}]},{\"text\":\"经典策略\",\"items\":[{\"text\":\"高噪声震荡策略\",\"link\":\"/mt5_quick_start/classic_strategy/\"},{\"text\":\"一目均衡云\",\"link\":\"/mt5_quick_start/classic_strategy/ichimoku\"},{\"text\":\"伦敦突破\",\"link\":\"/mt5_quick_start/classic_strategy/london_break\"},{\"text\":\"三重滤网\",\"link\":\"/mt5_quick_start/classic_strategy/triple_screen\"},{\"text\":\"趋势反转\",\"link\":\"/mt5_quick_start/classic_strategy/contrarian_rsi_ma\"},{\"text\":\"风险控制\",\"link\":\"/mt5_quick_start/classic_strategy/risk_monitor\"},{\"text\":\"TD序列\",\"link\":\"/mt5_quick_start/classic_strategy/td9_trend\"},{\"text\":\"唐奇安通道\",\"link\":\"/mt5_quick_start/classic_strategy/donchian_channel\"}]},{\"text\":\"指标工具\",\"items\":[{\"text\":\"风控控制\",\"link\":\"/mt5_quick_start/indicator_tools/\"},{\"text\":\"onCalculate\",\"link\":\"/mt5_quick_start/indicator_tools/oncaclulate\"},{\"text\":\"唐奇安通道指标\",\"link\":\"/mt5_quick_start/indicator_tools/donchian_channel\"},{\"text\":\"价格密度指标\",\"link\":\"/mt5_quick_start/indicator_tools/price_intensive\"},{\"text\":\"挤压指标\",\"link\":\"/mt5_quick_start/indicator_tools/squeeze\"},{\"text\":\"乖离震荡器\",\"link\":\"/mt5_quick_start/indicator_tools/oscillator\"},{\"text\":\"全周期指标监控\",\"link\":\"/mt5_quick_start/indicator_tools/full_period_indicator_monitor\"},{\"text\":\"财经日历\",\"link\":\"/mt5_quick_start/indicator_tools/calendar\"}]}],\"/mt5_ctp/\":[{\"text\":\"零基础教程\",\"items\":[{\"text\":\"初识\",\"link\":\"/mt5_ctp/quick_start/\"},{\"text\":\"账户\",\"link\":\"/mt5_ctp/quick_start/account_info\"},{\"text\":\"持仓\",\"link\":\"/mt5_ctp/quick_start/position_info\"},{\"text\":\"开仓\",\"link\":\"/mt5_ctp/quick_start/open_position\"},{\"text\":\"平仓\",\"link\":\"/mt5_ctp/quick_start/close_position\"}]},{\"text\":\"马丁格尔\",\"items\":[{\"text\":\"通用马丁\",\"link\":\"/mt5_ctp/martingale/\"}]}]}},\"locales\":{\"root\":{\"label\":\"简体中文\"}},\"scrollOffset\":134,\"cleanUrls\":true}");</script>
    
  </body>
</html>