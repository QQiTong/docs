<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>文件操作 | 专业投机策略</title>
    <meta name="description" content="迎接新的时代">
    <meta name="generator" content="VitePress v1.6.3">
    <link rel="preload stylesheet" href="/assets/style.BzGW_Voe.css" as="style">
    <link rel="preload stylesheet" href="/vp-icons.css" as="style">
    
    <script type="module" src="/assets/app.BcYwxvb9.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/theme.CghoMrlC.js">
    <link rel="modulepreload" href="/assets/chunks/framework.b7dag8kZ.js">
    <link rel="modulepreload" href="/assets/mq5_programming_for_traders_common_mql5_apis_working_with_files.md.bYurQNDG.lean.js">
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <link rel="alternate" type="application/rss+xml" href="/blog.rss">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="true">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&amp;family=Manrope:wght@600&amp;family=IBM+Plex+Mono:wght@400&amp;display=swap" as="style">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&amp;family=Manrope:wght@600&amp;family=IBM+Plex+Mono:wght@400&amp;display=swap">
    <link rel="me" href="https://m.webtoo.ls/@vite">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://vite.dev/og-image.jpg">
    <meta property="og:url" content="https://vite.dev">
    <meta property="og:description" content="Next Generation Frontend Tooling">
    <meta property="og:site_name" content="vitejs">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@vite_js">
    <meta name="theme-color" content="#646cff">
    <script src="https://cdn.usefathom.com/script.js" data-site="TPLGJZGR" data-spa="auto" defer></script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
    <link rel="canonical" href="https://vite.dev/mq5_programming_for_traders/common_mql5_apis/working_with_files">
    <meta property="og:title" content="文件操作">
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-e8cbffd7><!--[--><!--]--><!--[--><span tabindex="-1" data-v-4e586869></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-4e586869>Skip to content</a><!--]--><!----><header class="VPNav" data-v-e8cbffd7 data-v-7a0b7e8a><div class="VPNavBar" data-v-7a0b7e8a data-v-357046c4><div class="wrapper" data-v-357046c4><div class="container" data-v-357046c4><div class="title" data-v-357046c4><div class="VPNavBarTitle has-sidebar" data-v-357046c4 data-v-c0b09a5e><a class="title" href="/" data-v-c0b09a5e><!--[--><!--]--><!--[--><img class="VPImage logo" src="/logo.svg" alt data-v-7d39a773><!--]--><span data-v-c0b09a5e>专业投机策略</span><!--[--><!--]--></a></div></div><div class="content" data-v-357046c4><div class="content-body" data-v-357046c4><!--[--><!--]--><div class="VPNavBarSearch search" data-v-357046c4><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-357046c4 data-v-a8ff5a32><span id="main-nav-aria-label" class="visually-hidden" data-v-a8ff5a32> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/strategy_square/" tabindex="0" data-v-a8ff5a32 data-v-25d839e6><!--[--><span data-v-25d839e6>策略广场</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-a8ff5a32 data-v-00041c6c><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-00041c6c><span class="text" data-v-00041c6c><!----><span data-v-00041c6c>外盘策略</span><span class="vpi-chevron-down text-icon" data-v-00041c6c></span></span></button><div class="menu" data-v-00041c6c><div class="VPMenu" data-v-00041c6c data-v-64b59e26><div class="items" data-v-64b59e26><!--[--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_strategy/trend_follow/" data-v-06756f99><!--[--><span data-v-06756f99>趋势跟踪</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_strategy/martingale/" data-v-06756f99><!--[--><span data-v-06756f99>马丁格尔</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_strategy/frequency_trading/" data-v-06756f99><!--[--><span data-v-06756f99>高频交易</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/future_strategy/" tabindex="0" data-v-a8ff5a32 data-v-25d839e6><!--[--><span data-v-25d839e6>期货策略</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-a8ff5a32 data-v-00041c6c><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-00041c6c><span class="text" data-v-00041c6c><!----><span data-v-00041c6c>MT5编辑器</span><span class="vpi-chevron-down text-icon" data-v-00041c6c></span></span></button><div class="menu" data-v-00041c6c><div class="VPMenu" data-v-00041c6c data-v-64b59e26><div class="items" data-v-64b59e26><!--[--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/metaeditor/welcome/" data-v-06756f99><!--[--><span data-v-06756f99>欢迎来到算法交易</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/metaeditor/main_menu/" data-v-06756f99><!--[--><span data-v-06756f99>主菜单</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/metaeditor/toolbar/" data-v-06756f99><!--[--><span data-v-06756f99>工具栏</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/metaeditor/workspace/" data-v-06756f99><!--[--><span data-v-06756f99>工作区</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/metaeditor/mql5storage/" data-v-06756f99><!--[--><span data-v-06756f99>MQL5存储</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/metaeditor/mql5_wizard/" data-v-06756f99><!--[--><span data-v-06756f99>MQL4/MQL5 向导</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/metaeditor/development/" data-v-06756f99><!--[--><span data-v-06756f99>开发程序</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/metaeditor/other/" data-v-06756f99><!--[--><span data-v-06756f99>其它</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-a8ff5a32 data-v-00041c6c><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-00041c6c><span class="text" data-v-00041c6c><!----><span data-v-00041c6c>MQL5快速入门</span><span class="vpi-chevron-down text-icon" data-v-00041c6c></span></span></button><div class="menu" data-v-00041c6c><div class="VPMenu" data-v-00041c6c data-v-64b59e26><div class="items" data-v-64b59e26><!--[--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_quick_start/welcome/" data-v-06756f99><!--[--><span data-v-06756f99>初步认识</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_quick_start/basic_grammar/" data-v-06756f99><!--[--><span data-v-06756f99>基础语法</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_quick_start/first_real_ea/" data-v-06756f99><!--[--><span data-v-06756f99>第一个EA</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_quick_start/advance_konwledge/" data-v-06756f99><!--[--><span data-v-06756f99>进阶知识</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_quick_start/classic_strategy/" data-v-06756f99><!--[--><span data-v-06756f99>经典策略</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mt5_quick_start/indicator_tools/" data-v-06756f99><!--[--><span data-v-06756f99>指标工具</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-a8ff5a32 data-v-00041c6c><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-00041c6c><span class="text" data-v-00041c6c><!----><span data-v-00041c6c>MQL5官方教程</span><span class="vpi-chevron-down text-icon" data-v-00041c6c></span></span></button><div class="menu" data-v-00041c6c><div class="VPMenu" data-v-00041c6c data-v-64b59e26><div class="items" data-v-64b59e26><!--[--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mq5_programming_for_traders/welcome/" data-v-06756f99><!--[--><span data-v-06756f99>开始</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/" data-v-06756f99><!--[--><span data-v-06756f99>MQL5编程基础</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mq5_programming_for_traders/object_oriented_programming/" data-v-06756f99><!--[--><span data-v-06756f99>面向对象</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mq5_programming_for_traders/common_mql5_apis/" data-v-06756f99><!--[--><span data-v-06756f99>常用API</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mq5_programming_for_traders/creating_application_programs/" data-v-06756f99><!--[--><span data-v-06756f99>在 MQL5 中创建应用程序</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mq5_programming_for_traders/trading_automation/" data-v-06756f99><!--[--><span data-v-06756f99>交易自动化</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-64b59e26 data-v-06756f99><a class="VPLink link" href="/mq5_programming_for_traders/advanced_language_tools/" data-v-06756f99><!--[--><span data-v-06756f99>MQL5高级工具</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/article/" tabindex="0" data-v-a8ff5a32 data-v-25d839e6><!--[--><span data-v-25d839e6>经典文章</span><!--]--></a><!--]--><!--]--></nav><!----><!----><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-357046c4 data-v-a318d133 data-v-43df44de><!--[--><a class="VPSocialLink no-icon" href="https://www.douyin.com/user/MS4wLjABAAAAVb-2dWdStZkPrNrzAGkHhhquMun5zaNAUsNPN166PCA" aria-label="tiktok" target="_blank" rel="noopener" data-v-43df44de data-v-b3f2150c><span class="vpi-social-tiktok"></span></a><a class="VPSocialLink no-icon" href="https://space.bilibili.com/485926738" aria-label="bilibili" target="_blank" rel="noopener" data-v-43df44de data-v-b3f2150c><span class="vpi-social-bilibili"></span></a><a class="VPSocialLink no-icon" href="#wechat" aria-label="wechat" target="_blank" rel="noopener" data-v-43df44de data-v-b3f2150c><span class="vpi-social-wechat"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-357046c4 data-v-72eb2fc7 data-v-00041c6c><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-00041c6c><span class="vpi-more-horizontal icon" data-v-00041c6c></span></button><div class="menu" data-v-00041c6c><div class="VPMenu" data-v-00041c6c data-v-64b59e26><!----><!--[--><!--[--><!----><!----><div class="group" data-v-72eb2fc7><div class="item social-links" data-v-72eb2fc7><div class="VPSocialLinks social-links-list" data-v-72eb2fc7 data-v-43df44de><!--[--><a class="VPSocialLink no-icon" href="https://www.douyin.com/user/MS4wLjABAAAAVb-2dWdStZkPrNrzAGkHhhquMun5zaNAUsNPN166PCA" aria-label="tiktok" target="_blank" rel="noopener" data-v-43df44de data-v-b3f2150c><span class="vpi-social-tiktok"></span></a><a class="VPSocialLink no-icon" href="https://space.bilibili.com/485926738" aria-label="bilibili" target="_blank" rel="noopener" data-v-43df44de data-v-b3f2150c><span class="vpi-social-bilibili"></span></a><a class="VPSocialLink no-icon" href="#wechat" aria-label="wechat" target="_blank" rel="noopener" data-v-43df44de data-v-b3f2150c><span class="vpi-social-wechat"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-357046c4 data-v-5440f226><span class="container" data-v-5440f226><span class="top" data-v-5440f226></span><span class="middle" data-v-5440f226></span><span class="bottom" data-v-5440f226></span></span></button></div></div></div></div><div class="divider" data-v-357046c4><div class="divider-line" data-v-357046c4></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-e8cbffd7 data-v-315e22c6><div class="container" data-v-315e22c6><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-315e22c6><span class="vpi-align-left menu-icon" data-v-315e22c6></span><span class="menu-text" data-v-315e22c6>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-315e22c6 data-v-41946b35><button data-v-41946b35>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-e8cbffd7 data-v-2381695a><div class="curtain" data-v-2381695a></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-2381695a><span class="visually-hidden" id="sidebar-aria-label" data-v-2381695a> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-54ab8e9b><section class="VPSidebarItem level-0" data-v-54ab8e9b data-v-0221ad41><div class="item" role="button" tabindex="0" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><h2 class="text" data-v-0221ad41>开始</h2><!----></div><div class="items" data-v-0221ad41><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>大纲</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/introduction_to_mql5" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>简介</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/editing_compiling_running" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>编辑编译运行</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/mql_wizard" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>MQL向导</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/statements" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>语句代码块函数</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/first_program" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>第一个程序</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/data_types_and_values" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>数据类型和值</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/variables_and_identifiers" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>变量和标识符</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/assignment_and_initialization" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>赋值和初始化</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/data_input" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>数据输入</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/error_fixing_and_debugging" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>修复错误和调试</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/data_output" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>数据输出</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/formatting" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>格式化</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/welcome/mini_summary" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>迷你小结</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-54ab8e9b><section class="VPSidebarItem level-0 collapsible collapsed" data-v-54ab8e9b data-v-0221ad41><div class="item" role="button" tabindex="0" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><h2 class="text" data-v-0221ad41>MQL5编程基础</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-0221ad41><span class="vpi-chevron-right caret-icon" data-v-0221ad41></span></div></div><div class="items" data-v-0221ad41><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>简介</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/identifiers/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>标识符</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/built-in_data_types/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>内置数据类型</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/variables/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>变量</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/arrays/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>数组</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/expresssions/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>表达式</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/type_conversion/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>类型转换</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/statements/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>语句</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/function/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>函数</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/mql5_programming_fundamentals/preprocessor/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>预处理</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-54ab8e9b><section class="VPSidebarItem level-0 collapsible collapsed" data-v-54ab8e9b data-v-0221ad41><div class="item" role="button" tabindex="0" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><h2 class="text" data-v-0221ad41>面向对象</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-0221ad41><span class="vpi-chevron-right caret-icon" data-v-0221ad41></span></div></div><div class="items" data-v-0221ad41><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/object_oriented_programming/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>简介</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/object_oriented_programming/structures_and_unions" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>结构体和联合体</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/object_oriented_programming/classes_and_interfaces" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>类和接口</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/object_oriented_programming/templates" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>模板</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-54ab8e9b><section class="VPSidebarItem level-0 collapsible collapsed has-active" data-v-54ab8e9b data-v-0221ad41><div class="item" role="button" tabindex="0" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><h2 class="text" data-v-0221ad41>常用API</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-0221ad41><span class="vpi-chevron-right caret-icon" data-v-0221ad41></span></div></div><div class="items" data-v-0221ad41><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>简介</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/built-in_type_conversions" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>内置类型转换</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/working_with_strings_and_symbols" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>字符串和符号处理</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/working_with_arrays" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>数组操作</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/mathematical_functions" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>数学函数</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/working_with_files" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>文件操作</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/client_terminal_global_variables" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>客户端全局变量</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/functions_for_working_with_time" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>时间相关函数</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/user_interaction" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>用户交互</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/mql_program_execution_environment" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>MQL 程序执行环境</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/common_mql5_apis/matrices_and_vectors" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>矩阵和向量</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-54ab8e9b><section class="VPSidebarItem level-0 collapsible collapsed" data-v-54ab8e9b data-v-0221ad41><div class="item" role="button" tabindex="0" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><h2 class="text" data-v-0221ad41>在 MQL5 中创建应用程序</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-0221ad41><span class="vpi-chevron-right caret-icon" data-v-0221ad41></span></div></div><div class="items" data-v-0221ad41><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>简介</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/general_principles" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>一般原则</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/script_and_services" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>脚本和服务</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/timeseries" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>时间序列</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/creating_custom_indicators" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>自定义指标</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/ready-made-indicators" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>自带指标</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/working_with_timer" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>定时器的使用</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/working_with_charts" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>图表操作</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/graphical_objects" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>图表对象</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/creating_application_programs/interactive_events_on_charts" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>图表上的交互式事件</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-54ab8e9b><section class="VPSidebarItem level-0 collapsible collapsed" data-v-54ab8e9b data-v-0221ad41><div class="item" role="button" tabindex="0" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><h2 class="text" data-v-0221ad41>交易自动化</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-0221ad41><span class="vpi-chevron-right caret-icon" data-v-0221ad41></span></div></div><div class="items" data-v-0221ad41><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/trading_automation/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>简介</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/trading_automation/financial_instruments_and_market_watch" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>金融工具与市场报价</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/trading_automation/depth_of_market" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>市场深度</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/trading_automation/trading_account_information" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>交易账户信息</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/trading_automation/createing_expert_advisors" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>创建智能交易顾问</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/trading_automation/testing_and_optimization_of_expert_advisors" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>专家顾问的测试和优化</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-54ab8e9b><section class="VPSidebarItem level-0 collapsible collapsed" data-v-54ab8e9b data-v-0221ad41><div class="item" role="button" tabindex="0" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><h2 class="text" data-v-0221ad41>MQL5高级工具</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-0221ad41><span class="vpi-chevron-right caret-icon" data-v-0221ad41></span></div></div><div class="items" data-v-0221ad41><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>简介</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/resources" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>资源</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/custom_symbol" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>自定义交易品种</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/economic_calendar" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>经济日历</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/cryptography" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>密码学</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/network_functions" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>网络函数</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/sqlite_database" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>SQLite 数据库</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/connection_of_binary_format_libraries" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>二进制格式库的开发与连接</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/projects" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>项目</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/native_python_support" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>原生python支持</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/opencl" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>opencl</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0221ad41 data-v-0221ad41><div class="item" data-v-0221ad41><div class="indicator" data-v-0221ad41></div><a class="VPLink link link" href="/mq5_programming_for_traders/advanced_language_tools/conclusion" data-v-0221ad41><!--[--><p class="text" data-v-0221ad41>总结</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-e8cbffd7 data-v-41fb371c><div class="VPDoc has-sidebar has-aside" data-v-41fb371c data-v-c23ecb28><!--[--><!--]--><div class="container" data-v-c23ecb28><div class="aside" data-v-c23ecb28><div class="aside-curtain" data-v-c23ecb28></div><div class="aside-container" data-v-c23ecb28><div class="aside-content" data-v-c23ecb28><div class="VPDocAside" data-v-c23ecb28 data-v-296f4c62><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-296f4c62 data-v-e8bc4af3><div class="content" data-v-e8bc4af3><div class="outline-marker" data-v-e8bc4af3></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-e8bc4af3>本页目录</div><ul class="VPDocOutlineItem root" data-v-e8bc4af3 data-v-4326957b><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-296f4c62></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-c23ecb28><div class="content-container" data-v-c23ecb28><!--[--><!--]--><main class="main" data-v-c23ecb28><div style="position:relative;" class="vp-doc _mq5_programming_for_traders_common_mql5_apis_working_with_files" data-v-c23ecb28><div><h1 id="文件操作" tabindex="-1">文件操作 <a class="header-anchor" href="#文件操作" aria-label="Permalink to &quot;文件操作&quot;">​</a></h1><p>很难找到一个不使用数据输入输出的程序。我们已经知道，MQL程序可以通过输入变量接收设置，并将信息输出到日志中，因为我们几乎在所有测试脚本中都使用了后者。但在大多数情况下，这还不够。</p><p>例如，相当一部分程序定制工作涉及到大量数据，这些数据无法通过输入参数来传递。一个程序可能需要与某些外部分析工具集成，也就是说，以标准或专用格式上传市场信息，对其进行处理，然后以新的形式加载到终端中，特别是作为交易信号、一组神经网络权重或决策树系数。此外，为MQL程序维护一个单独的日志也会很方便。</p><p>文件子系统为完成这类任务提供了最通用的功能。MQL5 API提供了广泛的文件操作函数，包括创建、删除、搜索、写入和读取文件的函数。我们将在本章中学习所有这些内容。</p><p>MQL5中的所有文件操作都被限制在磁盘上的一个特殊区域，这个区域被称为沙盒。这样做是出于安全考虑，以防止任何MQL程序被用于恶意目的，从而损害你的计算机或操作系统。</p><p>高级用户可以通过特殊措施来规避这个限制，我们稍后会讨论这些措施。但这只应在特殊情况下进行，同时要注意预防措施并承担所有责任。</p><p>对于安装在计算机上的每个终端实例，沙盒的根目录位于&lt;terminal_data_folder&gt;/MQL5/Files/。在MetaEditor中，你可以使用“文件 -&gt; 打开数据文件夹”命令来打开数据文件夹。如果你在计算机上有足够的访问权限，这个目录通常与终端的安装位置相同。如果你没有所需的权限，路径将如下所示：</p><p>X:/Users/&lt;user_name&gt;/AppData/Roaming/MetaQuotes/Terminal/&lt;instance_id&gt;/MQL5/Files/</p><p>这里X是系统安装所在的盘符，&lt;user_name&gt;是Windows用户登录名，&lt;instance_id&gt;是终端实例的唯一标识符。Users文件夹也有一个别名“Documents and Settings”。</p><p>请注意，在通过RDP（远程桌面协议）远程连接到计算机的情况下，即使你拥有管理员权限，终端也将始终使用Roaming目录及其子目录。</p><p>我们回想一下，数据目录中的MQL5文件夹是存储所有MQL程序的地方：包括它们的源代码和编译后的ex5文件。每种类型的MQL程序，包括指标、智能交易系统、脚本等，在MQL5文件夹中都有一个专用的子文件夹。所以用于处理文件的Files文件夹就在它们旁边。</p><p>除了计算机上每个终端副本的单独沙盒之外，还有一个供所有终端共享的通用沙盒：它们可以通过这个沙盒进行通信。其路径经过Windows用户的主文件夹，并且可能因操作系统版本而异。例如，在Windows 7、8和10的标准安装中，路径如下：</p><p>X:/Users/&lt;user_name&gt;/AppData/Roaming/MetaQuotes/Terminal/Common/Files/</p><p>同样，你可以通过MetaTrader轻松访问该文件夹：运行“文件 -&gt; 打开共享数据文件夹”命令，你就会进入Common文件夹。</p><p>某些类型的MQL程序（智能交易系统和指标）不仅可以在终端中执行，还可以在测试器中执行。在测试器中运行时，共享沙盒仍然可访问，并且会使用测试代理内部的一个文件夹，而不是单个实例沙盒。通常，它看起来像这样：</p><p>X:/&lt;terminal_path&gt;/Tester/Agent-IP-port/MQL5/Files/</p><p>这在MQL程序本身中可能不可见，也就是说，所有文件函数的工作方式完全相同。然而，从用户的角度来看，可能会觉得存在某种问题。例如，如果程序将其工作结果保存到一个文件中，在运行完成后，该文件将在测试器的代理文件夹中被删除（就好像该文件从未被创建过一样）。这种常规方法是为了防止一个程序的潜在有价值数据泄露到另一个程序中，而这个程序可能在以后的某个时间在同一个代理上进行测试（特别是因为代理可以共享）。我们将在本书的第五部分讨论用于将文件传输到代理并从代理返回结果到终端的其他技术。</p><p>要绕过沙盒限制，你可以使用Windows为文件系统对象分配符号链接的功能。在我们的情况下，连接（连接点）最适合重定向对本地计算机上文件夹的访问。可以使用以下命令（在Windows命令行中）创建它们：</p><p>mklink /J new_name existing_target</p><p>参数new_name是新的虚拟文件夹的名称，它将指向真实文件夹existing_target。</p><p>为了创建到沙盒外部的外部文件夹的连接，建议在MQL5/Files中创建一个专用文件夹，例如Links。然后，进入该文件夹后，你可以通过选择new_name并将沙盒外部的真实路径替换为existing_target来执行上述命令。例如，以下命令将在Links文件夹中创建一个名为Settings的新链接，该链接将提供对MQL5/Presets文件夹的访问：</p><p>mklink /J Settings &quot;....\Presets&quot;</p><p>相对路径“....\”假定该命令在指定的MQL5/Files/Links文件夹中执行。两个点“..”的组合表示从当前文件夹切换到父文件夹。指定两次表示向上两级路径层次结构。结果，目标文件夹（existing_target）将被生成为MQL5/Presets。但是在existing_target参数中，你也可以指定绝对路径。</p><p>你可以像删除普通文件一样删除符号链接（但当然，你首先应该确保要删除的是左下角带有箭头图标的文件夹，即链接，而不是原始文件夹）。建议一旦你不再需要超出沙盒的限制，就立即删除它们。事实上，创建的虚拟文件夹对所有MQL程序都可用，而不仅仅是你的程序，并且不知道其他人的程序会如何利用这种额外的自由。</p><p>本章的许多部分都涉及文件名。它们充当文件系统元素的标识符，并且有类似的规则，包括一些限制。</p><p>请注意，文件名不能包含在文件系统中起特殊作用的某些字符（&#39;&lt;&#39;, &#39;&gt;&#39;, &#39;/&#39;, &#39;\&#39;, &#39;&quot;&#39;, &#39;:&#39;, &#39;|&#39;, &#39;* &#39;, &#39;?&#39;），以及任何代码在0到31（包括0和31）之间的字符。</p><p>以下文件名也被操作系统保留用于特殊用途，不能使用：CON, PRN, AUX, NUL, COM1, COM2, COM3, COM4, COM5, COM6, COM7, COM8, COM9, LPT1, LPT2, LPT3, LPT4, LPT5, LPT6, LPT7, LPT8, LPT9。</p><p>应该注意的是，Windows文件系统并不区分字母的大小写，所以像“Name”、“NAME”和“name”这样的名称指的是同一个元素。</p><p>Windows允许使用反斜杠&#39;\&#39;和正斜杠&#39;/&#39;作为路径组件（子文件夹和文件）之间的分隔符。然而，在MQL5字符串中，反斜杠需要转义（即实际上要写两次），因为&#39;&#39;字符本身是特殊的：它用于构造控制字符序列，如&#39;\r&#39;, &#39;\n&#39;, &#39;\t&#39;等（请参阅字符类型部分）。例如，以下路径是等效的：&quot;MQL5Book/file.txt&quot; 和 &quot;MQL5Book\file.txt&quot;。</p><p>点字符 &#39;.&#39; 用作名称和扩展名之间的分隔符。如果一个文件系统元素的标识符中有多个点，那么扩展名是最右边的点右边的片段，而它左边的所有内容都是名称。名称（点之前）或扩展名（点之后）可以为空。例如，没有扩展名的文件名是“text”，没有名称（只有扩展名）的文件是“.txt”。</p><p>在Windows中，路径和文件名的总长度是有限制的。同时，在MQL5中管理文件时，应该考虑到沙盒的路径将被添加到它们的路径和名称中，也就是说，在MQL函数调用中为文件对象名称分配的空间会更少。默认情况下，总长度限制是系统常量MAX_PATH，其值为260。从Windows 10（版本1607）开始，你可以将此限制增加到32767。为此，你需要将以下文本保存到一个.reg文件中，并通过将其添加到Windows注册表中来运行它。</p><p>[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\FileSystem] &quot;LongPathsEnabled&quot;=dword:00000001</p><p>对于其他版本的Windows，你可以使用命令行中的解决方法。特别是，你可以使用上述连接来缩短路径（通过创建一个具有短路径的虚拟文件夹）。你也可以使用shell命令 -subst，例如，subst z: c:\very\long\path（有关详细信息，请参阅Windows帮助）。</p><h2 id="信息存储方法-文本和二进制" tabindex="-1">信息存储方法：文本和二进制 <a class="header-anchor" href="#信息存储方法-文本和二进制" aria-label="Permalink to &quot;信息存储方法：文本和二进制&quot;">​</a></h2><p>在之前的许多章节中我们已经看到，同样的信息可以用文本和二进制两种形式来表示。例如，int、long和double格式的数字、日期和时间（datetime）以及颜色（color），在内存中是以一定长度的字节序列来存储的。这种方法很紧凑，更便于计算机解读，但对于人类来说，以文本形式分析信息则更加方便，尽管这会花费更多时间。因此，我们非常关注数字与字符串之间的相互转换，以及处理字符串的函数。</p><p>在文件层面，数据也同样分为二进制和文本两种表示形式。二进制文件用于以与内存中相同的内部表示形式存储数据。而文本文件则包含字符串表示形式。</p><p>文本文件通常用于诸如CSV（逗号分隔值）、JSON（JavaScript对象表示法）、XML（可扩展标记语言）、HTML（超文本标记语言）等标准格式。</p><p>当然，对于许多应用程序来说，二进制文件也有标准格式，特别是对于图像（PNG、GIF、JPG、BMP）、声音（WAV、MP3）或压缩档案（ZIP）。然而，二进制格式从一开始就具有更强的保护性，并且是对数据进行底层操作，因此在只看重存储效率和特定程序对数据的可访问性时，更常用于解决内部问题。换句话说，任何应用结构和类的对象都可以轻松地在二进制文件中保存和恢复它们的状态，实际上就像在内存中留下了印记，并且无需担心与任何标准的兼容性问题。</p><p>从理论上讲，在写入二进制文件时，我们可以手动将数据转换为字符串，然后在读取文件时再将其从字符串转换回数字（或结构、或数组）。这类似于文本文件模式自动提供的功能，但需要额外的工作量。而文本文件模式则为我们省去了这样的繁琐操作。此外，MQL5文件子系统会隐式地执行一些在处理文本时必要的可选但重要的操作。</p><p>首先，文本的概念是基于使用分隔符的一些通用规则。具体来说，我们假定所有文本都由字符串组成。这样，从算法角度来看，读取和分析它们会更加方便。因此，存在一些特殊字符用于分隔不同的字符串。</p><p>在这里，我们遇到了第一个困难，那就是不同的操作系统接受不同的字符组合作为分隔符。在Windows系统中，行分隔符是由两个字符组成的序列&#39;\r\n&#39;（既可以表示为十六进制代码：0xD 0xA，也可以用名称CRLF表示，即回车和换行）。在Unix和Linux系统中，单个字符&#39;\n&#39;是标准的行分隔符，但在MacOS系统下的某些版本和程序中可能会使用单个字符&#39;\r&#39;。</p><p>尽管MetaTrader 5运行在Windows系统下，但我们无法保证生成的任何文本文件不会使用不常见的分隔符进行保存。如果我们以二进制模式读取该文件，并自行检查分隔符以形成字符串，那么这些差异就需要进行特定的处理。而MQL5中的文件文本操作模式可以解决这个问题：它在读写时会自动对换行符进行规范化处理。</p><p>不过，MQL5并不能在所有情况下都修正换行符。特别是，在读取文本文件时，单个字符&#39;\r&#39;不会被解释为&#39;\r\n&#39;，而单个&#39;\n&#39;则会被正确地解释为&#39;\r\n&#39;。</p><p>其次，字符串在内存中可以有多种存储表示形式。默认情况下，MQL5中的字符串（string类型）由双字节字符组成。这提供了对通用Unicode编码的支持，这很好，因为它包含了所有国家的文字。然而，在许多情况下，并不需要这种通用性（例如，当存储数字或英文消息时），在这种情况下，使用ANSI编码的单字节字符字符串会更高效。MQL5 API函数允许你选择在文本模式下将字符串写入文件的首选方式。但如果我们在MQL程序中控制写入操作，就可以保证从Unicode转换为单字节字符的有效性和可靠性。在这种情况下，当与某些外部软件或网络服务集成时，其文件中的ANSI代码页可以是任意的。在这方面，就产生了以下一点。</p><p>第三，由于存在许多不同的语言，我们需要为各种ANSI编码的文本做好准备。如果不能正确解释编码，文本在写入或读取时可能会出现失真，甚至变得无法读取。我们在“处理符号和代码页”这一章节中已经看到了这一点。这就是为什么文件函数已经包含了正确处理字符的方法：只需在参数中指定所需或预期的编码即可。关于编码的选择，我们会在单独的章节中更详细地描述。</p><p>最后，文本模式内置了对著名的CSV格式的支持。由于交易经常需要表格数据，CSV格式非常适合这种需求。在CSV模式的文本文件中，MQL5 API函数不仅会处理用于换行的分隔符，还会处理用于分隔列（表格中每行的字段）边界的额外分隔符。这通常是制表符&#39;\t&#39;、逗号&#39;,&#39;或分号&#39;;&#39;。例如，以下是一个包含外汇新闻的CSV文件的样子（显示了一个逗号分隔的片段）：</p><p>标题,国家,日期,时间,影响程度,预测值,先前值 银行假日,日元,2021年08月09日,上午12:00,节假日,, 消费者物价指数年率,人民币,2021年08月09日,上午1:30,低,0.8%,1.1% 生产者物价指数年率,人民币,2021年08月09日,上午1:30,低,8.6%,8.8% 失业率,瑞士法郎,2021年08月09日,上午5:45,低,3.0%,3.1% 德国贸易差额,欧元,2021年08月09日,上午6:00,低,139亿欧元,126亿欧元 Sentix投资者信心指数,欧元,2021年08月09日,上午8:30,低,29.2,29.8 职位空缺与劳动力流动调查职位空缺数,美元,2021年08月09日,下午2:00,中等,927万个,921万个 美联储理事博斯蒂克讲话,美元,2021年08月09日,下午2:00,中等,, 美联储理事巴尔金讲话,美元,2021年08月09日,下午4:00,中等,, 英国零售联盟零售销售监测年率,英镑,2021年08月09日,晚上11:01,低,4.9%,6.7% 经常账户,日元,2021年08月09日,晚上11:50,低,1.71万亿日元,1.87万亿日元</p><p>为了更清晰地展示，以下是以表格形式呈现的内容：</p><table tabindex="0"><thead><tr><th>标题</th><th>国家</th><th>日期</th><th>时间</th><th>影响程度</th><th>预测值</th><th>先前值</th></tr></thead><tbody><tr><td>银行假日</td><td>日元</td><td>2021年08月09日</td><td>上午12:00</td><td>节假日</td><td></td><td></td></tr><tr><td>消费者物价指数年率</td><td>人民币</td><td>2021年08月09日</td><td>上午1:30</td><td>低</td><td>0.8%</td><td>1.1%</td></tr><tr><td>生产者物价指数年率</td><td>人民币</td><td>2021年08月09日</td><td>上午1:30</td><td>低</td><td>8.6%</td><td>8.8%</td></tr><tr><td>失业率</td><td>瑞士法郎</td><td>2021年08月09日</td><td>上午5:45</td><td>低</td><td>3.0%</td><td>3.1%</td></tr><tr><td>德国贸易差额</td><td>欧元</td><td>2021年08月09日</td><td>上午6:00</td><td>低</td><td>139亿欧元</td><td>126亿欧元</td></tr><tr><td>Sentix投资者信心指数</td><td>欧元</td><td>2021年08月09日</td><td>上午8:30</td><td>低</td><td>29.2</td><td>29.8</td></tr><tr><td>职位空缺与劳动力流动调查职位空缺数</td><td>美元</td><td>2021年08月09日</td><td>下午2:00</td><td>中等</td><td>927万个</td><td>921万个</td></tr><tr><td>美联储理事博斯蒂克讲话</td><td>美元</td><td>2021年08月09日</td><td>下午2:00</td><td>中等</td><td></td><td></td></tr><tr><td>美联储理事巴尔金讲话</td><td>美元</td><td>2021年08月09日</td><td>下午4:00</td><td>中等</td><td></td><td></td></tr><tr><td>英国零售联盟零售销售监测年率</td><td>英镑</td><td>2021年08月09日</td><td>晚上11:01</td><td>低</td><td>4.9%</td><td>6.7%</td></tr><tr><td>经常账户</td><td>日元</td><td>2021年08月09日</td><td>晚上11:50</td><td>低</td><td>1.71万亿日元</td><td>1.87万亿日元</td></tr></tbody></table><h2 id="简易模式下的文件读写" tabindex="-1">简易模式下的文件读写 <a class="header-anchor" href="#简易模式下的文件读写" aria-label="Permalink to &quot;简易模式下的文件读写&quot;">​</a></h2><p>在MQL5中用于读写数据的文件函数可以分为两个不对等的组。第一组包含两个函数：FileSave和FileLoad，它们允许在一次函数调用中以二进制模式写入或读取数据。一方面，这种方法具有不可否认的优势，即简单性，但另一方面，它也存在一些局限性（下面会详细介绍）。第二大组中的所有文件函数使用方式不同：需要依次调用几个函数，才能执行一个逻辑完整的读写操作。这看起来更复杂，但它为操作过程提供了灵活性和控制能力。第二组函数使用特殊的整数——文件描述符进行操作，文件描述符应使用FileOpen函数获取（详见下一节）。</p><p>我们先来看一下这两个函数的正式说明，然后再看它们的示例（FileSaveLoad.mq5）。</p><p>bool FileSave(const string filename, const void &amp;data[], const int flag = 0)</p><p>该函数将传入的数据数组的所有元素写入一个名为filename的二进制文件中。filename参数不仅可以包含文件名，还可以包含多层嵌套文件夹的名称：如果指定的文件夹不存在，该函数将创建它们。如果文件已存在，它将被覆盖（除非被另一个程序占用）。</p><p>作为data参数，可以传入除字符串外的任何内置类型的数组。它也可以是一个简单结构的数组，该结构包含除字符串、动态数组和指针之外的内置类型的字段。类也不被支持。</p><p>如果需要，flag参数可以包含预定义常量FILE_COMMON，这意味着在所有终端的公共数据目录（Common/Files/）中创建并写入文件。如果未指定flag（对应默认值0），则文件将被写入常规数据目录（如果MQL程序在终端中运行）或测试代理目录（如果在测试器中运行）。在最后两种情况下，如本章开头所述，将在目录内使用MQL5/Files/沙盒。</p><p>该函数返回操作成功（true）或失败（false）的指示。</p><p>long FileLoad(const string filename, void &amp;data[], const int flag = 0)</p><p>该函数将二进制文件filename的全部内容读取到指定的数据数组中。文件名可以包含MQL5/Files或Common/Files沙盒内的文件夹层次结构。</p><p>数据数组必须是除字符串外的任何内置类型，或者是简单结构类型（见上文）。</p><p>flag参数控制文件搜索和打开的目录选择：默认情况下（值为0）是标准沙盒，但如果设置为FILE_COMMON，则是所有终端共享的沙盒。</p><p>该函数返回读取的项目数量，如果出错则返回-1。</p><p>请注意，文件中的数据是以一个数组元素为块进行读取的。如果文件大小不是元素大小的倍数，那么剩余的数据将被跳过（不读取）。例如，如果文件大小为10字节，将其读取到double类型的数组中（sizeof(double)=8），实际上只会加载8字节，即1个元素（函数将返回1）。文件末尾的剩余2字节将被忽略。</p><p>在FileSaveLoad.mq5脚本中，我们定义了两个用于测试的结构。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Pair</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   short</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x, y;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Simple</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> d;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   datetime t;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   color c;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   uchar </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 允许固定大小的数组</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   Pair p;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 也允许复合字段（嵌套的简单结构）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 使用字符串和动态数组会导致编译错误</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // FileSave/FileLoad：不允许包含对象的结构或类</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // string s;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // uchar a[];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 指针也不被支持</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // void *ptr;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>Simple结构包含了大多数允许的类型的字段，以及一个具有Pair结构类型的复合字段。在OnStart函数中，我们填充了一个小型的Simple类型数组。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   Simple write</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.01.01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, clrBlue, {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;a&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.01.01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, clrRed,  {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;b&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span></code></pre></div><p>我们将选择与MQL5Book子文件夹一起写入数据的文件，这样我们的实验就不会与你的工作文件混淆：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string filename </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/rawdata&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>让我们将一个数组写入文件，再将其读取到另一个数组中，然后进行比较。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSave</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename, write</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/*, FILE_COMMON*/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Simple read</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileLoad</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename, read</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/*, FILE_COMMON*/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArrayCompare</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(write, read));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 0</span></span></code></pre></div><p>FileLoad返回了2，即读取了2个元素（2个结构）。如果比较结果为0，则表示数据匹配。你可以在你喜欢的文件管理器中打开MQL5/Files/MQL5Book文件夹，并确保存在“rawdata”文件（不建议使用文本编辑器查看其内容，建议使用支持二进制模式的查看器）。</p><p>在脚本的进一步操作中，我们将读取的结构数组转换为字节，并以十六进制代码的形式输出到日志中。这是一种内存转储，它可以让你了解二进制文件是什么。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">uchar bytes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ArraySize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(read); </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   uchar temp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StructToCharArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i], temp));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayCopy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bytes, temp, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArraySize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bytes));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ByteArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bytes);</span></span></code></pre></div><p>结果：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>[00] 00 | 00 | 00 | 00 | 00 | 00 | F0 | 3F | FF | FF | FF | FF | 00 | 66 | EE | 5F | </span></span>
<span class="line"><span>[16] 00 | 00 | 00 | 00 | 00 | 00 | FF | 00 | 61 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | </span></span>
<span class="line"><span>[32] 00 | 00 | 01 | E8 | 03 | 80 | 3E | 00 | 00 | 00 | 00 | 00 | 00 | F0 | BF | FE | </span></span>
<span class="line"><span>[48] FF | FF | FF | 00 | 66 | EE | 5F | 00 | 00 | 00 | 00 | FF | 00 | 00 | 00 | 62 | </span></span>
<span class="line"><span>[64] 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 01 | E8 | 03 | 80 | 3E |</span></span></code></pre></div><p>因为内置的ArrayPrint函数不能以十六进制格式打印，所以我们不得不开发自己的函数ByteArrayPrint（这里我们不会给出它的源代码，详见附件文件）。</p><p>接下来，让我们记住FileLoad能够将数据加载到任何类型的数组中，所以我们将使用它直接将同一个文件读取到一个字节数组中。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">uchar bytes2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileLoad</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename, bytes2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/*, FILE_COMMON*/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 78,  39 * 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArrayCompare</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bytes, bytes2));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 0, 相等</span></span></code></pre></div><p>两个字节数组的成功比较表明，FileLoad可以按照指定的任意方式处理来自文件的原始数据（文件中没有信息表明它存储的是Simple结构的数组）。</p><p>这里需要重点注意的是，由于字节类型的大小最小（1），它是任何文件大小的倍数。因此，任何文件总是能无剩余地被读取到字节数组中。这里FileLoad函数返回了数字78（元素数量等于字节数）。这就是文件的大小（两个39字节的结构）。</p><p>基本上，FileLoad能够为任何类型解释数据，这就要求程序员谨慎处理并进行检查。特别是，在脚本的进一步操作中，我们将同一个文件读取到MqlDateTime结构的数组中。这当然是错误的，但它运行时没有错误。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MqlDateTime mdt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(MqlDateTime));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 32</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileLoad</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename, mdt));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 2</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 注意：还有14字节未读取</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mdt);</span></span></code></pre></div><p>结果包含了一组无意义的数字：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>        [year]      [mon] [day]     [hour]    [min]    [sec] [day_of_week] [day_of_year]</span></span>
<span class="line"><span>[0]          0 1072693248    -1 1609459200        0 16711680            97             0</span></span>
<span class="line"><span>[1] -402587648    4096003     0  -20975616 16777215  6286950     -16777216    1644167168</span></span></code></pre></div><p>因为MqlDateTime的大小是32，所以在一个78字节的文件中只能容纳两个这样的结构，还剩下14字节多余。剩余字节的存在表明存在问题。但即使没有剩余字节，也不能保证所执行操作的合理性，因为两种不同大小的结构纯粹出于偶然也可能以整数（但不同）次的方式适配文件长度。此外，两个意义不同的结构可能具有相同的大小，但这并不意味着它们应该相互写入和读取。</p><p>毫不奇怪，MqlDateTime结构数组的日志显示了奇怪的值，因为实际上它是完全不同的数据类型。</p><p>为了使读取更加谨慎，脚本实现了一个类似于FileLoad的函数——MyFileLoad。当我们学习新的文件函数并使用它们来模拟FileSave/FileLoad的内部结构时，我们将在接下来的部分详细分析这个函数及其对应的MyFileSave函数。同时，只需注意在我们的版本中，我们可以检查文件中是否存在未读取的剩余部分并显示警告。</p><p>最后，让我们看一下脚本中演示的另外几个潜在错误。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 编译错误，这里不支持字符串类型</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">string texts[];</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">FileSave(&quot;any&quot;, texts); // 不允许参数转换</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">*/</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileLoad</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;any&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, data));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // -1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_LastError);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 5004, ERR_CANNOT_OPEN_FILE</span></span></code></pre></div><p>第一个错误发生在编译时（这就是为什么代码块被注释掉了），因为不允许使用字符串数组。</p><p>第二个错误是读取一个不存在的文件，这就是为什么FileLoad返回-1。可以使用GetLastError（或_LastError）轻松获取解释性的错误代码。</p><h2 id="文件的打开与关闭" tabindex="-1">文件的打开与关闭 <a class="header-anchor" href="#文件的打开与关闭" aria-label="Permalink to &quot;文件的打开与关闭&quot;">​</a></h2><p>要从文件中读写数据，大多数MQL5函数都要求先打开文件。为此，有FileOpen函数。在执行完所需的操作后，应该使用FileClose函数关闭打开的文件。事实上，根据应用的选项，一个打开的文件可能会被其他程序阻止访问。此外，出于性能原因，文件操作会在内存（缓存）中进行缓冲，如果不关闭文件，新数据可能在一段时间内不会实际上传到文件中。如果正在写入的数据在等待外部程序使用（例如，当将MQL程序与其他系统集成时），这一点尤其关键。我们可以从FileFlush函数的说明中了解到将缓冲区刷新到磁盘的另一种方法。</p><p>在MQL程序中，一个特殊的整数（称为描述符）与打开的文件相关联。它由FileOpen函数返回。所有与访问或修改文件内部内容相关的操作都需要在相应的API函数中指定这个标识符。那些对整个文件进行操作（复制、删除、移动、检查是否存在）的函数不需要描述符。执行这些操作时，不需要打开文件。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">filename</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> flags</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> short</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> delimiter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> codepage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CP_ACP)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">filename</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> flags</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">delimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> codepage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CP_ACP)</span></span></code></pre></div><p>该函数以flags参数指定的模式打开指定名称的文件。filename参数在实际文件名之前可能包含子文件夹。在这种情况下，如果以写入模式打开文件且所需的文件夹层次结构尚不存在，它将被创建。</p><p>flags参数必须包含描述所需文件操作模式的常量组合。该组合使用按位或操作来完成。以下是可用常量的表格。</p><table tabindex="0"><thead><tr><th>标识符</th><th>值</th><th>描述</th></tr></thead><tbody><tr><td>FILE_READ</td><td>1</td><td>以读取模式打开文件</td></tr><tr><td>FILE_WRITE</td><td>2</td><td>以写入模式打开文件</td></tr><tr><td>FILE_BIN</td><td>4</td><td>二进制读写模式，不进行字符串到字符串的数据转换</td></tr><tr><td>FILE_CSV</td><td>8</td><td>CSV类型的文件；写入的数据将转换为相应类型的文本（Unicode或ANSI，见下文），读取时进行从文本到所需类型（在读取函数中指定）的反向转换；一条CSV记录是一行文本，由换行符分隔（通常是CRLF）；在CSV记录内部，元素由分隔符字符（参数delimiter）分隔</td></tr><tr><td>FILE_TXT</td><td>16</td><td>纯文本文件，类似于CSV模式，但不使用分隔符字符（参数delimiter的值将被忽略）</td></tr><tr><td>FILE_ANSI</td><td>32</td><td>ANSI类型字符串（单字节字符）</td></tr><tr><td>FILE_UNICODE</td><td>64</td><td>Unicode类型字符串（双字节字符）</td></tr><tr><td>FILE_SHARE_READ</td><td>128</td><td>多个程序的共享读访问</td></tr><tr><td>FILE_SHARE_WRITE</td><td>256</td><td>多个程序的共享写访问</td></tr><tr><td>FILE_REWRITE</td><td>512</td><td>在FileCopy和FileMove函数中覆盖文件（如果文件已存在）的权限</td></tr><tr><td>FILE_COMMON</td><td>4096</td><td>文件位于所有客户端终端的共享文件夹/Terminal/Common/Files中（在打开文件（FileOpen）、复制文件（FileCopy、FileMove）和检查文件是否存在（FileIsExist）时使用该标志）</td></tr></tbody></table><p>打开文件时，必须指定FILE_WRITE、FILE_READ标志之一或它们的组合。</p><p>FILE_SHARE_READ和FILE_SHARE_WRITE标志不能替代或取消指定FILE_READ和FILE_WRITE标志的需求。</p><p>MQL程序执行环境总是对文件进行读取缓冲，这相当于隐式添加了FILE_READ标志。因此，为了正确处理共享文件，总是应该使用FILE_SHARE_READ（即使已知另一个进程打开了一个只写文件）。</p><p>如果未指定FILE_CSV、FILE_BIN、FILE_TXT标志中的任何一个，则假定FILE_CSV具有最高优先级。如果指定了这三个标志中的多个，则应用传递的最高优先级（它们按优先级降序列在上面）。</p><p>对于文本文件，默认模式是FILE_UNICODE。</p><p>仅影响CSV的delimiter参数可以是ushort或string类型。在第二种情况下，如果字符串长度大于1，将只使用其第一个字符。</p><p>codepage参数仅影响以文本模式（FILE_TXT或FILE_CSV）打开的文件，并且仅在为字符串选择了FILE_ANSI模式时才起作用。如果字符串以Unicode（FILE_UNICODE）存储，则代码页不重要。</p><p>如果成功，该函数将返回一个文件描述符，即一个正整数。它仅在特定的MQL程序内是唯一的；与其他程序共享它没有意义。为了进一步处理文件，将描述符传递给其他函数的调用。</p><p>如果出错，结果为INVALID_HANDLE (-1)。错误的本质应从GetLastError函数返回的代码中加以澄清。</p><p>文件打开时设置的所有操作模式设置在文件打开期间保持不变。如果需要更改模式，则应关闭文件并使用新参数重新打开。</p><p>对于每个打开的文件，MQL程序执行环境会维护一个内部指针，即文件内的当前位置。打开文件后，指针立即设置为开头（位置0）。在写入或读取过程中，根据从各种文件函数传输或接收的数据量，位置会相应地移动。也可以直接影响该位置（向后或向前移动）。所有这些功能将在以下部分中讨论。</p><p>FILE_READ和FILE_WRITE的各种组合允许实现几种场景：</p><ul><li>FILE_READ — 仅当文件存在时才打开文件；否则，函数返回错误，并且不会创建新文件。</li><li>FILE_WRITE — 如果文件尚不存在，则创建一个新文件，或者打开一个现有文件，其内容将被清除，大小将重置为零。</li><li>FILE_READ|FILE_WRITE — 打开一个现有文件及其所有内容，或者如果文件尚不存在，则创建一个新文件。</li></ul><p>如您所见，某些场景仅由于标志而无法实现。特别是，如果文件已经存在，您不能仅以写入模式打开它。这可以通过使用其他函数来实现，例如FileIsExist。此外，对于以读写组合模式打开的文件，无法“自动”重置：在这种情况下，MQL5始终保留其内容。</p><p>要向文件追加数据，不仅必须以FILE_READ|FILE_WRITE模式打开文件，还必须通过调用FileSeek将文件内的当前位置移动到文件末尾。</p><p>正确描述对文件的共享访问是成功执行文件打开的先决条件。这方面的管理如下：</p><ul><li>如果未指定FILE_SHARE_READ和FILE_SHARE_WRITE标志中的任何一个，那么如果当前程序首先打开文件，它将获得对该文件的独占访问权。如果同一个文件之前已被其他人（其他程序或同一个程序）打开，函数调用将失败。</li><li>当设置了FILE_SHARE_READ标志时，程序允许后续请求打开同一个文件进行读取。如果在函数调用时该文件已被另一个或同一个程序打开进行读取，并且未设置此标志，函数将失败。</li><li>当设置了FILE_SHARE_WRITE标志时，程序允许后续请求打开同一个文件进行写入。如果在函数调用时该文件已被另一个或同一个程序打开进行写入，并且未设置此标志，函数将失败。</li></ul><p>访问共享不仅要针对其他MQL程序或MetaTrader 5外部的进程进行检查，而且如果同一个MQL程序重新打开文件，也要针对该程序进行检查。</p><p>因此，冲突最少的模式意味着同时指定两个标志，但如果已经有人在没有共享的情况下获得了该文件的描述符，它仍然不能保证文件会被打开。然而，根据计划的读取或写入操作，应该遵循更严格的规则。</p><p>例如，当打开一个文件进行读取时，让其他人也有机会读取它是有意义的。此外，如果这是一个正在补充的文件（例如，日志），您可能还可以允许其他人写入它。但是，当打开一个文件进行写入时，几乎不应该让其他人拥有写入访问权限：这将导致不可预测的数据覆盖。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数通过句柄关闭先前打开的文件。</p><p>文件关闭后，程序中的句柄将变为无效：尝试对其调用任何文件函数将导致错误。但是，如果重新打开同一个或不同的文件，您可以使用相同的变量存储不同的句柄。</p><p>当程序终止时，打开的文件将被强制关闭，如果写入缓冲区不为空，将被写入磁盘。然而，建议显式关闭文件。</p><p>在完成对文件的操作后关闭文件是一条需要遵循的重要规则。这不仅是因为正在写入的信息会被缓存，如果不关闭文件，这些信息可能会在一段时间内保留在RAM中而不会保存到磁盘（如上文所述）。此外，一个打开的文件会消耗操作系统的一些内部资源，这里说的不是磁盘空间。同时打开的文件数量是有限的（根据Windows设置，可能是几百个或几千个）。如果许多程序保持大量文件处于打开状态，可能会达到这个限制，并且尝试打开新文件将失败。</p><p>在这方面，使用一个包装类来防止描述符可能的丢失是很有必要的。这个包装类在创建对象时打开文件并获取描述符，并且在析构函数中自动释放描述符并关闭文件。</p><p>我们将在测试纯FileOpen和FileClose函数之后创建一个包装类。</p><p>但在深入研究文件的具体细节之前，让我们准备一个新版本的宏，以说明我们的函数输出到调用日志的情况。需要这个新版本是因为到目前为止，像PRT和PRTS（在前面部分使用）这样的宏在打印时“吸收”了函数返回值。例如，我们这样写：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileLoad</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename, read));</span></span></code></pre></div><p>这里FileLoad调用的结果被发送到日志中，但无法在调用代码行中获取它。说实话，我们之前不需要它。但现在FileOpen函数将返回一个文件描述符，并且应该将其存储在一个变量中，以便进一步操作文件。</p><p>旧宏存在两个问题。首先，它们基于Print函数，该函数消耗传递的数据（将其发送到日志），但本身不返回任何内容。其次，对于带有结果的变量，任何值只能从表达式中获取，而Print调用不能成为表达式的一部分，因为它的类型是void。</p><p>为了解决这些问题，我们需要一个返回可打印值的打印辅助函数。我们将把它的调用打包到一个新的PRTF宏中：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;MQL5Book/MqlError.mqh&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">A</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ResultPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(#A, (A))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">template</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">typename T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">T </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ResultPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> T retval </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> E2S</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_LastError) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;(&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (string)_LastError </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;=&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, retval, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; / &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (_LastError </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ok&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> err));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ResetLastError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 清除下一次调用的错误标志</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> retval;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>使用&#39;#&#39;神奇字符串转换操作符，我们得到了作为第一个参数传递给ResultPrint的代码片段（表达式A）的详细描述符。表达式本身（宏参数）被求值（如果有函数，将调用它），其结果作为第二个参数传递给ResultPrint。接下来，通常的Print函数开始起作用，最后，相同的结果被返回给调用代码。</p><p>为了无需查阅帮助文档来解码错误代码，准备了一个E2S宏，它使用了包含所有MQL5错误的MQL_ERROR枚举。可以在头文件MQL5/Include/MQL5Book/MqlError.mqh中找到它。新的宏和ResultPrint函数在PRTF.mqh文件中定义，位于测试脚本旁边。</p><p>在FileOpenClose.mq5脚本中，让我们尝试打开不同的文件，特别是，将并行多次打开同一个文件。在实际程序中通常会避免这种情况。对于大多数任务，程序实例中对特定文件的单个句柄就足够了。</p><p>其中一个文件，MQL5Book/rawdata，肯定已经存在，因为它是由“简易模式下的文件读写”部分中的脚本创建的。另一个文件将在测试期间创建。</p><p>我们将选择FILE_BIN文件类型。在这个阶段，使用FILE_TXT或FILE_CSV文件类型的操作与此类似。</p><p>让我们预留一个文件描述符数组，以便在脚本结束时一次性关闭所有文件。</p><p>首先，让我们以不共享访问的读取模式打开MQL5Book/rawdata。假设该文件未被任何第三方应用程序使用，我们可以期望成功获取句柄。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> ha</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {};</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 用于测试文件句柄的数组 </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 运行FileSaveLoad.mq5后此文件必须存在</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string rawdata </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/rawdata&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">   ha</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rawdata, FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 1 / ok</span></span></code></pre></div><p>如果我们尝试再次打开同一个文件，我们将遇到错误，因为第一次和第二次调用都不允许共享。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ha</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rawdata, FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // -1 / CANNOT_OPEN_FILE(5004)</span></span></code></pre></div><p>让我们关闭第一个句柄，再次打开文件，但具有共享读权限，并确保现在重新打开操作有效（尽管它也需要允许共享读取）：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ha</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ha</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rawdata, FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_READ));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 1 / ok</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ha</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rawdata, FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_READ));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 2 / ok</span></span></code></pre></div><p>以写入模式（FILE_WRITE）打开文件将不起作用，因为之前的两次FileOpen调用只允许FILE_SHARE_READ。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ha</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rawdata, FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_READ));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// -1 / CANNOT_OPEN_FILE(5004)</span></span></code></pre></div><p>现在让我们尝试创建一个新文件MQL5Book/newdata。如果以只读模式打开它，文件将不会被创建。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string newdata </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/newdata&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ha</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(newdata, FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// -1 / CANNOT_OPEN_FILE(5004)</span></span></code></pre></div><p>要创建一个文件，必须指定FILE_WRITE模式（这里FILE_READ的存在并不关键，但它使调用更通用：如我们所记得的，在这种组合中，指令保证如果旧文件存在，将打开它，否则将创建一个新文件）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ha</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(newdata, FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 3 / ok</span></span></code></pre></div><p>让我们尝试使用我们已知的FileSave函数向新文件写入一些内容。它充当一个“外部参与者”，因为它绕过我们的描述符对文件进行操作，这与另一个MQL程序或第三方应用程序的操作方式非常相似。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> x</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">0x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">123456789ABCDEF0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSave</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(newdata, x));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // false</span></span></code></pre></div><p>这次调用失败，因为句柄是在没有共享权限的情况下打开的。关闭并以最大“权限”重新打开文件。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ha</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ha</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(newdata, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_WRITE));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 3 / ok</span></span></code></pre></div><p>这次FileSave按预期工作。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSave</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(newdata, x));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // true</span></span></code></pre></div><p>您可以查看文件夹MQL5/Files/MQL5Book/，并在那里找到长度为8字节的newdata文件。</p><p>请注意，在我们关闭文件后，其描述符将返回到空闲描述符池中，并且下次打开文件（可能是另一个文件）时，相同的数字将再次起作用。</p><p>为了整齐地关闭程序，我们将显式关闭所有打开的文件。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ArraySize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ha); </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ha</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INVALID_HANDLE)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ha</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>}</p><h2 id="文件描述符管理" tabindex="-1">文件描述符管理 <a class="header-anchor" href="#文件描述符管理" aria-label="Permalink to &quot;文件描述符管理&quot;">​</a></h2><p>由于我们需要时刻记住打开的文件，并在从函数中任何方式退出时释放局部描述符，将整个常规操作委托给特殊对象会更高效。</p><p>这种方法在编程中很常见，被称为资源获取即初始化（RAII）。使用RAII可以更轻松地控制资源并确保它们处于正确状态。特别是，如果打开文件的函数（并为其创建一个所有者对象）从几个不同的地方退出，这种方法会特别有效。</p><p>RAII的应用范围并不局限于文件。在“对象类型模板”部分，我们创建了AutoPtr类，它管理指向对象的指针。这是该概念的另一个例子，因为指针也是一种资源（内存），而且很容易丢失它，并且在算法的几个不同分支中释放它也会消耗资源。</p><p>文件包装类在另一方面也很有用。文件API没有提供一个函数，允许通过描述符获取文件名（尽管在内部这种关系肯定存在）。同时，在对象内部，我们可以存储这个文件名，并实现我们自己的与描述符的绑定。</p><p>在最简单的情况下，我们需要一个存储文件描述符并在析构函数中自动关闭它的类。FileHandle.mqh文件中展示了一个示例实现。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class FileHandle</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> handle;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">public:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileHandle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> h </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INVALID_HANDLE) : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(h)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileHandle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">holder, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> h) : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(h)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      holder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> h;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> operator</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> h)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> h;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> h;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span></code></pre></div><p>两个构造函数以及重载的赋值运算符确保对象与文件（描述符）绑定。第二个构造函数允许传递对局部变量的引用（来自调用代码），该变量将额外获得一个新描述符。这将是同一个描述符的一种外部别名，可以在其他函数调用中以通常的方式使用。</p><p>但也可以不使用别名。对于这些情况，类定义了“~”运算符，它返回内部handle变量的值。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> operator</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> handle;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>最后，实现这个类最重要的部分是智能析构函数：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   ~</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileHandle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INVALID_HANDLE)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         ResetLastError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // 如果句柄无效，将设置内部错误代码</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         FileGetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, FILE_SIZE);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_LastError </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            #ifdef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FILE_DEBUG_PRINT</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">               Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__FUNCTION__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;: Automatic close for handle: &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, handle);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            #endif</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            PrintFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">: handle </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is incorrect, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">               __FUNCTION__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, handle, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">E2S</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_LastError), _LastError);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>在进行几次检查后，对受控的handle变量调用FileClose。关键在于，文件可能在程序的其他地方被显式关闭，尽管使用这个类后不再需要这样做。结果是，当算法执行离开定义FileHandle对象的代码块时，在调用析构函数时描述符可能已经无效。为了查明这一点，使用了对FileGetInteger函数的虚拟调用。之所以说是虚拟的，是因为它没有做任何有用的事情。如果调用后内部错误代码仍然为0，则描述符有效。</p><p>我们可以省略所有这些检查，简单地写成以下形式：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   ~</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileHandle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INVALID_HANDLE)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>如果描述符已损坏，FileClose不会返回任何警告。但我们添加了检查，以便能够输出诊断信息。</p><p>让我们试试FileHandle类的实际效果。它的测试脚本名为FileHandle.mq5。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string dummy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/dummy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 创建一个新文件，或者打开一个现有文件并重置它</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   FileHandle </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fh1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dummy, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      FILE_TXT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_READ)));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 通过&#39;=&#39;连接描述符的另一种方式</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> h </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dummy, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      FILE_TXT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_READ));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   FileHandle fh2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> h;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 以及另一种支持的语法：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // int f;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // FileHandle ff(f, FileOpen(dummy,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   //    FILE_TXT | FILE_WRITE | FILE_SHARE_WRITE | FILE_SHARE_READ));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 假设在这里写入数据</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 手动关闭文件（这不是必需的；只是为了演示FileHandle将检测到这一点，并且不会尝试再次关闭它）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fh1);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 对对象应用&#39;~&#39;运算符将返回句柄</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 绑定到对象&#39;fh2&#39;的变量&#39;h&#39;中的描述符句柄不会被手动关闭</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 并且将在析构函数中自动关闭</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>根据日志中的输出，一切按计划进行：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>   FileHandle::~FileHandle: Automatic close for handle: 2</span></span>
<span class="line"><span>   FileHandle::~FileHandle: handle 1 is incorrect, INVALID_FILEHANDLE(5007)</span></span></code></pre></div><p>然而，如果有很多文件，为每个文件创建一个跟踪对象副本可能会带来不便。对于这种情况，设计一个在给定上下文中（例如，在一个函数内部）收集所有描述符的单个对象是有意义的。</p><p>这样的类在FileHolder.mqh文件中实现，并在FileHolder.mq5脚本中展示。FileHolder本身的一个副本根据请求创建FileOpener类的辅助观察对象，它与FileHandle有共同的特性，特别是析构函数以及handle字段。</p><p>要通过FileHolder打开文件，应该使用它的FileOpen方法（其签名与标准FileOpen函数的签名相同）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class FileHolder</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FileOpener </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">files</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> expand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ArrayResize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(files, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArraySize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(files) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">public:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string filename, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flags, </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ushort</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> delimiter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> uint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> codepage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CP_ACP)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> expand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         files</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[n] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> new </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename, flags, delimiter, codepage);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         return</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> files</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[n].handle;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INVALID_HANDLE;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>所有FileOpener对象都添加到files数组中，以跟踪它们的生命周期。在同一个数组中，零元素标记了创建FileHolder对象的局部上下文（代码块）的注册时刻。FileHolder构造函数负责这一点。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileHolder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> expand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         files</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[n] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>如我们所知，在程序执行期间，它会进入嵌套的代码块（调用函数）。如果它们需要管理局部文件描述符，则应在那里描述FileHolder对象（每个代码块一个或更少）。根据栈的规则（先进后出），所有这些描述都添加到files数组中，然后在程序离开上下文时以相反的顺序释放。在每个这样的时刻都会调用析构函数。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   ~</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileHolder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ArraySize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(files) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">--</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">files</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 减少数组大小并退出</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            ArrayResize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(files, i);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         delete </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">files</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>它的任务是删除数组中最后一个FileOpener对象，直到遇到第一个零元素，该零元素表示上下文的边界（数组中进一步的描述符来自另一个外部上下文）。</p><p>你可以自己研究整个类。</p><p>让我们看看它在测试脚本FileHolder.mq5中的使用。除了OnStart函数外，它还有SubFunc函数。在这两个上下文中都执行文件操作。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string dummy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/dummy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SubFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__FUNCTION__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; enter&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   FileHolder holder;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> h </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(holder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dummy, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_READ));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> f </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(holder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dummy, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_READ));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 使用h和f</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 无需手动关闭文件并跟踪函数的提前退出</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__FUNCTION__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; exit&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__FUNCTION__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; enter&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   FileHolder holder;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> h </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(holder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dummy, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_READ));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 通过描述符对文件进行写入数据和其他操作</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   /*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   int a[] = {1, 2, 3};</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   FileWriteArray(h, a);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   SubFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   SubFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 模拟条件分支</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 多亏了holder，我们不需要显式调用</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // FileClose(h);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__FUNCTION__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; return&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 函数中可能有很多退出点</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   /*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     ... 更多代码</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 多亏了holder，我们不需要显式调用</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // FileClose(h);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__FUNCTION__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; exit&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>我们没有手动关闭任何句柄，FileHolder的实例将在析构函数中自动关闭它们。</p><p>以下是日志输出的一个示例：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>OnStart enter</span></span>
<span class="line"><span>holder.FileOpen(dummy,FILE_BIN|FILE_WRITE|FILE_SHARE_WRITE|FILE_SHARE_READ)=1 / ok</span></span>
<span class="line"><span>SubFunc enter</span></span>
<span class="line"><span>holder.FileOpen(dummy,FILE_BIN|FILE_WRITE|FILE_SHARE_WRITE|FILE_SHARE_READ)=2 / ok</span></span>
<span class="line"><span>holder.FileOpen(dummy,FILE_BIN|FILE_WRITE|FILE_SHARE_WRITE|FILE_SHARE_READ)=3 / ok</span></span>
<span class="line"><span>SubFunc exit</span></span>
<span class="line"><span>FileOpener::~FileOpener: Automatic close for handle: 3</span></span>
<span class="line"><span>FileOpener::~FileOpener: Automatic close for handle: 2</span></span>
<span class="line"><span>SubFunc enter</span></span>
<span class="line"><span>holder.FileOpen(dummy,FILE_BIN|FILE_WRITE|FILE_SHARE_WRITE|FILE_SHARE_READ)=2 / ok</span></span>
<span class="line"><span>holder.FileOpen(dummy,FILE_BIN|FILE_WRITE|FILE_SHARE_WRITE|FILE_SHARE_READ)=3 / ok</span></span>
<span class="line"><span>SubFunc exit</span></span>
<span class="line"><span>FileOpener::~FileOpener: Automatic close for handle: 3</span></span>
<span class="line"><span>FileOpener::~FileOpener: Automatic close for handle: 2</span></span>
<span class="line"><span>OnStart exit</span></span>
<span class="line"><span>FileOpener::~FileOpener: Automatic close for handle: 1</span></span></code></pre></div><h2 id="文本模式下的编码选择" tabindex="-1">文本模式下的编码选择 <a class="header-anchor" href="#文本模式下的编码选择" aria-label="Permalink to &quot;文本模式下的编码选择&quot;">​</a></h2><p>对于编写的文本文件，应根据文本的特点来选择编码，或者根据生成文件所针对的外部程序的要求进行调整。如果没有外部要求，对于包含数字、英文字母和标点的纯文本，可以遵循始终使用ANSI编码的规则（在“字符串比较”部分给出了128个这样的国际字符的表）。当处理各种语言或特殊字符时，使用UTF-8或Unicode，即分别为：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> u8 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;utf8.txt&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, FILE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_TXT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_ANSI, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, CP_UTF8);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> u0 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;unicode.txt&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, FILE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_TXT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_UNICODE);</span></span></code></pre></div><p>例如，这些设置对于将金融工具的名称保存到文件中很有用，因为它们有时会使用表示货币或交易模式的特殊字符。</p><p>读取自己的文件应该不是问题，因为在读取时指定与写入时相同的编码设置就足够了。然而，文本文件可能来自不同的来源。它们的编码可能未知，或者会在没有事先通知的情况下发生变化。因此，就出现了这样一个问题：如果有些文件可能以单字节字符串（ANSI）的形式提供，有些以双字节字符串（Unicode）的形式提供，还有些以UTF-8编码的形式提供，该怎么办。</p><p>可以通过程序的输入参数来选择编码。然而，这仅对一个文件有效，并且如果必须打开许多不同的文件，它们的编码可能不匹配。因此，最好指示系统动态地（逐个文件地）做出正确的模式选择。</p><p>MQL5不允许100%自动检测和应用正确的编码，但是，有一种最通用的模式可用于读取各种文本文件。为此，需要设置FileOpen函数的以下输入参数：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> h </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename, FILE_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_TXT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_ANSI, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, CP_UTF8);</span></span></code></pre></div><p>有几个因素在起作用。</p><p>首先，UTF-8编码可以透明地跳过任何ANSI编码中提到的128个字符（即它们按“一对一”的方式传输）。</p><p>其次，它在互联网协议中是最流行的编码。</p><p>第三，MQL5对双字节Unicode的文本格式有额外的内置分析功能，如果有必要，无论指定的参数如何，它都可以自动将文件操作模式切换到FILE_UNICODE。事实上，Unicode格式的文件通常前面会有一对特殊的标识符：0xFFFE，或者反过来是0xFEFF。这个序列被称为字节序标记（BOM）。之所以需要它，是因为我们知道，在不同的平台上，字节在数字内部的存储顺序可能不同（这在“整数中的字节序控制”部分讨论过）。</p><p>FILE_UNICODE格式每个字符使用一个2字节的整数（代码），所以与其他编码不同，字节顺序变得很重要。Windows的字节序BOM是0xFFFE。如果MQL5核心在文本文件的开头找到这个标记，它的读取将自动切换到Unicode模式。</p><p>让我们看看不同的模式设置如何处理不同编码的文本文件。为此，我们将使用FileText.mq5脚本以及几个内容相同但编码不同的文本文件（括号内标明了字节大小）：</p><ul><li>ansi1252.txt (50)：欧洲编码1252（在使用欧洲语言的Windows系统中，它将完整显示且不会失真）</li><li>unicode1.txt (102)：双字节Unicode，开头是固有的Windows BOM 0xFFFE</li><li>unicode2.txt (100)：没有BOM的双字节Unicode（一般来说，BOM是可选的）</li><li>unicode3.txt (102)：双字节Unicode，开头是Unix固有的BOM 0xFEFF</li><li>utf8.txt (54)：UTF-8编码</li></ul><p>在OnStart函数中，我们将使用不同设置的FileOpen在循环中读取这些文件。请注意，通过使用FileHandle（在上一节中介绍过），我们不必担心关闭文件的问题：在每次迭代中一切都会自动进行。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;=====&gt; UTF-8&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ArraySize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(texts); </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      FileHandle </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">texts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i], FILE_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_TXT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_ANSI, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, CP_UTF8));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">texts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i], </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; -&gt; &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fh));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;=====&gt; Unicode&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ArraySize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(texts); </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      FileHandle </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">texts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i], FILE_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_TXT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_UNICODE));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">texts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i], </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; -&gt; &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fh));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;=====&gt; ANSI/1252&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ArraySize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(texts); </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      FileHandle </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">texts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i], FILE_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_TXT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_ANSI, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1252</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">texts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i], </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; -&gt; &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fh));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>FileReadString函数从文件中读取一个字符串。我们将在关于读写变量的部分介绍它。</p><p>以下是脚本执行结果的示例日志：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>=====&gt; UTF-8</span></span>
<span class="line"><span>MQL5Book/ansi1252.txt -&gt; This is a text with special characters: ?? / ? / ?</span></span>
<span class="line"><span>MQL5Book/unicode1.txt -&gt; This is a text with special characters: ±Σ / £ / ¥</span></span>
<span class="line"><span>MQL5Book/unicode2.txt -&gt; T</span></span>
<span class="line"><span>MQL5Book/unicode3.txt -&gt; ??</span></span>
<span class="line"><span>MQL5Book/utf8.txt -&gt; This is a text with special characters: ±Σ / £ / ¥</span></span>
<span class="line"><span>=====&gt; Unicode</span></span>
<span class="line"><span>MQL5Book/ansi1252.txt -&gt; 桔獩椠⁳⁡整瑸眠瑩⁨灳捥慩⁬档牡捡整獲㾱⼠ꌠ⼠ꔠ</span></span>
<span class="line"><span>MQL5Book/unicode1.txt -&gt; This is a text with special characters: ±Σ / £ / ¥</span></span>
<span class="line"><span>MQL5Book/unicode2.txt -&gt; This is a text with special characters: ±Σ / £ / ¥</span></span>
<span class="line"><span>MQL5Book/unicode3.txt -&gt; 吀栀椀猀 椀猀 愀 琀攀砀琀 眀椀琀栀 猀瀀攀挀椀愀氀 挀栀愀爀愀挀琀攀爀猀㨀 넀</span></span>
<span class="line"><span>MQL5Book/utf8.txt -&gt; 桔獩椠⁳⁡整瑸眠瑩⁨灳捥慩⁬档牡捡整獲뇂ꏎ⼠술₣ ꗂ</span></span>
<span class="line"><span>=====&gt; ANSI/1252</span></span>
<span class="line"><span>MQL5Book/ansi1252.txt -&gt; This is a text with special characters: ±? / £ / ¥</span></span>
<span class="line"><span>MQL5Book/unicode1.txt -&gt; This is a text with special characters: ±Σ / £ / ¥</span></span>
<span class="line"><span>MQL5Book/unicode2.txt -&gt; T</span></span>
<span class="line"><span>MQL5Book/unicode3.txt -&gt; þÿ</span></span>
<span class="line"><span>MQL5Book/utf8.txt -&gt; This is a text with special characters: Â±Î£ / Â£ / Â¥</span></span></code></pre></div><p>unicode1.txt文件总是能被正确读取，因为它有BOM 0xFFFE，系统会忽略源代码中的设置。然而，如果缺少这个标记或者是大端字节序，这种自动检测就不起作用。此外，当设置为FILE_UNICODE时，我们就失去了读取单字节文本和UTF-8文本的能力。</p><p>因此，前面提到的FILE_ANSI和CP_UTF8的组合应该被认为对格式变化更具适应性。只有在明确需要时，才建议选择特定的国家代码页。</p><p>尽管在文本模式下使用文件时，API为程序员提供了很大的帮助，但如果有必要，我们可以避免使用FILE_TXT或FILE_CSV模式，而以二进制模式FILE_BINARY打开文本文件。这将把解析文本和确定编码的所有复杂性都交给程序员，但这将使他们能够支持其他非标准格式。但这里的重点是，可以从以二进制模式打开的文件中读取和写入文本。然而，一般情况下，反过来是不可能的。以文本模式打开的包含任意数据的二进制文件（这意味着，它不专门包含字符串）很可能会被解释为“乱码”文本。如果需要将二进制数据写入文本文件，首先要使用CryptEncode函数和CRYPT_BASE64编码。</p><h2 id="数组的读写" tabindex="-1">数组的读写 <a class="header-anchor" href="#数组的读写" aria-label="Permalink to &quot;数组的读写&quot;">​</a></h2><p>MQL5中有两个函数用于读写数组：FileWriteArray和FileReadArray。对于二进制文件，它们允许处理除字符串外的任何内置类型的数组，以及不包含字符串字段、对象、指针和动态数组的简单结构数组。这些限制与读写过程的优化有关，由于排除了具有可变长度的类型，才使得这种优化成为可能。字符串、对象和动态数组就是属于可变长度的类型。</p><p>同时，在处理文本文件时，这些函数能够处理字符串类型的数组（在FILE_TXT/FILE_CSV模式的文件中，这些函数不允许处理其他类型的数组）。这样的数组以以下格式存储在文件中：每行一个元素。</p><p>如果需要在文件中存储没有类型限制的结构或类，请使用特定类型的函数，这些函数每次调用处理一个值。在关于读写内置类型变量的两个部分中（针对二进制文件和文本文件）对它们进行了描述。</p><p>此外，通过对信息存储的内部优化，可以实现对包含字符串的结构的支持。例如，您可以使用整数字段代替字符串字段，这些整数字段将包含在一个单独的字符串数组中相应字符串的索引。考虑到使用面向对象编程（OOP）工具重新定义许多操作（特别是赋值操作）以及按数字获取数组结构元素的可能性，算法的外观实际上不会改变。但是在写入时，您可以首先以二进制模式打开文件，并对具有简化结构类型的数组调用FileWriteArray，然后以文本模式重新打开文件，并使用第二次FileWriteArray调用将所有字符串的数组添加到其中。要读取这样的文件，应该在文件开头提供一个头，其中包含数组中的元素数量，以便将其作为count参数传递给FileReadArray（请参阅后文）。</p><p>如果需要保存或读取的不是结构数组，而是单个结构，请使用下一节中描述的FileWriteStruct和FileReadStruct函数。</p><p>让我们研究一下函数签名，然后看一个通用示例（FileArray.mq5）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileWriteArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">array</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WHOLE_ARRAY)</span></span></code></pre></div><p>该函数将数组array写入具有句柄描述符的文件中。数组可以是多维的。start和count参数允许设置元素的范围；默认情况下，它等于整个数组。对于多维数组，起始索引start和元素数量count是指所有维度的连续编号，而不是数组的第一维度。例如，如果数组的配置为[][5]，那么start值等于7将指向索引为[1][2]的元素，count = 2将把索引为[1][3]的元素添加到其中。</p><p>该函数返回写入的元素数量。如果出错，返回值将为0。</p><p>如果句柄是在二进制模式下获取的，数组可以是除字符串外的任何内置类型，或者简单结构类型。如果句柄是以任何文本模式打开的，数组必须是字符串类型。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileReadArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">array</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WHOLE_ARRAY)</span></span></code></pre></div><p>该函数从具有句柄描述符的文件中读取数据到数组中。数组可以是多维的和动态的。对于多维数组，start和count参数基于上述所有维度的元素连续编号来工作。如果需要，动态数组会自动增加大小以适应正在读取的数据。如果start大于数组的原始长度，在内存分配后，这些中间元素将包含随机数据（请参阅示例）。</p><p>请注意，该函数无法控制写入文件时使用的数组配置与读取时接收数组的配置是否匹配。基本上，不能保证正在读取的文件是使用FileWriteArray写入的。</p><p>为了检查数据结构的有效性，通常会使用文件内部一些预定义格式的初始头或其他描述符。这些函数本身将读取文件大小范围内的任何内容，并将其放置在指定的数组中。</p><p>如果句柄是在二进制模式下获取的，数组可以是任何内置的非字符串类型或简单结构类型。如果句柄是以文本模式打开的，数组必须是字符串类型。</p><p>让我们使用FileArray.mq5脚本检查在二进制和文本模式下的工作情况。为此，我们将预留两个文件名。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string raw </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/array.raw&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string txt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/array.txt&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>在OnStart函数中描述了三个long类型的数组和两个string类型的数组。每种类型中只有第一个数组被填充了数据，其余所有数组将在文件写入后检查读取情况。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> numbers1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, {</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, {</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}};</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> numbers2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> numbers3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   string text1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;abc&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;def&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;3.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ghi&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   string text2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span></code></pre></div><p>此外，为了测试对结构的操作，定义了以下3种类型：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TT</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   string s1;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   string s2;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> B</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">private:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">public:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> setB</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v) { b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v; }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> XYZ : public B</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   color x, y, z;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>我们将无法在上述函数中使用TT类型的结构，因为它包含字符串字段。它用于在注释语句中演示潜在的编译错误（请参阅后文）。结构B和XYZ之间的继承关系，以及私有字段的存在，对FileWriteArray和FileReadArray函数来说都不是障碍。</p><p>这些结构用于声明一对数组：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TT tt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 为空，因为数据不重要</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   XYZ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">xyz</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">   xyz</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setB</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">   xyz</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> xyz</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].y </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> xyz</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].z </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> clrRed;</span></span></code></pre></div><p>让我们从二进制模式开始。创建一个新文件或打开一个现有文件，清空其内容。然后，通过三次调用FileWriteArray，我们将尝试写入三个数组：numbers1、text1和xyz。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> writer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(raw, FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 1 / ok</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writer, numbers1));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 6 / ok</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writer, text1));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 0 / FILE_NOTTXT(5012)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writer, xyz));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 1 / ok</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writer);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(numbers1);</span></span></code></pre></div><p>数组numbers1和xyz写入成功，写入的元素数量表明了这一点。text1数组写入失败，错误为FILE_NOTTXT(5012)，因为字符串数组要求文件以文本模式打开。因此，xyz的内容将紧跟在numbers1的所有元素之后存储在文件中。</p><p>请注意，每个写入（或读取）函数从文件内的当前位置开始写入（或读取）数据，并根据写入或读取数据的大小移动指针。如果在写入操作之前此指针位于文件末尾，则文件大小会增加。如果在读取时到达文件末尾，指针不再移动，系统会引发特殊的内部错误代码5027（FILE_ENDOFFILE）。在大小为零的新文件中，开头和结尾是相同的。</p><p>从数组text1中写入了0个元素，所以文件中没有任何内容表明在两次成功的FileWriteArray调用之间有一次失败。</p><p>在测试脚本中，我们只是将函数的结果和状态（错误代码）输出到日志中，但在实际程序中，我们应该即时分析问题并采取一些行动：修改参数、文件设置中的某些内容，或者向用户发送消息中断进程。</p><p>让我们将文件读取到numbers2数组中。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reader </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(raw, FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 1 / ok</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(reader, numbers2));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 8 / ok</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(numbers2);</span></span></code></pre></div><p>由于向文件中写入了两个不同的数组（不仅有numbers1，还有xyz），所以有8个元素被读取到接收数组中（即读取了整个文件到末尾，因为没有使用参数指定其他情况）。</p><p>实际上，结构XYZ的大小是16字节（4个字段，每个字段4字节：一个int和三个color），这对应于数组numbers2中的一行（2个long类型的元素）。在这种情况下，这只是一个巧合。如前所述，这些函数不知道原始数据的配置和大小，可以将任何内容读取到任何数组中：程序员必须监控操作的有效性。</p><p>让我们比较初始状态和接收状态。源数组numbers1：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>       [,0][,1]</span></span>
<span class="line"><span>   [0,]   1   4</span></span>
<span class="line"><span>   [1,]   2   5</span></span>
<span class="line"><span>   [2,]   3   6</span></span></code></pre></div><p>结果数组numbers2：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>                 [,0]          [,1]</span></span>
<span class="line"><span>   [0,]             1             4</span></span>
<span class="line"><span>   [1,]             2             5</span></span>
<span class="line"><span>   [2,]             3             6</span></span>
<span class="line"><span>   [3,] 1099511627775 1095216660735</span></span></code></pre></div><p>numbers2数组的开头与原始的numbers1数组完全匹配，即通过文件进行的写入和读取操作正常工作。</p><p>最后一行完全被单个结构XYZ占据（值是正确的，但表示为两个long类型的数字是不正确的）。</p><p>现在我们回到文件开头（使用FileSeek函数，我们将在“文件内的位置控制”部分中讨论它），并调用FileReadArray指定元素的数量和数量，即我们进行部分读取。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSeek</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(reader, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, SEEK_SET));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(reader, numbers3, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(reader);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(numbers3);</span></span></code></pre></div><p>从文件中读取了三个元素，并从索引10开始放置到接收数组numbers3中。由于是从文件开头读取的，这些元素是值1、4、2。并且由于二维数组的配置为[][2]，通过索引10指向元素[5,0]。这是它在内存中的样子：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>       [,0][,1]</span></span>
<span class="line"><span>   [0,]   1   4</span></span>
<span class="line"><span>   [1,]   1   4</span></span>
<span class="line"><span>   [2,]   2   6</span></span>
<span class="line"><span>   [3,]   0   0</span></span>
<span class="line"><span>   [4,]   0   0</span></span>
<span class="line"><span>   [5,]   1   4</span></span>
<span class="line"><span>   [6,]   2   0</span></span></code></pre></div><p>用黄色标记的元素是随机的（对于不同的脚本运行可能会改变）。它们可能全为零，但不能保证。numbers3数组最初为空，FileReadArray调用启动了在偏移量10处接收3个元素所需的内存分配（总共13个）。所选的块没有填充任何内容，并且仅从文件中读取了3个数字。因此，通过索引从0到9（即前5行）的元素，以及最后一个索引为13的元素，包含无效数据。</p><p>多维数组沿着第一维度进行扩展，因此增加1个数字意味着沿着更高维度添加整个配置。在这种情况下，分布涉及一系列两个数字（[][2]）。换句话说，请求的大小13向上舍入为2的倍数，即14。</p><p>最后，让我们测试这些函数如何处理字符串数组。创建一个新文件或打开一个现有文件，清空其内容。然后，通过两次调用FileWriteArray，我们将写入text1和numbers1数组。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   writer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(txt, FILE_TXT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_ANSI </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 1 / ok</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writer, text1));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 6 / ok</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writer, numbers1));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 0 / FILE_NOTBIN(5011)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writer);</span></span></code></pre></div><p>字符串数组成功保存。数字数组因错误FILE_NOTBIN(5011)而被忽略，因为它必须以二进制模式打开文件。</p><p>当尝试写入结构tt的数组时，我们得到一个冗长的编译错误消息“不允许包含对象的结构或类”。编译器实际上的意思是它不喜欢像string这样的字段（假定字符串和动态数组具有某些服务对象的内部表示）。因此，尽管文件是以文本模式打开的，并且结构中只有文本字段，但在MQL5中不支持这种组合。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 编译错误：不允许包含对象的结构或类</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileWriteArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writer, tt);</span></span></code></pre></div><p>字符串字段的存在使结构变得“复杂”，不适合在任何模式下与FileWriteArray/FileReadArray函数一起使用。</p><p>运行脚本后，您可以切换到目录MQL5/Files/MQL5Book并检查生成文件的内容。</p><p>早些时候，在“简易模式下的文件读写”部分中，我们讨论了FileSave和FileLoad函数。在测试脚本（FileSaveLoad.mq5）中，我们使用FileWriteArray和FileReadArray实现了这些函数的等效版本。但我们还没有详细查看它们。由于我们现在熟悉了这些新函数，我们可以检查源代码：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">template</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">typename T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyFileSave</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> T </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">array</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> h </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name, FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flags);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(h </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INVALID_HANDLE) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileWriteArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(h, array);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(h);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">template</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">typename T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyFileLoad</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, T </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">array</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> h </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name, FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flags);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(h </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INVALID_HANDLE) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> uint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileReadArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(h, array, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(h) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(T)));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 与标准的FileLoad相比，此版本添加了以下检查：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 如果文件大小不是结构大小的倍数，则打印警告</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ulong leftover </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(h) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileTell</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(h);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(leftover </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PrintFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Warning from </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">: Some data left unread: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         __FUNCTION__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, leftover);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      SetUserError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ushort</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)leftover);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(h);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>MyFileSave基于对FileWriteArray的单个调用，MyFileLoad基于对FileReadArray的调用，在一对FileOpen/FileClose调用之间。在这两种情况下，所有可用数据都被写入和读取。由于使用了模板，我们的函数也能够接受任意类型的数组。但是，如果推导出任何不受支持的类型（例如类）作为元参数T，则会发生编译错误，就像错误地访问内置函数时一样。</p><h2 id="结构的读写-二进制文件" tabindex="-1">结构的读写（二进制文件） <a class="header-anchor" href="#结构的读写-二进制文件" aria-label="Permalink to &quot;结构的读写（二进制文件）&quot;">​</a></h2><p>在上一节中，我们学习了如何对结构数组执行输入/输出操作。当读写操作涉及单个结构时，使用FileWriteStruct和FileReadStruct这对函数会更加方便。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileWriteStruct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数将简单数据结构的内容写入具有句柄描述符的二进制文件中。如我们所知，这样的结构只能包含内置非字符串类型的字段以及嵌套的简单结构。</p><p>该函数的主要特点是size参数。它有助于设置要写入的字节数，这使我们能够舍弃结构的某些部分（结构的尾部）。默认情况下，该参数的值为-1，这意味着保存整个结构。如果size大于结构的大小，超出的部分将被忽略，即仅写入结构本身，也就是sizeof(data)字节。</p><p>如果成功，该函数返回写入的字节数；如果出错，返回0。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileReadStruct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数从具有句柄描述符的二进制文件中读取内容到数据结构中。size参数指定要读取的字节数。如果未指定该参数或该参数超过结构的大小，则使用指定结构的确切大小。</p><p>如果成功，该函数返回读取的字节数；如果出错，返回0。</p><p>只有FileWriteStruct和FileReadStruct函数具有截断结构尾部的选项。因此，在循环中使用它们是保存和读取经过修剪的结构数组的最合适的替代方法：FileWriteArray和FileReadArray函数不具备此功能，并且逐个字段进行读写可能会更耗费资源（我们将在后续部分查看相应的函数）。</p><p>需要注意的是，为了使用此功能，您设计结构时应确保所有不应该保存的临时和中间计算字段都位于结构的末尾。</p><p>让我们看一下在脚本FileStruct.mq5中使用这两个函数的示例。</p><p>假设我们希望不时地对最新的报价进行存档，以便能够在将来检查它们的不变性，或者与其他提供商的类似时间段进行比较。基本上，这可以通过MetaTrader 5中的“符号”对话框（在“柱线”选项卡中）手动完成。但这需要额外的努力并且要遵循一定的时间表。从程序中自动完成会容易得多。此外，手动导出的报价是以CSV文本格式完成的，而我们可能需要将文件发送到外部服务器。因此，最好以紧凑的二进制形式保存它们。除此之外，假设我们对有关报价点、点差和实际交易量的信息不感兴趣（对于外汇符号，这些信息总是为空）。</p><p>在“数组中的比较、排序和搜索”部分中，我们考虑了MqlRates结构和CopyRates函数。稍后将对它们进行详细描述，而现在我们将再次使用它们作为文件操作的测试基础。</p><p>使用FileWriteStruct中的size参数，我们可以仅保存MqlRates结构的一部分，不包括最后几个字段。</p><p>在脚本的开头，我们定义宏和测试文件名。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BARLIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 要写入的柱线数量</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HEADSIZE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 我们格式的头部大小 </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string filename </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/struct.raw&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>HEADSIZE常量特别值得关注。如前所述，文件函数本身并不负责文件中数据的一致性以及读取这些数据的结构类型。程序员必须在他们的代码中提供这样的控制。因此，通常会在文件开头写入某个头部信息，借助它，首先可以确保这是所需格式的文件，其次可以在其中保存正确读取所需的元信息。</p><p>特别是，头部可能指示记录的数量。严格来说，后者并不总是必要的，因为我们可以逐渐读取文件直到结束。然而，根据头部中的计数器一次性为所有预期的记录分配内存会更有效率。</p><p>为了我们的目的，我们开发了一个简单的结构FileHeader。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FileHeader</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   uchar </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">signature</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[HEADSIZE];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileHeader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">n</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(size)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> uchar </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[HEADSIZE] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;C&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;A&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;N&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;D&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;L&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;E&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;S&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;0&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArrayCopy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(signature, s);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>它以文本签名“CANDLES”（在signature字段中）、版本号“1.0”（在相同位置）以及记录数量（n字段）开头。由于我们不能对签名使用字符串字段（否则该结构将不再是简单结构，无法满足文件函数的要求），实际上文本被打包到固定大小为HEADSIZE的uchar数组中。实例中的初始化由构造函数基于局部静态副本完成。</p><p>在OnStart函数中，我们请求最后BARLIMIT个柱线的数据，以FILE_WRITE模式打开文件，并将头部信息以及经过截断形式的结果报价写入文件。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   MqlRates rates</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, candles</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CopyRates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Symbol, _Period, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, BARLIMIT, rates));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 10 / ok</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 创建一个新文件或从头覆盖旧文件</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename, FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 1 / ok</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileHeaderfh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(n);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 包含实际记录数量的头部</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 首先写入头部</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteStruct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, fh));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 14 / ok</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 然后写入数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      FileWriteStruct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i], </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">offsetof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(MqlRates, tick_volume));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rates);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span></code></pre></div><p>作为FileWriteStruct函数中size参数的值，我们使用了一个带有熟悉的offsetof操作符的表达式：offsetof(MqlRates, tick_volume)，即写入文件时，从tick_volume字段开始的所有字段都将被舍弃。</p><p>为了测试数据读取，让我们以FILE_READ模式打开同一个文件并读取FileHeader结构。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename, FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 1 / ok</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   FileHeader reference, reader;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadStruct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, reader));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 14 / ok</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 如果头部不匹配，则不是我们的数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArrayCompare</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(reader.signature, reference.signature))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Wrong file format; &#39;CANDLES&#39; header is missing&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>reference结构包含未更改的默认头部（签名）。reader结构从文件中获取了14字节。如果两个签名匹配，我们可以继续处理，因为文件格式正确，并且reader.n字段包含从文件中读取的记录数量。我们为接收数组candles分配并清零所需大小的内存，然后将所有记录读取到其中。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PrintFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Reading </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> candles...&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, reader.n);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ArrayResize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(candles, reader.n);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 提前为预期数据分配内存</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ZeroMemory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(candles);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reader.n; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      FileReadStruct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">candles</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i], </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">offsetof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(MqlRates, tick_volume));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(candles);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>清零操作是必要的，因为MqlRates结构是部分读取的，如果不清零，剩余的字段将包含无效数据。</p><p>以下是显示XAUUSD,H1初始数据（完整）的日志。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>                 [time]  [open]  [high]   [low] [close] [tick_volume] [spread] [real_volume]</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[0] 2021.08.16 03:00:00 1778.86 1780.58 1778.12 1780.56          3049        5             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[1] 2021.08.16 04:00:00 1780.61 1782.58 1777.10 1777.13          4633        5             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[2] 2021.08.16 05:00:00 1777.13 1780.25 1776.99 1779.21          3592        5             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[3] 2021.08.16 06:00:00 1779.26 1779.26 1776.67 1776.79          2535        5             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[4] 2021.08.16 07:00:00 1776.79 1777.59 1775.50 1777.05          2052        6             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[5] 2021.08.16 08:00:00 1777.03 1777.19 1772.93 1774.35          3213        5             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[6] 2021.08.16 09:00:00 1774.38 1775.41 1771.84 1773.33          4527        5             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[7] 2021.08.16 10:00:00 1773.26 1777.42 1772.84 1774.57          4514        5             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[8] 2021.08.16 11:00:00 1774.61 1776.67 1773.69 1775.95          3500        5             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[9] 2021.08.16 12:00:00 1775.96 1776.12 1773.68 1774.44          2425        5             0</span></span></code></pre></div><p>现在让我们看看读取到了什么。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>                 [time]  [open]  [high]   [low] [close] [tick_volume] [spread] [real_volume]</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[0] 2021.08.16 03:00:00 1778.86 1780.58 1778.12 1780.56             0        0             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[1] 2021.08.16 04:00:00 1780.61 1782.58 1777.10 1777.13             0        0             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[2] 2021.08.16 05:00:00 1777.13 1780.25 1776.99 1779.21             0        0             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[3] 2021.08.16 06:00:00 1779.26 1779.26 1776.67 1776.79             0        0             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[4] 2021.08.16 07:00:00 1776.79 1777.59 1775.50 1777.05             0        0             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[5] 2021.08.16 08:00:00 1777.03 1777.19 1772.93 1774.35             0        0             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[6] 2021.08.16 09:00:00 1774.38 1775.41 1771.84 1773.33             0        0             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[7] 2021.08.16 10:00:00 1773.26 1777.42 1772.84 1774.57             0        0             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[8] 2021.08.16 11:00:00 1774.61 1776.67 1773.69 1775.95             0        0             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[9] 2021.08.16 12:00:00 1775.96 1776.12 1773.68 1774.44             0        0             0</span></span></code></pre></div><p>报价数据匹配，但每个结构中的最后三个字段为空。</p><p>您可以打开MQL5/Files/MQL5Book文件夹并检查struct.raw文件的内部表示（使用支持二进制模式的查看器；示例如下）。</p><h2 id="在外部查看器中呈现带有报价存档的二进制文件的选项" tabindex="-1">在外部查看器中呈现带有报价存档的二进制文件的选项 <a class="header-anchor" href="#在外部查看器中呈现带有报价存档的二进制文件的选项" aria-label="Permalink to &quot;在外部查看器中呈现带有报价存档的二进制文件的选项&quot;">​</a></h2><p>在外部查看器中呈现带有报价存档的二进制文件的选项</p><p>这是显示二进制文件的典型方式：左列显示地址（相对于文件开头的偏移量），中间列是字节码，右列显示相应字节的符号表示。第一列和第二列使用十六进制表示数字。右列中的字符可能会因所选的ANSI代码页而异。只有在已知存在文本的片段中才值得关注它们。在我们的例子中，签名“CANDLES1.0”在开头清晰可见。应该通过中间列分析数字。例如，在签名之后，您可以看到4字节的值0x0A000000，即倒置形式的0x0000000A（记得“整数中的字节序控制”部分）：这是10，即写入的结构数量。</p><h2 id="变量的读写-二进制" tabindex="-1">变量的读写（二进制） <a class="header-anchor" href="#变量的读写-二进制" aria-label="Permalink to &quot;变量的读写（二进制）&quot;">​</a></h2><p>如果一个结构体包含的字段类型对于简单结构体来说是不允许的（如字符串、动态数组、指针），那么就无法使用之前讨论过的函数将其写入文件或从文件中读取。类对象的情况也是如此。然而，这类实体通常包含程序中的大部分数据，并且也需要保存和恢复它们的状态。</p><p>通过上一节中头部结构体的示例可以清楚地看到，字符串（以及其他可变长度类型）是可以避免使用的，但在这种情况下，就必须设计出更繁琐的替代算法实现方式（例如，用字符数组来代替字符串）。</p><p>为了读写任意复杂程度的数据，MQL5提供了一组较低级别的函数，这些函数操作特定类型的单个值：双精度浮点数（double）、单精度浮点数（float）、整型/无符号整型（int/uint）、长整型/无符号长整型（long/ulong）或字符串（string）。所有其他内置的MQL5类型都等同于不同大小的整数：字符型/无符号字符型（char/uchar）为1字节，短整型/无符号短整型（short/ushort）为2字节，颜色（color）为4字节，枚举（enumerations）为4字节，日期时间（datetime）为8字节。这样的函数可以称为原子函数（即不可分割的），因为在比特级别进行文件读写的函数已经不存在了。</p><p>当然，逐个元素地写入或读取也消除了对动态数组进行文件操作的限制。</p><p>至于对象指针，按照面向对象编程（OOP）范式的思想，我们可以允许它们保存和恢复对象：只需在每个类中实现一个接口（一组方法），该接口负责将重要内容传输到文件中以及从文件中读取回来，并使用低级函数即可。然后，如果在对象中遇到指向另一个对象的指针字段，我们只需将保存或读取操作委托给它，反过来，它将处理自身的字段，其中可能还存在其他指针，并且这种委托会不断深入，直到涵盖所有元素。</p><p>请注意，在本节中我们将介绍用于二进制文件的原子函数。它们对应于文本文件的函数将在下一节中介绍。本节中的所有函数都返回写入的字节数，如果出错则返回0。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileWriteDouble</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileWriteFloat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">float</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileWriteLong</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>这些函数将参数<code>value</code>中传入的相应类型（双精度浮点数、单精度浮点数、长整型）的值写入具有句柄描述符的二进制文件中。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileWriteInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INT_VALUE)</span></span></code></pre></div><p>该函数将整数值写入具有句柄描述符的二进制文件中。值的字节大小由<code>size</code>参数设置，可以是以下预定义常量之一：<code>CHAR_VALUE</code>（1）、<code>SHORT_VALUE</code>（2）、<code>INT_VALUE</code>（4，默认值），分别对应于<code>char</code>、<code>short</code>和<code>int</code>（有符号和无符号）类型。</p><p>该函数支持一种未记录的3字节整数写入模式。不建议使用这种模式。</p><p>文件指针会移动写入的字节数（而不是<code>int</code>类型的大小）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileWriteString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> length </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数将<code>value</code>参数中的字符串写入具有句柄描述符的二进制文件中。可以通过<code>length</code>参数指定要写入的字符数。如果<code>length</code>小于字符串的长度，则只有字符串的指定部分会被写入文件。如果<code>length</code>为-1或未指定，则整个字符串会被写入文件，且不包含终止空字符。如果<code>length</code>大于字符串的长度，则多余的字符会用零填充。</p><p>请注意，当写入以<code>FILE_UNICODE</code>标志打开的文件（或未使用<code>FILE_ANSI</code>标志打开的文件）时，字符串会以Unicode格式保存（每个字符占用2字节）。当写入以<code>FILE_ANSI</code>标志打开的文件时，每个字符占用1字节（外语字符可能会失真）。</p><p><code>FileWriteString</code>函数也可以用于文本文件。其在这方面的应用将在下一节中介绍。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileReadDouble</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">float</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileReadFloat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileReadLong</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>这些函数从具有指定描述符的二进制文件中读取相应类型（双精度浮点数、单精度浮点数或长整型）的数字。如果需要，会将结果转换为<code>ulong</code>（如果在文件的该位置预期是一个无符号长整型）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileReadInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INT_VALUE)</span></span></code></pre></div><p>该函数从具有句柄描述符的二进制文件中读取整数值。值的字节大小在<code>size</code>参数中指定。</p><p>由于该函数的结果是<code>int</code>类型，如果目标类型与<code>int</code>不同（即<code>uint</code>、<code>short/ushort</code>或<code>char/uchar</code>），则必须显式地将其转换为所需的目标类型。否则，至少会得到一个编译器警告，最严重的情况下可能会导致符号丢失。</p><p>实际上，当读取<code>CHAR_VALUE</code>或<code>SHORT_VALUE</code>时，默认结果总是正数（即对应于<code>uchar</code>和<code>ushort</code>，它们完全可以“容纳”在<code>int</code>中）。在这些情况下，如果数字实际上是<code>uchar</code>和<code>ushort</code>类型，编译器警告只是名义上的，因为我们已经确定在<code>int</code>类型的值内部只有1或2个低字节被填充，并且它们是无符号的。这样不会产生失真。</p><p>然而，当在文件中存储有符号值（<code>char</code>和<code>short</code>类型）时，转换就变得必要了，因为如果不进行转换，负数将变成具有相同位表示的反相正数（请参阅算术类型转换部分中的“有符号和无符号整数”部分）。</p><p>无论如何，最好通过显式类型转换来避免警告。</p><p>该函数支持3字节整数读取模式。不建议使用这种模式。</p><p>文件指针会移动读取的字节数（而不是<code>size</code>所表示的<code>int</code>大小）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数从具有句柄描述符的文件中读取指定字符数大小的字符串。在处理二进制文件时必须设置<code>size</code>参数（默认值仅适用于使用分隔字符的文本文件）。否则，不会读取字符串（函数返回空字符串），并且内部错误代码<code>_LastError</code>为5016（<code>FILE_BINSTRINGSIZE</code>）。</p><p>因此，即使在将字符串写入二进制文件的阶段，也需要考虑如何读取该字符串。主要有三种选择：</p><ol><li>写入末尾带有空终止字符的字符串。在这种情况下，必须在循环中逐个字符地分析，并将字符组合成字符串，直到遇到0为止。</li><li>始终写入固定（预定义）长度的字符串。长度应该在大多数情况下留有一定余量，或者根据规范（需求说明、协议等）来选择，但这样不经济，并且不能100%保证某些罕见的字符串在写入文件时不会被截断。</li><li>在字符串之前写入长度作为整数。</li></ol><p><code>FileReadString</code>函数也可以用于文本文件。其在这方面的应用将在下一节中介绍。</p><p>还请注意，如果<code>size</code>参数为0（在某些计算过程中可能会出现这种情况），则函数不会进行读取：文件指针保持在原来的位置，函数返回一个空字符串。</p><p>作为本节的一个示例，我们将改进上一节中的<code>FileStruct.mq5</code>脚本。新的程序名称为<code>FileAtomic.mq5</code>。</p><p>任务仍然是：将给定数量的带有报价的截断<code>MqlRates</code>结构体保存到一个二进制文件中。但现在<code>FileHeader</code>结构体将变成一个类（并且格式签名将存储在一个字符串中，而不是字符数组中）。这种类型的头部和一个报价数组将是另一个控制类<code>Candles</code>的一部分，并且这两个类都将从<code>Persistent</code>接口继承，以便将任意对象写入文件和从文件中读取。</p><p>以下是接口：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">interface Persistent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> handle);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> handle);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>在<code>FileHeader</code>类中，我们将实现格式签名（将其更改为“CANDLES/1.1”）以及当前符号名称和图表时间框架名称（关于<code>_Symbol</code>和<code>_Period</code>的更多信息）的保存和检查。</p><p>写入操作在从接口继承的<code>write</code>方法中实现。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class FileHeader : public Persistent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string signature;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">public:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileHeader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">signature</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;CANDLES/1.1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) { }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> handle) override</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, signature, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringLen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(signature)));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringLen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Symbol), CHAR_VALUE));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, _Symbol));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PeriodToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>签名会按照其确切长度写入，因为样本存储在对象中，并且在读取时也会设置相同的长度。</p><p>对于当前图表的交易品种，我们首先将其名称长度保存到文件中（对于长度不超过255的名称，1字节就足够了），然后才保存字符串本身。</p><p>时间框架名称如果不包括常量前缀“PERIOD_”，则永远不会超过3个字符，因此为该字符串选择了固定长度。去除前缀后的时间框架名称是在辅助函数<code>PeriodToString</code>中获得的：它在一个单独的头文件<code>Periods.mqh</code>中（在“符号和时间框架”部分将更详细地讨论）。</p><p>读取操作在<code>read</code>方法中以相反的顺序执行（当然，假设读取将在一个不同的新对象中进行）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) override</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string sig </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringLen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(signature)));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sig </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> signature)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         PrintFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Wrong file format, header is missing: want=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vs got </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            signature, sig);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> len </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, CHAR_VALUE));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string sym </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, len));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Symbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sym)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         PrintFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Wrong symbol: file=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vs chart=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, sym, _Symbol);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string stf </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Period </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StringToPeriod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(stf))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         PrintFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Wrong timeframe: file=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">) vs chart=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            stf, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">EnumToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringToPeriod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(stf)), </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">EnumToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Period));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>如果文件中的任何属性（签名、符号、时间框架）与当前图表上的不匹配，函数将返回<code>false</code>以指示错误。</p><p>将时间框架名称反向转换为<code>ENUM_TIMEFRAMES</code>枚举的操作是由函数<code>StringToPeriod</code>完成的，该函数也在文件<code>Periods.mqh</code>中。</p><p>用于请求、保存和读取报价存档的主要<code>Candles</code>类如下：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">class Candles : public Persistent</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   FileHeader header;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> limit;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   MqlRates rates</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">public:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Candles</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">limit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(size)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CopyRates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Symbol, _Period, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, limit, rates));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> limit </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 初始化失败</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> limit </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">n;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 可能小于请求的数量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>这些字段包括<code>FileHeader</code>类型的头部、请求的柱线数量<code>limit</code>，以及一个从MetaTrader 5接收<code>MqlRates</code>结构体的数组。数组在构造函数中填充。如果发生错误，<code>limit</code>字段将重置为零。</p><p>由于<code>Candles</code>类派生自<code>Persistent</code>接口，因此需要实现<code>write</code>和<code>read</code>方法。在<code>write</code>方法中，我们首先指示头部对象保存自身，然后将报价数量、日期范围（供参考）以及数组本身追加到文件中。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) override</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">limit) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 没有数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">header.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, limit));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteLong</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].time));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteLong</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[limit </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].time));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> limit; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         FileWriteStruct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i], </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">offsetof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(MqlRates, tick_volume));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>读取操作以相反的顺序进行：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) override</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">header.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      limit </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArrayResize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rates, limit);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ZeroMemory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rates);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 需要读取日期：它们不被使用，但这会移动文件中的位置；</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 本可以显式地更改位置，但这个函数还没有学习过</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      datetime dt0 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (datetime)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadLong</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      datetime dt1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (datetime)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadLong</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> limit; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         FileReadStruct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i], </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">offsetof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(MqlRates, tick_volume));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>在一个用于存档报价的实际程序中，日期范围的存在将允许通过文件头部在较长的历史记录中构建它们的正确顺序，并且在一定程度上可以防止文件被随意重命名。</p><p>有一个简单的打印方法来控制这个过程：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rates);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>在脚本的主函数中，我们创建两个<code>Candles</code>对象，并且使用其中一个对象，首先保存报价存档，然后使用另一个对象将其恢复。文件由我们已经知道的包装器<code>FileHandle</code>管理（请参阅“文件描述符管理”部分）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string filename </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/atomic.raw&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 创建一个新文件并覆盖旧文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   FileHandle </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_ANSI </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_READ)));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 生成数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   Candles </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">output</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(BARLIMIT);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 将数据写入文件</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">output.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">handle))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Can&#39;t write file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   output.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 打开新创建的文件进行检查</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_ANSI </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_WRITE));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 创建一个空对象来接收报价</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   Candles inputs;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 从文件中读取数据到对象中</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">inputs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">handle))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Can&#39;t read file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      inputs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>以下是XAUUSD，H1的初始数据日志示例：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>FileOpen(filename,FILE_BIN|FILE_WRITE|FILE_ANSI|FILE_SHARE_READ)=1 / 成功</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CopyRates(_Symbol,_Period,0,limit,rates)=10 / 成功</span></span>
<span class="line"><span></span></span>
<span class="line"><span>FileWriteString(handle,signature,StringLen(signature))=11 / 成功</span></span>
<span class="line"><span></span></span>
<span class="line"><span>FileWriteInteger(handle,StringLen(_Symbol),CHAR_VALUE)=1 / 成功</span></span>
<span class="line"><span></span></span>
<span class="line"><span>FileWriteString(handle,_Symbol)=6 / 成功</span></span>
<span class="line"><span></span></span>
<span class="line"><span>FileWriteString(handle,PeriodToString(),3)=3 / 成功</span></span>
<span class="line"><span></span></span>
<span class="line"><span>FileWriteInteger(handle,limit)=4 / 成功</span></span>
<span class="line"><span></span></span>
<span class="line"><span>FileWriteLong(handle,rates[0].time)=8 / 成功</span></span>
<span class="line"><span></span></span>
<span class="line"><span>FileWriteLong(handle,rates[limit-1].time)=8 / 成功</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                 [time]  [open]  [high]   [low] [close] [tick_volume] [spread] [real_volume]</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[0] 2021.08.17 15:00:00 1791.40 1794.57 1788.04 1789.46          8157        5             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[1] 2021.08.17 16:00:00 1789.46 1792.99 1786.69 1789.69          9285        5             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[2] 2021.08.17 17:00:00 1789.76 1790.45 1780.95 1783.30          8165        5             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[3] 2021.08.17 18:00:00 1783.30 1783.98 1780.53 1782.73          5114        5             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[4] 2021.08.17 19:00:00 1782.69 1784.16 1782.09 1782.49          3586        6             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[5] 2021.08.17 20:00:00 1782.49 1786.23 1782.17 1784.23          3515        5             0</span></span>
<span class="line"><span>[6] 2021.08.17 20:00:00 1782.49 1786.23 1782.17 1784.23          3515        5             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[7] 2021.08.17 21:00:00 1784.20 1784.85 1782.73 1783.12          2627        6             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[8] 2021.08.17 22:00:00 1783.10 1785.52 1782.37 1785.16          2114        5             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[9] 2021.08.17 23:00:00 1785.11 1785.84 1784.71 1785.80           922        5             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[10] 2021.08.18 01:00:00 1786.30 1786.34 1786.18 1786.20            13        5             0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>以下是恢复数据的示例（回想一下，根据我们假设的技术任务，这些结构体是以截断形式保存的）：</span></span></code></pre></div><p>FileOpen(filename,FILE_BIN|FILE_READ|FILE_ANSI|FILE_SHARE_READ|FILE_SHARE_WRITE)=2 / 成功</p><p>FileReadString(handle,StringLen(signature))=CANDLES/1.1 / 成功</p><p>FileReadInteger(handle,CHAR_VALUE)=6 / 成功</p><p>FileReadString(handle,len)=XAUUSD / 成功</p><p>FileReadString(handle,3)=H1 / 成功</p><p>FileReadInteger(handle)=10 / 成功</p><p>FileReadLong(handle)=1629212400 / 成功</p><p>FileReadLong(handle)=1629248400 / 成功</p><pre><code>             [time]  [open]  [high]   [low] [close] [tick_volume] [spread] [real_volume]
</code></pre><p>[0] 2021.08.17 15:00:00 1791.40 1794.57 1788.04 1789.46 0 0 0</p><p>[1] 2021.08.17 16:00:00 1789.46 1792.99 1786.69 1789.69 0 0 0</p><p>[2] 2021.08.17 17:00:00 1789.76 1790.45 1780.95 1783.30 0 0 0</p><p>[3] 2021.08.17 18:00:00 1783.30 1783.98 1780.53 1782.73 0 0 0</p><p>[4] 2021.08.17 19:00:00 1782.69 1784.16 1782.09 1782.49 0 0 0</p><p>[5] 2021.08.17 20:00:00 1782.49 1786.23 1782.17 1784.23 0 0 0</p><p>[6] 2021.08.17 21:00:00 1784.20 1784.85 1782.73 1783.12 0 0 0</p><p>[7] 2021.08.17 22:00:00 1783.10 1785.52 1782.37 1785.16 0 0 0</p><p>[8] 2021.08.17 23:00:00 1785.11 1785.84 1784.71 1785.80 0 0 0</p><p>[9] 2021.08.18 01:00:00 1786.30 1786.34 1786.18 1786.20 0 0 0</p><p>很容易确认数据被正确地存储和读取了。现在让我们看看文件内部的数据是什么样的：</p><h4 id="使用外部程序查看包含报价存档的二进制文件的内部结构" tabindex="-1">使用外部程序查看包含报价存档的二进制文件的内部结构 <a class="header-anchor" href="#使用外部程序查看包含报价存档的二进制文件的内部结构" aria-label="Permalink to &quot;使用外部程序查看包含报价存档的二进制文件的内部结构&quot;">​</a></h4><p>使用外部程序查看包含报价存档的二进制文件的内部结构</p><p>在这里，我们头部的各种字段用颜色进行了标记：签名、符号名称长度、符号名称、时间框架名称等等。</p><h2 id="变量的读写-文本文件" tabindex="-1">变量的读写（文本文件） <a class="header-anchor" href="#变量的读写-文本文件" aria-label="Permalink to &quot;变量的读写（文本文件）&quot;">​</a></h2><p>文本文件有其自己的一组用于原子（逐个元素）保存和读取数据的函数。这与上一节中介绍的二进制文件的函数略有不同。还应该注意的是，没有用于将结构体或结构体数组写入文本文件或从文本文件中读取的类似函数。如果你尝试对文本文件使用这些函数中的任何一个，它们将不会产生任何效果，并且会引发内部错误代码5011（FILE_NOTBIN）。</p><p>我们已经知道，MQL5中的文本文件有两种形式：纯文本和CSV格式的文本。在打开文件时设置相应的模式，即FILE_TXT或FILE_CSV，并且在不关闭并重新获取句柄的情况下无法更改该模式。它们之间的差异仅在读取文件时才会显现。两种模式的写入方式是相同的。</p><p>在TXT模式下，每次调用读取函数（我们将在本节中介绍的任何一个函数）都会在文件中找到下一个换行符（一个‘\n’字符或一对‘\r\n’），并处理直到该换行符之前的所有内容。处理的重点是将文件中的文本转换为与调用函数相对应的特定类型的值。在最简单的情况下，如果调用了FileReadString函数，则不会执行任何处理（字符串将按原样返回）。</p><p>在CSV模式下，每次调用读取函数时，文件中的文本在逻辑上不仅会按换行符进行分割，还会按打开文件时指定的附加分隔符进行分割。从文件当前位置到最近分隔符的片段的其余处理过程是类似的。</p><p>换句话说，读取文本并在文件内移动内部位置是按从一个分隔符到下一个分隔符的片段进行的，这里的分隔符不仅指FileOpen参数列表中的分隔符字符，还包括换行符（‘\n’，‘\r\n’）以及文件的开头和结尾。</p><p>附加分隔符对向FILE_TXT和FILE_CSV文件写入文本具有相同的影响，但仅在使用FileWrite函数时才会体现：它会自动在记录的元素之间插入该字符。FileWriteString函数的分隔符将被忽略。</p><p>让我们先查看这些函数的正式描述，然后看一下FileTxtCsv.mq5中的示例。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileWrite</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,...)</span></span></code></pre></div><p>该函数属于接受可变数量参数的函数类别。在函数原型中，此类参数用省略号表示。仅支持内置数据类型。要写入结构体或类对象，必须解引用它们的元素并单独传递。</p><p>该函数将第一个参数之后传递的所有参数写入具有句柄描述符的文本文件中。参数之间用逗号分隔，就像在普通参数列表中一样。输出到文件的参数数量不能超过63个。</p><p>在输出时，数值数据将根据转换为（string）的标准规则转换为文本格式。double类型的值将以16位有效数字输出，采用传统格式或科学指数格式（选择更紧凑的选项）。float类型的数据将以7位有效数字的精度显示。要以不同的精度或以显式指定的格式显示实数，请使用DoubleToString函数（请参阅“数字转换为字符串及反之”）。</p><p>datetime类型的值将以“YYYY.MM.DD hh:mm:ss”格式输出（请参阅“日期和时间”）。</p><p>标准颜色（来自网页颜色列表）将显示为名称，非标准颜色将显示为RGB分量值的三元组（请参阅“颜色”），并用逗号分隔（注意：逗号是CSV中最常见的分隔符字符）。</p><p>对于枚举类型，将显示表示元素的整数，而不是其标识符（名称）。例如，当写入FRIDAY（来自ENUM_DAY_OF_WEEK，请参阅“枚举”）时，我们在文件中得到的数字是5。</p><p>bool类型的值将以字符串“true”或“false”输出。</p><p>如果在打开文件时指定了非0的分隔符字符，则该字符将插入到由相应参数转换得到的两个相邻行之间。</p><p>一旦所有参数都写入文件，将添加一个行终止符‘\r\n’。</p><p>该函数返回写入的字节数，如果出错则返回0。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileWriteString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> length </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数将文本字符串参数写入具有句柄描述符的文本文件中。length参数仅适用于二进制文件，在此上下文中将被忽略（整行将被完整写入）。</p><p>FileWriteString函数也可以用于二进制文件。该函数在这方面的应用已在上一节中介绍。</p><p>任何分隔符（行中元素之间的分隔符）和换行符都必须由程序员插入/添加。</p><p>该函数返回写入的字节数（在FILE_UNICODE模式下，这将是字符串字符长度的2倍），如果出错则返回0。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> length </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数从具有句柄描述符的文件中读取直到下一个分隔符的字符串（CSV文件中的分隔符字符、任何文件中的换行符，或者直到文件结束）。length参数仅适用于二进制文件，在此上下文中将被忽略。</p><p>得到的字符串可以使用标准的类型转换规则或使用转换函数转换为所需类型的值。或者，也可以使用专门的读取函数：下面将介绍FileReadBool、FileReadDatetime、FileReadNumber。</p><p>如果出错，将返回一个空字符串。可以通过变量_LastError或函数GetLastError找到错误代码。特别是，当到达文件末尾时，错误代码将是5027（FILE_ENDOFFILE）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileReadBool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数读取CSV文件中直到下一个分隔符的片段，或者直到行尾，并将其转换为bool类型的值。如果片段包含文本“true”（任何大小写形式，包括混合大小写，例如“True”），或者一个非零数字，则返回true。在其他情况下，返回false。</p><p>单词“true”必须占据整个读取的元素。即使字符串以“true”开头，但有后续内容（例如“True Volume”），也将返回false。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">datetime </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadDatetime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数从CSV文件中读取以下格式之一的字符串：“YYYY.MM.DD hh:mm:ss”、“YYYY.MM.DD”或“hh:mm:ss”，并将其转换为datetime类型的值。如果片段不包含有效的日期和/或时间的文本表示形式，该函数将返回零或“奇怪”的时间，具体取决于它可以将哪些字符解释为日期和时间片段。对于空字符串或非数字字符串，将得到当前日期且时间为零。</p><p>通过组合两个函数StringToTime(FileReadString(handle))，可以实现更灵活的日期和时间读取（支持更多格式）。有关StringToTime的更多详细信息，请参阅“日期和时间”。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileReadNumber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数从CSV文件中读取直到下一个分隔符或直到行尾的片段，并根据标准类型转换规则将其转换为double类型的值。</p><p>请注意，double类型可能会丢失非常大的值的精度，这可能会影响long/ulong类型的大数字的读取（double内部整数失真的值是9007199254740992：在“联合类型”部分给出了这种现象的一个示例）。</p><p>上一节中讨论的函数，包括FileReadDouble、FileReadFloat、FileReadInteger、FileReadLong和FileReadStruct，不能应用于文本文件。</p><p>FileTxtCsv.mq5脚本演示了如何处理文本文件。上次我们将报价上传到了二进制文件中。现在让我们以TXT和CSV格式来做这件事。</p><p>基本上，MetaTrader 5允许从“符号”对话框中以CSV格式导出和导入报价。但出于教学目的，我们将重现这个过程。此外，软件实现允许偏离默认生成的确切格式。下面显示了以标准方式导出的XAUUSD H1历史数据的一个片段。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>&lt;DATE&gt; » &lt;TIME&gt; » &lt;OPEN&gt; » &lt;HIGH&gt; » &lt;LOW&gt; » &lt;CLOSE&gt; » &lt;TICKVOL&gt; » &lt;VOL&gt; » &lt;SPREAD&gt;</span></span>
<span class="line"><span>2021.01.04 » 01:00:00 » 1909.07 » 1914.93 » 1907.72 » 1913.10 » 4230 » 0 » 5</span></span>
<span class="line"><span>2021.01.04 » 02:00:00 » 1913.04 » 1913.64 » 1909.90 » 1913.41 » 2694 » 0 » 5</span></span>
<span class="line"><span>2021.01.04 » 03:00:00 » 1913.41 » 1918.71 » 1912.16 » 1916.61 » 6520 » 0 » 5</span></span>
<span class="line"><span>2021.01.04 » 04:00:00 » 1916.60 » 1921.89 » 1915.49 » 1921.79 » 3944 » 0 » 5</span></span>
<span class="line"><span>2021.01.04 » 05:00:00 » 1921.79 » 1925.26 » 1920.82 » 1923.19 » 3293 » 0 » 5</span></span>
<span class="line"><span>2021.01.04 » 06:00:00 » 1923.20 » 1923.71 » 1920.24 » 1922.67 » 2146 » 0 » 5</span></span>
<span class="line"><span>2021.01.04 » 07:00:00 » 1922.66 » 1922.99 » 1918.93 » 1921.66 » 3141 » 0 » 5</span></span>
<span class="line"><span>2021.01.04 » 08:00:00 » 1921.66 » 1925.60 » 1921.47 » 1922.99 » 3752 » 0 » 5</span></span>
<span class="line"><span>2021.01.04 » 09:00:00 » 1922.99 » 1925.54 » 1922.47 » 1924.80 » 2895 » 0 » 5</span></span>
<span class="line"><span>2021.01.04 » 10:00:00 » 1924.85 » 1935.16 » 1924.59 » 1932.07 » 6132 » 0 » 5</span></span></code></pre></div><p>特别是在这里，我们可能对默认的分隔符字符（制表符，表示为‘&quot;’）、列的顺序，或者日期和时间被分成两个字段的情况不满意。</p><p>在我们的脚本中，我们将选择逗号作为分隔符，并且我们将按照MqlRates结构体的字段顺序生成列。将在FILE_TXT和FILE_CSV模式下进行导出和后续的测试读取。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string txtfile </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/atomic.txt&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string csvfile </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/atomic.csv&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> short</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> delimiter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;,&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>在OnStart函数的开头，将以标准方式请求报价：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   MqlRates rates</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CopyRates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Symbol, _Period, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, rates));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 10</span></span></code></pre></div><p>我们将分别在数组中指定列的名称，并且还将使用辅助函数StringCombine将它们组合起来。需要单独的标题，因为我们使用可选择的分隔符字符将它们组合成一个通用标题（另一种解决方案可以基于StringReplace）。我们鼓励你独立研究StringCombine的源代码：它执行与内置的StringSplit相反的操作。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string columns</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;DateTime&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Open&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;High&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Low&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Close&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                             &quot;Ticks&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Spread&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;True&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string caption </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StringCombine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(columns, delimiter) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\r\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>最后一列本应命名为“Volume”，但我们将使用它的示例来检查FileReadBool函数的性能。你可以假设当前名称意味着“True Volume”（但这样的字符串不会被解释为true）。</p><p>接下来，让我们以FILE_TXT和FILE_CSV模式打开两个文件，并将准备好的标题写入其中。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fh1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(txtfile, FILE_TXT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_ANSI </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE, delimiter));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fh2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(csvfile, FILE_CSV </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_ANSI </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE, delimiter));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fh1, caption));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 48</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fh2, caption));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 48</span></span></code></pre></div><p>由于FileWriteString函数不会自动添加换行符，我们在caption变量中添加了‘\r\n’。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      FileWrite</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fh1, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].time, </span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].open, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].high, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].low, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].close, </span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].tick_volume, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].spread, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].real_volume);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      FileWrite</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fh2, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].time, </span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].open, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].high, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].low, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].close, </span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].tick_volume, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].spread, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].real_volume);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fh1);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fh2);</span></span></code></pre></div><p>从rates数组中写入结构体字段的方式相同，即通过在循环中为两个文件分别调用FileWrite函数来实现。回想一下，FileWrite函数会自动在参数之间插入分隔符字符，并在字符串末尾添加‘\r\n’。当然，也可以将所有输出值独立转换为字符串，并使用FileWriteString将它们发送到文件中，但那样我们就必须自己处理分隔符和换行符。在某些情况下，它们是不需要的，例如，如果你以紧凑形式（基本上在一整行中）写入JSON格式的数据。</p><p>因此，在写入阶段，两个文件的处理方式相同，并且内容也相同。以下是XAUUSD，H1的文件内容示例（你的结果可能会有所不同）：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>DateTime,Open,High,Low,Close,Ticks,Spread,True</span></span>
<span class="line"><span>2021.08.19 12:00:00,1785.3,1789.76,1784.75,1789.06,4831,5,0</span></span>
<span class="line"><span>2021.08.19 13:00:00,1789.06,1790.02,1787.61,1789.06,3393,5,0</span></span>
<span class="line"><span>2021.08.19 14:00:00,1789.08,1789.95,1786.78,1786.89,3536,5,0</span></span>
<span class="line"><span>2021.08.19 15:00:00,1786.78,1789.86,1783.73,1788.82,6840,5,0</span></span>
<span class="line"><span>2021.08.19 16:00:00,1788.82,1792.44,1782.04,1784.02,9514,5,0</span></span>
<span class="line"><span>2021.08.19 17:00:00,1784.04,1784.27,1777.14,1780.57,8526,5,0</span></span>
<span class="line"><span>2021.08.19 18:00:00,1780.55,1784.02,1780.05,1783.07,5271,6,0</span></span>
<span class="line"><span>2021.08.19 19:00:00,1783.06,1783.15,1780.73,1782.59,3571,7,0</span></span>
<span class="line"><span>2021.08.19 20:00:00,1782.61,1782.96,1780.16,1780.78,3236,10,0</span></span>
<span class="line"><span>2021.08.19 21:00:00,1780.79,1780.9,1778.54,1778.65,1017,13,0</span></span></code></pre></div><p>在读取阶段，处理这些文件的差异将开始显现。</p><p>让我们打开一个文本文件进行读取，并在循环中使用FileReadString函数“扫描”它，直到它返回一个空字符串（即直到文件结束）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   string read;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   fh1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(txtfile, FILE_TXT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_ANSI </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ, delimiter));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;===== Reading TXT&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      read </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fh1));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringLen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(read) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>日志将显示类似以下内容：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>===== Reading TXT</span></span>
<span class="line"><span>FileReadString(fh1)=DateTime,Open,High,Low,Close,Ticks,Spread,True / ok</span></span>
<span class="line"><span>FileReadString(fh1)=2021.08.19 12:00:00,1785.3,1789.76,1784.75,1789.06,4831,5,0 / ok</span></span>
<span class="line"><span>FileReadString(fh1)=2021.08.19 13:00:00,1789.06,1790.02,1787.61,1789.06,3393,5,0 / ok</span></span>
<span class="line"><span>FileReadString(fh1)=2021.08.19 14:00:00,1789.08,1789.95,1786.78,1786.89,3536,5,0 / ok</span></span>
<span class="line"><span>FileReadString(fh1)=2021.08.19 15:00:00,1786.78,1789.86,1783.73,1788.82,6840,5,0 / ok</span></span>
<span class="line"><span>FileReadString(fh1)=2021.08.19 16:00:00,1788.82,1792.44,1782.04,1784.02,9514,5,0 / ok</span></span>
<span class="line"><span>FileReadString(fh1)=2021.08.19 17:00:00,1784.04,1784.27,1777.14,1780.57,8526,5,0 / ok</span></span>
<span class="line"><span>FileReadString(fh1)=2021.08.19 18:00:00,1780.55,1784.02,1780.05,1783.07,5271,6,0 / ok</span></span>
<span class="line"><span>FileReadString(fh1)=2021.08.19 19:00:00,1783.06,1783.15,1780.73,1782.59,3571,7,0 / ok</span></span>
<span class="line"><span>FileReadString(fh1)=2021.08.19 20:00:00,1782.61,1782.96,1780.16,1780.78,3236,10,0 / ok</span></span>
<span class="line"><span>FileReadString(fh1)=2021.08.19 21:00:00,1780.79,1780.9,1778.54,1778.65,1017,13,0 / ok</span></span>
<span class="line"><span>FileReadString(fh1)= / FILE_ENDOFFILE(5027)</span></span></code></pre></div><p>在FILE_TXT模式下，每次调用FileReadString函数都会读取整行内容（直到‘\r\n’）。为了将其拆分为各个元素，我们应该实现额外的处理。或者，我们可以使用FILE_CSV模式。</p><p>让我们对CSV文件进行同样的操作。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   fh2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(csvfile, FILE_CSV </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_ANSI </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ, delimiter));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;===== Reading CSV&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      read </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fh2));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringLen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(read) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>这次日志中的记录会多很多：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>===== Reading CSV</span></span>
<span class="line"><span>FileReadString(fh2)=DateTime / ok</span></span>
<span class="line"><span>FileReadString(fh2)=Open / ok</span></span>
<span class="line"><span>FileReadString(fh2)=High / ok</span></span>
<span class="line"><span>FileReadString(fh2)=Low / ok</span></span>
<span class="line"><span>FileReadString(fh2)=Close / ok</span></span>
<span class="line"><span>FileReadString(fh2)=Ticks / ok</span></span>
<span class="line"><span>FileReadString(fh2)=Spread / ok</span></span>
<span class="line"><span>FileReadString(fh2)=True / ok</span></span>
<span class="line"><span>FileReadString(fh2)=2021.08.19 12:00:00 / ok</span></span>
<span class="line"><span>FileReadString(fh2)=1785.3 / ok</span></span>
<span class="line"><span>FileReadString(fh2)=1789.76 / ok</span></span>
<span class="line"><span>FileReadString(fh2)=1784.75 / ok</span></span>
<span class="line"><span>FileReadString(fh2)=1789.06 / ok</span></span>
<span class="line"><span>FileReadString(fh2)=4831 / ok</span></span>
<span class="line"><span>FileReadString(fh2)=5 / ok</span></span>
<span class="line"><span>FileReadString(fh2)=0 / ok</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>FileReadString(fh2)=2021.08.19 21:00:00 / ok</span></span>
<span class="line"><span>FileReadString(fh2)=1780.79 / ok</span></span>
<span class="line"><span>FileReadString(fh2)=1780.9 / ok</span></span>
<span class="line"><span>FileReadString(fh2)=1778.54 / ok</span></span>
<span class="line"><span>FileReadString(fh2)=1778.65 / ok</span></span>
<span class="line"><span>FileReadString(fh2)=1017 / ok</span></span>
<span class="line"><span>FileReadString(fh2)=13 / ok</span></span>
<span class="line"><span>FileReadString(fh2)=0 / ok</span></span>
<span class="line"><span>FileReadString(fh2)= / FILE_ENDOFFILE(5027)</span></span></code></pre></div><p>关键在于，在FILE_CSV模式下，FileReadString函数会考虑分隔符字符，并将字符串拆分为各个元素。每次调用FileReadString函数都会从CSV表格中返回一个单一的值（单元格）。显然，得到的字符串随后需要转换为相应的类型。</p><p>这个问题可以通过使用专门的函数FileReadDatetime、FileReadNumber、FileReadBool以通用的形式来解决。然而，无论如何，开发人员必须跟踪当前可读列的编号，并确定其实际意义。在测试的第三步中给出了这样一个算法的示例。它使用相同的CSV文件（为简单起见，我们在每一步结束时关闭它，并在下一步开始时打开它）。</p><p>为了通过列编号更轻松地为MqlRates结构体中的下一个字段赋值，我们创建了一个子结构体MqlRates，它包含一个模板方法集：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MqlRatesM : public MqlRates</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   template</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">typename T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> field, T v)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(field)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: this.time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (datetime)v; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: this.open </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)v; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: this.high </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)v; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: this.low </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)v; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: this.close </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)v; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: this.tick_volume </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)v; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: this.spread </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)v; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: this.real_volume </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)v; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>在OnStart函数中，我们描述了一个这样的结构体数组，我们将在其中添加传入的值。需要这个数组是为了使用ArrayPrint简化日志记录（在MQL5中没有现成的函数可以单独打印一个结构体）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;===== Reading CSV (alternative)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   MqlRatesM </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">r</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> column </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> maxColumn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ArraySize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(columns);</span></span></code></pre></div><p>用于记录记录数的count变量不仅用于统计，还作为跳过第一行的一种方式，因为第一行包含标题而不是数据。当前列编号在column变量中进行跟踪。其最大值不应超过列数maxColumn。</p><p>现在我们只需要打开文件，并在循环中使用各种函数从文件中读取元素，直到发生错误，特别是像5027（FILE_ENDOFFILE）这样的预期错误，即到达文件末尾。</p><p>当列编号为0时，我们应用FileReadDatetime函数。对于其他列，使用FileReadNumber函数。例外情况是包含标题的第一行：对于这一行，我们调用FileReadBool函数，以演示它对故意添加到最后一列的“True”标题的反应。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   fh2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(csvfile, FILE_CSV </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_ANSI </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ, delimiter));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(column)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 在包含标题的第一条记录上演示FileReadBool函数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">            r</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(column, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadBool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fh2)));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">            r</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(column, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadNumber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fh2));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      else</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 第0列是日期和时间</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         ++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">count;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 上一行的结构体已准备好</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(r, _Digits, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         }</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         r</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileReadDatetime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fh2);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      column </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (column </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> maxColumn;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_LastError </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 当到达文件末尾（5027，FILE_ENDOFFILE）时退出</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 打印最后一个结构体</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(column </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> maxColumn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(r, _Digits, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>以下是记录的日志内容：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>===== Reading CSV (alternative)</span></span>
<span class="line"><span>FileOpen(csvfile,FILE_CSV|FILE_ANSI|FILE_READ,delimiter)=1 / ok</span></span>
<span class="line"><span>FileReadBool(fh2)=false / ok</span></span>
<span class="line"><span>FileReadBool(fh2)=false / ok</span></span>
<span class="line"><span>FileReadBool(fh2)=false / ok</span></span>
<span class="line"><span>FileReadBool(fh2)=false / ok</span></span>
<span class="line"><span>FileReadBool(fh2)=false / ok</span></span>
<span class="line"><span>FileReadBool(fh2)=false / ok</span></span>
<span class="line"><span>FileReadBool(fh2)=true / ok</span></span>
<span class="line"><span>2021.08.19 00:00:00   0.00   0.00  0.00    0.00          0     0       1</span></span>
<span class="line"><span>2021.08.19 12:00:00 1785.30 1789.76 1784.75 1789.06       4831     5       0</span></span>
<span class="line"><span>2021.08.19 13:00:00 1789.06 1790.02 1787.61 1789.06       3393     5       0</span></span>
<span class="line"><span>2021.08.19 14:00:00 1789.08 1789.95 1786.78 1786.89       3536     5       0</span></span>
<span class="line"><span>2021.08.19 15:00:00 1786.78 1789.86 1783.73 1788.82       6840     5       0</span></span>
<span class="line"><span>2021.08.19 16:00:00 1788.82 1792.44 1782.04 1784.02       9514     5       0</span></span>
<span class="line"><span>2021.08.19 17:00:00 1784.04 1784.27 1777.14 1780.57       8526     5       0</span></span>
<span class="line"><span>2021.08.19 18:00:00 1780.55 1784.02 1780.05 1783.07       5271     6       0</span></span>
<span class="line"><span>2021.08.19 19:00:00 1783.06 1783.15 1780.73 1782.59       3571     7       0</span></span>
<span class="line"><span>2021.08.19 20:00:00 1782.61 1782.96 1780.16 1780.78       3236    10       0</span></span>
<span class="line"><span>2021.08.19 21:00:00 1780.79 1780.90 1778.54 1778.65       1017    13       0</span></span></code></pre></div><p>如你所见，在所有标题中，只有最后一个被转换为true值，而之前的所有标题都为false。</p><p>读取的结构体内容与原始数据相同。</p><h2 id="文件中的位置管理" tabindex="-1">文件中的位置管理 <a class="header-anchor" href="#文件中的位置管理" aria-label="Permalink to &quot;文件中的位置管理&quot;">​</a></h2><p>我们已经知道，系统会为每个打开的文件关联一个特定的指针：它确定了文件中的位置（从文件开头的偏移量），下次调用任何输入/输出函数时，将在此处写入或读取数据。函数执行后，指针会根据写入或读取的数据大小进行移动。</p><p>在某些情况下，您希望在不进行输入/输出操作的情况下更改指针的位置。特别是，当我们需要将数据追加到文件末尾时，我们以“混合”模式<code>FILE_READ | FILE_WRITE</code>打开文件，然后必须以某种方式将指针移动到文件末尾（否则我们将从文件开头覆盖数据）。我们可以在有数据可读时调用读取函数（从而移动指针），但这样效率不高。最好使用特殊函数<code>FileSeek</code>。而<code>FileTell</code>函数则允许获取指针的实际值（文件中的位置）。</p><p>在本节中，我们将探讨这些以及其他几个与文件中当前位置相关的函数。其中一些函数在文本模式和二进制模式下对文件的工作方式相同，而另一些则有所不同。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileSeek</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> offset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ENUM_FILE_POSITION </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">origin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数使用<code>origin</code>作为参考点，将文件指针移动<code>offset</code>个字节，<code>origin</code>是<code>ENUM_FILE_POSITION</code>枚举中描述的预定义位置之一。<code>offset</code>可以是正数（向文件末尾及更远的方向移动）或负数（向文件开头移动）。<code>ENUM_FILE_POSITION</code>有以下成员：</p><ul><li><code>SEEK_SET</code>：表示文件开头</li><li><code>SEEK_CUR</code>：表示当前位置</li><li><code>SEEK_END</code>：表示文件末尾</li></ul><p>如果相对于锚点计算的新位置为负值（即请求向文件开头左侧的偏移量），则文件指针将设置为文件开头。</p><p>如果将位置设置在文件末尾之后（该值大于文件大小），则后续对文件的写入将不是从文件末尾开始，而是从设置的位置开始。在这种情况下，将在文件先前的末尾和给定位置之间写入未定义的值（见下文）。</p><p>函数成功时返回<code>true</code>，出错时返回<code>false</code>。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ulong </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileTell</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>对于使用句柄描述符打开的文件，该函数返回内部指针的当前位置（相对于文件开头的偏移量）。如果出错，将返回<code>ULONG_MAX ((ulong)-1)</code>。错误代码可在<code>_LastError</code>变量中获取，或通过<code>GetLastError</code>函数获取。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileIsEnding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数返回一个指示，表明指针是否位于句柄文件的末尾。如果是，则结果为<code>true</code>。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileIsLineEnding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>对于具有句柄描述符的文本文件，该函数返回一个指示，表明文件指针是否位于行尾（紧跟在换行符<code>\n</code>或<code>\r\n</code>之后）。换句话说，返回值为<code>true</code>表示当前位置在下一行的开头（或在文件末尾）。对于二进制文件，结果始终为<code>false</code>。</p><p>用于测试上述函数的脚本名为<code>FileCursor.mq5</code>。它处理三个文件：两个二进制文件和一个文本文件。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string fileraw </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/cursor.raw&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string filetxt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/cursor.csv&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string file100 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/k100.raw&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>为了简化对当前位置、文件结束（End-Of-File，EOF）和行结束（End-Of-Line，EOL）标志的日志记录，我们创建了一个辅助函数<code>FileState</code>。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StringFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;P:</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">I64d, F:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, L:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      FileTell</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      (string)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileIsEnding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      (string)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileIsLineEnding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>在二进制文件上测试这些函数的场景包括以下步骤：</p><ol><li>以读写模式创建一个新的或打开一个现有的<code>fileraw</code>文件（<code>&quot;MQL5Book/cursor.raw&quot;</code>）。打开后，以及在每次操作之后，我们通过调用<code>FileState</code>输出文件的当前状态。</li></ol><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> handle;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> * Phase I. Binary file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fileraw, FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span></code></pre></div><ol start="2"><li>将指针移动到文件末尾，这将使我们每次执行脚本时都能向该文件追加数据（而不是从开头覆盖数据）。引用文件末尾最明显的方法是：相对于<code>origin=SEEK_END</code>的零偏移量。</li></ol><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSeek</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, SEEK_END));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span></code></pre></div><ol start="3"><li>如果文件不再为空（不是新文件），我们可以在其任意位置（相对或绝对）读取现有数据。特别是，如果<code>FileSeek</code>函数的<code>origin</code>参数等于<code>SEEK_CUR</code>，这意味着负偏移量将使当前位置向后移动相应的字节数（向左），正偏移量将使当前位置向前移动（向右）。</li></ol><p>在这个例子中，我们尝试向后移动一个<code>int</code>类型值的大小。稍后我们会看到，在这个位置应该是<code>MqlDateTime</code>结构体的<code>day_of_year</code>字段（最后一个字段），因为我们在后续指令中将其写入文件，并且在下次运行时可以从文件中获取这些数据。读取的值将被记录下来，以便与之前保存的值进行比较。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSeek</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), SEEK_CUR)))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>在一个新的空文件中，<code>FileSeek</code>调用将以错误<code>4003 (INVALID_PARAMETER)</code>结束，并且<code>if</code>语句块将不会执行。</p><ol start="4"><li>接下来，用数据填充文件。首先，使用<code>FileWriteLong</code>写入计算机的当前本地时间（<code>datetime</code>类型的8个字节）。</li></ol><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   datetime now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TimeLocal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteLong</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, now));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span></code></pre></div><ol start="5"><li>然后，我们尝试从当前位置向后移动4个字节（<code>-4</code>）并读取<code>long</code>类型数据。</li></ol><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSeek</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, SEEK_CUR));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadLong</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span></code></pre></div><p>这次尝试将以错误<code>5015 (FILE_READERROR)</code>结束，因为我们在文件末尾，向左移动4个字节后，无法从右侧读取8个字节（<code>long</code>类型的大小）。然而，正如我们将从日志中看到的，由于这次不成功的尝试，指针仍然会移动回文件末尾。</p><p>如果向后移动8个字节（<code>-8</code>），随后对<code>long</code>类型值的读取将成功，并且两个时间值，包括原始值和从文件中读取的值，必须匹配。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSeek</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, SEEK_CUR));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadLong</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x));</span></span></code></pre></div><ol start="6"><li>最后，将填充了相同时间的<code>MqlDateTime</code>结构体写入文件。文件中的位置将增加32（结构体的字节大小）。</li></ol><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   MqlDateTime mdt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   TimeToStruct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(now, mdt);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   StructPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mdt);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 在日志中直观显示日期/时间</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteStruct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, mdt));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 32 = sizeof(MqlDateTime)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle);</span></span></code></pre></div><p>在首次运行针对<code>fileraw</code>文件（<code>MQL5Book/cursor.raw</code>）的脚本场景后，我们会得到类似以下的结果（时间会有所不同）：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>first run </span></span>
<span class="line"><span> * Phase I. Binary file</span></span>
<span class="line"><span>FileOpen(fileraw,FILE_BIN|FILE_WRITE|FILE_READ)=1 / ok</span></span>
<span class="line"><span>P:0, F:true, L:false</span></span>
<span class="line"><span>FileSeek(handle,0,SEEK_END)=true / ok</span></span>
<span class="line"><span>P:0, F:true, L:false</span></span>
<span class="line"><span>FileSeek(handle,-1*sizeof(int),SEEK_CUR)=false / INVALID_PARAMETER(4003)</span></span>
<span class="line"><span>FileWriteLong(handle,now)=8 / ok</span></span>
<span class="line"><span>P:8, F:true, L:false</span></span>
<span class="line"><span>FileSeek(handle,-4,SEEK_CUR)=true / ok</span></span>
<span class="line"><span>FileReadLong(handle)=0 / FILE_READERROR(5015)</span></span>
<span class="line"><span>P:8, F:true, L:false</span></span>
<span class="line"><span>FileSeek(handle,-8,SEEK_CUR)=true / ok</span></span>
<span class="line"><span>P:0, F:false, L:false</span></span>
<span class="line"><span>FileReadLong(handle)=1629683392 / ok</span></span>
<span class="line"><span>(now==x)=true / ok</span></span>
<span class="line"><span>  2021     8    23      1    49    52             1           234</span></span>
<span class="line"><span>FileWriteStruct(handle,mdt)=32 / ok</span></span>
<span class="line"><span>P:40, F:true, L:false</span></span></code></pre></div><p>根据状态，文件大小最初为零，因为在移动到文件末尾后位置为<code>&quot;P:0&quot;</code>（<code>&quot;F:true&quot;</code>）。每次写入（使用<code>FileWriteLong</code>和<code>FileWriteStruct</code>）后，位置<code>P</code>会根据写入数据的大小增加。</p><p>在第二次运行脚本后，您可以在日志中注意到一些变化：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>second run</span></span>
<span class="line"><span> * Phase I. Binary file</span></span>
<span class="line"><span>FileOpen(fileraw,FILE_BIN|FILE_WRITE|FILE_READ)=1 / ok</span></span>
<span class="line"><span>P:0, F:false, L:false</span></span>
<span class="line"><span>FileSeek(handle,0,SEEK_END)=true / ok</span></span>
<span class="line"><span>P:40, F:true, L:false</span></span>
<span class="line"><span>FileSeek(handle,-1*sizeof(int),SEEK_CUR)=true / ok</span></span>
<span class="line"><span>P:36, F:false, L:false</span></span>
<span class="line"><span>FileReadInteger(handle)=234 / ok</span></span>
<span class="line"><span>FileWriteLong(handle,now)=8 / ok</span></span>
<span class="line"><span>P:48, F:true, L:false</span></span>
<span class="line"><span>FileSeek(handle,-4,SEEK_CUR)=true / ok</span></span>
<span class="line"><span>FileReadLong(handle)=0 / FILE_READERROR(5015)</span></span>
<span class="line"><span>P:48, F:true, L:false</span></span>
<span class="line"><span>FileSeek(handle,-8,SEEK_CUR)=true / ok</span></span>
<span class="line"><span>P:40, F:false, L:false</span></span>
<span class="line"><span>FileReadLong(handle)=1629683397 / ok</span></span>
<span class="line"><span>(now==x)=true / ok</span></span>
<span class="line"><span>  2021     8    23      1    49    57             1           234</span></span>
<span class="line"><span>FileWriteStruct(handle,mdt)=32 / ok</span></span>
<span class="line"><span>P:80, F:true, L:false</span></span></code></pre></div><p>首先，打开后文件的大小为40（根据移动到文件末尾后的位置<code>&quot;P:40&quot;</code>）。每次运行脚本时，文件将增长40个字节。</p><p>其次，由于文件不为空，因此可以在其中导航并读取“旧”数据。特别是，从当前位置（也是文件末尾）向后移动<code>-1*sizeof(int)</code>后，我们成功读取了值234，这是<code>MqlDateTime</code>结构体的最后一个字段（它是一年中的第几天，您的情况很可能不同）。</p><p>第二个测试场景处理文本CSV文件<code>filetxt</code>（<code>MQL5Book/cursor.csv</code>）。我们也将以读写组合模式打开它，但不会将指针移动到文件末尾。因此，每次运行脚本都会从文件开头覆盖数据。为了便于发现差异，CSV第一列中的数字是随机生成的。在第二列中，总是从<code>StringFormat</code>函数的模板中替换相同的字符串。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; * Phase II. Text file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   srand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GetTickCount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 创建一个新文件或打开一个现有文件以进行写入/覆盖</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 从开头开始并进行后续读取；内部为CSV数据（Unicode）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filetxt, FILE_CSV </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;,&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 三行数据（每行一对数字和字符串），用&#39;\n&#39;分隔</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 注意，最后一个元素不以换行符&#39;\n&#39;结尾</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 这是可选的，但允许</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   string content </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StringFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%02d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,abc</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n%02d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,def</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n%02d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,ghi&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      rand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 由于FileWriteString，&#39;\n&#39;将自动替换为&#39;\r\n&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, content));</span></span></code></pre></div><p>以下是生成数据的一个示例：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>34,abc</span></span>
<span class="line"><span>20,def</span></span>
<span class="line"><span>02,ghi</span></span></code></pre></div><p>然后，我们返回到文件开头，并使用<code>FileReadString</code>在循环中读取文件，同时不断记录状态。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSeek</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, SEEK_SET));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 使用FileIsLineEnding特性计算文件中的行数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lineCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileIsEnding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileReadString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 当FileIsEnding等于true时，FileIsLineEnding也等于true，</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 即使没有尾随的&#39;\n&#39;字符</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileIsLineEnding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle)) lineCount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lineCount);</span></span></code></pre></div><p>以下是脚本第一次和第二次运行后<code>filetxt</code>文件的日志。首先是第一次运行的日志：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>first run</span></span>
<span class="line"><span> * Phase II. Text file</span></span>
<span class="line"><span>FileOpen(filetxt,FILE_CSV|FILE_WRITE|FILE_READ,&#39;,&#39;)=1 / ok</span></span>
<span class="line"><span>FileWriteString(handle,content)=44 / ok</span></span>
<span class="line"><span>FileSeek(handle,0,SEEK_SET)=true / ok</span></span>
<span class="line"><span>P:0, F:false, L:false</span></span>
<span class="line"><span>FileReadString(handle)=08 / ok</span></span>
<span class="line"><span>P:8, F:false, L:false</span></span>
<span class="line"><span>FileReadString(handle)=abc / ok</span></span>
<span class="line"><span>P:18, F:false, L:true</span></span>
<span class="line"><span>FileReadString(handle)=37 / ok</span></span>
<span class="line"><span>P:24, F:false, L:false</span></span>
<span class="line"><span>FileReadString(handle)=def / ok</span></span>
<span class="line"><span>P:34, F:false, L:true</span></span>
<span class="line"><span>FileReadString(handle)=96 / ok</span></span>
<span class="line"><span>P:40, F:false, L:false</span></span>
<span class="line"><span>FileReadString(handle)=ghi / ok</span></span>
<span class="line"><span>P:46, F:true, L:true</span></span>
<span class="line"><span>lineCount=3 / ok</span></span></code></pre></div><p>这是第二次运行的日志：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>second run</span></span>
<span class="line"><span> * Phase II. Text file</span></span>
<span class="line"><span>FileOpen(filetxt,FILE_CSV|FILE_WRITE|FILE_READ,&#39;,&#39;)=1 / ok</span></span>
<span class="line"><span>FileWriteString(handle,content)=44 / ok</span></span>
<span class="line"><span>FileSeek(handle,0,SEEK_SET)=true / ok</span></span>
<span class="line"><span>P:0, F:false, L:false</span></span>
<span class="line"><span>FileReadString(handle)=34 / ok</span></span>
<span class="line"><span>P:8, F:false, L:false</span></span>
<span class="line"><span>FileReadString(handle)=abc / ok</span></span>
<span class="line"><span>P:18, F:false, L:true</span></span>
<span class="line"><span>FileReadString(handle)=20 / ok</span></span>
<span class="line"><span>P:24, F:false, L:false</span></span>
<span class="line"><span>FileReadString(handle)=def / ok</span></span>
<span class="line"><span>P:34, F:false, L:true</span></span>
<span class="line"><span>FileReadString(handle)=02 / ok</span></span>
<span class="line"><span>P:40, F:false, L:false</span></span>
<span class="line"><span>FileReadString(handle)=ghi / ok</span></span>
<span class="line"><span>P:46, F:true, L:true</span></span>
<span class="line"><span>lineCount=3 / ok</span></span></code></pre></div><p>如您所见，文件大小没有变化，但在相同的偏移量处写入了不同的数字。因为这个CSV文件有两列，所以在我们读取的每第二个值之后，我们会看到一个行结束标志（<code>&quot;L:true&quot;</code>）被触发。</p><p>检测到的行数为3，尽管文件中只有2个换行符：最后（第三）行在文件结尾处结束。</p><p>最后，最后一个测试场景使用文件<code>file100</code>（<code>MQL5Book/k100.raw</code>）将指针移动到文件末尾之后（到1000000字节的标记处），从而增加其大小（为未来可能的写入操作预留磁盘空间）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; * Phase III. Allocate large file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(file100, FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSeek</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, SEEK_END));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 要更改大小，至少需要写入一些内容</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">0x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">FF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileTell</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle);</span></span></code></pre></div><p>此脚本的日志输出在每次运行时不会改变，但是，最终出现在为文件分配的空间中的随机数据可能会有所不同（此处不显示其内容：请使用外部二进制查看器）。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span> * Phase III. Allocate large file</span></span>
<span class="line"><span>FileOpen(file100,FILE_BIN|FILE_WRITE)=1 / ok</span></span>
<span class="line"><span>FileSeek(handle,1000000,SEEK_END)=true / ok</span></span>
<span class="line"><span>FileWriteInteger(handle,0xFF,1)=1 / ok</span></span>
<span class="line"><span>FileTell(handle)=1000001 / ok</span></span></code></pre></div><h2 id="获取文件属性" tabindex="-1">获取文件属性 <a class="header-anchor" href="#获取文件属性" aria-label="Permalink to &quot;获取文件属性&quot;">​</a></h2><p>在处理文件的过程中，除了直接读写数据外，通常还需要分析文件的属性。其中一个主要属性——文件大小，可以使用 <code>FileSize</code> 函数获取。此外，还有一些其他特性可以使用 <code>FileGetInteger</code> 函数来查询。</p><p>请注意，<code>FileSize</code> 函数需要一个已打开的文件句柄。而 <code>FileGetInteger</code> 函数有一些属性（包括文件大小）可以通过文件名识别，无需事先打开文件。</p><div class="language-plaintext vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">plaintext</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>ulong FileSize(int handle)</span></span></code></pre></div><p>该函数通过文件描述符返回已打开文件的大小。若出现错误，返回结果为 0，而 0 也是函数正常执行时可能的有效大小，因此你应该始终使用 <code>_LastError</code>（或 <code>GetLastError</code>）来分析潜在的错误。</p><p>文件大小也可以通过将文件指针移动到文件末尾 <code>FileSeek(handle, 0, SEEK_END)</code> 并调用 <code>FileTell(handle)</code> 来获取。这两个函数在上一节中有描述。</p><div class="language-plaintext vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">plaintext</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>long FileGetInteger(int handle, ENUM_FILE_PROPERTY_INTEGER property)</span></span>
<span class="line"><span>long FileGetInteger(const string filename, ENUM_FILE_PROPERTY_INTEGER property, bool common = false)</span></span></code></pre></div><p>该函数有两种使用方式：一种是通过已打开的文件描述符操作，另一种是通过文件名（包括未打开的文件）操作。</p><p>该函数返回 <code>property</code> 参数指定的文件属性之一。每种使用方式的有效属性列表不同（见下文）。尽管返回值类型为 <code>long</code>，但根据所请求的属性，它不仅可以包含整数，还可以包含日期时间或布尔值：需要显式进行所需的类型转换。</p><p>当通过文件名请求属性时，你可以额外使用 <code>common</code> 参数来指定在哪个文件夹中搜索文件：当前终端文件夹 <code>MQL5/Files</code>（<code>false</code>，默认值）或公共文件夹 <code>Users/&lt;user_name&gt;...MetaQuotes/Terminal/Common/Files</code>（<code>true</code>）。如果 MQL 程序在测试器中运行，工作目录位于测试代理文件夹内（<code>Tester/&lt;agent&gt;/MQL5/Files</code>），请参阅“文件操作”章节的介绍。</p><p>以下表格列出了 <code>ENUM_FILE_PROPERTY_INTEGER</code> 的所有成员。</p><table tabindex="0"><thead><tr><th>属性</th><th>描述</th></tr></thead><tbody><tr><td><code>FILE_EXISTS</code> *</td><td>检查文件是否存在（类似于 <code>FileIsExist</code>）</td></tr><tr><td><code>FILE_CREATE_DATE</code> *</td><td>创建日期</td></tr><tr><td><code>FILE_MODIFY_DATE</code> *</td><td>最后修改日期</td></tr><tr><td><code>FILE_ACCESS_DATE</code> *</td><td>最后访问日期</td></tr><tr><td><code>FILE_SIZE</code> *</td><td>文件大小（以字节为单位，类似于 <code>FileSize</code>）</td></tr><tr><td><code>FILE_POSITION</code></td><td>文件指针位置（类似于 <code>FileTell</code>）</td></tr><tr><td><code>FILE_END</code></td><td>文件末尾位置（类似于 <code>FileIsEnding</code>）</td></tr><tr><td><code>FILE_LINE_END</code></td><td>行末尾位置（类似于 <code>FileIsLineEnding</code>）</td></tr><tr><td><code>FILE_IS_COMMON</code></td><td>文件是否在终端共享文件夹中打开（<code>FILE_COMMON</code>）</td></tr><tr><td><code>FILE_IS_TEXT</code></td><td>文件是否以文本模式打开（<code>FILE_TXT</code>）</td></tr><tr><td><code>FILE_IS_BINARY</code></td><td>文件是否以二进制模式打开（<code>FILE_BIN</code>）</td></tr><tr><td><code>FILE_IS_CSV</code></td><td>文件是否以 CSV 模式打开（<code>FILE_CSV</code>）</td></tr><tr><td><code>FILE_IS_ANSI</code></td><td>文件是否以 ANSI 模式打开（<code>FILE_ANSI</code>）</td></tr><tr><td><code>FILE_IS_READABLE</code></td><td>文件是否以只读模式打开（<code>FILE_READ</code>）</td></tr><tr><td><code>FILE_IS_WRITABLE</code></td><td>文件是否以可写模式打开（<code>FILE_WRITE</code>）</td></tr></tbody></table><p>允许通过文件名使用的属性标有星号。如果你尝试获取其他属性，函数的第二个版本将返回错误 4003（<code>INVALID_PARAMETER</code>）。</p><p>某些属性在处理已打开的文件时可能会发生变化：<code>FILE_MODIFY_DATE</code>、<code>FILE_ACCESS_DATE</code>、<code>FILE_SIZE</code>、<code>FILE_POSITION</code>、<code>FILE_END</code>、<code>FILE_LINE_END</code>（仅适用于文本文件）。</p><p>若出现错误，函数调用结果为 -1。</p><p>函数的第二个版本允许你检查指定的名称是文件还是目录。如果在通过名称获取属性时指定了目录，函数将设置一个特殊的内部错误代码 5018（<code>ERR_MQL_FILE_IS_DIRECTORY</code>），而返回值将是正确的。</p><p>我们将使用脚本 <code>FileProperties.mq5</code> 来测试本节中的函数。该脚本将处理一个预定义名称的文件。</p><div class="language-plaintext vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">plaintext</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>const string fileprop = &quot;MQL5Book/fileprop&quot;;</span></span></code></pre></div><p>在 <code>OnStart</code> 函数开始时，让我们尝试通过一个错误的描述符（未通过 <code>FileOpen</code> 调用获取）来请求文件大小。调用 <code>FileSize</code> 后，需要检查 <code>_LastError</code> 变量，而 <code>FileGetInteger</code> 会立即返回一个特殊值，即错误指示符（-1）。</p><div class="language-plaintext vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">plaintext</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>void OnStart()</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>   int handle = 0;</span></span>
<span class="line"><span>   ulong size = FileSize(handle);</span></span>
<span class="line"><span>   if(_LastError)</span></span>
<span class="line"><span>   {</span></span>
<span class="line"><span>      Print(&quot;FileSize error=&quot;, E2S(_LastError) + &quot;(&quot; + (string)_LastError + &quot;)&quot;);</span></span>
<span class="line"><span>      // 我们将得到：FileSize 0, error=WRONG_FILEHANDLE(5008)</span></span>
<span class="line"><span>   }</span></span>
<span class="line"><span>   </span></span>
<span class="line"><span>   PRTF(FileGetInteger(handle, FILE_SIZE)); // -1 / WRONG_FILEHANDLE(5008)</span></span></code></pre></div><p>接下来，我们创建一个新文件或打开一个现有文件并将其重置，然后写入测试文本。</p><div class="language-plaintext vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">plaintext</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>   handle = PRTF(FileOpen(fileprop, FILE_TXT | FILE_WRITE | FILE_ANSI)); // 1</span></span>
<span class="line"><span>   PRTF(FileWriteString(handle, &quot;Test Text\n&quot;)); // 11</span></span></code></pre></div><p>我们有选择地请求一些属性。</p><div class="language-plaintext vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">plaintext</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>   PRTF(FileGetInteger(fileprop, FILE_SIZE)); // 0，尚未写入磁盘</span></span>
<span class="line"><span>   PRTF(FileGetInteger(handle, FILE_SIZE)); // 11</span></span>
<span class="line"><span>   PRTF(FileSize(handle)); // 11</span></span>
<span class="line"><span>   PRTF(FileGetInteger(handle, FILE_MODIFY_DATE)); // 1629730884，自 1970 年以来的秒数</span></span>
<span class="line"><span>   PRTF(FileGetInteger(handle, FILE_IS_TEXT)); // 1，布尔值 true</span></span>
<span class="line"><span>   PRTF(FileGetInteger(handle, FILE_IS_BINARY)); // 0，布尔值 false</span></span></code></pre></div><p>通过文件描述符获取的文件长度信息会考虑当前的缓存缓冲区，而通过文件名获取时，只有在文件关闭后或调用 <code>FileFlush</code> 函数（见“强制将缓存写入磁盘”部分），实际长度才可用。</p><p>该函数以自 1970 年 1 月 1 日标准纪元以来的秒数形式返回日期和时间，这对应于 <code>datetime</code> 类型，可以进行类型转换。</p><p>对于使用描述符的函数版本，请求文件打开标志（即文件模式）是成功的，特别是我们得到响应表明文件是文本文件而不是二进制文件。然而，接下来对文件名进行的类似请求将失败，因为该属性仅在传递有效句柄时才支持。即使文件名指向的是我们已打开的同一个文件，也会出现这种情况。</p><div class="language-plaintext vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">plaintext</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>   PRTF(FileGetInteger(fileprop, FILE_IS_TEXT)); // -1 / INVALID_PARAMETER(4003)</span></span></code></pre></div><p>让我们等待一秒钟，关闭文件，然后再次检查修改日期（这次通过文件名，因为描述符已不再有效）。</p><div class="language-plaintext vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">plaintext</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>   Sleep(1000);</span></span>
<span class="line"><span>   FileClose(handle);</span></span>
<span class="line"><span>   PRTF(FileGetInteger(fileprop, FILE_MODIFY_DATE)); // 1629730885 / 正常</span></span></code></pre></div><p>在这里你可以清楚地看到时间增加了 1 秒。</p><p>最后，确保目录（文件夹）的属性是可用的。</p><div class="language-plaintext vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">plaintext</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>   PRTF((datetime)FileGetInteger(&quot;MQL5Book&quot;, FILE_CREATE_DATE));</span></span>
<span class="line"><span>   // 我们将得到：2021.08.09 22:38:00 / FILE_IS_DIRECTORY(5018)</span></span></code></pre></div><p>由于本书的所有示例都位于 &quot;MQL5Book&quot; 文件夹中，该文件夹必须已经存在。不过，你实际的创建时间会有所不同。在这种情况下，<code>FILE_IS_DIRECTORY</code> 错误代码由 <code>PRTF</code> 宏显示。在实际工作的程序中，函数调用不应使用宏，然后应从 <code>_LastError</code> 中读取错误代码。</p><h2 id="强制将缓存写入磁盘" tabindex="-1">强制将缓存写入磁盘 <a class="header-anchor" href="#强制将缓存写入磁盘" aria-label="Permalink to &quot;强制将缓存写入磁盘&quot;">​</a></h2><p>在MQL5中，文件的写入和读取是经过缓存处理的。这意味着会为数据维护一个特定的内存缓冲区，由此提高了工作效率。因此，在写入时通过函数调用传输的数据会进入输出缓冲区，只有在缓冲区满了之后，才会真正地将数据写入磁盘。而在读取时则相反，会从磁盘读取比程序通过函数请求的更多的数据（如果不是文件末尾的话），并且后续很可能进行的读取操作会更快。</p><p>缓存是一种在大多数应用程序以及操作系统本身层面都使用的标准技术。然而，除了优点之外，缓存也有其缺点。</p><p>特别是当文件被用作程序之间的数据交换手段时，延迟写入会显著降低通信速度，并且使通信的可预测性变差，因为缓冲区的大小可能相当大，而且将缓冲区数据 “转储” 到磁盘的频率可能会根据某些算法进行调整。</p><p>例如，在MetaTrader 5中，有一整类的MQL程序用于将交易信号从一个终端实例复制到另一个终端实例。它们倾向于使用文件来传输信息，对于它们来说，缓存不会拖慢速度是非常重要的。对于这种情况，MQL5提供了<code>FileFlush</code>函数。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileFlush</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数会强制将具有句柄描述符的文件的I/O文件缓冲区中剩余的所有数据刷新到磁盘上。</p><p>如果不使用这个函数，那么在最坏的情况下，从程序 “发送” 的部分数据可能只有在文件关闭时才会写入磁盘。</p><p>这个功能在发生意外事件（如操作系统或程序挂起）时，为有价值的数据安全提供了更大的保障。然而，另一方面，在大量写入操作期间不建议频繁调用<code>FileFlush</code>函数，因为这可能会对性能产生不利影响。</p><p>如果文件是以混合模式打开的，即同时用于写入和读取，那么必须在对文件进行读取和写入操作之间调用<code>FileFlush</code>函数。</p><p>作为一个示例，考虑脚本<code>FileFlush.mq5</code>，在这个脚本中，我们实现了两种模式来模拟交易复制器的操作。我们需要在不同的图表上运行该脚本的两个实例，其中一个作为数据发送方，另一个作为数据接收方。</p><p>该脚本有两个输入参数：<code>EnableFlashing</code>允许我们比较使用<code>FileFlush</code>函数和不使用该函数时程序的行为，<code>UseCommonFolder</code>表示是否需要创建一个用作数据传输手段的文件，可选择在当前终端实例的文件夹中或在共享文件夹中（在后一种情况下，可以测试不同终端之间的数据传输）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#property script_show_inputs</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EnableFlashing </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UseCommonFolder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>回想一下，为了在脚本启动时出现带有输入变量的对话框，必须额外设置<code>script_show_inputs</code>属性。</p><p>中转文件的名称在<code>dataport</code>变量中指定。<code>UseCommonFolder</code>选项控制添加到<code>File Open</code>函数中打开文件的模式开关集中的<code>FILE_COMMON</code>标志。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string dataport </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/dataport&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UseCommonFolder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_COMMON </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>主要的<code>OnStart</code>函数实际上由两部分组成：打开文件的设置以及一个定期发送或接收数据的循环。</p><p>我们需要运行该脚本的两个实例，并且每个实例都有自己的文件描述符，指向磁盘上的同一个文件，但以不同的模式打开。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> modeWriter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 默认情况下，脚本应该写入数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // 进行的写入/读取次数</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 以写入模式创建一个新文件或重置旧文件，作为 “发送方”</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dataport, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flag));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 如果无法写入，很可能另一个脚本实例已经在向该文件写入数据，</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 所以我们尝试以读取模式打开它</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INVALID_HANDLE)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 如果可以以读取模式打开文件，我们将继续作为 “接收方” 工作</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dataport, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         FILE_BIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_SHARE_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flag));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INVALID_HANDLE)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Can&#39;t open file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 出问题了</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      modeWriter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 切换模式/角色</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>一开始，我们尝试以<code>FILE_WRITE</code>模式打开文件，不共享写入权限（<code>FILE_SHARE_WRITE</code>），所以运行的脚本的第一个实例将占用该文件，并阻止第二个实例以写入模式工作。第二个实例在第一次调用<code>FileOpen</code>后将得到一个错误并返回<code>INVALID_HANDLE</code>，然后会尝试使用<code>FILE_SHARE_WRITE</code>并行写入标志，通过第二次调用<code>FileOpen</code>以读取模式（<code>FILE_READ</code>）打开文件。理想情况下，这应该是可行的。然后，<code>modeWriter</code>变量将被设置为<code>false</code>，以指示脚本的实际角色。</p><p>主要的操作循环具有以下结构：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IsStopped</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(modeWriter)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // ...写入测试数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // ...读取测试数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      Sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>该循环会一直执行，直到用户手动从图表中删除该脚本：这将由<code>IsStopped</code>函数发出信号。在循环内部，通过调用<code>Sleep</code>函数，每5秒触发一次操作，<code>Sleep</code>函数会使程序 “冻结” 指定的毫秒数（在这种情况下是5000毫秒）。这样做是为了更容易分析正在进行的变化，并且避免过于频繁地记录状态。在没有详细日志的实际程序中，可以每100毫秒甚至更频繁地发送数据。</p><p>传输的数据将包括当前时间（一个<code>datetime</code>值，8个字节）。在<code>if(modeWriter)</code>指令的第一个分支中，即写入文件的地方，我们调用<code>FileWriteLong</code>函数写入最后一次的计数（从<code>TimeLocal</code>函数获得），将操作计数器加1（<code>count++</code>），并将当前状态输出到日志中。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> temp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TimeLocal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 获取当前本地时间的datetime</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         FileWriteLong</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, temp);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // （每5秒）将其追加到文件中</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         count</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(EnableFlashing)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            FileFlush</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Written[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]: </span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">I64d&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, count, temp));</span></span></code></pre></div><p>需要注意的是，只有当输入参数<code>EnableFlashing</code>设置为<code>true</code>时，才会在每次写入后调用<code>FileFlush</code>函数。</p><p>在<code>if</code>操作符的第二个分支中，即我们读取数据的地方，我们首先通过调用<code>ResetLastError</code>重置内部错误标志。这是必要的，因为我们要从文件中读取数据，直到没有数据为止。一旦没有更多的数据可读，程序将得到一个特定的错误代码5015（<code>ERR_FILE_READERROR</code>）。</p><p>由于内置的MQL5定时器，包括<code>Sleep</code>函数，精度有限（大约10毫秒），我们不能排除在两次连续尝试读取文件之间发生两次连续写入的情况。例如，一次读取发生在10:00:00&#39;200，第二次读取发生在10:00:05&#39;210（以 “小时:分钟:秒&#39;毫秒” 的格式表示）。在这种情况下，同时发生了两次写入：一次在10:00:00&#39;205，另一次在10:00:05&#39;205，并且这两次写入都落在上述时间段内。这种情况不太可能发生，但却是有可能的。即使时间间隔绝对精确，如果运行的程序总数很大，并且没有足够的处理器核心来处理所有程序，MQL5运行时系统可能会被迫在两个正在运行的脚本之间做出选择（哪个脚本先调用）。</p><p>MQL5提供了高精度定时器（精度可达微秒），但对于当前任务来说这并不关键。</p><p>嵌套循环还有另一个原因。在脚本作为数据 “接收方” 启动后，它必须处理自 “发送方” 启动以来在文件中积累的所有记录（两个脚本几乎不可能同时启动）。可能有人会更喜欢不同的算法：跳过所有 “旧” 记录，只跟踪新记录。这是可以做到的，但这里实现的是 “无损” 选项。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         ResetLastError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 只要有数据且没有问题就循环</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reportedEndBeforeRead </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileIsEnding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            ulong reportedTellBeforeRead </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileTell</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            temp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileReadLong</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 如果没有更多数据，我们将得到错误5015（ERR_FILE_READERROR）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_LastError)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 遇到任何错误就退出循环</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 这里数据在没有错误的情况下被接收</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            count</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Read[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]: </span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">I64d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">               &quot;(size=</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">I64d, before=</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">I64d(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">), after=</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">I64d)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">               count, temp, </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">               FileSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle), reportedTellBeforeRead, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">               (string)reportedEndBeforeRead, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileTell</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle)));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         }</span></span></code></pre></div><p>请注意以下几点。对于为读取而打开的文件的元数据，例如由<code>FileSize</code>函数返回的文件大小（请参阅 “获取文件属性”），在文件打开后不会改变。如果另一个程序后来向我们打开用于读取的文件中添加了内容，即使我们对读取描述符调用<code>FileFlash</code>函数，其 “可检测到的” 长度也不会更新。可以关闭并重新打开文件（在每次读取之前，但这样效率不高）：然后新的描述符将显示新的长度。但我们将通过另一个技巧来避免这种情况。</p><p>这个技巧是只要读取函数（在我们的例子中是<code>FileReadLong</code>）返回的数据没有错误，就继续使用这些读取函数读取数据。重要的是不要使用其他操作元数据的函数。特别是，由于只读的文件结束位置保持不变，使用<code>FileIsEnding</code>函数进行检查（请参阅 “文件内的位置控制”）在旧位置将返回<code>true</code>，尽管可能有另一个进程向文件中添加了内容。此外，尝试将内部文件指针移动到文件末尾（<code>FileSeek(handle, 0, SEEK_END);</code>，关于<code>FileSeek</code>函数请参阅同一部分）不会跳到实际的数据末尾，而是跳到打开文件时文件末尾所在的过时位置。</p><p><code>FileTell</code>函数（请参阅同一部分）会告诉我们文件内部的实际位置。随着另一个脚本实例向文件中添加信息并在这个循环中读取信息，指针会越来越向右移动，尽管很奇怪，它会超过<code>FileSize</code>。为了直观地演示指针如何超过文件大小，让我们保存调用<code>FileReadLong</code>之前和之后的指针值，然后将这些值与文件大小一起输出到日志中。</p><p>一旦<code>FileReadLong</code>的读取操作产生任何错误，内部循环就会中断。正常的循环退出意味着错误5015（<code>ERR_FILE_READERROR</code>）。特别是当在文件的当前位置没有数据可供读取时，就会发生这种情况。</p><p>最后成功读取的数据将输出到日志中，并且很容易将其与发送方脚本输出的数据进行比较。</p><p>让我们运行新脚本两次。为了区分脚本的副本，我们将在不同交易品种的图表上运行它。</p><p>在运行两个脚本时，重要的是要确保<code>UseCommonFolder</code>参数的值相同。在我们的测试中，将其保留为<code>false</code>，因为我们将在一个终端中完成所有操作。建议在<code>UseCommonFolder</code>设置为<code>true</code>时，独立测试不同终端之间的数据传输。</p><p>首先，我们在EURUSD,H1图表上运行第一个实例，保留所有默认设置，包括<code>EnableFlashing=false</code>。然后，我们在XAUUSD,H1图表上运行第二个实例（同样使用默认设置）。日志将如下所示（你的时间会不同）：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>(EURUSD,H1) *</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) FileOpen(dataport,FILE_BIN|FILE_WRITE|FILE_SHARE_READ|flag)=1 / ok</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) Written[1]: 1629652995</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(XAUUSD,H1) *</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(XAUUSD,H1) FileOpen(dataport,FILE_BIN|FILE_WRITE|FILE_SHARE_READ|flag)=-1 / CANNOT_OPEN_FILE(5004)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(XAUUSD,H1) FileOpen(dataport,FILE_BIN|FILE_READ|FILE_SHARE_WRITE|FILE_SHARE_READ|flag)=1 / ok</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) Written[2]: 1629653000</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) Written[3]: 1629653005</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) Written[4]: 1629653010</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) Written[5]: 1629653015</span></span></code></pre></div><p>发送方成功打开文件进行写入，并开始每5秒发送一次数据，从带有 “Written” 字样的行以及不断增加的值可以看出这一点。在发送方启动后不到5秒，接收方也启动了。它给出了一个错误消息，因为它无法打开文件进行写入。但随后它成功地打开了文件进行读取。然而，没有记录表明它能够在文件中找到传输的数据。数据仍然 “挂” 在发送方的缓存中。</p><p>让我们停止两个脚本，然后按照相同的顺序再次运行它们：首先在EURUSD上运行发送方，然后在XAUUSD上运行接收方。但这次我们将为发送方指定<code>EnableFlashing=true</code>。</p><p>以下是日志中的情况：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>(EURUSD,H1) *</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) FileOpen(dataport,FILE_BIN|FILE_WRITE|FILE_SHARE_READ|flag)=1 / ok</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) Written[1]: 1629653638</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(XAUUSD,H1) *</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(XAUUSD,H1) FileOpen(dataport,FILE_BIN|FILE_WRITE|FILE_SHARE_READ|flag)=-1 / CANNOT_OPEN_FILE(5004)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(XAUUSD,H1) FileOpen(dataport,FILE_BIN|FILE_READ|FILE_SHARE_WRITE|FILE_SHARE_READ|flag)=1 / ok</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(XAUUSD,H1) Read[1]: 1629653638 (size=8, before=0(false), after=8)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) Written[2]: 1629653643</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(XAUUSD,H1) Read[2]: 1629653643 (size=8, before=8(true), after=16)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) Written[3]: 1629653648</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(XAUUSD,H1) Read[3]: 1629653648 (size=8, before=16(true), after=24)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) Written[4]: 1629653653</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(XAUUSD,H1) Read[4]: 1629653653 (size=8, before=24(true), after=32)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) Written[5]: 1629653658</span></span></code></pre></div><p>同样的文件在两个脚本中再次以不同的模式成功打开，但这次写入的值会被接收方定期读取。</p><p>有趣的是，除了第一次之外，在每次下一次数据读取之前，<code>FileIsEnding</code>函数都会返回<code>true</code>（显示在与接收到的数据相同的行中，在 “before” 字符串后面的括号内）。因此，有一个迹象表明我们处于文件末尾，但随后<code>FileReadLong</code>成功地读取了一个据推测超出文件限制的值，并将位置向右移动。例如，“size=8, before=8(true), after=16” 这一记录意味着报告给MQL程序的文件大小为8，调用<code>FileReadLong</code>之前的当前指针也等于8，并且文件结束标志已启用。在成功调用<code>FileReadLong</code>之后，指针移动到了16。然而，在接下来的所有其他迭代中，我们再次看到 “size=8”，并且指针逐渐越来越超出文件范围。</p><p>由于发送方的写入和接收方的读取每5秒发生一次，根据它们的循环偏移阶段，我们可以观察到这两个操作之间存在不同的延迟，在最坏的情况下可能长达近5秒。然而，这并不意味着缓存刷新速度如此之慢。实际上，这几乎是一个瞬间的过程。为了确保更快速地检测到变化，可以减少循环中的睡眠周期（请注意，如果延迟太短，这个测试会很快填满日志 —— 与实际程序不同，这里总是生成新数据，因为这是发送方最接近秒的当前时间）。</p><p>顺便说一下，与只能有一个发送方不同，你可以运行多个接收方。下面的日志显示了在EURUSD上的发送方以及在XAUUSD和USDRUB图表上的两个接收方的操作情况。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>(EURUSD,H1) *</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) FileOpen(dataport,FILE_BIN|FILE_WRITE|FILE_SHARE_READ|flag)=1 / ok</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) Written[1]: 1629671658</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(XAUUSD,H1) *</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(XAUUSD,H1) FileOpen(dataport,FILE_BIN|FILE_WRITE|FILE_SHARE_READ|flag)=-1 / CANNOT_OPEN_FILE(5004)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(XAUUSD,H1) FileOpen(dataport,FILE_BIN|FILE_READ|FILE_SHARE_WRITE|FILE_SHARE_READ|flag)=1 / ok</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(XAUUSD,H1) Read[1]: 1629671658 (size=8, before=0(false), after=8)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) Written[2]: 1629671663</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(USDRUB,H1) *</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(USDRUB,H1) FileOpen(dataport,FILE_BIN|FILE_WRITE|FILE_SHARE_READ|flag)=-1 / CANNOT_OPEN_FILE(5004)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(USDRUB,H1) FileOpen(dataport,FILE_BIN|FILE_READ|FILE_SHARE_WRITE|FILE_SHARE_READ|flag)=1 / ok</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(USDRUB,H1) Read[1]: 1629671658 (size=16, before=0(false), after=8)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(USDRUB,H1) Read[2]: 1629671663 (size=16, before=8(false), after=16)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(XAUUSD,H1) Read[2]: 1629671663 (size=8, before=8(true), after=16)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) Written[3]: 1629671668</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(USDRUB,H1) Read[3]: 1629671668 (size=16, before=16(true), after=24)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(XAUUSD,H1) Read[3]: 1629671668 (size=8, before=16(true), after=24)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) Written[4]: 1629671673</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(USDRUB,H1) Read[4]: 1629671673 (size=16, before=24(true), after=32)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(XAUUSD,H1) Read[4]: 1629671673 (size=8, before=24(true), after=32)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(EURUSD,H1) Written[5]: 1629671678</span></span></code></pre></div><p>当在USDRUB上运行第三个脚本时，文件中已经有两条8字节的记录，所以内部循环立即对<code>FileReadLong</code>执行了两次迭代，并且文件大小 “看起来” 等于16。</p><h2 id="删除文件并检查其是否存在" tabindex="-1">删除文件并检查其是否存在 <a class="header-anchor" href="#删除文件并检查其是否存在" aria-label="Permalink to &quot;删除文件并检查其是否存在&quot;">​</a></h2><p>检查文件是否存在以及删除文件是与文件系统相关的关键操作，也就是说，这些操作与文件所处的外部环境有关。到目前为止，我们研究的是操作文件内部内容的函数。从本节开始，重点将转向那些把文件作为不可分割的单元进行管理的函数。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileIsExist</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">filename</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数检查名为<code>filename</code>的文件是否存在，如果存在则返回<code>true</code>。使用<code>flag</code>参数选择搜索目录：如果它的值为0（默认值），则在当前终端实例的目录（<code>MQL5/Files</code>）中搜索文件；如果<code>flag</code>等于<code>FILE_COMMON</code>，则检查所有终端的公共目录<code>Users/&lt;user&gt;...MetaQuotes/Terminal/Common/Files</code>。如果MQL程序在测试器中运行，工作目录位于测试器代理文件夹内（<code>Tester/&lt;agent&gt;/MQL5/Files</code>），请参阅 “文件操作” 章节的介绍部分。</p><p>指定的名称可能不是文件的名称，而是目录的名称。在这种情况下，<code>FileIsExist</code>函数将返回<code>false</code>，并且会在<code>_LastError</code>变量中记录一个伪错误5018（<code>FILE_IS_DIRECTORY</code>）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileDelete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">filename</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数删除指定名称为<code>filename</code>的文件。<code>flag</code>参数指定文件的位置。使用默认值时，删除操作在当前终端实例的工作目录（<code>MQL5/Files</code>）中执行，如果程序在测试器中运行，则在测试器代理的工作目录（<code>Tester/&lt;agent&gt;/MQL5/Files</code>）中执行。如果<code>flag</code>等于<code>FILE_COMMON</code>，则文件必须位于所有终端的公共文件夹（<code>/Terminal/Common/Files</code>）中。</p><p>该函数返回操作成功的标志（<code>true</code>）或错误标志（<code>false</code>）。</p><p>此函数不允许删除目录。要删除目录，请使用<code>FolderDelete</code>函数（请参阅 “文件夹操作”）。</p><p>为了了解上述函数的工作方式，我们将使用脚本<code>FileExist.mq5</code>。我们将对一个临时文件进行一些操作。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string filetemp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/temp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileIsExist</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filetemp));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // false / FILE_NOT_EXIST(5019)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileDelete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filetemp));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // false / FILE_NOT_EXIST(5019)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filetemp, FILE_TXT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_ANSI));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileIsExist</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filetemp));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileDelete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filetemp));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // false / CANNOT_DELETE_FILE(5006)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileIsExist</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filetemp));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileDelete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filetemp));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileIsExist</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filetemp));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // false / FILE_NOT_EXIST(5019)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileIsExist</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MQL5Book&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // false / FILE_IS_DIRECTORY(5018)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileDelete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MQL5Book&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // false / FILE_IS_DIRECTORY(5018)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>文件最初不存在，所以<code>FileIsExist</code>和<code>FileDelet</code>函数都返回<code>false</code>，错误代码为5019（<code>FILE_NOT_EXIST</code>）。</p><p>然后我们创建一个文件，<code>FileIsExist</code>函数报告该文件已存在。然而，此时无法删除该文件，因为它已被打开且被我们的进程占用（错误代码5006，<code>CANNOT_DELETE_FILE</code>）。</p><p>一旦文件关闭，就可以删除它了。</p><p>在脚本的最后，检查了“<code>MQL5Book</code>”目录并尝试删除它。<code>FileIsExist</code>返回<code>false</code>，因为它不是一个文件，不过错误代码5018（<code>FILE_IS_DIRECTORY</code>）表明它是一个目录。</p><h2 id="文件复制与移动" tabindex="-1">文件复制与移动 <a class="header-anchor" href="#文件复制与移动" aria-label="Permalink to &quot;文件复制与移动&quot;">​</a></h2><p>在文件系统层面，对文件的主要操作是复制和移动。为此，MQL5实现了两个原型相同的函数。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileCopy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">source</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> flag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">destination</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> mode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数将源文件复制到目标文件。上述两个参数既可以只包含文件名，也可以包含MQL5沙盒中的文件名及其前缀路径（文件夹层级结构）。<code>flag</code>和<code>mode</code>参数决定了在哪个工作文件夹中查找源文件以及目标工作文件夹是哪个：值为0表示是当前终端本地实例的文件夹（如果程序在测试器中运行，则是测试器代理的文件夹），值为<code>FILE_COMMON</code>表示是所有终端的公共文件夹。</p><p>此外，在<code>mode</code>参数中，你可以选择性地指定<code>FILE_REWRITE</code>常量（如果需要将<code>FILE_REWRITE</code>和<code>FILE_COMMON</code>组合使用，可以使用按位或运算符（|）来实现）。如果没有指定<code>FILE_REWRITE</code>，则禁止覆盖已存在的文件。换句话说，如果<code>destination</code>参数中指定路径和名称的文件已经存在，你必须通过设置<code>FILE_REWRITE</code>来确认你要覆盖它的意图。如果不这样做，函数调用将会失败。</p><p>函数在成功完成时返回<code>true</code>，出现错误时返回<code>false</code>。</p><p>如果源文件或目标文件被其他进程占用（已打开），复制操作可能会失败。</p><p>复制文件时，通常会保留其元数据（创建时间、访问权限、替代数据流）。如果你只需要对文件的数据进行 “纯粹” 的复制，可以连续调用<code>FileLoad</code>和<code>FileSave</code>函数，详见 “简化模式下的文件读写”。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileMove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">source</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> flag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">destination</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> mode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数用于移动或重命名文件。源文件的路径和名称在<code>source</code>参数中指定，目标文件的路径和名称在<code>destination</code>参数中指定。</p><p>参数列表及其操作原理与<code>FileCopy</code>函数相同。简单来说，<code>FileMove</code>函数的操作和<code>FileCopy</code>函数类似，但在成功复制后会额外删除原始文件。</p><p>下面我们通过脚本<code>FileCopy.mq5</code>来学习如何实际使用这些函数。该脚本有两个包含文件名的变量。脚本运行时，这两个文件都不存在。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string source </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/source&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string destination </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/destination&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>在<code>OnStart</code>函数中，我们按照一个简单的场景执行一系列操作。首先，我们尝试将源文件从本地工作文件夹复制到公共文件夹中的目标文件。不出所料，操作返回<code>false</code>，<code>_LastError</code>中的错误代码为5019（<code>FILE_NOT_EXIST</code>）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileCopy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(source, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, destination, FILE_COMMON));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // false / FILE_NOT_EXIST(5019)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span></code></pre></div><p>因此，我们将以常规方式创建一个源文件，写入一些数据并将其刷新到磁盘。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(source, FILE_TXT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FILE_WRITE));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileWriteString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Test Text</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 22</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileFlush</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle);</span></span></code></pre></div><p>由于文件处于打开状态，并且在打开时没有指定<code>FILE_SHARE_READ</code>权限，因此通过其他方式（绕过句柄）访问该文件仍然会被阻止。所以，下一次复制尝试仍将失败。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileCopy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(source, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, destination, FILE_COMMON));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // false / CANNOT_OPEN_FILE(5004)</span></span></code></pre></div><p>我们关闭文件并再次尝试。但首先，我们将生成文件的属性（创建时间和修改时间）输出到日志。这两个属性都会包含你计算机的当前时间戳。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileGetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(source, FILE_CREATE_DATE));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 例如：1629757115</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileGetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(source, FILE_MODIFY_DATE));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 例如：1629757115</span></span></code></pre></div><p>在调用<code>FileCopy</code>之前，我们等待3秒。这样可以让你看到原始文件和其副本在属性上的差异。这个暂停与之前文件被锁定无关：如果启用了<code>FILE_SHARE_READ</code>选项，我们可以在关闭文件后立即进行复制，甚至在写入文件时也可以进行复制。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>现在我们进行文件复制。这次操作成功了。让我们查看一下副本的属性。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileCopy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(source, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, destination, FILE_COMMON));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileGetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(destination, FILE_CREATE_DATE, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 例如：1629757118，比原始文件晚3秒</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileGetInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(destination, FILE_MODIFY_DATE, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 例如：1629757115</span></span></code></pre></div><p>每个文件都有自己的创建时间（副本的创建时间比原始文件晚3秒），但修改时间相同（副本继承了原始文件的属性）。</p><p>现在，我们尝试将副本移回本地文件夹。如果不使用<code>FILE_REWRITE</code>选项，操作将无法完成，因为没有权限覆盖原始文件。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileMove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(destination, FILE_COMMON, source, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // false / FILE_CANNOT_REWRITE(5020)</span></span></code></pre></div><p>通过更改参数值，我们可以成功完成文件移动。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileMove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(destination, FILE_COMMON, source, FILE_REWRITE));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // true</span></span></code></pre></div><p>最后，我们还会删除原始文件，以便为使用该脚本进行新的实验提供一个干净的环境。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileDelete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(source);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="文件和文件夹的搜索" tabindex="-1">文件和文件夹的搜索 <a class="header-anchor" href="#文件和文件夹的搜索" aria-label="Permalink to &quot;文件和文件夹的搜索&quot;">​</a></h2><p>MQL5允许你在终端沙盒、测试器代理以及所有终端的公共沙盒中搜索文件和文件夹（有关沙盒的更多详细信息，请参阅 “文件操作” 章节的介绍部分）。如果你确切知道所需文件/目录的名称和位置，请使用<code>FileIsExist</code>函数。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileFindFirst</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, string </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">found</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数根据传入的筛选条件开始搜索文件和文件夹。筛选条件可以包含沙盒内由子文件夹组成的路径，并且必须包含所搜索的文件系统元素的确切名称或名称模式。<code>filter</code>参数不能为空。</p><p>模式是一个包含一个或多个通配符的字符串。有两种类型的通配符：星号（<code>*</code>）可以替代任意数量的任意字符（包括零个字符），问号（<code>?</code>）最多可以替代一个任意字符。例如，筛选条件<code>*</code>将找到所有文件和文件夹，而<code>???.*</code>将只找到名称长度不超过3个字符的文件和文件夹，并且可以有扩展名也可以没有。可以使用<code>*.csv</code>筛选条件找到扩展名为<code>csv</code>的文件（但请注意，文件夹也可能有扩展名）。筛选条件<code>*.</code>可以找到没有扩展名的元素，而<code>.*</code>可以找到没有名称的元素。不过，这里需要记住以下几点。</p><p>在许多版本的Windows中，会为文件系统元素生成两种名称：长名称（默认情况下，最长可达260个字符）和短名称（采用从MS-DOS继承的8.3格式）。如果长名称超过8个字符或者扩展名长度超过3个字符，系统会自动从长名称生成短名称。如果没有软件使用短名称，系统可以禁用短名称的生成，但通常情况下短名称生成是启用的。</p><p>搜索会同时在这两种名称中进行，这就是为什么返回的列表中可能会包含一些乍一看出乎意料的元素。特别是，如果系统从长名称生成了短名称，那么短名称在点号之前总是包含一个最长为8个字符的初始部分。它可能会意外地与所需的模式匹配。</p><p>如果你需要查找具有多种扩展名的文件，或者名称中具有不同片段且无法用一种模式概括的文件，你将不得不使用不同的设置重复搜索过程几次。</p><p>搜索仅在特定文件夹中执行（如果筛选条件中没有路径，则在沙盒的根文件夹中搜索；如果筛选条件中包含路径，则在指定的子文件夹中搜索），并且不会深入到子目录中。</p><p>搜索不区分大小写。例如，对<code>*.txt</code>文件的搜索请求也会返回扩展名为<code>TXT</code>、<code>Txt</code>等的文件。</p><p>如果找到匹配名称的文件或文件夹，该名称将被放置在输出参数<code>found</code>中（需要一个变量，因为结果是通过引用传递的），并且函数会返回一个搜索句柄：如果有多个匹配项，需要将此句柄传递给<code>FileFindNext</code>函数，以便继续迭代匹配的项目。</p><p>在<code>found</code>参数中，只返回名称和扩展名，不包含可能在筛选条件中指定的路径（文件夹层级结构）。</p><p>如果找到的项目是一个文件夹，会在其名称右侧附加一个反斜杠（<code>\</code>）字符。</p><p><code>flag</code>参数允许在当前终端副本的本地工作文件夹（值为0）或所有终端的公共文件夹（值为<code>FILE_COMMON</code>）之间选择搜索区域。当MQL程序在测试器中执行时，其本地沙盒（值为0）位于测试器代理目录中。</p><p>在搜索过程完成后，应通过调用<code>FileFindClose</code>函数释放接收到的句柄（详见下文）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileFindNext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, string </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">found</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数继续搜索由<code>FileFindFirst</code>函数启动的合适的文件系统元素。第一个参数是从<code>FileFindFirst</code>函数接收到的描述符，通过它应用所有先前的搜索条件。</p><p>如果找到下一个元素，其名称将通过参数<code>found</code>传递给调用代码，并且函数返回<code>true</code>。</p><p>如果没有更多元素，函数返回<code>false</code>。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileFindClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数关闭作为调用<code>FileFindFirst</code>函数结果而接收到的搜索描述符。</p><p>在搜索过程完成后，必须调用此函数以释放系统资源。</p><p>作为一个示例，让我们看一下脚本<code>FileFind.mq5</code>。在前面的章节中，我们测试了许多其他脚本，这些脚本在目录<code>MQL5/Files/MQL5Book</code>中创建了文件。请求获取所有此类文件的列表。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   string found;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 接收变量</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 开始搜索并获取描述符 </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileFindFirst</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MQL5Book/*&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, found));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INVALID_HANDLE)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(found);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileFindNext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, found));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      FileFindClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>即使你已经清空了该目录，你也可以将本书附带的各种编码的示例文件复制到其中。因此，脚本<code>FileFind.mq5</code>至少应该输出以下列表（枚举顺序可能会有所不同）：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>ansi1252.txt</span></span>
<span class="line"><span>unicode1.txt</span></span>
<span class="line"><span>unicode2.txt</span></span>
<span class="line"><span>unicode3.txt</span></span>
<span class="line"><span>utf8.txt</span></span></code></pre></div><p>为了简化搜索过程，该脚本有一个辅助函数<code>DirList</code>。它包含对内置函数的所有必要调用，以及一个用于构建包含与筛选条件匹配的元素列表的字符串数组的循环。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DirList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, string </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> common </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">found</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileFindFirst</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filter, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">found</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INVALID_HANDLE) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArrayCopy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result, found, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArraySize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileFindNext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">found</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileFindClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>借助这个函数，我们将请求本地沙盒中的目录列表。为此，我们使用这样一个假设，即目录通常没有扩展名（理论上，情况并非总是如此，因此那些希望更严格地请求子文件夹列表的人应该以不同的方式实现）。对于没有扩展名的元素的筛选条件是<code>*.</code>（你可以在Windows shell中使用命令<code>dir *.*</code>进行检查）。然而，这个模式在MQL5函数中会导致错误5002（<code>WRONG_FILENAME</code>）。因此，我们将指定一个更 “模糊” 的模式<code>*.?</code>：它表示没有扩展名或扩展名长度为1个字符的元素。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   string list</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 尝试请求没有扩展名的元素</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // （在Windows命令行中有效）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DirList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;*.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, list));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // false / WRONG_FILENAME(5002)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 扩展条件：扩展名必须不超过1个字符</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DirList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;*.?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, list))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(list);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 例如：&quot;MQL5Book\&quot; &quot;Tester\&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>在我的MetaTrader 5实例中，该脚本找到了两个文件夹<code>MQL5Book\</code>和<code>Tester\</code>。如果你运行了前面的测试脚本，你也应该有第一个文件夹。</p><h2 id="文件夹操作" tabindex="-1">文件夹操作 <a class="header-anchor" href="#文件夹操作" aria-label="Permalink to &quot;文件夹操作&quot;">​</a></h2><p>很难想象一个文件系统不具备通过任意目录层级结构（用于存放逻辑相关文件集合的容器）来组织存储信息的能力。在MQL5层面，同样支持这一功能。如果有需要，我们可以使用内置函数<code>FolderCreate</code>、<code>FolderClean</code>和<code>FolderDelete</code>来创建、清理和删除文件夹。</p><p>早些时候，我们已经见过一种创建文件夹的方法，甚至可能不止一种，而是可以一次性创建出所需的整个子文件夹层级结构。为此，在使用<code>FileOpen</code>创建（打开）文件时，或者在复制文件（<code>FileCopy</code>、<code>FileMove</code>）时，不应只指定文件名，而应在文件名前加上所需的路径。例如：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileCopy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MQL5Book/unicode1.txt&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ABC/DEF/code.txt&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>这条语句将在沙盒中创建“<code>ABC</code>”文件夹，在“<code>ABC</code>”文件夹中创建“<code>DEF</code>”文件夹，并将文件以新名称复制到该文件夹中（源文件必须存在）。</p><p>如果你不想预先创建源文件，也可以在操作过程中创建一个虚拟文件：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   uchar dummy</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileSave</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ABC/DEF/empty&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, dummy);</span></span></code></pre></div><p>这样，我们将得到与前面示例相同的文件夹层级结构，但其中有一个大小为零的“<code>empty</code>”文件。</p><p>通过这些方法，文件夹的创建成为了文件操作的某种副产品。然而，有时需要将文件夹作为独立的实体进行操作，且不产生副作用，特别是只创建一个空文件夹。<code>FolderCreate</code>函数就提供了这样的功能。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FolderCreate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">folder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数创建名为<code>folder</code>的文件夹，<code>folder</code>可以包含路径（多个顶级文件夹名称）。无论哪种情况，都会在由<code>flag</code>参数定义的沙盒中创建单个文件夹或文件夹层级结构。默认情况下，当<code>flag</code>为0时，使用终端或测试器代理（如果程序在测试器中运行）的本地工作文件夹<code>MQL5/Files</code>。如果<code>flag</code>等于<code>FILE_COMMON</code>，则使用所有终端的共享文件夹。</p><p>函数在成功创建文件夹或文件夹已存在时返回<code>true</code>。出现错误时，结果为<code>false</code>。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FolderClean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">folder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数删除指定文件夹目录中任意嵌套级别的所有文件和文件夹（连同其所有内容）。<code>flag</code>参数指定操作发生的沙盒（本地或全局）。</p><p>使用此功能时要谨慎，因为所有文件和子文件夹（及其文件）都会被永久删除。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FolderDelete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">folder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数删除指定的文件夹（<code>folder</code>）。在调用该函数之前，文件夹必须为空，否则无法删除。</p><p>脚本<code>FileFolder.mq5</code>展示了使用这三个函数的方法。你可以在调试模式下逐步（逐语句）执行此脚本，并在文件管理器中观察文件夹和文件的出现与消失。不过请注意，在执行下一条指令之前，你应该使用文件管理器退出已创建的文件夹，直到“<code>MQL5Book</code>”层级，因为否则文件夹可能会被文件管理器占用，这将导致脚本运行出现问题。</p><p>我们首先通过向几个子文件夹中写入一个空的虚拟文件来创建这些子文件夹，将其作为文件操作的副产品。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string filename </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MQL5Book/ABC/DEF/dummy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   uchar dummy</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSave</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename, dummy));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // true</span></span></code></pre></div><p>接下来，我们使用<code>FolderCreate</code>函数在最低嵌套层级创建另一个文件夹：这次文件夹是独立创建的，没有借助辅助文件。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FolderCreate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MQL5Book/ABC/GHI&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // true</span></span></code></pre></div><p>如果你尝试删除“<code>DEF</code>”文件夹，操作将会失败，因为它不是空的（里面有一个文件）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FolderDelete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MQL5Book/ABC/DEF&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // false / CANNOT_DELETE_DIRECTORY(5024)</span></span></code></pre></div><p>为了删除它，必须先清空该文件夹，最简单的方法是使用<code>FolderClean</code>函数。但我们将尝试模拟一种常见情况，即正在清理的文件夹中的某些文件可能会被其他MQL程序、外部应用程序或终端本身锁定。我们打开文件进行读取，然后调用<code>FolderClean</code>函数。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename, FILE_READ));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FolderClean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MQL5Book/ABC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // false / CANNOT_CLEAN_DIRECTORY(5025)</span></span></code></pre></div><p>该函数返回<code>false</code>，并显示错误代码5025（<code>CANNOT_CLEAN_DIRECTORY</code>）。在我们关闭文件后，清理并删除整个文件夹层级结构的操作就成功了。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   FileClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handle);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FolderClean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MQL5Book/ABC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FolderDelete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MQL5Book/ABC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>当使用共享的终端目录时，更有可能出现潜在的锁定情况，因为在这种情况下，同一个文件或文件夹可能会被不同的程序实例“占用”。但即使在本地沙盒中，也不应忘记可能出现的冲突（例如，如果一个csv文件在Excel中被打开）。为处理文件夹的代码部分实现详细的诊断和错误输出，以便用户能够注意到并解决问题。</p><h2 id="文件或文件夹选择对话框" tabindex="-1">文件或文件夹选择对话框 <a class="header-anchor" href="#文件或文件夹选择对话框" aria-label="Permalink to &quot;文件或文件夹选择对话框&quot;">​</a></h2><p>在用于处理文件和文件夹的函数组中，有一个函数允许以交互方式向用户请求文件或文件夹的名称，以及一组文件的名称，以便将这些信息传递给MQL程序。调用<code>FileSelectDialog</code>函数会使终端中弹出一个标准的Windows文件和文件夹选择窗口。</p><p>由于在对话框关闭之前，它会中断MQL程序的执行，因此该函数仅允许在两种在单独线程中执行的MQL程序中调用：智能交易系统（EA）和脚本（请参阅“MQL程序的类型”）。在指标和服务中禁止使用此函数：指标在终端的界面线程中执行（停止指标会导致相应交易品种图表的更新冻结），而服务在后台执行，无法访问用户界面。</p><p>该函数所处理的文件系统的所有元素都位于沙盒内部，即在当前终端副本或测试代理（如果程序在测试器中运行）的目录下的<code>MQL5/Files</code>子文件夹中。</p><p>如果<code>flags</code>参数中存在<code>FSD_COMMON_FOLDER</code>标志（详见下文），则会使用所有终端的公共沙盒<code>Users/&lt;user&gt;...MetaQuotes/Terminal/Common/Files</code>。</p><p>对话框的外观取决于Windows操作系统。下面展示了一种可能的界面选项。</p><p>Windows文件和文件夹选择对话框</p><p>Windows文件和文件夹选择对话框</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileSelectDialog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">caption</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">initDir</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    uint</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> flags</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, string </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">filenames</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">defaultName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数显示一个标准的Windows对话框，用于打开或创建文件，或者选择文件夹。对话框的标题在<code>caption</code>参数中指定。如果该值为<code>NULL</code>，则使用标准标题：根据<code>flags</code>参数中的标志，读取文件时为“打开”，写入文件时为“另存为”，或者选择文件夹时为“选择文件夹”。</p><p><code>initDir</code>参数允许设置对话框打开时的初始文件夹。如果设置为<code>NULL</code>，将显示<code>MQL5/Files</code>文件夹的内容。如果在<code>initDir</code>中指定了一个不存在的路径，也会使用该文件夹。</p><p>使用<code>filter</code>参数，可以限制对话框中显示的文件扩展名集合。其他格式的文件将被隐藏。<code>NULL</code>表示没有限制。</p><p>筛选字符串的格式如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>&quot;&lt;描述1&gt;|&lt;扩展名1&gt;|&lt;描述2&gt;|&lt;扩展名2&gt;...&quot;</span></span></code></pre></div><p>描述可以是任何字符串。你可以编写任何筛选条件，其中的通配符<code>*</code>和<code>?</code>的用法与我们在“查找文件和文件夹”部分中讨论的作为扩展名时的用法相同。符号<code>|</code>是分隔符。</p><p>由于相邻的描述和扩展名构成了一个逻辑相关的对，所以字符串中的元素总数必须是偶数，分隔符的数量必须是奇数。</p><p>每个描述和扩展名的组合都会在对话框的下拉列表中生成一个单独的选项。描述会显示给用户，而扩展名用于筛选。</p><p>例如，<code>&quot;Text documents (*.txt)|*.txt|All files (*.*)|*.*&quot;</code>，并且第一个扩展名<code>&quot;Text documents (*.txt)|*.txt&quot;</code>将被选为默认文件类型。</p><p>在<code>flags</code>参数中，可以使用<code>|</code>运算符指定一个位掩码来设置操作模式。为其定义了以下常量：</p><ul><li><code>FSD_WRITE_FILE</code> — 文件写入模式（“另存为”）。如果不存在此标志，默认使用读取模式（“打开”）。如果存在此标志，无论<code>FSD_FILE_MUST_EXIST</code>标志如何，始终允许输入任意新名称。</li><li><code>FSD_SELECT_FOLDER</code> — 文件夹选择模式（只能选择一个且必须是已存在的文件夹）。使用此标志时，除<code>FSD_COMMON_FOLDER</code>标志外的所有其他标志将被忽略或导致错误。无法显式请求创建文件夹，但可以在对话框中以交互方式创建一个文件夹并立即选择它。</li><li><code>FSD_ALLOW_MULTISELECT</code> — 在读取模式下选择多个文件的权限。如果指定了<code>FSD_WRITE_FILE</code>或<code>FSD_SELECT_FOLDER</code>，则此标志将被忽略。</li><li><code>FSD_FILE_MUST_EXIST</code> — 所选文件必须存在。如果用户尝试指定一个任意名称，对话框将显示警告并保持打开状态。如果指定了<code>FSD_WRITE_FILE</code>模式，则此标志将被忽略。</li><li><code>FSD_COMMON_FOLDER</code> — 为所有客户端终端的公共沙盒打开对话框。</li></ul><p>该函数将用所选文件或文件夹的名称填充字符串数组<code>filenames</code>。如果数组是动态的，其大小会根据实际数据量进行调整，特别是如果没有选择任何内容，数组大小将扩展或截断为0。如果数组是固定大小的，它必须足够大以容纳预期的数据。否则，将发生错误4007（<code>ARRAY_RESIZE_ERROR</code>）。</p><p><code>defaultName</code>参数指定默认的文件/文件夹名称，该名称将在对话框打开后立即替换到相应的输入字段中。如果该参数为<code>NULL</code>，则该字段最初将为空。</p><p>如果设置了<code>defaultName</code>参数，那么在对MQL程序进行非可视化测试时，<code>FileSelectDialog</code>调用将返回1，并且<code>defaultName</code>的值将被复制到<code>filenames</code>数组中。</p><p>该函数返回所选项目的数量（如果用户未选择任何内容，则为0），如果出现错误则返回-1。</p><p>考虑一下在脚本<code>FileSelect.mq5</code>中该函数的工作示例。在<code>OnStart</code>函数中，我们将使用不同的设置依次调用<code>FileSelectDialog</code>。只要用户选择了某些内容（没有点击对话框中的“取消”按钮），测试就会一直进行到最后一步（即使函数执行时带有错误代码）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string filenames</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 适合任何调用的动态数组</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">fixed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 如果文件数量超过1个，这个固定数组就太小了</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stringfilter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 筛选条件示例</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &quot;Text documents (*.txt)|*.txt&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &quot;|Files with short names|????.*&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &quot;|All files (*.*)|*.*&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>首先，我们将要求用户从“<code>MQL5Book</code>”文件夹中选择一个文件。你可以选择一个已存在的文件，也可以输入一个新名称（因为没有<code>FSD_FILE_MUST_EXIST</code>标志）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Open a file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSelectDialog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MQL5book&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, filter, </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, filenames, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             // 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filenames);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                            // &quot;MQL5Book\utf8.txt&quot;</span></span></code></pre></div><p>假设该文件夹中至少有5个本书附带的文件，这里会选择其中一个。</p><p>然后，我们将以“用于写入”模式（带有<code>FSD_WRITE_FILE</code>标志）进行类似的请求。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Save as a file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSelectDialog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MQL5book&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      FSD_WRITE_FILE, filenames, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1 </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filenames);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                            // &quot;MQL5Book\newfile&quot;</span></span></code></pre></div><p>在这里，用户也将能够选择一个已存在的文件或输入一个新名称。程序员必须检查用户是否要覆盖一个已存在的文件（对话框不会生成警告）。</p><p>现在，让我们检查在动态数组中选择多个文件（<code>FSD_ALLOW_MULTISELECT</code>）的情况。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSelectDialog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MQL5book&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">     FSD_FILE_MUST_EXIST </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FSD_ALLOW_MULTISELECT, filenames, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filenames);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // &quot;MQL5Book\ansi1252.txt&quot; &quot;MQL5Book\unicode1.txt&quot; &quot;MQL5Book\unicode2.txt&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // &quot;MQL5Book\unicode3.txt&quot; &quot;MQL5Book\utf8.txt&quot;</span></span></code></pre></div><p><code>FSD_FILE_MUST_EXIST</code>标志的存在意味着如果尝试输入一个新名称，对话框将显示警告并保持打开状态。</p><p>如果我们尝试以类似的方式在固定大小的数组中选择多个文件，将会得到一个错误。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Open multiple files (fixed, choose more than 1 file for error)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSelectDialog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MQL5book&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      FSD_FILE_MUST_EXIST </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FSD_ALLOW_MULTISELECT, fixed, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // -1 / ARRAY_RESIZE_ERROR(4007)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fixed);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // null</span></span></code></pre></div><p>最后，让我们检查文件夹操作（<code>FSD_SELECT_FOLDER</code>）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Select a folder&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSelectDialog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MQL5book/nonexistent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      FSD_SELECT_FOLDER, filenames, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filenames);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // &quot;MQL5Book&quot;</span></span></code></pre></div><p>在这种情况下，指定了一个不存在的子文件夹“<code>nonexistent</code>”作为起始路径，因此对话框将在沙盒<code>MQL5/Files</code>的根目录中打开。我们在那里选择了“<code>MQL5book</code>”。</p><p>如果我们组合了无效的标志，将得到另一个错误。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FileSelectDialog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MQL5book&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      FSD_SELECT_FOLDER </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FSD_WRITE_FILE, filenames, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // -1 / INTERNAL_ERROR(4001)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filenames);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // &quot;MQL5Book&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>由于出现错误，该函数没有修改传递的数组，并且旧的“<code>MQL5Book</code>”元素仍然存在于其中。</p><p>在这个测试中，我们故意只检查结果是否为0，以便展示所有选项，而不管是否存在错误。在实际程序中，应考虑错误情况来检查函数的结果，即针对三种结果设置条件：已做出选择（&gt;0）、未做出选择（==0）和出现错误（&lt;0）。</p></div></div></main><footer class="VPDocFooter" data-v-c23ecb28 data-v-7e27a434><!--[--><!--]--><div class="edit-info" data-v-7e27a434><!----><div class="last-updated" data-v-7e27a434><p class="VPLastUpdated" data-v-7e27a434 data-v-205198a3>最近更新: <time datetime="2025-04-11T15:58:41.000Z" data-v-205198a3></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-7e27a434><span class="visually-hidden" id="doc-footer-aria-label" data-v-7e27a434>Pager</span><div class="pager" data-v-7e27a434><a class="VPLink link pager-link prev" href="/mq5_programming_for_traders/common_mql5_apis/mathematical_functions" data-v-7e27a434><!--[--><span class="desc" data-v-7e27a434>上一页</span><span class="title" data-v-7e27a434>数学函数</span><!--]--></a></div><div class="pager" data-v-7e27a434><a class="VPLink link pager-link next" href="/mq5_programming_for_traders/common_mql5_apis/client_terminal_global_variables" data-v-7e27a434><!--[--><span class="desc" data-v-7e27a434>下一页</span><span class="title" data-v-7e27a434>客户端全局变量</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-e8cbffd7 data-v-6afcd22d><div class="container" data-v-6afcd22d><!----><p class="copyright" data-v-6afcd22d>Copyright © 2025-present </p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"article_agile_dev.md\":\"NdNksZ5T\",\"article_common_custom.md\":\"B5sE08La\",\"article_eastore.md\":\"CgBIgP7m\",\"article_equity_control.md\":\"Cujy3psS\",\"article_index.md\":\"Wa4OTFCi\",\"article_insample_outsample.md\":\"DBA1X8xV\",\"article_judge_strategy.md\":\"CIsWPRY9\",\"article_kaufman.md\":\"DOUk4OXd\",\"article_market_pending.md\":\"DsJu6rft\",\"article_market_scan.md\":\"CbZmgwd4\",\"article_monte_carlo_simulate2.md\":\"Cm4k7L6d\",\"article_mt5_ontester.md\":\"Cj6T22Pr\",\"article_overfitting_underfitting.md\":\"Cb4ZpjNj\",\"article_parameter_optimization.md\":\"BX-0xMLY\",\"article_portfolio.md\":\"D4mA5Reo\",\"article_pre_live.md\":\"BzrhK6Dx\",\"article_quant_rank.md\":\"VrthFTFv\",\"article_rand_probability.md\":\"DLTTm8ny\",\"article_success_for_quant.md\":\"p_TcVXdX\",\"article_unify_price.md\":\"DzNrbUoq\",\"blog.md\":\"BBN8JdHd\",\"future_strategy_index copy.md\":\"BwvOy1hQ\",\"future_strategy_index.md\":\"CzDhk-dr\",\"future_strategy_indicator_desc_index.md\":\"B10rEjEo\",\"future_strategy_macd.md\":\"C-50_5JZ\",\"index.md\":\"CDNEFdtK\",\"metaeditor_development_ai_assistant.md\":\"Qh8YIGlY\",\"metaeditor_development_c_dll.md\":\"B4yoin-H\",\"metaeditor_development_compile.md\":\"DVRo-uoD\",\"metaeditor_development_debug.md\":\"B2d4Ifvu\",\"metaeditor_development_generate_mqh.md\":\"Xd75GVMe\",\"metaeditor_development_index.md\":\"DE5MTnWI\",\"metaeditor_development_intelligent_management.md\":\"CjVjq_8j\",\"metaeditor_development_mql5_cloud_protector.md\":\"6eq8xFFz\",\"metaeditor_development_opencl.md\":\"CdDUVMDo\",\"metaeditor_development_profiling.md\":\"Dr_qEn6W\",\"metaeditor_development_python.md\":\"7f90Ke0w\",\"metaeditor_development_source_code_find.md\":\"DwXw9-7w\",\"metaeditor_development_styler.md\":\"aeVj7YCs\",\"metaeditor_main_menu_index.md\":\"CsZfAngo\",\"metaeditor_main_menu_main_menu_build.md\":\"D7tch4dN\",\"metaeditor_main_menu_main_menu_debug.md\":\"C4wAN0Bw\",\"metaeditor_main_menu_main_menu_edit.md\":\"BSEzT4HX\",\"metaeditor_main_menu_main_menu_file.md\":\"QrFMmwOF\",\"metaeditor_main_menu_main_menu_help.md\":\"C_aMJIES\",\"metaeditor_main_menu_main_menu_search.md\":\"CxQ-4Oor\",\"metaeditor_main_menu_main_menu_tools.md\":\"DQ-Dq6TH\",\"metaeditor_main_menu_main_menu_view.md\":\"DT9pbEW0\",\"metaeditor_main_menu_main_menu_window.md\":\"DCukVq7K\",\"metaeditor_mql5_wizard_index.md\":\"QlxPeAXF\",\"metaeditor_mql5_wizard_wizard_class.md\":\"BF9hu16p\",\"metaeditor_mql5_wizard_wizard_ea.md\":\"_UMZQE5z\",\"metaeditor_mql5_wizard_wizard_ea_generate.md\":\"Dlscjoyf\",\"metaeditor_mql5_wizard_wizard_include.md\":\"DgWzXxuT\",\"metaeditor_mql5_wizard_wizard_indicator.md\":\"BBJ7J478\",\"metaeditor_mql5_wizard_wizard_library.md\":\"BrDnwfZU\",\"metaeditor_mql5_wizard_wizard_script.md\":\"2lUOgcbi\",\"metaeditor_mql5storage_index.md\":\"mBzBbcmN\",\"metaeditor_mql5storage_mql5storage_connect.md\":\"iYDMainN\",\"metaeditor_mql5storage_mql5storage_diff.md\":\"5lUIXKAz\",\"metaeditor_mql5storage_mql5storage_merging.md\":\"BeryPg52\",\"metaeditor_mql5storage_mql5storage_svn_client.md\":\"FoqAuE8g\",\"metaeditor_mql5storage_mql5storage_working.md\":\"YDC3CDPd\",\"metaeditor_mql5storage_projects.md\":\"CT-WuAj-\",\"metaeditor_other_articles.md\":\"C3GAEYxI\",\"metaeditor_other_index.md\":\"DavKqh0I\",\"metaeditor_other_machine_learning.md\":\"Dvp3_p2Y\",\"metaeditor_other_mql5_help.md\":\"Dp7_k9VZ\",\"metaeditor_other_mql5community.md\":\"Qpg-vGKy\",\"metaeditor_other_project_example.md\":\"Bx-DsCI8\",\"metaeditor_other_structure.md\":\"CbGZytYU\",\"metaeditor_other_video_guides.md\":\"DL2P45uj\",\"metaeditor_toolbar_index.md\":\"eth3Ai6A\",\"metaeditor_toolbar_toolbar_customize.md\":\"CWrpOwUr\",\"metaeditor_toolbar_toolbar_search.md\":\"6scXDOKF\",\"metaeditor_toolbar_toolbar_standard.md\":\"BiyIL1uY\",\"metaeditor_welcome_index.md\":\"By1rEzqW\",\"metaeditor_welcome_integration_ide.md\":\"BUY3d7Bq\",\"metaeditor_welcome_open.md\":\"Ck35TjWz\",\"metaeditor_welcome_settings.md\":\"BAxr8soh\",\"metaeditor_workspace_hotkeys.md\":\"Czdmqi5F\",\"metaeditor_workspace_index.md\":\"CmBJn6ZH\",\"metaeditor_workspace_navigator.md\":\"DJCLqPk6\",\"metaeditor_workspace_source_code_windows.md\":\"tnuTZsRk\",\"metaeditor_workspace_status_bar.md\":\"C13k-6hq\",\"metaeditor_workspace_toolbox.md\":\"CNRIQj54\",\"mq5_programming_for_traders_advanced_language_tools_conclusion.md\":\"0PwNZPNl\",\"mq5_programming_for_traders_advanced_language_tools_connection_of_binary_format_libraries.md\":\"hvpRSgQ9\",\"mq5_programming_for_traders_advanced_language_tools_cryptography.md\":\"BTyMSjhf\",\"mq5_programming_for_traders_advanced_language_tools_custom_symbol.md\":\"CLr1ZIzp\",\"mq5_programming_for_traders_advanced_language_tools_economic_calendar.md\":\"B-1BdDqs\",\"mq5_programming_for_traders_advanced_language_tools_index.md\":\"rtzvW4xP\",\"mq5_programming_for_traders_advanced_language_tools_native_python_support.md\":\"CAzzlsno\",\"mq5_programming_for_traders_advanced_language_tools_network_functions.md\":\"DGqpCXaq\",\"mq5_programming_for_traders_advanced_language_tools_opencl.md\":\"d-FLxv9t\",\"mq5_programming_for_traders_advanced_language_tools_projects.md\":\"CwYCSmY8\",\"mq5_programming_for_traders_advanced_language_tools_resources.md\":\"DdxIf_Gq\",\"mq5_programming_for_traders_advanced_language_tools_sqlite_database.md\":\"BJJ4vRXZ\",\"mq5_programming_for_traders_common_mql5_apis_built-in_type_conversions.md\":\"BJ8b8E40\",\"mq5_programming_for_traders_common_mql5_apis_client_terminal_global_variables.md\":\"CZJKm3Tr\",\"mq5_programming_for_traders_common_mql5_apis_functions_for_working_with_time.md\":\"DI4Huh6u\",\"mq5_programming_for_traders_common_mql5_apis_index.md\":\"Bxnf4t60\",\"mq5_programming_for_traders_common_mql5_apis_mathematical_functions.md\":\"v0RcZ8Bm\",\"mq5_programming_for_traders_common_mql5_apis_matrices_and_vectors.md\":\"BloYrgu5\",\"mq5_programming_for_traders_common_mql5_apis_mql_program_execution_environment.md\":\"BYy0lKsO\",\"mq5_programming_for_traders_common_mql5_apis_user_interaction.md\":\"brOfJ4xk\",\"mq5_programming_for_traders_common_mql5_apis_working_with_arrays.md\":\"4boikkon\",\"mq5_programming_for_traders_common_mql5_apis_working_with_files.md\":\"bYurQNDG\",\"mq5_programming_for_traders_common_mql5_apis_working_with_strings_and_symbols.md\":\"BHt6IaQ5\",\"mq5_programming_for_traders_creating_application_programs_creating_custom_indicators.md\":\"Cd6PXBEr\",\"mq5_programming_for_traders_creating_application_programs_general_principles.md\":\"CecaAjsK\",\"mq5_programming_for_traders_creating_application_programs_graphical_objects.md\":\"CeRDg33Q\",\"mq5_programming_for_traders_creating_application_programs_index.md\":\"DzjN0t2z\",\"mq5_programming_for_traders_creating_application_programs_interactive_events_on_charts.md\":\"DoWfUhJ-\",\"mq5_programming_for_traders_creating_application_programs_ready-made-indicators.md\":\"CdGrAok6\",\"mq5_programming_for_traders_creating_application_programs_script_and_services.md\":\"Ds6GQ7Mu\",\"mq5_programming_for_traders_creating_application_programs_timeseries.md\":\"DAOQf8DS\",\"mq5_programming_for_traders_creating_application_programs_working_with_charts.md\":\"C8ALaJ3W\",\"mq5_programming_for_traders_creating_application_programs_working_with_timer.md\":\"rKnhTcwB\",\"mq5_programming_for_traders_mql5_programming_fundamentals_arrays.md\":\"B7TDIA2N\",\"mq5_programming_for_traders_mql5_programming_fundamentals_built-in_data_types.md\":\"BJecBoo0\",\"mq5_programming_for_traders_mql5_programming_fundamentals_expresssions.md\":\"B2GKuwhl\",\"mq5_programming_for_traders_mql5_programming_fundamentals_function.md\":\"C4vnB2H3\",\"mq5_programming_for_traders_mql5_programming_fundamentals_identifiers.md\":\"BSg_2nhU\",\"mq5_programming_for_traders_mql5_programming_fundamentals_index.md\":\"DQ0B6ZTn\",\"mq5_programming_for_traders_mql5_programming_fundamentals_preprocessor.md\":\"B_k42HAk\",\"mq5_programming_for_traders_mql5_programming_fundamentals_statements.md\":\"CWk98WNh\",\"mq5_programming_for_traders_mql5_programming_fundamentals_type_conversion.md\":\"8_ZNUVGX\",\"mq5_programming_for_traders_mql5_programming_fundamentals_variables.md\":\"C7GVmurH\",\"mq5_programming_for_traders_object_oriented_programming_classes_and_interfaces.md\":\"CzU8_4ZT\",\"mq5_programming_for_traders_object_oriented_programming_common_mql5_apis.md\":\"D5XEbYZb\",\"mq5_programming_for_traders_object_oriented_programming_index.md\":\"BBkB91cc\",\"mq5_programming_for_traders_object_oriented_programming_structures_and_unions.md\":\"Dws_3Wfi\",\"mq5_programming_for_traders_object_oriented_programming_templates.md\":\"Bp5Vsu7i\",\"mq5_programming_for_traders_trading_automation_createing_expert_advisors.md\":\"B8KWDu4f\",\"mq5_programming_for_traders_trading_automation_depth_of_market.md\":\"CJua2CZk\",\"mq5_programming_for_traders_trading_automation_financial_instruments_and_market_watch.md\":\"B9RlHY5U\",\"mq5_programming_for_traders_trading_automation_index.md\":\"DcVCA3Xb\",\"mq5_programming_for_traders_trading_automation_testing_and_optimization_of_expert_advisors.md\":\"LG4RxcmA\",\"mq5_programming_for_traders_trading_automation_trading_account_information.md\":\"CHmQrrmp\",\"mq5_programming_for_traders_welcome_assignment_and_initialization.md\":\"CdLaVmgo\",\"mq5_programming_for_traders_welcome_data_input.md\":\"B5W5WYJv\",\"mq5_programming_for_traders_welcome_data_output.md\":\"DcGmnzpC\",\"mq5_programming_for_traders_welcome_data_types_and_values.md\":\"Dv6hAERD\",\"mq5_programming_for_traders_welcome_editing_compiling_running.md\":\"BA3EGcZg\",\"mq5_programming_for_traders_welcome_error_fixing_and_debugging.md\":\"BN8lpIjA\",\"mq5_programming_for_traders_welcome_first_program.md\":\"oXez6HUu\",\"mq5_programming_for_traders_welcome_formatting.md\":\"D5ebtoBn\",\"mq5_programming_for_traders_welcome_index.md\":\"BrRXkeMt\",\"mq5_programming_for_traders_welcome_introduction_to_mql5.md\":\"BvM3hfTq\",\"mq5_programming_for_traders_welcome_mini_summary.md\":\"BSHljDGF\",\"mq5_programming_for_traders_welcome_mql5_programming_fundamentals.md\":\"BsoDEGck\",\"mq5_programming_for_traders_welcome_mql_wizard.md\":\"CwvlpJdf\",\"mq5_programming_for_traders_welcome_statements.md\":\"KkeQ-Bou\",\"mq5_programming_for_traders_welcome_variables_and_identifiers.md\":\"C9lxFFVr\",\"mt5_ctp_quick_start_account_info.md\":\"B9SED1s5\",\"mt5_ctp_quick_start_close_position.md\":\"Bgc6e1PS\",\"mt5_ctp_quick_start_index.md\":\"Cf9LfOhP\",\"mt5_ctp_quick_start_open_position.md\":\"CC2GwVxz\",\"mt5_ctp_quick_start_position_info.md\":\"fOBh3mYY\",\"mt5_quick_start_advance_konwledge_avoid_overfitting.md\":\"CYXUcurC\",\"mt5_quick_start_advance_konwledge_correlation_factor.md\":\"Df2TVMr3\",\"mt5_quick_start_advance_konwledge_evaluation_function.md\":\"CRTpSWij\",\"mt5_quick_start_advance_konwledge_high_quality_data.md\":\"BCe0ZMc_\",\"mt5_quick_start_advance_konwledge_index.md\":\"DfrB40VA\",\"mt5_quick_start_advance_konwledge_market_scan.md\":\"D6OwrfeJ\",\"mt5_quick_start_advance_konwledge_monte_carlo_simulate.md\":\"D5Psab6X\",\"mt5_quick_start_advance_konwledge_multiple_symbol_ea.md\":\"CqeHZuaj\",\"mt5_quick_start_advance_konwledge_oop.md\":\"Ce16Qf4A\",\"mt5_quick_start_advance_konwledge_optimize.md\":\"CBp1MtPi\",\"mt5_quick_start_advance_konwledge_strategy_portfolio_manage.md\":\"jMZCKkG3\",\"mt5_quick_start_advance_konwledge_unify_price.md\":\"Cdd48RSR\",\"mt5_quick_start_advance_konwledge_wfa.md\":\"CBVZld5V\",\"mt5_quick_start_basic_grammar_control.md\":\"DXrWevAk\",\"mt5_quick_start_basic_grammar_data_type.md\":\"bvOOK_9s\",\"mt5_quick_start_basic_grammar_ea_composition.md\":\"kmz5f2uL\",\"mt5_quick_start_basic_grammar_expression.md\":\"CFp45n45\",\"mt5_quick_start_basic_grammar_function.md\":\"DCw0nVWK\",\"mt5_quick_start_basic_grammar_index.md\":\"BcwriF-p\",\"mt5_quick_start_basic_grammar_variable.md\":\"Di2Z9VyK\",\"mt5_quick_start_classic_strategy_contrarian_rsi_ma.md\":\"DlhSlLhW\",\"mt5_quick_start_classic_strategy_donchian_channel.md\":\"B11B0XL9\",\"mt5_quick_start_classic_strategy_ichimoku.md\":\"DmyK-iRD\",\"mt5_quick_start_classic_strategy_index.md\":\"BW01Mahg\",\"mt5_quick_start_classic_strategy_london_break.md\":\"DRPmVjE5\",\"mt5_quick_start_classic_strategy_td9_trend.md\":\"B_au5RI6\",\"mt5_quick_start_classic_strategy_triple_screen.md\":\"BzqrpBO4\",\"mt5_quick_start_first_real_ea_complete_code.md\":\"D4pYUMXn\",\"mt5_quick_start_first_real_ea_index.md\":\"Cui2l2y2\",\"mt5_quick_start_first_real_ea_indicator_data.md\":\"DXNoqidi\",\"mt5_quick_start_first_real_ea_open_detail.md\":\"DPcf3iSx\",\"mt5_quick_start_first_real_ea_param_check.md\":\"CfhNaSL3\",\"mt5_quick_start_first_real_ea_risk_manage.md\":\"CI_1yN-i\",\"mt5_quick_start_indicator_tools_calendar.md\":\"Dx-u1-9h\",\"mt5_quick_start_indicator_tools_donchian_channel.md\":\"C6UdoYsl\",\"mt5_quick_start_indicator_tools_full_period_indicator_monitor.md\":\"Cg3E4P32\",\"mt5_quick_start_indicator_tools_index.md\":\"T8_hH-X4\",\"mt5_quick_start_indicator_tools_oncaclulate.md\":\"DZXrMONa\",\"mt5_quick_start_indicator_tools_oscillator.md\":\"D6fbQis8\",\"mt5_quick_start_indicator_tools_price_intensive.md\":\"BJeQg57_\",\"mt5_quick_start_indicator_tools_squeeze.md\":\"B1fRjKOy\",\"mt5_quick_start_welcome_cfd_advantage.md\":\"CsSTntXp\",\"mt5_quick_start_welcome_index.md\":\"Dm1LgN2p\",\"mt5_quick_start_welcome_mt5_ide.md\":\"CzMr1ovT\",\"mt5_quick_start_welcome_mt5_indroduce.md\":\"C270Qr91\",\"mt5_quick_start_welcome_outline.md\":\"CNBRu7CX\",\"mt5_strategy_boll.md\":\"eqNfyQD_\",\"mt5_strategy_bolla.md\":\"YcT5JBd3\",\"mt5_strategy_contrarian_by_rsi_ma.md\":\"Dn6YJGtY\",\"mt5_strategy_debug.md\":\"Bw_RG2JV\",\"mt5_strategy_divergent_oscillation.md\":\"V2TZ7D3X\",\"mt5_strategy_eldtriplescreen.md\":\"CH1Y_PM0\",\"mt5_strategy_frequency_trading_index.md\":\"Cs1h0vax\",\"mt5_strategy_ichimokutrendflow.md\":\"gCCidq-w\",\"mt5_strategy_indicator_donchianchannel.md\":\"K_A0QSae\",\"mt5_strategy_indicator_oncalculate.md\":\"B5Cf0q34\",\"mt5_strategy_londonbreakout.md\":\"DAjUgWpG\",\"mt5_strategy_macd.md\":\"DWTPDJMP\",\"mt5_strategy_martingale_index.md\":\"iVGMVdJI\",\"mt5_strategy_martingale_martingale_reverse.md\":\"BofDE7Js\",\"mt5_strategy_nr4.md\":\"27flp7Jg\",\"mt5_strategy_panel_calendar.md\":\"na0kHjPa\",\"mt5_strategy_permission_verification.md\":\"1kPC8vuY\",\"mt5_strategy_price_action_index.md\":\"B8lljuXe\",\"mt5_strategy_risk_monitor.md\":\"BwkEkhLf\",\"mt5_strategy_strategy_quant_x.md\":\"BWvNaPfT\",\"mt5_strategy_td9_trend_flow_stop_order.md\":\"DTeyzVMU\",\"mt5_strategy_trend_follow_index.md\":\"C2G7sYAc\",\"mt5_strategy_trend_follow_triple_screen.md\":\"DG8iv4YS\",\"readme.md\":\"iYUHVd_-\",\"strategy_square_index.md\":\"BTD_WV_L\",\"team.md\":\"Cxg2soeu\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"专业投机策略\",\"description\":\"迎接新的时代\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":false,\"themeConfig\":{\"logo\":\"/logo.svg\",\"lastUpdated\":{\"text\":\"最近更新\"},\"outline\":{\"label\":\"本页目录\",\"level\":[2,3]},\"search\":{\"provider\":\"local\",\"options\":{\"translations\":{\"button\":{\"buttonText\":\"搜索\",\"buttonAriaLabel\":\"搜索\"},\"modal\":{\"footer\":{\"selectText\":\"选择\",\"navigateText\":\"切换\",\"closeText\":\"关闭\"}}}}},\"docFooter\":{\"prev\":\"上一页\",\"next\":\"下一页\"},\"footer\":{\"copyright\":\"Copyright © 2025-present \"},\"socialLinks\":[{\"icon\":\"tiktok\",\"link\":\"https://www.douyin.com/user/MS4wLjABAAAAVb-2dWdStZkPrNrzAGkHhhquMun5zaNAUsNPN166PCA\"},{\"icon\":\"bilibili\",\"link\":\"https://space.bilibili.com/485926738\"},{\"icon\":\"wechat\",\"link\":\"#wechat\"}],\"nav\":[{\"text\":\"策略广场\",\"link\":\"/strategy_square/\",\"activeMatch\":\"/strategy_square/\"},{\"text\":\"外盘策略\",\"items\":[{\"text\":\"趋势跟踪\",\"link\":\"/mt5_strategy/trend_follow/\"},{\"text\":\"马丁格尔\",\"link\":\"/mt5_strategy/martingale/\"},{\"text\":\"高频交易\",\"link\":\"/mt5_strategy/frequency_trading/\"}]},{\"text\":\"期货策略\",\"link\":\"/future_strategy/\",\"activeMatch\":\"/future_strategy/\"},{\"text\":\"MT5编辑器\",\"items\":[{\"text\":\"欢迎来到算法交易\",\"link\":\"/metaeditor/welcome/\"},{\"text\":\"主菜单\",\"link\":\"/metaeditor/main_menu/\"},{\"text\":\"工具栏\",\"link\":\"/metaeditor/toolbar/\"},{\"text\":\"工作区\",\"link\":\"/metaeditor/workspace/\"},{\"text\":\"MQL5存储\",\"link\":\"/metaeditor/mql5storage/\"},{\"text\":\"MQL4/MQL5 向导\",\"link\":\"/metaeditor/mql5_wizard/\"},{\"text\":\"开发程序\",\"link\":\"/metaeditor/development/\"},{\"text\":\"其它\",\"link\":\"/metaeditor/other/\"}]},{\"text\":\"MQL5快速入门\",\"items\":[{\"text\":\"初步认识\",\"link\":\"/mt5_quick_start/welcome/\"},{\"text\":\"基础语法\",\"link\":\"/mt5_quick_start/basic_grammar/\"},{\"text\":\"第一个EA\",\"link\":\"/mt5_quick_start/first_real_ea/\"},{\"text\":\"进阶知识\",\"link\":\"/mt5_quick_start/advance_konwledge/\"},{\"text\":\"经典策略\",\"link\":\"/mt5_quick_start/classic_strategy/\"},{\"text\":\"指标工具\",\"link\":\"/mt5_quick_start/indicator_tools/\"}]},{\"text\":\"MQL5官方教程\",\"items\":[{\"text\":\"开始\",\"link\":\"/mq5_programming_for_traders/welcome/\"},{\"text\":\"MQL5编程基础\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/\"},{\"text\":\"面向对象\",\"link\":\"/mq5_programming_for_traders/object_oriented_programming/\"},{\"text\":\"常用API\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/\"},{\"text\":\"在 MQL5 中创建应用程序\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/\"},{\"text\":\"交易自动化\",\"link\":\"/mq5_programming_for_traders/trading_automation/\"},{\"text\":\"MQL5高级工具\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/\"}]},{\"text\":\"经典文章\",\"link\":\"/article/\",\"activeMatch\":\"/article/\"}],\"sidebar\":{\"/mt5_strategy/\":[{\"text\":\"趋势跟踪\",\"items\":[{\"text\":\"RSI + MA\",\"link\":\"/mt5_strategy/trend_follow/\"},{\"text\":\"三重滤网\",\"link\":\"/mt5_strategy/trend_follow/triple_screen\"}]},{\"text\":\"马丁格尔\",\"items\":[{\"text\":\"通用马丁\",\"link\":\"/mt5_strategy/martingale/\"},{\"text\":\"顺势反手马丁\",\"link\":\"/mt5_strategy/martingale/martingale_reverse\"}]},{\"text\":\"高频交易\",\"items\":[{\"text\":\"剥头皮\",\"link\":\"/mt5_strategy/frequency_trading/\"}]},{\"text\":\"价格行为\",\"items\":[{\"text\":\"双底双顶\",\"link\":\"/mt5_strategy/price_action/\"}]}],\"/future_strategy/\":[{\"collapsed\":true,\"text\":\"趋势跟踪\",\"items\":[{\"text\":\"布林线\",\"link\":\"/future_strategy/\"},{\"text\":\"MACD\",\"link\":\"/future_strategy/macd\"},{\"text\":\"指标说明\",\"link\":\"/future_strategy/indicator_desc\"}]}],\"/article/\":[{\"collapsed\":true,\"text\":\"量化\",\"items\":[{\"text\":\"梁文锋2019年演讲\",\"link\":\"/article/\"},{\"text\":\"桥水基金雷·达里奥\",\"link\":\"/article/portfolio\"},{\"text\":\"量化交易的段位\",\"link\":\"/article/quant_rank\"},{\"text\":\"解决策略过度拟合\",\"link\":\"/article/insample_outsample\"},{\"text\":\"挂单和市价单区别\",\"link\":\"/article/market_pending\"},{\"text\":\"EA商店\",\"link\":\"/article/eastore\"},{\"text\":\"评估策略是否有盈利能力\",\"link\":\"/article/judge_strategy\"},{\"text\":\"通用策略和定制策略\",\"link\":\"/article/common_custom\"},{\"text\":\"量化成功的要点\",\"link\":\"/article/success_for_quant\"},{\"text\":\"使用走完的K线\",\"link\":\"/article/unify_price\"},{\"text\":\"实盘前的准备\",\"link\":\"/article/pre_live\"},{\"text\":\"佩里·考夫曼\",\"link\":\"/article/kaufman\"},{\"text\":\"自定义统计结果\",\"link\":\"/article/mt5_ontester\"},{\"text\":\"概率优势与随机幸运\",\"link\":\"/article/rand_probability\"},{\"text\":\"量化策略的敏捷开发\",\"link\":\"/article/agile_dev\"},{\"text\":\"净值曲线控制\",\"link\":\"/article/equity_control\"}]}],\"/metaeditor/\":[{\"collapsed\":true,\"text\":\"欢迎来到算法交易\",\"items\":[{\"text\":\"开始\",\"link\":\"/metaeditor/welcome/\"},{\"text\":\"启动\",\"link\":\"/metaeditor/welcome/open\"},{\"text\":\"设置\",\"link\":\"/metaeditor/welcome/settings\"},{\"text\":\"与其它开发环境整合\",\"link\":\"/metaeditor/welcome/integration_ide\"}]},{\"collapsed\":true,\"text\":\"主菜单\",\"items\":[{\"text\":\"摘要\",\"link\":\"/metaeditor/main_menu/\"},{\"text\":\"文件\",\"link\":\"/metaeditor/main_menu/main_menu_file\"},{\"text\":\"编辑\",\"link\":\"/metaeditor/main_menu/main_menu_edit\"},{\"text\":\"搜索\",\"link\":\"/metaeditor/main_menu/main_menu_search\"},{\"text\":\"视图\",\"link\":\"/metaeditor/main_menu/main_menu_view\"},{\"text\":\"调试\",\"link\":\"/metaeditor/main_menu/main_menu_debug\"},{\"text\":\"构建\",\"link\":\"/metaeditor/main_menu/main_menu_build\"},{\"text\":\"工具\",\"link\":\"/metaeditor/main_menu/main_menu_tools\"},{\"text\":\"窗口\",\"link\":\"/metaeditor/main_menu/main_menu_window\"},{\"text\":\"帮助\",\"link\":\"/metaeditor/main_menu/main_menu_help\"}]},{\"collapsed\":true,\"text\":\"工具栏\",\"items\":[{\"text\":\"摘要\",\"link\":\"/metaeditor/toolbar/\"},{\"text\":\"标准\",\"link\":\"/metaeditor/toolbar/toolbar_standard\"},{\"text\":\"搜索\",\"link\":\"/metaeditor/toolbar/toolbar_search\"},{\"text\":\"安装\",\"link\":\"/metaeditor/toolbar/toolbar_customize\"}]},{\"collapsed\":true,\"text\":\"工作区\",\"items\":[{\"text\":\"摘要\",\"link\":\"/metaeditor/workspace/\"},{\"text\":\"导航\",\"link\":\"/metaeditor/workspace/navigator\"},{\"text\":\"工具箱\",\"link\":\"/metaeditor/workspace/toolbox\"},{\"text\":\"状态栏\",\"link\":\"/metaeditor/workspace/status_bar\"},{\"text\":\"操作窗口\",\"link\":\"/metaeditor/workspace/source_code_windows\"},{\"text\":\"热键\",\"link\":\"/metaeditor/workspace/hotkeys\"}]},{\"collapsed\":true,\"text\":\"MQL5存储\",\"items\":[{\"text\":\"摘要\",\"link\":\"/metaeditor/mql5storage/\"},{\"text\":\"启用存储\",\"link\":\"/metaeditor/mql5storage/mql5storage_connect\"},{\"text\":\"创建并操作项目\",\"link\":\"/metaeditor/mql5storage/projects\"},{\"text\":\"操控存储\",\"link\":\"/metaeditor/mql5storage/mql5storage_working\"},{\"text\":\"查看项目历史\",\"link\":\"/metaeditor/mql5storage/mql5storage_diff\"},{\"text\":\"合并修改\",\"link\":\"/metaeditor/mql5storage/mql5storage_merging\"},{\"text\":\"外部 Subversion 客户端\",\"link\":\"/metaeditor/mql5storage/mql5storage_svn_client\"}]},{\"collapsed\":true,\"text\":\"MQL4/MQL5 向导\",\"items\":[{\"text\":\"摘要\",\"link\":\"/metaeditor/mql5_wizard/\"},{\"text\":\"创建 EA 模板\",\"link\":\"/metaeditor/mql5_wizard/wizard_ea\"},{\"text\":\"创建成品智能交易系统\",\"link\":\"/metaeditor/mql5_wizard/wizard_ea_generate\"},{\"text\":\"创建指标\",\"link\":\"/metaeditor/mql5_wizard/wizard_indicator\"},{\"text\":\"创建脚本\",\"link\":\"/metaeditor/mql5_wizard/wizard_script\"},{\"text\":\"创建函数库\",\"link\":\"/metaeditor/mql5_wizard/wizard_library\"},{\"text\":\"创建包含文件\",\"link\":\"/metaeditor/mql5_wizard/wizard_include\"},{\"text\":\"创建类\",\"link\":\"/metaeditor/mql5_wizard/wizard_class\"}]},{\"collapsed\":true,\"text\":\"开发程序\",\"items\":[{\"text\":\"摘要\",\"link\":\"/metaeditor/development/\"},{\"text\":\"智能管理\",\"link\":\"/metaeditor/development/intelligent_management\"},{\"text\":\"查找和替换\",\"link\":\"/metaeditor/development/source_code_find\"},{\"text\":\"格式化\",\"link\":\"/metaeditor/development/styler\"},{\"text\":\"编译\",\"link\":\"/metaeditor/development/compile\"},{\"text\":\"MQL5 云端保护: 为程序提供先进的保护\",\"link\":\"/metaeditor/development/mql5_cloud_protector\"},{\"text\":\"代码调试\",\"link\":\"/metaeditor/development/debug\"},{\"text\":\"代码分析\",\"link\":\"/metaeditor/development/profiling\"},{\"text\":\"AI Assistant编码助手\",\"link\":\"/metaeditor/development/ai_assistant\"},{\"text\":\"生成头文件\",\"link\":\"/metaeditor/development/generate_mqh\"},{\"text\":\"调用 C++ 的 DLL (与 MS Visual Studio 集成)\",\"link\":\"/metaeditor/development/c_dll\"},{\"text\":\"使用Python\",\"link\":\"/metaeditor/development/python\"},{\"text\":\"OpenCL 支持\",\"link\":\"/metaeditor/development/opencl\"}]},{\"collapsed\":true,\"text\":\"其它\",\"items\":[{\"text\":\"SQL数据库操作\",\"link\":\"/metaeditor/other/\"},{\"text\":\"使用机器学习模型\",\"link\":\"/metaeditor/other/machine_learning\"},{\"text\":\"程序开发示例\",\"link\":\"/metaeditor/other/project_example\"},{\"text\":\"MetaEditor 环境文件夹\",\"link\":\"/metaeditor/other/structure\"},{\"text\":\"MQL5 社区: 交易者的社区\",\"link\":\"/metaeditor/other/mql5community\"},{\"text\":\"内置帮助\",\"link\":\"/metaeditor/other/mql5_help\"},{\"text\":\"有关开发交易应用程序的文章\",\"link\":\"/metaeditor/other/article\"},{\"text\":\"交易平台指南视频\",\"link\":\"/metaeditor/other/video_guides\"}]}],\"/mq5_programming_for_traders/\":[{\"text\":\"开始\",\"items\":[{\"text\":\"大纲\",\"link\":\"/mq5_programming_for_traders/welcome/\"},{\"text\":\"简介\",\"link\":\"/mq5_programming_for_traders/welcome/introduction_to_mql5\"},{\"text\":\"编辑编译运行\",\"link\":\"/mq5_programming_for_traders/welcome/editing_compiling_running\"},{\"text\":\"MQL向导\",\"link\":\"/mq5_programming_for_traders/welcome/mql_wizard\"},{\"text\":\"语句代码块函数\",\"link\":\"/mq5_programming_for_traders/welcome/statements\"},{\"text\":\"第一个程序\",\"link\":\"/mq5_programming_for_traders/welcome/first_program\"},{\"text\":\"数据类型和值\",\"link\":\"/mq5_programming_for_traders/welcome/data_types_and_values\"},{\"text\":\"变量和标识符\",\"link\":\"/mq5_programming_for_traders/welcome/variables_and_identifiers\"},{\"text\":\"赋值和初始化\",\"link\":\"/mq5_programming_for_traders/welcome/assignment_and_initialization\"},{\"text\":\"数据输入\",\"link\":\"/mq5_programming_for_traders/welcome/data_input\"},{\"text\":\"修复错误和调试\",\"link\":\"/mq5_programming_for_traders/welcome/error_fixing_and_debugging\"},{\"text\":\"数据输出\",\"link\":\"/mq5_programming_for_traders/welcome/data_output\"},{\"text\":\"格式化\",\"link\":\"/mq5_programming_for_traders/welcome/formatting\"},{\"text\":\"迷你小结\",\"link\":\"/mq5_programming_for_traders/welcome/mini_summary\"}]},{\"text\":\"MQL5编程基础\",\"collapsed\":true,\"items\":[{\"text\":\"简介\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/\"},{\"text\":\"标识符\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/identifiers/\"},{\"text\":\"内置数据类型\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/built-in_data_types/\"},{\"text\":\"变量\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/variables/\"},{\"text\":\"数组\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/arrays/\"},{\"text\":\"表达式\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/expresssions/\"},{\"text\":\"类型转换\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/type_conversion/\"},{\"text\":\"语句\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/statements/\"},{\"text\":\"函数\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/function/\"},{\"text\":\"预处理\",\"link\":\"/mq5_programming_for_traders/mql5_programming_fundamentals/preprocessor/\"}]},{\"text\":\"面向对象\",\"collapsed\":true,\"items\":[{\"text\":\"简介\",\"link\":\"/mq5_programming_for_traders/object_oriented_programming/\"},{\"text\":\"结构体和联合体\",\"link\":\"/mq5_programming_for_traders/object_oriented_programming/structures_and_unions\"},{\"text\":\"类和接口\",\"link\":\"/mq5_programming_for_traders/object_oriented_programming/classes_and_interfaces\"},{\"text\":\"模板\",\"link\":\"/mq5_programming_for_traders/object_oriented_programming/templates\"}]},{\"text\":\"常用API\",\"collapsed\":true,\"items\":[{\"text\":\"简介\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/\"},{\"text\":\"内置类型转换\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/built-in_type_conversions\"},{\"text\":\"字符串和符号处理\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/working_with_strings_and_symbols\"},{\"text\":\"数组操作\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/working_with_arrays\"},{\"text\":\"数学函数\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/mathematical_functions\"},{\"text\":\"文件操作\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/working_with_files\"},{\"text\":\"客户端全局变量\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/client_terminal_global_variables\"},{\"text\":\"时间相关函数\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/functions_for_working_with_time\"},{\"text\":\"用户交互\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/user_interaction\"},{\"text\":\"MQL 程序执行环境\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/mql_program_execution_environment\"},{\"text\":\"矩阵和向量\",\"link\":\"/mq5_programming_for_traders/common_mql5_apis/matrices_and_vectors\"}]},{\"text\":\"在 MQL5 中创建应用程序\",\"collapsed\":true,\"items\":[{\"text\":\"简介\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/\"},{\"text\":\"一般原则\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/general_principles\"},{\"text\":\"脚本和服务\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/script_and_services\"},{\"text\":\"时间序列\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/timeseries\"},{\"text\":\"自定义指标\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/creating_custom_indicators\"},{\"text\":\"自带指标\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/ready-made-indicators\"},{\"text\":\"定时器的使用\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/working_with_timer\"},{\"text\":\"图表操作\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/working_with_charts\"},{\"text\":\"图表对象\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/graphical_objects\"},{\"text\":\"图表上的交互式事件\",\"link\":\"/mq5_programming_for_traders/creating_application_programs/interactive_events_on_charts\"}]},{\"text\":\"交易自动化\",\"collapsed\":true,\"items\":[{\"text\":\"简介\",\"link\":\"/mq5_programming_for_traders/trading_automation/\"},{\"text\":\"金融工具与市场报价\",\"link\":\"/mq5_programming_for_traders/trading_automation/financial_instruments_and_market_watch\"},{\"text\":\"市场深度\",\"link\":\"/mq5_programming_for_traders/trading_automation/depth_of_market\"},{\"text\":\"交易账户信息\",\"link\":\"/mq5_programming_for_traders/trading_automation/trading_account_information\"},{\"text\":\"创建智能交易顾问\",\"link\":\"/mq5_programming_for_traders/trading_automation/createing_expert_advisors\"},{\"text\":\"专家顾问的测试和优化\",\"link\":\"/mq5_programming_for_traders/trading_automation/testing_and_optimization_of_expert_advisors\"}]},{\"text\":\"MQL5高级工具\",\"collapsed\":true,\"items\":[{\"text\":\"简介\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/\"},{\"text\":\"资源\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/resources\"},{\"text\":\"自定义交易品种\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/custom_symbol\"},{\"text\":\"经济日历\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/economic_calendar\"},{\"text\":\"密码学\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/cryptography\"},{\"text\":\"网络函数\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/network_functions\"},{\"text\":\"SQLite 数据库\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/sqlite_database\"},{\"text\":\"二进制格式库的开发与连接\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/connection_of_binary_format_libraries\"},{\"text\":\"项目\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/projects\"},{\"text\":\"原生python支持\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/native_python_support\"},{\"text\":\"opencl\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/opencl\"},{\"text\":\"总结\",\"link\":\"/mq5_programming_for_traders/advanced_language_tools/conclusion\"}]}],\"/mt5_quick_start/\":[{\"text\":\"初步认识\",\"items\":[{\"text\":\"介绍\",\"link\":\"/mt5_quick_start/welcome/\"},{\"text\":\"大纲\",\"link\":\"/mt5_quick_start/welcome/outline\"},{\"text\":\"CFD优势\",\"link\":\"/mt5_quick_start/welcome/cfd_advantage\"},{\"text\":\"认识MT5\",\"link\":\"/mt5_quick_start/welcome/mt5_indroduce\"},{\"text\":\"开发环境配置\",\"link\":\"/mt5_quick_start/welcome/mt5_ide\"}]},{\"text\":\"基础语法\",\"items\":[{\"text\":\"注释 标识符 保留字\",\"link\":\"/mt5_quick_start/basic_grammar/\"},{\"text\":\"数据类型\",\"link\":\"/mt5_quick_start/basic_grammar/data_type\"},{\"text\":\"表达式\",\"link\":\"/mt5_quick_start/basic_grammar/expression\"},{\"text\":\"EA的组成\",\"link\":\"/mt5_quick_start/basic_grammar/ea_composition\"},{\"text\":\"变量\",\"link\":\"/mt5_quick_start/basic_grammar/variable\"},{\"text\":\"控制语句\",\"link\":\"/mt5_quick_start/basic_grammar/control\"},{\"text\":\"函数\",\"link\":\"/mt5_quick_start/basic_grammar/function\"}]},{\"text\":\"第一个EA\",\"items\":[{\"text\":\"标准库 外部输入\",\"link\":\"/mt5_quick_start/first_real_ea/\"},{\"text\":\"4种资金管理方式\",\"link\":\"/mt5_quick_start/first_real_ea/risk_manage\"},{\"text\":\"指标数据\",\"link\":\"/mt5_quick_start/first_real_ea/indicator_data\"},{\"text\":\"开仓细节\",\"link\":\"/mt5_quick_start/first_real_ea/open_detail\"},{\"text\":\"完整代码\",\"link\":\"/mt5_quick_start/first_real_ea/complete_code\"}]},{\"text\":\"进阶知识\",\"items\":[{\"text\":\"常见异常\",\"link\":\"/mt5_quick_start/advance_konwledge/\"},{\"text\":\"高质量历史数据\",\"link\":\"/mt5_quick_start/advance_konwledge/high_quality_data\"},{\"text\":\"统一喂价模式\",\"link\":\"/mt5_quick_start/advance_konwledge/unify_price\"},{\"text\":\"策略组合管理\",\"link\":\"/mt5_quick_start/advance_konwledge/strategy_portfolio_manage\"},{\"text\":\"面相对象\",\"link\":\"/mt5_quick_start/advance_konwledge/oop\"},{\"text\":\"多品种EA\",\"link\":\"/mt5_quick_start/advance_konwledge/multiple_symbol_ea\"},{\"text\":\"策略优化\",\"link\":\"/mt5_quick_start/advance_konwledge/optimize\"},{\"text\":\"市场扫描\",\"link\":\"/mt5_quick_start/advance_konwledge/market_scan\"},{\"text\":\"避免过度拟合\",\"link\":\"/mt5_quick_start/advance_konwledge/avoid_overfitting\"},{\"text\":\"WFA推进分析\",\"link\":\"/mt5_quick_start/advance_konwledge/wfa\"},{\"text\":\"蒙特卡洛模拟\",\"link\":\"/mt5_quick_start/advance_konwledge/monte_carlo_simulate\"},{\"text\":\"评价函数\",\"link\":\"/mt5_quick_start/advance_konwledge/evaluation_function\"}]},{\"text\":\"经典策略\",\"items\":[{\"text\":\"高噪声震荡策略\",\"link\":\"/mt5_quick_start/classic_strategy/\"},{\"text\":\"一目均衡云\",\"link\":\"/mt5_quick_start/classic_strategy/ichimoku\"},{\"text\":\"伦敦突破\",\"link\":\"/mt5_quick_start/classic_strategy/london_break\"},{\"text\":\"三重滤网\",\"link\":\"/mt5_quick_start/classic_strategy/triple_screen\"},{\"text\":\"趋势反转\",\"link\":\"/mt5_quick_start/classic_strategy/contrarian_rsi_ma\"},{\"text\":\"风险控制\",\"link\":\"/mt5_quick_start/classic_strategy/risk_monitor\"},{\"text\":\"TD序列\",\"link\":\"/mt5_quick_start/classic_strategy/td9_trend\"},{\"text\":\"唐奇安通道\",\"link\":\"/mt5_quick_start/classic_strategy/donchian_channel\"}]},{\"text\":\"指标工具\",\"items\":[{\"text\":\"风控控制\",\"link\":\"/mt5_quick_start/indicator_tools/\"},{\"text\":\"onCalculate\",\"link\":\"/mt5_quick_start/indicator_tools/oncaclulate\"},{\"text\":\"唐奇安通道指标\",\"link\":\"/mt5_quick_start/indicator_tools/donchian_channel\"},{\"text\":\"价格密度指标\",\"link\":\"/mt5_quick_start/indicator_tools/price_intensive\"},{\"text\":\"挤压指标\",\"link\":\"/mt5_quick_start/indicator_tools/squeeze\"},{\"text\":\"乖离震荡器\",\"link\":\"/mt5_quick_start/indicator_tools/oscillator\"},{\"text\":\"全周期指标监控\",\"link\":\"/mt5_quick_start/indicator_tools/full_period_indicator_monitor\"},{\"text\":\"财经日历\",\"link\":\"/mt5_quick_start/indicator_tools/calendar\"}]}],\"/mt5_ctp/\":[{\"text\":\"零基础教程\",\"items\":[{\"text\":\"初识\",\"link\":\"/mt5_ctp/quick_start/\"},{\"text\":\"账户\",\"link\":\"/mt5_ctp/quick_start/account_info\"},{\"text\":\"持仓\",\"link\":\"/mt5_ctp/quick_start/position_info\"},{\"text\":\"开仓\",\"link\":\"/mt5_ctp/quick_start/open_position\"},{\"text\":\"平仓\",\"link\":\"/mt5_ctp/quick_start/close_position\"}]},{\"text\":\"马丁格尔\",\"items\":[{\"text\":\"通用马丁\",\"link\":\"/mt5_ctp/martingale/\"}]}]}},\"locales\":{\"root\":{\"label\":\"简体中文\"}},\"scrollOffset\":134,\"cleanUrls\":true}");</script>
    
  </body>
</html>