import{_ as a,c as n,ag as i,j as l,o as t}from"./chunks/framework.CCnnzLsu.js";const g=JSON.parse('{"title":"MT5 CTP基础函数：平仓、撤单、计算保证金","description":"","frontmatter":{"head":[["link",{"rel":"canonical","href":"https://vite.dev/mt5_ctp/quick_start/close_position"}],["meta",{"property":"og:title","content":"MT5 CTP基础函数：平仓、撤单、计算保证金"}]]},"headers":[],"relativePath":"mt5_ctp/quick_start/close_position.md","filePath":"mt5_ctp/quick_start/close_position.md","lastUpdated":null}'),h={name:"mt5_ctp/quick_start/close_position.md"};function k(p,s,e,r,E,d){return t(),n("div",null,s[0]||(s[0]=[i(`<h1 id="mt5-ctp基础函数-平仓、撤单、计算保证金" tabindex="-1">MT5 CTP基础函数：平仓、撤单、计算保证金 <a class="header-anchor" href="#mt5-ctp基础函数-平仓、撤单、计算保证金" aria-label="Permalink to &quot;MT5 CTP基础函数：平仓、撤单、计算保证金&quot;">​</a></h1><h2 id="一、理论概念-order、position与deal" tabindex="-1">一、理论概念：Order、Position与Deal <a class="header-anchor" href="#一、理论概念-order、position与deal" aria-label="Permalink to &quot;一、理论概念：Order、Position与Deal&quot;">​</a></h2><ol><li><p><strong>Order（报单/订单）</strong><br> 向市场发出的交易请求，无论是否成交，只要发出即成为一个Order。例如挂单未成交时仍属于Order。</p></li><li><p><strong>Position（持仓/头寸）</strong><br> 成交后的Order形成持仓，是实际持有的仓位。多头持仓为“Long Position”，空头持仓为“Short Position”。</p><ul><li>经典案例：《股票大作手回忆录》中“不可失去Position”强调持仓对趋势交 易的重要性。</li><li>关键关系：所有Position均来自成交的Order，未成交的Order为挂单。</li></ul></li><li><p><strong>Deal（成交）</strong><br> 订单成交的结果，MT5中可理解为持仓（Position）与挂单（未成交Order）的区分。</p></li></ol><h2 id="二、平仓操作-position-close" tabindex="-1">二、平仓操作（Position Close） <a class="header-anchor" href="#二、平仓操作-position-close" aria-label="Permalink to &quot;二、平仓操作（Position Close）&quot;">​</a></h2><h3 id="_1-遍历持仓并定位" tabindex="-1">1. 遍历持仓并定位 <a class="header-anchor" href="#_1-遍历持仓并定位" aria-label="Permalink to &quot;1. 遍历持仓并定位&quot;">​</a></h3><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;T5CTP/T5CTP.mqh&gt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 引入MT5 CTP库</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CTrade trade;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 交易对象</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pos_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PositionsTotal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 获取持仓总数</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 倒序遍历避免删除时索引混乱</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pos_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">--</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        CPosition pos;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pos.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SelectByIndex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 按索引选中持仓</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ulong ticket </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pos.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Ticket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 获取持仓唯一标识Ticket</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 筛选目标品种（如螺纹钢RB2301）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        string symbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pos.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (symbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;RB2301&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            trade.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PositionClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ticket);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 平仓指定持仓</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_2-关键逻辑" tabindex="-1">2. 关键逻辑 <a class="header-anchor" href="#_2-关键逻辑" aria-label="Permalink to &quot;2. 关键逻辑&quot;">​</a></h3><ul><li><strong>倒序遍历</strong>：删除持仓时，正序遍历可能导致索引错位（如删除第0号后，原第1号变为新第0号），倒序操作更安全。</li><li><strong>条件筛选</strong>：通过品种（Symbol）、魔术码（Magic Number）等条件过滤目标持仓，避免误平其他合约。</li></ul><h2 id="三、撤单操作-order-delete" tabindex="-1">三、撤单操作（Order Delete） <a class="header-anchor" href="#三、撤单操作-order-delete" aria-label="Permalink to &quot;三、撤单操作（Order Delete）&quot;">​</a></h2><h3 id="_1-处理未成交挂单" tabindex="-1">1. 处理未成交挂单 <a class="header-anchor" href="#_1-处理未成交挂单" aria-label="Permalink to &quot;1. 处理未成交挂单&quot;">​</a></h3><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CancelOrders</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CTrade trade;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> order_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OrdersTotal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 获取挂单总数</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> order_total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">--</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        COrder order;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">order.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SelectByIndex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 按索引选挂单</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ulong ticket </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> order.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Ticket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 获取挂单Ticket</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 筛选目标品种</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        string symbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> order.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (symbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;RB2301&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            trade.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">OrderDelete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ticket);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 撤销指定挂单</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_2-注意事项" tabindex="-1">2. 注意事项 <a class="header-anchor" href="#_2-注意事项" aria-label="Permalink to &quot;2. 注意事项&quot;">​</a></h3><ul><li>挂单（Order）未成交时占用资金，撤单后释放资金以便重新挂单或开仓。</li><li>同样采用倒序遍历避免索引错误，结合品种或策略条件精准撤单。</li></ul><h2 id="四、保证金计算" tabindex="-1">四、保证金计算 <a class="header-anchor" href="#四、保证金计算" aria-label="Permalink to &quot;四、保证金计算&quot;">​</a></h2><h3 id="_1-计算公式" tabindex="-1">1. 计算公式 <a class="header-anchor" href="#_1-计算公式" aria-label="Permalink to &quot;1. 计算公式&quot;">​</a></h3>`,15),l("p",{保证金比例:""},"\\[\\text{保证金} = \\text{昨结算价} \\times \\text{合约乘数} \\times \\text\\]",-1),i(`<ul><li><strong>昨结算价</strong>：期货特有的结算价，用于计算当日保证金（非实时最新价）。</li><li><strong>合约乘数</strong>：每手合约对应的标的数量（如螺纹钢每手10吨，生猪每手16吨）。</li><li><strong>保证金比例</strong>：期货公司规定的比例（多头/空头可能不同，通常取多头比例）。</li></ul><h3 id="_2-代码实现" tabindex="-1">2. 代码实现 <a class="header-anchor" href="#_2-代码实现" aria-label="Permalink to &quot;2. 代码实现&quot;">​</a></h3><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CalculateMargin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">string</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CSymbolInfo sym;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sym.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 选中目标合约</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> last_settlement </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sym.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PriceSettlement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 昨结算价</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> contract_size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sym.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ContractSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 合约乘数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> margin_ratio </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sym.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MarginLongRatio</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 多头保证金比例</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> last_settlement </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> contract_size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> margin_ratio;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="五、总结" tabindex="-1">五、总结 <a class="header-anchor" href="#五、总结" aria-label="Permalink to &quot;五、总结&quot;">​</a></h2><ol><li><strong>平仓</strong>：通过遍历持仓，筛选条件（品种、魔术码等）后调用<code>PositionClose</code>。</li><li><strong>撤单</strong>：遍历未成交挂单，条件筛选后调用<code>OrderDelete</code>。</li><li><strong>保证金计算</strong>：基于昨结算价、合约乘数、保证金比例三项乘积，需正确获取合约基础信息。</li></ol><p><strong>最佳实践</strong>：</p><ul><li>严谨的程序化交易需加入异常处理（如持仓/挂单不存在时的容错）。</li><li>郭老师MT5 CTP库已封装底层逻辑，用户可聚焦策略层条件筛选与业务逻辑。</li></ul><p>通过以上操作，可实现从开仓到平仓/撤单的完整闭环，结合保证金计算优化仓位管理，为策略开发奠定基础。</p>`,8)]))}const y=a(h,[["render",k]]);export{g as __pageData,y as default};
