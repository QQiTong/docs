import{_ as i,c as a,aI as n,o as h}from"./chunks/framework.b7dag8kZ.js";const g=JSON.parse('{"title":"时间序列","description":"","frontmatter":{"head":[["link",{"rel":"canonical","href":"https://vite.dev/mq5_programming_for_traders/creating_application_programs/timeseries"}],["meta",{"property":"og:title","content":"时间序列"}]]},"headers":[],"relativePath":"mq5_programming_for_traders/creating_application_programs/timeseries.md","filePath":"mq5_programming_for_traders/creating_application_programs/timeseries.md","lastUpdated":1744387121000}'),k={name:"mq5_programming_for_traders/creating_application_programs/timeseries.md"};function t(p,s,l,e,E,d){return h(),a("div",null,s[0]||(s[0]=[n(`<h1 id="时间序列" tabindex="-1">时间序列 <a class="header-anchor" href="#时间序列" aria-label="Permalink to &quot;时间序列&quot;">​</a></h1><p>时间序列是数据数组，其中元素的索引对应于有序的时间样本。由于交易终端的应用特性，交易者所需的几乎所有信息都以时间序列的形式提供。具体来说，这些信息包括报价数组、报价点数组、技术指标读数数组等。绝大多数的MQL程序也处理这些数据，因此在MQL5 API中有一组专门用于处理它们的函数，我们将在本节中进行探讨。</p><p>在MQL5中，访问数组的方式使开发者能够设置两种索引方向之一：</p><ul><li><strong>正常（正向）</strong>：元素的编号从数组的开头到结尾（从旧的数据到新的数据）。</li><li><strong>反向（时间序列）</strong>：编号从数组的结尾到开头（从新的数据到旧的数据）。</li></ul><p>我们已经在“数组索引方向（如时间序列）”部分讨论过这个问题。</p><p>使用<code>ArraySetAsSeries</code>函数来更改索引模式，这不会影响数组在内存中的物理布局。只是通过编号访问元素的方式发生了变化：在正常索引中，我们通过<code>array[i]</code>获取第<code>i</code>个元素，而在时间序列模式下，等效的公式是<code>array[N - i - 1]</code>，其中<code>N</code>是数组的大小（之所以称为“等效”，是因为应用程序开发者无需在各处进行这样的重新计算，因为如果为数组设置了时间序列索引模式，终端会自动进行此操作）。下表（对于一个包含10个元素的字符数组）对此进行了说明。</p><table tabindex="0"><thead><tr><th>数组元素</th><th>A</th><th>B</th><th>C</th><th>D</th><th>E</th><th>F</th><th>G</th><th>H</th><th>I</th><th>J</th></tr></thead><tbody><tr><td>常规索引</td><td>0</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td></tr><tr><td>时间序列索引</td><td>9</td><td>8</td><td>7</td><td>6</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td>0</td></tr></tbody></table><p>请记住，数组索引总是从0开始。</p><p>当涉及到报价数组和其他不断更新的数据时，新元素会物理地附加到数组的末尾。然而，从交易的角度来看，在分析历史数据时，应该考虑最新的数据并将其作为起点。这就是为什么将当前（最后一个）K线置于索引0下，并从它开始往过去计算之前的K线是很方便的。这样，我们就得到了时间序列索引。</p><p>默认情况下，数组是从左到右进行索引的。如果我们想象这样一个数组显示在标准的MetaTrader 5图表上，那么从视觉上看，索引为0的元素将位于最左边的位置，而最后一个元素位于最右边的位置。在反向索引的时间序列中，第0个元素对应于最右边的位置，而最后一个元素对应于最左边的位置。由于时间序列存储了金融工具价格数据相对于时间的历史记录，其中最新的数据总是在旧数据的右边。</p><p>时间序列数组中索引为零的元素包含有关最新品种报价的信息。零号K线通常是不完整的，因为它还在继续形成中。</p><p>报价时间序列的另一个特征是其周期，即相邻读数之间的时间间隔。这个周期也称为“时间框架”，可以更精确地表述。时间框架是形成一根报价K线的时间段，其开始和结束在绝对时间上以相同的步长对齐。例如，在“1小时”（H1）时间框架中，K线严格在每天每小时的0分钟开始。每个这样的时间段的开始包含在当前K线中，而结束属于下一根K线。</p><p>“品种和时间框架”章节提供了标准时间框架的完整列表。</p><p>通常，在时间序列概念的框架内，技术指标的缓冲区也会起作用，但我们将在后面研究它们的特点。</p><p>如有必要，在任何MQL程序中，您都可以请求任何品种和时间框架的时间序列值，以及为任何品种和时间框架计算的指标值。通过使用<code>Copy</code>函数来获取这些数据，其中有几个函数可以分别读取不同类型的价格数组（例如，开盘价、最高价、最低价、收盘价），或者读取包含每根K线所有特征的<code>MqlRates</code>结构数组。</p><h2 id="k线和报价点" tabindex="-1">K线和报价点 <a class="header-anchor" href="#k线和报价点" aria-label="Permalink to &quot;K线和报价点&quot;">​</a></h2><p>除了带有报价的K线之外，MetaTrader 5还为用户和MQL程序提供了分析报价点的能力，报价点是基本的价格变化，K线就是基于这些报价点构建的。每个报价点包含精确到毫秒的时间、几种类型的价格（买价、卖价、最新价）、描述变化本质的标志以及交易的成交量。我们将在稍后的“处理真实报价点数组”章节中研究相应的<code>MqlTick</code>结构。</p><p>根据交易品种的类型，K线可以基于买价或最新价来构建。特别是，对于交易所交易品种，有最新价可用，这些品种还会广播市场深度价格。对于非交易所交易品种，如外汇或差价合约，使用买价。</p><p>没有价格变化的时间段不会生成K线。这就是MetaTrader 5中价格的呈现方式。例如，如果时间框架等于1天（D1），那么通常周末没有几根K线，星期五之后直接就是星期一。</p><p>如果在相应的时间间隔内至少发生了一个报价点，就会出现一根报价K线。同时，K线的开盘时间总是严格与时间段边界对齐，即使第一个报价点到达的时间较晚（通常就是这样）。例如，如果在午夜后的4分钟内没有报价点，然后在00:05:15（即第五分钟的第15秒）发生了价格变化，那么当天的第一根M1 K线可能会在00:05形成。因此，一个报价点根据以下时间戳的关系被包含在特定的K线中：<code>Topen &lt;=Ttick &lt; Topen + P</code>，其中<code>Topen</code>是K线的开盘时间，<code>Ttick</code>是报价点的时间，<code>Topen + P</code>是在时间段<code>P</code>之后下一个潜在K线的开盘时间（之所以称为“潜在”K线，是因为它的存在取决于其他报价点）。</p><h2 id="交易品种和时间框架" tabindex="-1">交易品种和时间框架 <a class="header-anchor" href="#交易品种和时间框架" aria-label="Permalink to &quot;交易品种和时间框架&quot;">​</a></h2><p>带有报价的时间序列由两个参数来确定：交易品种名称（金融工具）和时间框架（周期）。</p><p>用户可以在“市场报价”窗口中查看交易品种列表，并根据经纪商提供的总列表（“交易品种”对话框）对其进行编辑。对于MQL程序，有一组函数可用于执行相同的操作：在所有交易品种中搜索、了解它们的属性，以及在“市场报价”中添加或删除交易品种。这些功能将在单独的章节中进行讨论。</p><p>然而，要请求时间序列，只需知道交易品种的名称即可——这是一个包含现有金融工具标识的字符串。例如，它可以由用户在输入变量中设置。此外，当前图表的交易品种可以通过内置变量<code>_Symbol</code>（或<code>Symbol</code>函数）找到，但为了方便起见，所有时间序列函数都支持这样的约定：<code>NULL</code>值也对应于当前图表的交易品种。</p><p>现在让我们来谈谈时间框架。系统中定义了21种标准时间框架：每种时间框架都由特殊枚举<code>ENUM_TIMEFRAMES</code>中的一个元素指定。</p><table tabindex="0"><thead><tr><th>标识符</th><th>值（十六进制）</th><th>描述</th></tr></thead><tbody><tr><td><code>PERIOD_CURRENT</code></td><td>0</td><td>当前图表周期</td></tr><tr><td><code>PERIOD_M1</code></td><td>1 (0x1)</td><td>1分钟</td></tr><tr><td><code>PERIOD_M2</code></td><td>2 (0x2)</td><td>2分钟</td></tr><tr><td><code>PERIOD_M3</code></td><td>3 (0x3)</td><td>3分钟</td></tr><tr><td><code>PERIOD_M4</code></td><td>4 (0x4)</td><td>4分钟</td></tr><tr><td><code>PERIOD_M5</code></td><td>5 (0x5)</td><td>5分钟</td></tr><tr><td><code>PERIOD_M6</code></td><td>6 (0x6)</td><td>6分钟</td></tr><tr><td><code>PERIOD_M10</code></td><td>10 (0xA)</td><td>10分钟</td></tr><tr><td><code>PERIOD_M12</code></td><td>12 (0xC)</td><td>12分钟</td></tr><tr><td><code>PERIOD_M15</code></td><td>15 (0xF)</td><td>15分钟</td></tr><tr><td><code>PERIOD_M20</code></td><td>20 (0x14)</td><td>20分钟</td></tr><tr><td><code>PERIOD_M30</code></td><td>30 (0x1E)</td><td>30分钟</td></tr><tr><td><code>PERIOD_H1</code></td><td>16385 (0x4001)</td><td>1小时</td></tr><tr><td><code>PERIOD_H2</code></td><td>16386 (0x4002)</td><td>2小时</td></tr><tr><td><code>PERIOD_H3</code></td><td>16387 (0x4003)</td><td>3小时</td></tr><tr><td><code>PERIOD_H4</code></td><td>16388 (0x4004)</td><td>4小时</td></tr><tr><td><code>PERIOD_H6</code></td><td>16390 (0x4006)</td><td>6小时</td></tr><tr><td><code>PERIOD_H8</code></td><td>16392 (0x4008)</td><td>8小时</td></tr><tr><td><code>PERIOD_H12</code></td><td>16396 (0x400C)</td><td>12小时</td></tr><tr><td><code>PERIOD_D1</code></td><td>16408 (0x4018)</td><td>1天</td></tr><tr><td><code>PERIOD_W1</code></td><td>32769 (0x8001)</td><td>1周</td></tr><tr><td><code>PERIOD_MN1</code></td><td>49153 (0xC001)</td><td>1个月</td></tr></tbody></table><p>正如我们在“预定义变量”部分中看到的，程序可以通过内置变量<code>_Period</code>（或<code>Period</code>函数）了解当前图表的周期。从值这一列中很容易看出，将零传递给接受时间框架的内置函数意味着当前图表的周期。</p><p>对于分钟时间框架，其值与其中的分钟数相同（例如，30表示M30）。对于小时时间框架，设置了0x4000位，并且低字节包含小时数（例如，H3为0x4003）。日周期D1编码为24小时，即0x4018（0x18等于24）。最后，周时间框架和月时间框架分别有自己的区分位0x8000和0xC000作为单位指示符，并且在这两种情况下计数（在低字节中）均为1。</p><p>为了方便地将枚举元素转换为字符串以及反向转换，本书附带了一个头文件<code>Periods.mqh</code>（我们已经在文件操作示例中使用过它，并且将在未来的示例中继续使用）。它的一个函数<code>StringToPeriod</code>在其算法中使用了上述枚举元素内部位表示的特征。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PERIOD_PREFIX_LENGTH</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 7</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // StringLen(&quot;PERIOD_&quot;)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 获取不带“PERIOD_”前缀的周期缩写名称</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">string </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PeriodToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ENUM_TIMEFRAMES tf </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PERIOD_CURRENT)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prefix </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StringLen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;PERIOD_&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StringSubstr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">EnumToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tf </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PERIOD_CURRENT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _Period </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tf),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      PERIOD_PREFIX_LENGTH);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 通过完整名称（如PERIOD_H4）或短名称（如H4）获取周期值</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ENUM_TIMEFRAMES </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringToPeriod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringLen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 如果需要，将完整名称“PERIOD_TN”转换为短名称“TN”</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringLen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PERIOD_PREFIX_LENGTH)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">     name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StringSubstr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name, PERIOD_PREFIX_LENGTH);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 将数字结尾“N”转换为数字，跳过“T”</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringToInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringSubstr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 清除可能的错误WRONG_STRING_PARAMETER(5040)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 例如，如果输入字符串是“MN1”，那么对于StringToInteger来说，N1不是一个数字</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ResetLastError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;M&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">count) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PERIOD_MN1;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ENUM_TIMEFRAMES)count;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;H&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ENUM_TIMEFRAMES)(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">0x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;D&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PERIOD_D1;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;W&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PERIOD_W1;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>请注意，<code>_Symbol</code>和<code>_Period</code>变量仅在在图表上运行的MQL程序（包括脚本、智能交易系统和指标）中包含实际数据。在服务中，这些变量为空，因此，要访问时间序列，必须显式设置交易品种名称和周期，或者以某种方式从外部获取它们。</p><p>时间框架的定义属性是其持续时间（K线持续时间）。MQL5允许使用<code>PeriodSeconds</code>函数获取构成特定时间框架一根K线的秒数。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PeriodSeconds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ENUM_TIMEFRAMES period </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PERIOD_CURRENT)</span></span></code></pre></div><p><code>period</code>参数将周期指定为<code>ENUM_TIMEFRAMES</code>枚举的一个元素。如果未指定该参数，则返回程序正在运行的当前图表周期的秒数。</p><p>我们将在“等待数据和管理可见性”部分的指标<code>IndDeltaVolume.mq5</code>中，以及“使用内置指标”部分的指标<code>UseM1MA.mq5</code>中考虑使用该函数的示例。</p><p>为了生成未包含在指定列表中的非标准持续时间的时间框架，MQL5 API提供了自定义交易品种，但是，如果不修改智能交易系统，它们不允许像在标准图表上那样进行交易。</p><p>此外，需要注意的是，在MetaTrader 5中，特定时间序列内或图表上的K线持续时间始终是相同的。因此，要构建K线不是根据时间形成，而是随着其他参数（特别是成交量（等量图））的积累或价格沿一个方向以固定步长移动（砖形图）而形成的图表，可以基于指标（例如，使用<code>DRAW_CANDLES</code>或<code>DRAW_BARS</code>渲染类型）或使用自定义交易品种开发自己的解决方案。</p><h2 id="时间序列组织和存储的技术方面" tabindex="-1">时间序列组织和存储的技术方面 <a class="header-anchor" href="#时间序列组织和存储的技术方面" aria-label="Permalink to &quot;时间序列组织和存储的技术方面&quot;">​</a></h2><p>在着手使用MQL5 API中用于处理时间序列的函数的实际问题之前，我们应该先了解从服务器获取报价数据并将其存储在MetaTrader 5中的技术基础。</p><p>在价格数据可在终端中用于在图表上显示并传输给MQL程序之前，它们会从服务器下载并以特殊方式进行准备。从服务器获取数据的机制，并不取决于请求是如何发起的——无论是用户在浏览图表时发起的，还是通过MQL5语言以编程方式发起的。</p><p>数据以压缩格式从服务器传输过来：这些是经过高效打包的分钟K线数据块，但它们并不是通常意义上的M1周期K线。</p><p>从服务器接收到的数据会自动解压缩，并以特殊的HCC中间格式保存。每个交易品种的数据都会写入一个单独的文件夹{terminal_dir}/bases/{server_name}/history/{symbol_name}中。例如，来自MetaQuotes-Demo交易服务器的欧元兑美元（EURUSD）数据可能位于文件夹C:/Program Files/MetaTrader 5/bases/MetaQuotes-Demo/history/EURUSD/中。</p><p>数据会写入扩展名为*.hcc的文件中：每个文件存储一年的一分钟K线数据。例如，EURUSD文件夹中的2021.hcc文件包含2021年的欧元兑美元分钟K线数据。这些文件用于为所有时间框架准备价格数据，并不用于直接访问。</p><p>HCC格式的服务文件充当为特定时间框架绘制价格数据的数据源。它们仅在图表或MQL程序请求时创建，并以*.hc扩展名的文件形式保存以供后续使用。</p><p>对于每个时间框架，数据的准备独立于其他时间框架。数据生成和可用的规则对所有时间框架都是相同的，包括M1时间框架。也就是说，尽管HCC格式中数据存储的单位是分钟K线，但它们的存在并不意味着在HC格式中以相同数量存在和可用的M1时间框架数据。</p><p>为了节省资源，时间框架数据仅在必要时加载并存储在随机存取存储器（RAM）中：如果长时间没有对数据进行访问，它们会从RAM中卸载（但仍保留在文件中）。如果某个时间序列长时间未被使用，这可能会导致下一次请求该时间序列时执行时间增加。如果计算机有足够的资源，所有常用的时间序列，特别是那些已打开其图表的时间序列，几乎可以立即获取。</p><p>从服务器接收新数据会导致自动更新所有时间框架的HC格式的已用价格数据，并重新计算所有相关指标。</p><p>当MQL程序访问特定交易品种和时间框架的数据时，有可能所需的时间序列尚未生成，或者尚未与交易服务器同步（例如，服务器上出现了更新的价格）。在这种情况下，应该以某种形式实现等待数据准备就绪的机制。</p><p>对于脚本来说，唯一的解决方案是使用循环，因为由于缺乏事件处理功能，它们没有其他选择。对于指标而言，绝对不建议使用这样的算法（与任何其他等待循环一样），因为它们会导致给定交易品种的所有指标计算以及价格数据的其他处理暂停。</p><p>对于智能交易系统（EA）和指标，最好使用事件处理模型。如果在处理<code>OnTick</code>或<code>OnCalculate</code>事件时，未能获取所需时间序列的所有必要数据，那么应该退出事件处理程序，并等待在下次调用该处理程序时数据出现。</p><h3 id="最大k线数量" tabindex="-1">最大K线数量 <a class="header-anchor" href="#最大k线数量" aria-label="Permalink to &quot;最大K线数量&quot;">​</a></h3><p>需要注意的是，对于每个请求的交易品种/时间框架对，将计算的最大K线数量不会超过终端“选项”对话框中“图表中最大K线数”（Max. bars in chart）参数的值。因此，该参数不仅对任何时间框架的图表施加了限制，也对所有MQL程序施加了限制。</p><p>此限制主要是为了节省资源。在设置该参数的较大值时，应该记住，如果较低时间框架的价格数据历史记录足够深，存储时间序列和指标缓冲区的内存消耗可能会达到数百兆字节，并占用所有的RAM。</p><p>更改K线限制仅在重新启动客户端终端后才会生效。它会影响从服务器请求的数据量，以便构建所需数量的工作时间框架的K线。</p><p>该参数设置的限制并非绝对严格，在某些情况下可能会被超过。例如，如果在会话开始时，特定时间框架的报价历史记录足以达到整个限制数量，那么随着新K线的形成，它们的数量可能会超过当前参数值。可用K线的实际数量由<code>Bars/iBars</code>函数返回。</p><h2 id="获取价格数组的特征" tabindex="-1">获取价格数组的特征 <a class="header-anchor" href="#获取价格数组的特征" aria-label="Permalink to &quot;获取价格数组的特征&quot;">​</a></h2><p>在读取时间序列数组之前，我们应该确保它们是可用的，并且具备所需的特征。<code>SeriesInfoInteger</code>函数用于获取基本属性，例如终端和服务器上可用历史数据的深度、针对特定交易品种/周期组合构建的K线数量，以及终端与服务器之间报价是否存在差异。</p><p>该函数有两种形式：第一种直接返回请求的值（类型为<code>long</code>），第二种使用通过引用传递的第四个参数<code>result</code>。在这种情况下，第二种形式返回成功标志（<code>true</code>）或错误标志（<code>false</code>）。无论哪种情况，都可以使用<code>GetLastError</code>函数找到错误代码。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SeriesInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ENUM_TIMEFRAMES </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">timeframe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ENUM_SERIES_INFO_INTEGER </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">property</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SeriesInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ENUM_TIMEFRAMES </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">timeframe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ENUM_SERIES_INFO_INTEGER </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">property</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数允许您查询指定交易品种和时间框架的时间序列属性之一，或者查询整个交易品种历史的属性。所请求的属性由<code>ENUM_SERIES_INFO_INTEGER</code>类型的第三个参数来标识。此枚举包含所有可用属性：</p><table tabindex="0"><thead><tr><th>标识符</th><th>描述</th><th>属性类型</th></tr></thead><tbody><tr><td><code>SERIES_BARS_COUNT</code></td><td>按交易品种/周期的K线数量，见<code>Bars</code>函数</td><td><code>long</code></td></tr><tr><td><code>SERIES_FIRSTDATE</code></td><td>按交易品种/周期的最早日期</td><td><code>datetime</code></td></tr><tr><td><code>SERIES_LASTBAR_DATE</code></td><td>按交易品种/周期的最后一根K线的开盘时间</td><td><code>datetime</code></td></tr><tr><td><code>SERIES_SYNCHRONIZED</code></td><td>终端和服务器上按交易品种/周期的数据同步标志</td><td><code>bool</code></td></tr><tr><td><code>SERIES_SERVER_FIRSTDATE</code></td><td>服务器上按交易品种的历史最早日期，与周期无关</td><td><code>datetime</code></td></tr><tr><td><code>SERIES_TERMINAL_FIRSTDATE</code></td><td>客户端终端上按交易品种的历史最早日期，与周期无关</td><td><code>datetime</code></td></tr></tbody></table><p>根据属性的本质，结果值应转换为特定类型的值（请参阅“属性类型”列）。</p><p>所有属性均返回当前时刻的值。</p><p>脚本<code>SeriesInfo.mq5</code>提供了查询所有属性的示例：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SeriesInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, SERIES_BARS_COUNT));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((datetime)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SeriesInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, SERIES_FIRSTDATE));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((datetime)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SeriesInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, SERIES_LASTBAR_DATE));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SeriesInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, SERIES_SYNCHRONIZED));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((datetime)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SeriesInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, SERIES_SERVER_FIRSTDATE));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((datetime)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SeriesInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, SERIES_TERMINAL_FIRSTDATE));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SeriesInfoInteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ABRACADABRA&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, SERIES_BARS_COUNT));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>以下是在MQ Demo服务器上针对欧元兑美元（EURUSD）、H1时间框架获得的结果示例：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>SeriesInfoInteger(NULL,0,SERIES_BARS_COUNT)=10001 / ok</span></span>
<span class="line"><span>(datetime)SeriesInfoInteger(NULL,0,SERIES_FIRSTDATE)=2020.03.02 10:00:00 / ok</span></span>
<span class="line"><span>(datetime)SeriesInfoInteger(NULL,0,SERIES_LASTBAR_DATE)=2021.10.08 14:00:00 / ok</span></span>
<span class="line"><span>(bool)SeriesInfoInteger(NULL,0,SERIES_SYNCHRONIZED)=false / ok</span></span>
<span class="line"><span>(datetime)SeriesInfoInteger(NULL,0,SERIES_SERVER_FIRSTDATE)=1971.01.04 00:00:00 / ok</span></span>
<span class="line"><span>(datetime)SeriesInfoInteger(NULL,0,SERIES_TERMINAL_FIRSTDATE)=2016.06.01 00:00:00 / ok</span></span>
<span class="line"><span>SeriesInfoInteger(ABRACADABRA,0,SERIES_BARS_COUNT)=0 / MARKET_UNKNOWN_SYMBOL(4301)</span></span></code></pre></div><h3 id="可用k线数量-bars-ibars" tabindex="-1">可用K线数量（Bars/iBars） <a class="header-anchor" href="#可用k线数量-bars-ibars" aria-label="Permalink to &quot;可用K线数量（Bars/iBars）&quot;">​</a></h3><p>函数<code>Bars</code>和<code>iBars</code>提供了一种更简便的方法来查询按交易品种/周期划分的时间序列中K线的总数（它们之间没有区别，<code>iBars</code>的存在是为了与MQL4兼容）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Bars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ENUM_TIMEFRAMES </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">timeframe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)        </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iBars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ENUM_TIMEFRAMES </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">timeframe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>这些函数返回MQL程序针对给定交易品种和周期可获取的K线数量。该值受终端“选项”中“图表中最大K线数”（Max. bars in chart）参数的影响（请参阅“时间序列组织和存储的技术特点”部分的注释）。例如，如果下载到终端的某个特定时间框架的历史数据有20,000根K线，但在设置中限制为10,000根K线，那么第二个值将起决定作用。在终端启动后，这些函数将立即返回10,000根K线的数量，但随着新K线的形成，该数量会增加（如果有足够的可用内存）。在MQL5中，可以通过调用<code>TerminalInfoInteger(TERMINAL_MAXBARS)</code>来获取这个限制值。</p><p>此外，<code>Bars</code>函数还有第二种形式，它允许查询两个日期之间范围内的K线数量。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Bars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ENUM_TIMEFRAMES </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">timeframe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, datetime </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, datetime </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stop</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>这样的请求仅查询开盘时间落在从<code>start</code>到<code>stop</code>（包括两端）范围内的那些K线。<code>start</code>和<code>stop</code>的指定顺序无关紧要：函数将从较小的时间到较大的时间来分析报价。</p><p>如果在调用<code>Bars/iBars</code>函数时，具有指定参数的时间序列数据尚未生成，或者尚未与交易服务器同步，该函数将返回<code>null</code>。在这种情况下，<code>_LastError</code>中的错误属性也将为0（没有错误，因为数据只是尚未下载或准备好）。在得到返回值0之后，可以使用<code>SeriesInfoInteger(..., SERIES_SYNCHRONIZED)</code>检查特定时间框架的同步情况，或者使用特殊的<code>SymbolIsSynchronized</code>函数检查交易品种的同步情况。</p><p>下一节中的脚本<code>SeriesBars.mq5</code>将展示如何使用这些函数的示例，同时还会介绍相关的<code>iBarShift</code>函数。</p><h2 id="按时间搜索k线索引-ibarshift" tabindex="-1">按时间搜索K线索引（iBarShift） <a class="header-anchor" href="#按时间搜索k线索引-ibarshift" aria-label="Permalink to &quot;按时间搜索K线索引（iBarShift）&quot;">​</a></h2><p><code>iBarShift</code>函数可提供指定时间对应的K线编号。在这种情况下，K线的编号始终按照时间序列的方式进行，即索引0对应最右边、最新的K线，并且从右向左（向过去的方向）数值逐渐增大。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iBarShift</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ENUM_TIMEFRAMES </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">timeframe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, datetime </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> exact </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数返回在指定交易品种/时间框架参数对的时间序列中，<code>time</code>参数值所属K线的索引。每根K线都由一个开盘时间和该序列中所有K线共有的持续时间（即周期）来表征。例如，在小时时间框架下，开盘时间标记为13:00的K线持续时间是从13:00:00到13:59:59（包括最后一分钟和一秒）。</p><p>如果不存在与指定时间对应的K线（例如，该时间处于非交易时间或非交易日），那么函数的行为会根据<code>exact</code>参数而有所不同：如果<code>exact = true</code>，函数将返回-1；如果<code>exact = false</code>，它将返回开盘时间小于指定时间的最近K线的索引。当不存在这样的K线时，也就是说，在指定时间之前没有历史数据，函数将返回-1。但这里有一个细微之处。</p><p>**注意！**如果<code>iBarShift</code>函数返回一个特定的K线编号，即一个不等于-1的值，这并不意味着随后通过该索引访问时间序列就一定能获取到该K线的价格或其他特征。特别是当请求的K线索引超过终端窗口中的K线限制（<code>TerminalInfoInteger(TERMINAL_MAXBARS)</code>）时，就可能出现这种情况。随着新K线的形成，这种情况可能会发生：较旧的K线可能会向左移动超出限制范围，处于可见窗口之外，尽管名义上它们可能会在内存中保留一段时间。开发者应该始终检查这种情况。</p><p>让我们使用脚本<code>SeriesBars.mq5</code>来检验<code>Bars/iBars</code>函数（见上一节）和<code>iBarShift</code>函数的性能。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime target </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ChartTimeOnDropped</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">iBarShift</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, target));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">iBarShift</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, target, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">iBarShift</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TimeCurrent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Bars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, target, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TimeCurrent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Bars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TimeCurrent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), target));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">iBars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Bars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Bars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TimeCurrent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Bars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TimeCurrent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TimeCurrent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>在这里我们遇到了另一个不熟悉的函数<code>ChartTimeOnDropped</code>（我们稍后会描述它）：它返回（在活动图表上）从导航器中用鼠标拖放到的特定K线的时间。首先，让我们将脚本拖放到图表上有报价的区域。</p><p>日志中会创建以下记录（根据您的设置、操作和当前时间，数字会有所不同）：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>ChartTimeOnDropped()=2021.10.01 09:00:00 / ok</span></span>
<span class="line"><span>iBarShift(NULL,0,target)=125 / ok</span></span>
<span class="line"><span>iBarShift(NULL,0,target,true)=125 / ok</span></span>
<span class="line"><span>iBarShift(NULL,0,TimeCurrent())=0 / ok</span></span>
<span class="line"><span>Bars(NULL,0,target,TimeCurrent())=126 / ok</span></span>
<span class="line"><span>Bars(NULL,0,TimeCurrent(),target)=126 / ok</span></span>
<span class="line"><span>iBars(NULL,0)=10004 / ok</span></span>
<span class="line"><span>Bars(NULL,0)=10004 / ok</span></span>
<span class="line"><span>Bars(NULL,0,0,TimeCurrent())=10004 / ok</span></span>
<span class="line"><span>Bars(NULL,0,TimeCurrent(),TimeCurrent())=0 / ok</span></span></code></pre></div><p>在这种情况下，脚本被拖放到时间为2021.10.01 09:00的K线（使用的是小时时间框架）上。根据<code>iBarShift</code>函数，这个时间对应的是第125根K线。</p><p>从鼠标所在的K线到最后一根（当前时间）K线的数量是126。这与K线编号125是相符的，因为编号是从0开始的。</p><p>通过不同方式（<code>iBars</code>、不带日期范围的<code>Bars</code>以及从0到当前时刻<code>TimeCurrent</code>的完整范围的<code>Bars</code>）得到的图表上的K线总数都等于10004。终端设置的限制是10000，但在会话期间又形成了额外的4根小时K线。</p><p>对于现有的交易品种和时间框架，当<code>exact = false</code>时，当前时间所在K线的编号<code>iBarShift(..., TimeCurrent())</code>始终为0。如果<code>exact = true</code>，那么有时我们可能会得到-1，因为当所有市场工具的报价点到达时，服务器时间会增加，并且当前交易品种可能暂时不进行交易。然后服务器时间可能会比一根K线的时间提前更多，并且对于<code>TimeCurrent</code>来说，没有新的K线能正好与之对应。</p><p>如果我们将脚本拖放到当前最后一根K线右边的空白区域（即未来的时间），我们会得到类似这样的结果：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>ChartTimeOnDropped()=2021.10.09 02:30:00 / ok</span></span>
<span class="line"><span>iBarShift(NULL,0,target)=0 / ok</span></span>
<span class="line"><span>iBarShift(NULL,0,target,true)=-1 / ok</span></span>
<span class="line"><span>Bars(NULL,0,target,TimeCurrent())=0 / ok</span></span>
<span class="line"><span>Bars(NULL,0,TimeCurrent(),target)=0 / ok</span></span>
<span class="line"><span>iBars(NULL,0)=10004 / ok</span></span>
<span class="line"><span>Bars(NULL,0)=10004 / ok</span></span>
<span class="line"><span>Bars(NULL,0,0,TimeCurrent())=10004 / ok</span></span>
<span class="line"><span>Bars(NULL,0,TimeCurrent(),TimeCurrent())=0 / ok</span></span></code></pre></div><p>在搜索任何先前K线的模式下（<code>exact = false</code>），<code>iBarShift</code>函数返回0，因为当前K线是离未来最近的。然而，精确搜索（<code>exact = true</code>）得到的结果是-1。此外，计算从当前时间到“目标”未来时间范围内K线数量的<code>Bars</code>函数现在返回0（那里还没有K线）。</p><p><code>iBarShift</code>函数对于编写多货币MQL程序特别有用。不同金融工具的交易时间表常常不一致，所以对于特定的时间，某一交易品种可能存在一根K线，而另一交易品种则不存在。使用<code>iBarShift</code>函数的最近（先前）K线搜索模式，您总是可以获取在同一时刻对于不同交易品种相关的带有价格的K线索引。通常，即使对于外汇交易品种，同一时间的历史K线索引也可能不同。</p><p>例如，以下指令将记录在一小时时间框架下（MQ Demo服务器），三个交易品种（欧元兑美元（EURUSD）、黄金兑美元（XAUUSD）、美元兑卢布（USDRUB））在相同日期范围内的不同K线数量及其编号：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Bars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;EURUSD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PERIOD_H1, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.05.01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.09.01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 2087</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Bars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;XAUUSD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PERIOD_H1, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.05.01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.09.01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 1991</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Bars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;USDRUB&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PERIOD_H1, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.05.01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.09.01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 694</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">iBarShift</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;EURUSD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PERIOD_H1, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.09.01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 671</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">iBarShift</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;XAUUSD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PERIOD_H1, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.09.01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 638</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">iBarShift</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;USDRUB&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PERIOD_H1, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.09.01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 224</span></span></code></pre></div><h2 id="用于获取报价数组的copy函数概述" tabindex="-1">用于获取报价数组的Copy函数概述 <a class="header-anchor" href="#用于获取报价数组的copy函数概述" aria-label="Permalink to &quot;用于获取报价数组的Copy函数概述&quot;">​</a></h2><p>MQL5 API中有几个函数可用于将报价时间序列读取到数组中。以下表格列出了这些函数及其作用：</p><table tabindex="0"><thead><tr><th>函数</th><th>作用</th></tr></thead><tbody><tr><td><code>CopyRates</code></td><td>将报价历史数据获取到<code>MqlRates</code>结构体数组中</td></tr><tr><td><code>CopyTime</code></td><td>将K线开盘时间历史数据获取到<code>datetime</code>类型的数组中</td></tr><tr><td><code>CopyOpen</code></td><td>将K线开盘价历史数据获取到<code>double</code>类型的数组中</td></tr><tr><td><code>CopyHigh</code></td><td>将K线最高价历史数据获取到<code>double</code>类型的数组中</td></tr><tr><td><code>CopyLow</code></td><td>将K线最低价历史数据获取到<code>double</code>类型的数组中</td></tr><tr><td><code>CopyClose</code></td><td>将K线收盘价历史数据获取到<code>double</code>类型的数组中</td></tr><tr><td><code>CopyTickVolume</code></td><td>将报价成交量历史数据获取到<code>long</code>类型的数组中</td></tr><tr><td><code>CopyRealVolume</code></td><td>将交易所成交量历史数据获取到<code>long</code>类型的数组中</td></tr><tr><td><code>CopySpread</code></td><td>将点差历史数据获取到<code>int</code>类型的数组中</td></tr></tbody></table><p>所有这些函数的前两个参数都是所需交易品种的名称和时间周期，可用以下伪代码表示：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Copy</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">***</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string symbol, ENUM_TIMEFRAMES timeframe, ...)</span></span></code></pre></div><p>此外，所有函数都有三种原型变体，它们的区别在于请求范围的设置方式：</p><ol><li><strong>起始K线索引和K线数量</strong>：<code>Copy***(..., int offset, int count, ...)</code></li><li><strong>范围起始时间和K线数量</strong>：<code>Copy***(..., datetime start, int count, ...)</code></li><li><strong>范围起始时间和结束时间</strong>：<code>Copy***(..., datetime start, datetime stop, ...)</code></li></ol><p>同时，参数表示方式意味着请求的数据采用时间序列的索引方向，即索引为0的偏移位置存储当前未完成K线的数据，索引增加对应向价格历史更深处移动。因此，特别是对于第二种方式，指定的K线数量<code>count</code>将从偏移范围的起始位置开始反向计数，也就是时间递减的方向。</p><p>第三种方式提供了额外的灵活性：起始日期和结束日期（<code>start</code>/<code>stop</code>）的指定顺序无关紧要，因为函数无论如何都会返回从较小日期到较大日期范围内的数据。合适的K线是这样选择的：其开盘时间在时间计数<code>start</code>/<code>stop</code>之间，或者等于其中之一，即考虑范围<code>[start; stop]</code>包括边界。</p><p>选择哪种函数选项由开发者根据更重要的因素来决定：是获取保证数量的元素（例如，用于机器学习算法），还是覆盖特定的日期区间（例如，具有预定的统一市场行为）。</p><p><code>datetime</code>类型的时间表示精度为1秒。<code>start</code>/<code>stop</code>值不必四舍五入到周期大小。例如，从14:59到16:01的范围将允许在H1时间框架下选择15:00和16:00的两根K线。具有相等且四舍五入标签的退化范围，例如H1报价中的15:00，对应一根K线。</p><p>即使<code>start</code>/<code>stop</code>参数中包含非零的小时/分钟/秒，也可以请求日线时间框架的K线（尽管D1时间框架的K线标签时间为00:00）。在这种情况下，仅选择开盘时间在<code>start</code>/<code>stop</code>最小值之后且到<code>start</code>/<code>stop</code>最大值之前的D1 K线（在这种情况下，与日线K线标签相等是不可能的，因为所需时间包含小时/分钟/秒）。例如，在D&#39;2021.09.01 12:00&#39;和D&#39;2021.09.03 07:00&#39;之间，有两个D1 K线的开盘时间——D&#39;2021.09.02&#39;和D&#39;2021.09.03&#39;。这些K线将包含在结果中。D&#39;2021.09.01&#39; K线的开盘时间为00:00，早于范围的开始时间，因此被丢弃。D&#39;2021.09.03&#39; K线包含在结果中，尽管该日只有上午7个小时落入该范围。另一方面，请求一天内的几个小时，例如，在D&#39;2021.09.01 12:00&#39;和D&#39;2021.09.01 15:00&#39;之间，将不会覆盖任何日线K线（D&#39;2021.09.01&#39; K线的开盘时间不在此范围内），因此接收数组将为空。</p><p>表格中所有函数的唯一区别在于接收数据的数组类型，该数组作为最后一个参数通过引用传递。例如，<code>CopyRates</code>函数将请求的数据放入<code>MqlRates</code>结构体数组中，<code>CopyTime</code>函数将K线开盘时间放入<code>datetime</code>类型的数组中，依此类推。</p><p>因此，通用的函数原型可以表示如下：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Copy</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">***</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string symbol, ENUM_TIMEFRAMES timeframe, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> offset, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count, type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Copy</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">***</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string symbol, ENUM_TIMEFRAMES timeframe, datetime start, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count, type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Copy</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">***</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string symbol, ENUM_TIMEFRAMES timeframe, datetime start, datetime stop, type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>这里，<code>type</code>根据具体函数匹配<code>MqlRates</code>、<code>datetime</code>、<code>double</code>、<code>long</code>或<code>int</code>中的任何一种类型。</p><p>这些函数返回复制到数组中的元素数量，出错时返回 -1。特别是，如果服务器上请求的区间没有数据，或者该区间超出了图表上的最大K线数量（<code>TerminalInfoInteger(TERMINAL_MAXBARS)</code>），我们将得到 -1。</p><p>重要的是要注意，在接收数组中，接收到的数据总是按时间顺序从过去到未来物理放置。因此，如果对接收数组使用标准索引（即函数<code>ArraySetAsSeries</code>），则索引为0的元素将是最旧的，最后一个元素将是最新的。如果对数组执行了<code>ArraySetAsSeries(result, true)</code>指令，则编号将按时间序列的反向顺序进行：第0个元素将是范围内最新的，最后一个元素将是最旧的。这在以下图中得到说明。</p><p>当成功执行时，将从终端自身（内部）时间序列中复制指定数量的元素到目标数组。当按日期范围（<code>start</code>/<code>stop</code>）请求数据时，结果数组中的元素数量将根据该范围内的历史内容间接确定。因此，为了复制先前未知数量的值，建议使用动态数组：复制函数会自动分配目标数组所需的大小（大小可以增加或减少）。</p><p>如果需要复制已知数量的元素，或者频繁进行复制操作，例如在智能交易系统的每次<code>OnTick</code>调用或指标的每次<code>OnCalculate</code>调用中，最好使用静态分配的数组。事实上，动态数组的内存分配操作需要额外的时间，并且可能会影响性能，特别是在测试和优化期间。</p><p>对于不同类型的MQL程序，如果请求的数据尚未准备好，访问时间序列的方式不同。例如，在自定义指标中，<code>Copy</code>函数会立即返回错误，因为指标在终端的公共界面线程中执行，不能等待数据接收（假设指标将在其事件处理程序的下一次调用中请求数据，届时时间序列将已下载并构建）。此外，在指标章节中，我们将了解到，要访问指标所在“原生”图表的报价，不需要使用<code>Copy</code>函数，因为所有时间序列都会通过<code>OnCalculate</code>处理程序的数组参数自动传递。</p><p>当从智能交易系统和脚本访问时，会尝试多次接收数据，并进行短暂暂停（函数内部有等待），这为加载和计算缺失的时间序列提供了时间。函数将返回在超时到期时准备好的数据量，但历史加载将继续，下一次类似的请求将返回更多数据。</p><p>无论如何，您应该做好准备，<code>Copy</code>函数可能会返回错误而不是数据（原因有很多：连接失败、请求的数据缺失、如果并行请求许多新的时间序列会导致处理器负载过高）：在代码中分析问题的原因（<code>_LastError</code>），稍后再试，调整设置，或者通知用户。</p><p>使用<code>Copy</code>函数请求时间序列时，交易品种是否在“市场报价”窗口中并非必要条件。然而，对于包含在该窗口中的交易品种，查询往往运行得更快，因为已经从服务器下载了一些数据，并且可能已经针对请求的周期进行了计算。我们将在“编辑市场报价列表”部分学习如何以编程方式将交易品种添加到“市场报价”窗口中。</p><p>为了说明这些函数在实践中的工作原理，让我们考虑脚本<code>SeriesCopy.mq5</code>。它包含对<code>CopyTime</code>函数的多次调用，这使得我们可以直观地看到时间戳和K线编号之间的关联。</p><p>脚本定义了一个动态数组<code>times</code>来接收数据。所有请求都是针对“EURUSD”交易品种和H1时间框架进行的。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    datetime times</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 首先，请求从2021年9月5日开始向过去的10根K线</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CopyTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;EURUSD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PERIOD_H1, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.09.05&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, times));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 10 / ok</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(times);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    [0] 2021.09.03 14:00 2021.09.03 15:00 2021.09.03 16:00 2021.09.03 17:00 2021.09.03 18:00</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    [5] 2021.09.03 19:00 2021.09.03 20:00 2021.09.03 21:00 2021.09.03 22:00 2021.09.03 23:00</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 默认情况下，数组输出按时间顺序进行（尽管函数参数设置为时间序列的反向坐标系）。让我们更改接收数组的索引顺序并再次输出。</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArraySetAsSeries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(times, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // true / ok</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(times);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    [0] 2021.09.03 23:00 2021.09.03 22:00 2021.09.03 21:00 2021.09.03 20:00 2021.09.03 19:00</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    [5] 2021.09.03 18:00 2021.09.03 17:00 2021.09.03 16:00 2021.09.03 15:00 2021.09.03 14:00</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 对于接下来的实验，我们将恢复通常的顺序。</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArraySetAsSeries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(times, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // true / ok</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 现在让我们请求两个时间点之间不确定数量的K线（数量未知，因为范围内可能有假期等）。我们将通过两种方式进行：第一种情况，我们指定从未来到过去的范围，第二种情况，从过去到未来。结果相同。</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //                                      FROM                 TO</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CopyTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;EURUSD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PERIOD_H1, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.09.06 03:00&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.09.05 03:00&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, times));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(times);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //                   FROM                 TO</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CopyTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;EURUSD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PERIOD_H1, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.09.05 03:00&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.09.06 03:00&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, times));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(times);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    CopyTime(EURUSD,PERIOD_H1,D&#39;2021.09.06 03:00&#39;,D&#39;2021.09.05 03:00&#39;,times)=4 / ok</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    2021.09.06 00:00 2021.09.06 01:00 2021.09.06 02:00 2021.09.06 03:00</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    CopyTime(EURUSD,PERIOD_H1,D&#39;2021.09.05 03:00&#39;,D&#39;2021.09.06 03:00&#39;,times)=4 / ok</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    2021.09.06 00:00 2021.09.06 01:00 2021.09.06 02:00 2021.09.06 03:00</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 通过打印数组，我们可以看到它们是相同的。让我们回到时间序列索引模式并讨论另一个要点。</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArraySetAsSeries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(times, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // true / ok</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(times);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2021.09.06 03:00 2021.09.06 02:00 2021.09.06 01:00 2021.09.06 00:00</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 虽然两个时间戳相差24小时，这意味着数组中应该有25个元素（记住起始和结束是包含在内的），但结果只包含4根K线。事实是，9月5日是周日，因此，在整个范围内，仅在6日上午进行了交易。</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 此外，注意接收数组的大小已自动从10个元素减少到4个元素。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 最后，我们将请求从第100根K线开始的10根K线（获得的结果将取决于您的当前时间和可用历史数据）。</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CopyTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;EURUSD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PERIOD_H1, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, times));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 10 / ok</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(times);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    [0] 2021.10.04 19:00 2021.10.04 18:00 2021.10.04 17:00 2021.10.04 16:00 2021.10.04 15:00</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    [5] 2021.10.04 14:00 2021.10.04 13:00 2021.10.04 12:00 2021.10.04 11:00 2021.10.04 10:00</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>由于采用时间序列的索引方式，数组按逆时间顺序显示。</p><h2 id="将报价作为mqlrates结构体数组获取" tabindex="-1">将报价作为MqlRates结构体数组获取 <a class="header-anchor" href="#将报价作为mqlrates结构体数组获取" aria-label="Permalink to &quot;将报价作为MqlRates结构体数组获取&quot;">​</a></h2><p>要请求包含所有K线特征的报价数组，请使用具有多个重载形式的<code>CopyRates</code>函数。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CopyRates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ENUM_TIMEFRAMES </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">timeframe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> offset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, MqlRates </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CopyRates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ENUM_TIMEFRAMES </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">timeframe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, datetime </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, MqlRates </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CopyRates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ENUM_TIMEFRAMES </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">timeframe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, datetime </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, datetime </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stop</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, MqlRates </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>该函数将指定参数（交易品种、时间框架，以及通过K线编号或<code>datetime</code>类型的<code>start</code>/<code>stop</code>值指定的时间范围）的历史数据获取到<code>rates</code>数组中。</p><p>函数返回复制的数组元素数量，如果出错则返回 -1，错误代码可从<code>_LastError</code>中获取。特别是，如果指定了不存在的交易品种、服务器上的区间不包含数据，或者该区间超出了图表上K线数量的限制（<code>TerminalInfoInteger (TERMINAL_MAXBARS)</code>），就会发生错误。</p><p>使用此函数的基本要点与所有<code>Copy</code>函数相同，已在“用于获取报价数组的Copy函数概述”部分进行了概述。</p><p>内联类型结构体<code>MqlRates</code>描述如下：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MqlRates</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   datetime time;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // K线开盘时间</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   open;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // 开盘价</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   high;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // 每根K线的最高价</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   low;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // 每根K线的最低价</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   close;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 收盘价</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">     tick_volume;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 每根K线的报价成交量</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      spread;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       // 每根K线的最小点差（以点数为单位）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">     real_volume;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 每根K线的交易所成交量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>让我们尝试在脚本<code>SeriesStats.mq5</code>中应用此函数来计算K线的平均大小。在输入变量中，我们将提供选择工作交易品种、时间框架、分析的K线数量以及向过去的初始偏移量（0表示从当前K线开始分析）的功能。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input string WorkSymbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 交易品种（留空表示当前品种）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input ENUM_TIMEFRAMES TimeFrame </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PERIOD_CURRENT;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BarOffset </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BarCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   MqlRates rates</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> range </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, move </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 计算K线的波动范围和价格变动</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PrintFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Requesting </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bars on </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> %s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      BarCount, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringLen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkSymbol) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WorkSymbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _Symbol, </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      EnumToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TimeFrame </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PERIOD_CURRENT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _Period </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TimeFrame));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 请求关于BarCount根K线的所有信息并存储到MqlRates数组中</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CopyRates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkSymbol, TimeFrame, BarOffset, BarCount, rates));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 在循环中计算波动范围和价格变动的平均值</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      range </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].high </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].low) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      move </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fmax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].open, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].close)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">             -</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fmin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].open, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].close)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PrintFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Stats per bar: range=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, movement=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, range, move);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PrintFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Dates: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> - </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      TimeToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].time), </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TimeToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].time));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>将此脚本拖放到欧元兑美元（EURUSD）、H1时间框架的图表上，我们大约会得到以下结果：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>Requesting 100000 bars on EURUSD PERIOD_H1</span></span>
<span class="line"><span>CopyRates(WorkSymbol,TimeFrame,BarOffset,BarCount,rates)=20018 / ok</span></span>
<span class="line"><span>Stats per bar: range=0.001280, movement=0.000621</span></span>
<span class="line"><span>Dates: 2018.07.19 15:00 - 2021.10.11 17:00</span></span></code></pre></div><p>由于终端的K线数量限制为20,000根，请求100,000根K线只能返回20018根（限制数量以及会话开始后新形成的K线）。数组的第一个元素（索引为0）包含时间为2018.07.19 15:00的K线，最后一个元素包含时间为2021.10.11 17:00的K线。</p><p>根据统计数据，在此期间K线的平均波动范围为128个点，开盘价和收盘价之间的变动为62个点。</p><p>当使用起始日期和结束日期（<code>start</code>/<code>stop</code>）请求信息时，请记住两个边界都是包含在内的。因此，要设置与更高时间框架的任何一根K线相对应的区间，应该从右边界减去1秒。我们将在“按K线索引读取价格、成交量、点差和时间”部分的脚本<code>SeriesSpread.mq5</code>示例中应用此技巧。</p><h2 id="分别请求价格、成交量、点差和时间数组" tabindex="-1">分别请求价格、成交量、点差和时间数组 <a class="header-anchor" href="#分别请求价格、成交量、点差和时间数组" aria-label="Permalink to &quot;分别请求价格、成交量、点差和时间数组&quot;">​</a></h2><p>你可以选择将特定字段（价格、成交量、点差或时间）的数据读取到单独的数组中，而不是将所有K线特征作为<code>MqlRates</code>数组进行查询。为此，定义了几个函数，它们遵循“用于获取报价数组的Copy函数概述”部分中讨论的通用原则。</p><p>下面的脚本<code>SeriesRates.mq5</code>使用复制开盘价（Open）、最高价（High）、最低价（Low）和收盘价（Close）（OHLC）的函数，并将结果与调用<code>CopyRates</code>的结果进行比较。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> N </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    MqlRates rates</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 请求并显示MqlRates数组中N根K线的所有信息</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CopyRates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;EURUSD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PERIOD_D1, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.10.01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, N, rates));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rates);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 现在分别请求OHLC价格</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> open</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, high</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, low</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, close</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CopyOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;EURUSD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PERIOD_D1, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.10.01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, N, open));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CopyHigh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;EURUSD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PERIOD_D1, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.10.01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, N, high));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CopyLow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;EURUSD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PERIOD_D1, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.10.01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, N, low));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    PRTF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CopyClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;EURUSD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PERIOD_D1, D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021.10.01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, N, close));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 比较通过不同方法获取的价格</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> N; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].open </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> open</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        ||</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].high </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> high</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        ||</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].low </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> low</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        ||</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> rates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].close </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 不应该出现这种情况</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Data mismatch at &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, i);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Copied OHLC arrays match MqlRates array&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 成功：数据匹配</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>运行脚本后，日志中会出现以下记录：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>CopyRates(EURUSD,PERIOD_D1,D&#39;2021.10.01&#39;,N,rates)=10 / ok</span></span>
<span class="line"><span>                 [time]  [open]  [high]   [low] [close] [tick_volume] [spread] [real_volume]</span></span>
<span class="line"><span>[0] 2021.09.20 00:00:00 1.17272 1.17363 1.17004 1.17257         58444        0             0</span></span>
<span class="line"><span>[1] 2021.09.21 00:00:00 1.17248 1.17486 1.17149 1.17252         58514        0             0</span></span>
<span class="line"><span>[2] 2021.09.22 00:00:00 1.17240 1.17555 1.16843 1.16866         72571        0             0</span></span>
<span class="line"><span>[3] 2021.09.23 00:00:00 1.16860 1.17501 1.16835 1.17381         68536        0             0</span></span>
<span class="line"><span>[4] 2021.09.24 00:00:00 1.17379 1.17476 1.17007 1.17206         51401        0             0</span></span>
<span class="line"><span>[5] 2021.09.27 00:00:00 1.17255 1.17255 1.16848 1.16952         57807        0             0</span></span>
<span class="line"><span>[6] 2021.09.28 00:00:00 1.16940 1.17032 1.16682 1.16826         64793        0             0</span></span>
<span class="line"><span>[7] 2021.09.29 00:00:00 1.16825 1.16901 1.15894 1.15969         68964        0             0</span></span>
<span class="line"><span>[8] 2021.09.30 00:00:00 1.15963 1.16097 1.15626 1.15769         68517        0             0</span></span>
<span class="line"><span>[9] 2021.10.01 00:00:00 1.15740 1.16075 1.15630 1.15927         66777        0             0</span></span>
<span class="line"><span>CopyOpen(EURUSD,PERIOD_D1,D&#39;2021.10.01&#39;,N,open)=10 / ok</span></span>
<span class="line"><span>CopyHigh(EURUSD,PERIOD_D1,D&#39;2021.10.01&#39;,N,high)=10 / ok</span></span>
<span class="line"><span>CopyLow(EURUSD,PERIOD_D1,D&#39;2021.10.01&#39;,N,low)=10 / ok</span></span>
<span class="line"><span>CopyClose(EURUSD,PERIOD_D1,D&#39;2021.10.01&#39;,N,close)=10 / ok</span></span>
<span class="line"><span>Copied OHLC arrays match MqlRates array</span></span></code></pre></div><p>需要注意的是，<code>tick_volume</code>字段中的报价成交量是一个周期内报价点的简单计数器。对于非交易所交易工具（如这里的欧元兑美元），<code>real_volume</code>字段中的交易所成交量为零。</p><p>另外，在“用于获取报价数组的Copy函数概述”部分的脚本<code>SeriesCopy.mq5</code>中给出了使用<code>CopyTime</code>函数的示例。</p><h2 id="按k线索引读取价格、成交量、点差和时间" tabindex="-1">按K线索引读取价格、成交量、点差和时间 <a class="header-anchor" href="#按k线索引读取价格、成交量、点差和时间" aria-label="Permalink to &quot;按K线索引读取价格、成交量、点差和时间&quot;">​</a></h2><p>有时，我们需要获取的不是一系列K线的信息，而仅仅是某一根K线的信息。从理论上讲，这可以通过使用前面讨论过的<code>Copy</code>函数来实现，在这些函数中指定数量（参数<code>count</code>）为1，但这样做不是很方便。下面的这些函数提供了一种更简单的方式，它们可以根据时间序列中K线的编号返回某一特定类型的一个值。</p><p>所有这些函数都有相似的原型，但名称和返回类型不同。从历史角度看，函数名以前缀<code>i</code>开头，即形如<code>iValue</code>（这些函数属于一大类内置技术指标：毕竟，报价特征是技术分析的主要来源，几乎所有指标都是其衍生出来的，所以用字母<code>i</code>表示）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">type </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">iValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ENUM_TIMEFRAMES </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">timeframe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> offset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>这里的<code>type</code>根据具体函数对应<code>datetime</code>、<code>double</code>、<code>long</code>或<code>int</code>中的一种类型。<code>symbol</code>和<code>timeframe</code>用于确定所请求的时间序列。所需的K线索引<code>offset</code>按照时间序列的表示方法传递：0表示最新的、最右边的K线（通常尚未完成），数值越大表示的K线越旧。与<code>Copy</code>函数的情况一样，<code>NULL</code>和0可用于将交易品种和周期设置为与当前图表的属性相同。</p><p>由于<code>i</code>系列函数等同于调用<code>Copy</code>函数，“用于获取报价数组的Copy函数概述”部分中描述的从不同类型程序请求时间序列的所有特点也适用于它们。</p><table tabindex="0"><thead><tr><th>函数</th><th>描述</th></tr></thead><tbody><tr><td><code>iTime</code></td><td>K线开盘时间</td></tr><tr><td><code>iOpen</code></td><td>K线开盘价</td></tr><tr><td><code>iHigh</code></td><td>K线最高价</td></tr><tr><td><code>iLow</code></td><td>K线最低价</td></tr><tr><td><code>iClose</code></td><td>K线收盘价</td></tr><tr><td><code>iTickVolume</code></td><td>K线报价成交量（类似于<code>iVolume</code>）</td></tr><tr><td><code>iVolume</code></td><td>K线报价成交量（类似于<code>iTickVolume</code>）</td></tr><tr><td><code>iRealVolume</code></td><td>K线的实际交易量</td></tr><tr><td><code>iSpread</code></td><td>K线最小点差（以点为单位）</td></tr></tbody></table><p>这些函数返回请求的值，如果出错则返回0（遗憾的是，在某些情况下0可能是一个真实的值）。要获取关于错误的更多信息，请调用<code>GetLastError</code>函数。</p><p>这些函数不会缓存结果。每次调用时，它们都会从指定交易品种/周期的时间序列中返回实际数据。这意味着在没有准备好的数据时（首次调用，或同步丢失后），函数可能需要一些时间来准备结果。</p><p>例如，让我们尝试对每根K线的点差大小进行一个较为现实的估计。最小点差值存储在报价中，这可能会在设计交易策略时导致不合理的过高预期。要获取每根K线的平均、中位数或最大点差的绝对准确值，需要分析实际的报价点，但我们还没有学习如何处理它们。此外，这将是一个非常耗费资源的过程。一个更合理的方法是分析较低的M1时间框架的点差：对于较高时间框架的K线，只需在M1的内部K线中寻找最大点差就足够了。当然，严格来说，这不是真正的最大值，而是最小值中的最大值，但考虑到分钟数据的短暂性，我们可以希望至少在某些M1 K线中检测到特征性的点差扩大情况，这对于获得可接受的分析精度和速度的比例已经足够了。</p><p>脚本<code>SeriesSpread.mq5</code>实现了该算法的一个版本。在输入变量中，你可以设置交易品种、时间框架以及要分析的K线数量。默认情况下，处理当前图表的交易品种及其周期（应该大于M1）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input string WorkSymbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 交易品种（留空表示当前品种）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input ENUM_TIMEFRAMES TimeFrame </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PERIOD_CURRENT;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BarCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>由于对于每根K线来说，只有其时间和点差信息是重要的，所以定义了一个有两个字段的特殊结构体。我们本可以使用标准的<code>MqlRates</code>结构体，并将“最大”点差添加到一些未使用的字段中（例如，对于外汇交易品种的<code>real_volume</code>字段），但这样的话，大多数字段的数据都会被复制，从而浪费内存。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SpreadPerBar</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   datetime time;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> spread;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>使用新的结构体类型，我们准备了<code>peaks</code>数组来计算指定数量K线的数据。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   SpreadPerBar peaks</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayResize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(peaks, BarCount);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ZeroMemory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(peaks);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span></code></pre></div><p>接下来，算法的主要部分在K线循环中执行。对于每根K线，我们使用<code>iTime</code>函数来确定定义该K线边界的两个时间戳。实际上，这是第<code>i</code>根K线和相邻的第<code>(i + 1)</code>根K线的开盘时间。根据索引原则，我们可以说第<code>(i + 1)</code>根K线是前一根K线（更旧，见变量<code>prev</code>），第<code>i</code>根K线是后一根K线（更新，见变量<code>next</code>）。K线开盘时间只属于一根K线，也就是说，标签<code>prev</code>包含在第<code>(i + 1)</code>根K线中，标签<code>next</code>在第<code>i</code>根K线中。因此，在处理每根K线时，其右边界应从区间<code>[prev; next)</code>中排除。</p><p>我们关注的是一分钟时间框架的点差，因此对于<code>PERIOD_M1</code>时间框架，我们将使用<code>CopySpread</code>函数。在这种情况下，通过将<code>start</code>/<code>stop</code>参数设置为精确的<code>prev</code>值和减少1秒的<code>next</code>值来实现半开区间。点差信息被复制到动态数组<code>spreads</code>中（其内存由函数自身分配）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BarCount; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> spreads</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 用于接收第i根K线内部M1点差的数组</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime next </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkSymbol, TimeFrame, i);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime prev </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkSymbol, TimeFrame, i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CopySpread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkSymbol, PERIOD_M1, prev, next </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, spreads);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ArrayMaximum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(spreads);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(m </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         peaks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].spread </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> spreads</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[m];</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         peaks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prev;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>然后，我们在这个数组中找到最大值，并将其与K线时间一起保存到相应的<code>SpreadPerBar</code>结构体中。请注意，未完成的第0根K线不包含在分析中（如有必要，可以补充算法）。</p><p>循环完成后，我们将结构体数组输出到日志中。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PrintFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Maximal speeds per intraday bar</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Processed </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bars on </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> %s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      BarCount, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringLen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkSymbol) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WorkSymbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _Symbol, </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      EnumToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TimeFrame </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PERIOD_CURRENT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _Period </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TimeFrame));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayPrintM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(peaks);</span></span></code></pre></div><p>在欧元兑美元（EURUSD）、H1时间框架的图表上运行该脚本，我们将得到每小时K线内部的点差统计信息（节选）：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>Maximal speeds per intraday bar</span></span>
<span class="line"><span>Processed 100 bars on EURUSD PERIOD_H1</span></span>
<span class="line"><span>[ 0] 2021.10.12 14:00        1</span></span>
<span class="line"><span>[ 1] 2021.10.12 13:00        1</span></span>
<span class="line"><span>[ 2] 2021.10.12 12:00        1</span></span>
<span class="line"><span>[ 3] 2021.10.12 11:00        1</span></span>
<span class="line"><span>[ 4] 2021.10.12 10:00        0</span></span>
<span class="line"><span>[ 5] 2021.10.12 09:00        1</span></span>
<span class="line"><span>[ 6] 2021.10.12 08:00        2</span></span>
<span class="line"><span>[ 7] 2021.10.12 07:00        2</span></span>
<span class="line"><span>[ 8] 2021.10.12 06:00        1</span></span>
<span class="line"><span>[ 9] 2021.10.12 05:00        1</span></span>
<span class="line"><span>[10] 2021.10.12 04:00        1</span></span>
<span class="line"><span>[11] 2021.10.12 03:00        1</span></span>
<span class="line"><span>[12] 2021.10.12 02:00        4</span></span>
<span class="line"><span>[13] 2021.10.12 01:00       16</span></span>
<span class="line"><span>[14] 2021.10.12 00:00       65</span></span>
<span class="line"><span>[15] 2021.10.11 23:00       15</span></span>
<span class="line"><span>[16] 2021.10.11 22:00        2</span></span>
<span class="line"><span>[17] 2021.10.11 21:00        1</span></span>
<span class="line"><span>[18] 2021.10.11 20:00        1</span></span>
<span class="line"><span>[19] 2021.10.11 19:00        2</span></span>
<span class="line"><span>[20] 2021.10.11 18:00        1</span></span>
<span class="line"><span>[21] 2021.10.11 17:00        1</span></span>
<span class="line"><span>[22] 2021.10.11 16:00        1</span></span>
<span class="line"><span>[23] 2021.10.11 15:00        2</span></span>
<span class="line"><span>[24] 2021.10.11 14:00        1</span></span></code></pre></div><p>很明显，夜间点差会增加：例如，接近午夜时，报价中的点差为7 - 15点，而在我们的测量中，它们为15 - 65点。然而，在其他时间段也发现了非零值，尽管每小时K线的指标通常包含零值。</p><h2 id="在时间序列中查找最大值和最小值" tabindex="-1">在时间序列中查找最大值和最小值 <a class="header-anchor" href="#在时间序列中查找最大值和最小值" aria-label="Permalink to &quot;在时间序列中查找最大值和最小值&quot;">​</a></h2><p>在用于处理报价时间序列的函数组中，有两个函数提供了最简单的聚合处理功能：分别用于在给定区间内搜索序列的最大值和最小值，即<code>iHighest</code>和<code>iLowest</code>。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iHighest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ENUM_TIMEFRAMES </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">timeframe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ENUM_SERIESMODE </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WHOLE_ARRAY, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> offset </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iLowest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ENUM_TIMEFRAMES </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">timeframe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ENUM_SERIESMODE </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WHOLE_ARRAY, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> offset </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>这些函数返回特定时间序列类型的最大/最小值的索引，该时间序列由交易品种/时间框架参数对以及<code>ENUM_SERIESMODE</code>枚举元素（它描述了我们已经熟悉的报价字段）指定。</p><table tabindex="0"><thead><tr><th>标识符</th><th>描述</th></tr></thead><tbody><tr><td><code>MODE_OPEN</code></td><td>开盘价</td></tr><tr><td><code>MODE_LOW</code></td><td>最低价</td></tr><tr><td><code>MODE_HIGH</code></td><td>最高价</td></tr><tr><td><code>MODE_CLOSE</code></td><td>收盘价</td></tr><tr><td><code>MODE_VOLUME</code></td><td>报价成交量</td></tr><tr><td><code>MODE_REAL_VOLUME</code></td><td>实际成交量</td></tr><tr><td><code>MODE_SPREAD</code></td><td>点差</td></tr></tbody></table><p><code>offset</code>参数指定开始搜索的索引。编号方式与时间序列中的一致，即<code>offset</code>值增加表示向过去的方向移动，索引0表示当前K线（这是默认值）。分析的K线数量由<code>count</code>参数指定（默认值为<code>WHOLE_ARRAY</code>）。</p><p>如果出错，这些函数返回 -1。使用<code>GetLastError</code>函数可以找到错误代码。</p><p>为了演示其中一个函数（<code>iHighest</code>）的工作方式，让我们修改上一节中关于估计每根K线实际点差大小的示例，并比较结果。当然，它们必须匹配。新版本的脚本包含在文件<code>SeriesSpreadHighest.mq5</code>中。</p><p>这些更改影响了<code>SpreadPerBar</code>结构体以及<code>OnStart</code>函数内部的工作循环。</p><p>向结构体中添加了一些字段，以便理解新函数的工作方式。由于算法的特性，这些字段不是必需的。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SpreadPerBar</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   datetime time;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> spread;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> max;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 具有最大点差值的M1 K线的索引，该点差值在当前较高时间框架K线内的所有M1 K线中最大</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 当前较高时间框架K线内的M1 K线数量</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pos;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 当前较高时间框架K线内M1 K线的初始索引</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>主要的修改影响了<code>OnStart</code>函数，但它们都局限在循环内部（所有其他代码片段保持不变）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BarCount; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime next </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkSymbol, TimeFrame, i);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime prev </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkSymbol, TimeFrame, i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">     ...</span></span></code></pre></div><p>与之前一样，定义了当前K线的边界<code>prev</code>和<code>next</code>。然而，我们不是将这些标签之间的时间序列元素复制到自己的数组<code>spreads</code>中，然后对其调用<code>ArrayMaximum</code>函数，而是确定构成当前较高时间框架K线的M1 K线的索引和数量。具体做法如下。</p><p><code>iBarShift</code>函数可以让我们找到在M1历史数据中时间为<code>next - 1</code>的K线右边界所在的偏移量（变量<code>p</code>）。<code>Bars</code>函数计算落在<code>prev</code>和<code>next - 1</code>之间的M1 K线数量（变量<code>n</code>）。这两个值成为调用<code>iHighest</code>函数的参数，用于在从索引<code>p</code>开始的<code>n</code>根M1 K线中查找<code>MODE_SPREAD</code>类型的最大值。如果顺利找到最大值（<code>m &gt; -1</code>），我们只需使用<code>iSpread</code>获取相应的值并将其放入结构体中。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iBarShift</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkSymbol, PERIOD_M1, next </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Bars</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkSymbol, PERIOD_M1, prev, next </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iHighest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkSymbol, PERIOD_M1, MODE_SPREAD, n, p);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(m </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         peaks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].spread </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iSpread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkSymbol, PERIOD_M1, m);</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         peaks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prev;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         peaks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].max </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         peaks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         peaks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].pos </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span></code></pre></div><p>当将结果数组输出到日志中时，我们现在还会额外看到M1 K线的索引，即较高时间框架K线“开始”的位置以及在其中找到最大点差的位置。“开始”这个词加上引号是因为随着新的M1 K线到来，这些索引会增加，每个K线的虚拟“开始”位置会移动，尽管历史K线的开盘时间当然是保持不变的。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>Maximal speeds per intraday bar</span></span>
<span class="line"><span>Processed 100 bars on EURUSD PERIOD_H1</span></span>
<span class="line"><span>               [time] [spread] [max] [num] [pos]</span></span>
<span class="line"><span>[ 0] 2021.10.12 15:00        0     7    60     7</span></span>
<span class="line"><span>[ 1] 2021.10.12 14:00        1    89    60    67</span></span>
<span class="line"><span>[ 2] 2021.10.12 13:00        1   181    60   127</span></span>
<span class="line"><span>[ 3] 2021.10.12 12:00        1   213    60   187</span></span>
<span class="line"><span>[ 4] 2021.10.12 11:00        1   248    60   247</span></span>
<span class="line"><span>[ 5] 2021.10.12 10:00        0   307    60   307</span></span>
<span class="line"><span>[ 6] 2021.10.12 09:00        1   385    60   367</span></span>
<span class="line"><span>[ 7] 2021.10.12 08:00        2   469    60   427</span></span>
<span class="line"><span>[ 8] 2021.10.12 07:00        2   497    60   487</span></span>
<span class="line"><span>[ 9] 2021.10.12 06:00        1   550    60   547</span></span>
<span class="line"><span>[10] 2021.10.12 05:00        1   616    60   607</span></span>
<span class="line"><span>[11] 2021.10.12 04:00        1   678    60   667</span></span>
<span class="line"><span>[12] 2021.10.12 03:00        1   727    60   727</span></span>
<span class="line"><span>[13] 2021.10.12 02:00        4   820    60   787</span></span>
<span class="line"><span>[14] 2021.10.12 01:00       16   906    60   847</span></span>
<span class="line"><span>[15] 2021.10.12 00:00       65   956    60   907</span></span>
<span class="line"><span>[16] 2021.10.11 23:00       15   967    60   967</span></span>
<span class="line"><span>[17] 2021.10.11 22:00        2  1039    60  1027</span></span>
<span class="line"><span>[18] 2021.10.11 21:00        1  1090    60  1087</span></span>
<span class="line"><span>[19] 2021.10.11 20:00        1  1148    60  1147</span></span>
<span class="line"><span>[20] 2021.10.11 19:00        2  1210    60  1207</span></span>
<span class="line"><span>[21] 2021.10.11 18:00        1  1313    60  1267</span></span>
<span class="line"><span>[22] 2021.10.11 17:00        1  1345    60  1327</span></span>
<span class="line"><span>[23] 2021.10.11 16:00        1  1411    60  1387</span></span>
<span class="line"><span>[24] 2021.10.11 15:00        2  1461    60  1447</span></span>
<span class="line"><span>[25] 2021.10.11 14:00        1  1526    60  1507</span></span>
<span class="line"><span>...</span></span></code></pre></div><p>例如，在脚本启动时，标签为2021.10.12 14:00的K线从第67根M1 K线开始（即它是在67分钟前开盘的），并且在这个H1 K线内部具有最大点差的M1 K线的索引为89。显然，这个索引应该小于前一个H1 K线（2021.10.12 13:00）开始的M1 K线的编号：它是在127分钟前标记的。反过来，在这个H1 K线中，找到了索引为181的最大点差。并且这个索引小于更早的K线（2021.10.12 12:00）的索引187。</p><p><code>pos</code>和<code>max</code>列中的索引不断增加，因为我们是按从当前到过去的顺序遍历K线的。<code>num</code>列几乎总是60，因为大多数H1 K线由60根M1 K线组成。但并非总是如此。例如，下面是不完整的小时K线，由较少的分钟组成：这可能是由于假期安排导致市场提前收盘的结果，或者是交易活动的实际缺口（缺乏流动性）。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>...</span></span>
<span class="line"><span>[38] 2021.10.11 01:00       20  2346    60  2287</span></span>
<span class="line"><span>[39] 2021.10.11 00:00       85  2404    58  2347</span></span>
<span class="line"><span>[40] 2021.10.08 23:00       15  2406    55  2405</span></span>
<span class="line"><span>[41] 2021.10.08 22:00        2  2463    60  2460</span></span>
<span class="line"><span>...</span></span></code></pre></div><h2 id="使用mqltick结构体处理真实报价点数组" tabindex="-1">使用MqlTick结构体处理真实报价点数组 <a class="header-anchor" href="#使用mqltick结构体处理真实报价点数组" aria-label="Permalink to &quot;使用MqlTick结构体处理真实报价点数组&quot;">​</a></h2><p>MetaTrader 5不仅提供了处理报价（K线）历史数据的能力，还支持处理真实报价点的历史数据。从用户界面来看，所有历史数据都可以在“交易品种”对话框中获取。该对话框有三个选项卡：规格、K线和报价点。当在第一个选项卡的树状交易品种列表中选择特定的交易品种后，切换到“K线”和“报价点”选项卡时，你可以分别以K线或报价点的形式请求相应的报价数据。</p><p>在MQL程序中，也可以使用<code>CopyTicks</code>和<code>CopyTicksRange</code>函数来获取真实报价点的历史数据。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CopyTicks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, MqlTick </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ticks</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COPY_TICKS_ALL, ulong from </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CopyTicksRange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, MqlTick </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ticks</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COPY_TICKS_ALL, ulong from </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ulong to </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>这两个函数都将指定交易品种的报价点数据请求到通过引用传递的<code>ticks</code>数组中。<code>MqlTick</code>结构体包含了关于一个报价点的所有信息，在MQL5中其描述如下：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MqlTick</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   datetime time;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 此价格更新的时间</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   bid;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // 当前买价</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ask;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // 当前卖价</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   last;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 最后成交价</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ulong    volume;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 最后成交价的成交量</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">     time_msc;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 此价格更新的时间（以毫秒为单位）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   uint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">     flags;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       // 标志位（结构体中哪些字段发生了变化）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   volume_real;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 最后成交价的更精确成交量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p><code>flags</code>字段用于存储标志位的位掩码，标识报价点结构体中哪些字段包含已更改的值。</p><table tabindex="0"><thead><tr><th>常量</th><th>值</th><th>描述</th></tr></thead><tbody><tr><td><code>TICK_FLAG_BID</code></td><td>2</td><td>买价已更改</td></tr><tr><td><code>TICK_FLAG_ASK</code></td><td>4</td><td>卖价已更改</td></tr><tr><td><code>TICK_FLAG_LAST</code></td><td>8</td><td>最后成交价已更改</td></tr><tr><td><code>TICK_FLAG_VOLUME</code></td><td>16</td><td>成交量已更改</td></tr><tr><td><code>TICK_FLAG_BUY</code></td><td>32</td><td>报价点是由买入交易产生的</td></tr><tr><td><code>TICK_FLAG_SELL</code></td><td>64</td><td>报价点是由卖出交易产生的</td></tr></tbody></table><p>之所以需要这样，是因为每个报价点总是会填充所有字段，无论与前一个报价点相比数据是否发生了变化。这使得你在任何时候都能获取到价格的当前状态，而无需在报价点历史记录中查找先前的值。例如，一个报价点可能仅买价发生了变化，但除了新的价格之外，结构体中还会指示其他参数：之前的卖价、最后成交价、成交量等等。</p><p>同时，你应该记住，根据交易品种的类型，报价点中的某些字段可能始终为零（并且相应的掩码位永远不会为它们设置）。特别是对于外汇交易品种，通常<code>last</code>、<code>volume</code>、<code>volume_real</code>字段会保持为空。</p><p>接收报价点的数组可以是固定大小的，也可以是动态的。无论请求的时间间隔（由<code>CopyTicksRange</code>函数中的<code>from</code>/<code>to</code>参数指定）或<code>CopyTicks</code>函数中的<code>count</code>参数中实际的报价点数量是多少，这些函数复制到固定数组中的报价点数量都不会超过数组的大小。在<code>ticks</code>数组中，最旧的报价点放在最前面，最新的报价点放在最后面。</p><p>在这两个函数的参数中，时间读数被指定为自1970年1月1日00:00:00以来的毫秒数。在<code>CopyTicks</code>函数中，请求的报价点范围由起始时间<code>from</code>和报价点数量<code>count</code>设置，而在<code>CopyTicksRange</code>函数中，由<code>from</code>和<code>to</code>设置（两个值都包含在内）。</p><p>换句话说，<code>CopyTicksRange</code>函数用于获取特定时间间隔内的报价点，并且事先不知道这些报价点的数量。<code>CopyTicks</code>函数保证不超过<code>count</code>个报价点，但不允许事先确定这些报价点将覆盖的时间间隔。</p><p><code>CopyTicksRange</code>函数中<code>from</code>和<code>to</code>值的时间顺序并不重要：该函数无论如何都会给出从两个值中的最小值开始，到最大值结束的报价点。</p><p><code>CopyTicks</code>函数将<code>from</code>参数视为最小时间的左边界，并从它开始向未来计数<code>count</code>个报价点。然而，有一个重要的例外：<code>from = 0</code>（默认值）被视为当前时刻，并且从它开始向过去计数报价点。这使得始终可以获取指定数量的最新报价点。当<code>count = 0</code>（默认值）时，该函数最多复制2000个报价点。</p><p>这两个函数都返回复制的报价点数量，如果出错则返回 -1。特别是，<code>GetLastError</code>可能返回以下错误代码：</p><ul><li><code>ERR_HISTORY_TIMEOUT</code> — 报价点同步超时，函数返回了已有的所有数据。</li><li><code>ERR_HISTORY_SMALL_BUFFER</code> — 静态缓冲区太小，因此它给出了数组中能容纳的数据量。</li><li><code>ERR_NOT_ENOUGH_MEMORY</code> — 未能分配所需的内存量，以便将指定范围内的报价点历史数据获取到动态数组中。</li></ul><p><code>flags</code>参数定义了请求的报价点类型。</p><table tabindex="0"><thead><tr><th>常量</th><th>值</th><th>描述</th></tr></thead><tbody><tr><td><code>COPY_TICKS_INFO</code></td><td>1</td><td>由买价和/或卖价变化引起的报价点（<code>TICK_FLAG_BID</code>，<code>TICK_FLAG_ASK</code>）</td></tr><tr><td><code>COPY_TICKS_TRADE</code></td><td>2</td><td>最后成交价和成交量发生变化的报价点（<code>TICK_FLAG_LAST</code>，<code>TICK_FLAG_VOLUME</code>，<code>TICK_FLAG_BUY</code>，<code>TICK_FLAG_SELL</code>）</td></tr><tr><td><code>COPY_TICKS_ALL</code></td><td>3</td><td>所有报价点</td></tr></tbody></table><p>对于任何请求类型，<code>MqlTick</code>结构体中与标志位不匹配的其余字段将包含先前的实际值。例如，如果仅请求了信息报价点（<code>COPY_TICKS_INFO</code>），其余字段仍将被填充。这意味着如果仅买价发生了变化，卖价和成交量字段将写入最后已知的值。要了解报价点中发生了哪些变化，请分析其<code>flags</code>字段（可能是<code>TICK_FLAG_BID</code>、<code>TICK_FLAG_ASK</code>或两者的组合）。如果一个报价点的买价和卖价为零，并且标志位表明这些价格已发生变化（<code>flags == TICK_FLAG_BID | TICK_FLAG_ASK</code>），则表示订单簿已清空。</p><p>类似地，如果请求了交易报价点（<code>COPY_TICKS_TRADE</code>），最后已知的价格值将记录在买价和卖价字段中。在这种情况下，<code>flags</code>字段可能是<code>TICK_FLAG_LAST</code>、<code>TICK_FLAG_VOLUME</code>、<code>TICK_FLAG_BUY</code>、<code>TICK_FLAG_SELL</code>的组合。</p><p>当请求<code>COPY_TICKS_ALL</code>时，将返回所有报价点。</p><p>调用<code>CopyTicks</code>/<code>CopyTicksRange</code>函数中的任何一个都会检查存储在硬盘上的给定交易品种的报价点库的同步情况。如果本地数据库中的报价点不足，缺失的报价点将自动从交易服务器下载。在这种情况下，将根据查询参数中的最早日期到当前时刻进行报价点同步。之后，该交易品种的所有传入报价点都将进入报价点数据库，并使其保持同步的最新状态。</p><p>报价点数据比分钟报价数据大得多。当首次请求报价点历史数据或通过真实报价点开始测试时，下载它们可能需要很长时间。报价点数据的历史记录以内部<code>TKC</code>格式存储在文件中，路径为<code>{terminal_dir}/bases/{server_name}/ticks/{symbol_name}</code>。每个文件包含一个月的信息。</p><p>在指标中，这些函数会立即返回结果，即它们按交易品种复制可用的报价点，并在数据不足时启动报价点库同步的后台进程。一个交易品种上的所有指标都在一个公共线程中工作，所以它们无权等待同步完成。同步结束后，函数的下一次调用将返回所有请求的报价点。</p><p>在智能交易系统和脚本中，函数最多可以等待45秒以获取结果：与指标不同，每个智能交易系统和脚本都在自己的线程中运行，因此可以在超时时间内等待同步完成。如果在此期间仍未按要求同步足够的报价点，则仅返回可用的报价点，并且同步将在后台继续进行。</p><p>回想一下，实时报价点作为事件广播到图表上：指标在<code>OnCalculate</code>处理程序中接收新报价点的通知，而智能交易系统在<code>OnTick</code>处理程序中接收它们。应该记住，系统不能保证交付所有事件。如果在程序处理当前<code>OnCalculate</code>/<code>OnTick</code>事件时，新的报价点到达终端，针对这个“繁忙”程序的新事件可能不会添加到其队列中（请参阅“事件处理函数概述”部分）。此外，多个报价点可能同时到达，但每个MQL程序只会生成一个事件：当前市场状态事件。在这种情况下，可以使用<code>CopyTicks</code>函数请求自上次处理事件以来到达的所有报价点。以下是此算法的伪代码：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processAllTicks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ulong prev </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">prev)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      MqlTick ticks</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CopyTicks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Symbol, ticks, COPY_TICKS_ALL, prev </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         prev </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> ticks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].time_msc;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         ...</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 处理所有错过的报价点</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      MqlTick tick;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      SymbolInfoTick</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_Symbol, tick);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      prev </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tick.time_msc;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ...</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 处理第一个报价点</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>这里使用的<code>SymbolInfoTick</code>函数会将最后一个报价点数据填充到通过引用传递的单个<code>MqlTick</code>结构体中。我们将在单独的部分中学习它。</p><p>请注意，在调用<code>CopyTicks</code>时，会在旧的时间戳<code>prev</code>上增加一毫秒。这确保了不会再次处理先前的报价点。然而，如果在与<code>prev</code>对应的一毫秒内有多个报价点，此算法将跳过它们。如果你想涵盖绝对所有的报价点，则应在更新<code>prev</code>变量时记住<code>prev</code>时间的可用报价点数量。在下一次调用<code>CopyTicks</code>时，从<code>prev</code>时刻请求报价点，并跳过（在数组中忽略）“旧”报价点的数量。</p><p>然而，请注意，并非每个MQL程序都需要上述算法。大多数程序不会分析每个报价点，而与最后已知报价点对应的当前价格状态会在事件模型中快速广播到图表上，并可通过交易品种和图表属性获取。</p><p>为了演示这些函数的使用，让我们考虑两个示例，每个函数对应一个示例。对于这两个示例，开发了一个通用的头文件<code>TickEnum.mqh</code>，其中将上述请求报价点标志和报价点状态标志的常量汇总到两个枚举中。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">enum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COPY_TICKS</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ALL_TICKS </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* -1 */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COPY_TICKS_ALL,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 所有报价点</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   INFO_TICKS </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* 1 */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COPY_TICKS_INFO,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 信息报价点</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TRADE_TICKS </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* 2 */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COPY_TICKS_TRADE,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 交易报价点</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">enum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAGS</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_BID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* 2 */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_BID, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_ASK </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* 4 */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_ASK, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_BID_ASK </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_BID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_ASK, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_LAST </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* 8 */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_LAST, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_BID_LAST </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_BID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_LAST, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_ASK_LAST </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_ASK </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_LAST, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_BID_ASK_LAST </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TF_BID_ASK </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_LAST, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_VOLUME </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* 16 */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_VOLUME, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_LAST_VOLUME </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_LAST </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_VOLUME, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_BID_VOLUME </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_BID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_VOLUME, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_BID_ASK_VOLUME </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TF_BID_ASK </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_VOLUME, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_BID_ASK_LAST_VOLUME </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TF_BID_ASK </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TF_LAST_VOLUME, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_BUY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* 32 */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_BUY, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_SELL </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* 64 */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_SELL, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_BUY_SELL </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_BUY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_SELL, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_LAST_VOLUME_BUY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TF_LAST_VOLUME </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_BUY, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_LAST_VOLUME_SELL </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TF_LAST_VOLUME </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_SELL, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TF_LAST_VOLUME_BUY_SELL </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TF_BUY_SELL </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TF_LAST_VOLUME, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>使用枚举使得在源代码中的类型检查更加严格，并且使用<code>EnumToString</code>函数将值的含义显示为字符串也更加容易。此外，<code>TICK_FLAGS</code>枚举中添加了最常用的标志组合，以优化报价点的可视化或过滤。不能给枚举元素与内置常量相同的名称，否则会发生名称冲突。</p><p>第一个脚本<code>SeriesTicksStats.mq5</code>使用<code>CopyTicks</code>函数来统计在给定历史深度内设置了不同标志位的报价点数量。</p><p>在输入参数中，你可以设置工作交易品种（默认为图表交易品种）、分析的报价点数量以及来自<code>COPY_TICKS</code>的请求模式。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input string WorkSymbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 交易品种（留空表示当前品种）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TickCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input COPY_TICKS TickType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ALL_TICKS;</span></span></code></pre></div><p>在<code>TickFlagStats</code>结构体中收集每个标志位（位掩码中的每个位）在报价点属性中出现的统计信息。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TickFlagStats</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TICK_FLAGS flag;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 带有位（一个或多个）的掩码</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       // 在flags字段中具有此位的报价点数量 </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   string legend;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 位的描述</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p><code>OnStart</code>函数定义了一个大小为8个元素的<code>TickFlagStats</code>结构体数组：其中6个（从1到6，包括1和6）用于相应的<code>TICK_FLAG</code>位，另外两个用于位组合（见下文）。使用一个简单的循环，将各个标准位/标志的元素填充到数组中，循环结束后，填充两个组合掩码（在第0个元素中，将统计买价和卖价同时发生变化的报价点，在第7个元素中，统计同时有买入和卖出交易的报价点）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TickFlagStats </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {};</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> k </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; k </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">k)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">      stats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[k].flag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (TICK_FLAGS)(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> k);</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">      stats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[k].legend </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> EnumToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[k].flag);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">   stats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].flag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TF_BID_ASK;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 买价和卖价的组合</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">   stats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].flag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TF_BUY_SELL;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 买入和卖出的组合</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">   stats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].legend </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;TF_BID_ASK (COMBO)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">   stats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].legend </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;TF_BUY_SELL (COMBO)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">我们将所有主要工作委托给辅助函数CalcTickStats，将输入参数和准备好的统计数组传递给它。之后，只需在日志中显示统计的数量。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CalcTickStats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TickType, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, TickCount, stats);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PrintFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stats requested: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> (got: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">) on </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      EnumToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TickType),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      TickCount, count, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringLen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkSymbol) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WorkSymbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _Symbol);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(stats);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="代码功能概述" tabindex="-1">代码功能概述 <a class="header-anchor" href="#代码功能概述" aria-label="Permalink to &quot;代码功能概述&quot;">​</a></h3><p>这段代码主要围绕MetaTrader 5中处理真实报价点数据展开，包含两个脚本：<code>SeriesTicksStats.mq5</code>和<code>SeriesTicksDeltaVolume.mq5</code>。下面为你详细介绍这两个脚本的功能及实现细节。</p><h3 id="脚本1-seriesticksstats-mq5" tabindex="-1">脚本1：<code>SeriesTicksStats.mq5</code> <a class="header-anchor" href="#脚本1-seriesticksstats-mq5" aria-label="Permalink to &quot;脚本1：\`SeriesTicksStats.mq5\`&quot;">​</a></h3><p>此脚本借助<code>CopyTicks</code>函数统计在给定历史深度内设置了不同标志位的报价点数量。</p><h4 id="主要功能" tabindex="-1">主要功能： <a class="header-anchor" href="#主要功能" aria-label="Permalink to &quot;主要功能：&quot;">​</a></h4><ol><li><strong>请求报价点数据</strong>：调用<code>CopyTicks</code>函数请求指定交易品种、类型和数量的报价点数据。</li><li><strong>记录时间范围</strong>：若请求成功，记录接收到的报价点的时间范围。</li><li><strong>统计标志位</strong>：遍历所有报价点，统计每个标志位在报价点属性中出现的次数。</li></ol><h4 id="代码示例" tabindex="-1">代码示例： <a class="header-anchor" href="#代码示例" aria-label="Permalink to &quot;代码示例：&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CalcTickStats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COPY_TICKS </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   TickFlagStats </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stats</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   MqlTick ticks</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ResetLastError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nf </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ArraySize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(stats);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CopyTicks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(symbol, ticks, type, start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, count);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(nt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _LastError </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      PrintFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Ticks range: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%03d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> - </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%03d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         TimeToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ticks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].time, TIME_DATE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TIME_SECONDS),</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         ticks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].time_msc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         TimeToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ticks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[nt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].time, TIME_DATE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TIME_SECONDS),</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         ticks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[nt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].time_msc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // loop through ticks</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">j)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // loop through TICK_FLAGs (2 4 8 16 32 64) and combinations</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> k </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; k </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nf; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">k)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ticks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[j].flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> stats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[k].flag) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> stats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[k].flag)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">               stats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[k].count</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="运行结果示例" tabindex="-1">运行结果示例： <a class="header-anchor" href="#运行结果示例" aria-label="Permalink to &quot;运行结果示例：&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>Ticks range: 2021.10.11 07:39:53&#39;278 - 2021.10.13 11:51:29&#39;428</span></span>
<span class="line"><span>ALL_TICKS stats requested: 100000 (got: 100000) on YNDX.MM</span></span>
<span class="line"><span>    [flag] [count]              [legend]</span></span>
<span class="line"><span>[0]      6   11323 &quot;TF_BID_ASK (COMBO)&quot; </span></span>
<span class="line"><span>[1]      2   26700 &quot;TF_BID&quot;             </span></span>
<span class="line"><span>[2]      4   33541 &quot;TF_ASK&quot;             </span></span>
<span class="line"><span>[3]      8   51082 &quot;TF_LAST&quot;            </span></span>
<span class="line"><span>[4]     16   51082 &quot;TF_VOLUME&quot;          </span></span>
<span class="line"><span>[5]     32   25654 &quot;TF_BUY&quot;             </span></span>
<span class="line"><span>[6]     64   28802 &quot;TF_SELL&quot;            </span></span>
<span class="line"><span>[7]     96    3374 &quot;TF_BUY_SELL (COMBO)&quot;</span></span></code></pre></div><h3 id="脚本2-seriesticksdeltavolume-mq5" tabindex="-1">脚本2：<code>SeriesTicksDeltaVolume.mq5</code> <a class="header-anchor" href="#脚本2-seriesticksdeltavolume-mq5" aria-label="Permalink to &quot;脚本2：\`SeriesTicksDeltaVolume.mq5\`&quot;">​</a></h3><p>该脚本使用<code>CopyTicksRange</code>函数计算每个K线的成交量差值。</p><h4 id="主要功能-1" tabindex="-1">主要功能： <a class="header-anchor" href="#主要功能-1" aria-label="Permalink to &quot;主要功能：&quot;">​</a></h4><ol><li><strong>获取K线时间范围</strong>：遍历每个K线，获取其时间范围。</li><li><strong>请求报价点数据</strong>：调用<code>CopyTicksRange</code>函数请求该时间范围内的报价点数据。</li><li><strong>计算成交量差值</strong>：根据报价点的标志位和价格变动，分别累计买入和卖出成交量，并计算差值。</li></ol><h4 id="代码示例-1" tabindex="-1">代码示例： <a class="header-anchor" href="#代码示例-1" aria-label="Permalink to &quot;代码示例：&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   DeltaVolumePerBar deltas</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayResize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(deltas, BarCount);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ZeroMemory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(deltas);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BarCount; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      MqlTick ticks</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime next </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkSymbol, TimeFrame, i);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> datetime prev </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkSymbol, TimeFrame, i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      ResetLastError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CopyTicksRange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkSymbol, ticks, COPY_TICKS_ALL, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         prev </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, next </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _LastError </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         deltas</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prev;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // remember the bar time</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">j)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // when real volumes can be available, take them from ticks</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TickType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRADE_TICKS)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">               // separately accumulate volumes for buy and sell deals</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">               if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ticks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[j].flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_BUY) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">               {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">                  deltas</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].buy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> ticks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[j].volume;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">               }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">               if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ticks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[j].flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_SELL) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">               {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">                  deltas</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].sell </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> ticks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[j].volume;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">               }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // when there are no real volumes, we evaluate them by the price movement up/down</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            else</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TickType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INFO_TICKS </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">               if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ticks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[j].flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (TICK_FLAG_ASK </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TICK_FLAG_BID)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">               {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                  const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> d </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ticks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[j].ask </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> ticks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[j].bid)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                               -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ticks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].ask </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> ticks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].bid)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _Point);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(d </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">deltas</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].buy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> d;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                  else</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> deltas</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].sell </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">d;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">               }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         }</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">         deltas</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].delta </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">deltas</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].buy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> deltas</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].sell);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   PrintFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Delta volumes per intraday bar</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Processed </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bars on </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> %s</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> %s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      BarCount, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">StringLen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkSymbol) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WorkSymbol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _Symbol, </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      EnumToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TimeFrame </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PERIOD_CURRENT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _Period </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TimeFrame),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      EnumToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TickType));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   ArrayPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(deltas);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="运行结果示例-1" tabindex="-1">运行结果示例： <a class="header-anchor" href="#运行结果示例-1" aria-label="Permalink to &quot;运行结果示例：&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span>Delta volumes per intraday bar</span></span>
<span class="line"><span>Processed 100 bars on YNDX.MM PERIOD_H1 TRADE_TICKS</span></span>
<span class="line"><span>                  [time] [buy] [sell] [delta]</span></span>
<span class="line"><span>[ 0] 2021.10.13 11:00:00  7912  14169   -6257</span></span>
<span class="line"><span>[ 1] 2021.10.13 10:00:00  8470  11467   -2997</span></span>
<span class="line"><span>[ 2] 2021.10.13 09:00:00 10830  13047   -2217</span></span>
<span class="line"><span>[ 3] 2021.10.13 08:00:00 23682  19478    4204</span></span>
<span class="line"><span>[ 4] 2021.10.13 07:00:00 14538  11600    2938</span></span>
<span class="line"><span>[ 5] 2021.10.12 20:00:00  2132   4786   -2654</span></span>
<span class="line"><span>[ 6] 2021.10.12 19:00:00  9173  13775   -4602</span></span>
<span class="line"><span>[ 7] 2021.10.12 18:00:00  1297   1719    -422</span></span>
<span class="line"><span>[ 8] 2021.10.12 17:00:00  3803   2995     808</span></span>
<span class="line"><span>[ 9] 2021.10.12 16:00:00  6743   7045    -302</span></span>
<span class="line"><span>[10] 2021.10.12 15:00:00 17286  37286  -20000</span></span>
<span class="line"><span>[11] 2021.10.12 14:00:00 33263  54157  -20894</span></span>
<span class="line"><span>[12] 2021.10.12 13:00:00 56060  52659    3401</span></span>
<span class="line"><span>[13] 2021.10.12 12:00:00 12832  10489    2343</span></span>
<span class="line"><span>[14] 2021.10.12 11:00:00  7530   6092    1438</span></span>
<span class="line"><span>[15] 2021.10.12 10:00:00  6268  25201  -18933</span></span>
<span class="line"><span>...</span></span></code></pre></div><h3 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>这两个脚本借助MetaTrader 5提供的<code>CopyTicks</code>和<code>CopyTicksRange</code>函数，对真实报价点数据进行处理和分析，为交易决策提供了有价值的信息。</p>`,255)]))}const y=i(k,[["render",t]]);export{g as __pageData,y as default};
